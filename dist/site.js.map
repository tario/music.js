{"version":3,"sources":["app.js","en.js","es.js","langSettings.js","routes.js","directives.js","functionGraph.js","keyboard.js","musicEventEditor.js","ngfDrop.js","ngfLoader.js","patternTrackCompactView.js","playingLine.js","recipeBlink.js","recipeTooltip.js","recipeWizard.js","recycleBinCompactView.js","typeIcon.js","services.js","errMessage.js","export.js","index.js","midi.js","recipe.js","sync.js","translationsLoader.js","typeService.js","welcomeMessage.js","_localforage.js","controllers.js","errorModalCtrl.js","infoModalController.js","midiSettingsModalCtrl.js","openProjectModalCtrl.js","projectSettingsModalCtrl.js","recycleBinModalCtrl.js","welcomeModalCtrl.js"],"names":["musicShowCaseApp","angular","module","constant","MUSIC","localforage","enTranslations","midi","settings","inputs","connected","disconnected","events","octave","transpose","open_project","p1","title","array_editor","tooltip","remove_item","add_item","edit_item","index","not_implemented","filter","type","instrument","pattern","song","fx","type_p1","type_p2","project","basic_info","references","new","menu","new_instrument","new_pattern","new_song","new_project","file_import","tools","tools_preferences","help_view_help","help_recipes","help_recipes_intro","help_recipes_howto_create_song","help_recipes_howto_create_instrument","help_contextual_help","help_welcome","help_about","recycle_bin","preferences","help","project_settings","project_remove_project","project_export_project","contextual_help","enable","disable","recycle","p2","p3","compact_title","compact_hint_restore","compact_hint_open","EMPTY","welcome","nevershow","about","authors","i_am","credit","mohayonao","higuma","kristopolous","contribute","contact_me","common","yes","no","ok","dismiss","cancel","create","open","name","language","loader_error","cantremove_error","cantremove_project_error","error_title","HELP","more","remove","export","reset","play","pause","stop","record","bpm","bpm_lc","add","playing_speed","modulation","FLOW","RECIPES","p4","p5","p6","p7","p8","recipes","CONTEXTUAL_HELP","stack","drop_elements_here","you_can_drop_new_effects_here","up","down","expand","editor","keyboard_instructions","test_instrument_here","type_here_instrument","track_muted","track_solo","measure_beats","amount_beats","measure_count","zoom_level","total_measures","tracks","drop_instrument","change_name","remove_track","compact_view_p1","compact_view_p2","drop_zone","editor_notes_p1","editor_notes_p2","editor_notes_p3","editor_notes_p4","add_track","note_event_p1","note_event_p2","note_event_p3","muted","solo","instrument_edit","drop_pattern","download","remove_block","edit_block","BUTTON_LANG_EN","BUTTON_LANG_ES","esTranslations","config","$translateProvider","getBrowserLanguage","resolveClientLocale","langCode","split","translations","preferredLanguage","fallbackLanguage","useSanitizeValueStrategy","useLoader","$routeProvider","$locationProvider","when","templateUrl","controller","directive","$timeout","$http","TypeService","Recipe","MusicObjectFactory","scope","file","link","element","attrs","types","getTypes","output","parameters","recipe","start","termschanged","$broadcast","f_t","str","state","ret","eval","error","e","toString","oscTermsUpdateFromWaveForm","fn","debounce","waveform","terms","resolution","count","values","Array","i","isNaN","ft","DFT","length","forward","cos","real","sin","imag","f","t","a","b","Math","PI","maxvalue","value","invalidWaveform","err","oscTermsUpdate","serie","errVar","n","range","init","end","x","push","truthy","updateObject","newValue","changed","outputObserver","$on","destroy","updateTemplate","observeOutput","then","selectedType","getType","k","_default","data","map","parameter","components","modulations","component","array","changeType","$watch","forEach","$emit","subobjects","maxElements","maxelements","parseInt","Infinity","currentTab","addObject","newObject","setCurrentTab","idx","removeObject","object","o","initFile","dropzoneExtraName","swap","idx1","idx2","tmp","defaultStackAppend","concat","onDropComplete","event","stackAppend","oldCollection","newFile","template","termsChanged","scale","semitoneToNote","noteToSemitone","notation7","newVal","Utils","Scale","deltas","initTone","notes","d","semitone","tone","alt","$parse","restrict","scrollVarGetter","ngScrollTop","scrollVarSetter","assign","$","scrollTop","on","ngScrollLeft","scrollLeft","replace","t0","parseFloat","tf","samples","scaley","$parent","_f","redraw","canvas","context","getContext","width","clientWidth","height","clientHeight","drawLine","x0","y0","x1","y1","color","save","beginPath","moveTo","lineTo","strokeStyle","lineWidth","stroke","restore","drawFunc","translate","lineJoin","$uibModal","Midi","MusicContext","onMIDIMessage","command","octaveNumber","floor","oct","octaves","update","listener","registerEventListener","updateMidiStatus","getStatus","midiConnected","keyCodeToNote","90","83","88","68","67","86","71","66","72","78","74","77","stopAll","midiSetup","result","base","mouse","key","note","this","undefined","gesture","resumeAudio","mouseOff","mouseLeave","mouseEnter","keyDownHandler","document","activeElement","tagName","toLowerCase","keyCode","noteName","noteToNoteNum","$digest","keyUpHandler","bind","pianoFirstRow","find","pianoSecondRow","unbind","TICKS_PER_BEAT","Pattern","track","zoomLevel","beatWidth","measure","measureCount","defaultL","clearShadow","shadowEvt","defaultMouseLeave","defaultMouseMove","clipDistance","target","classList","contains","upperLimit","offsetY","l","s","exactPosition","offsetX","clipS","findClipS","abs","cutEvent","raiseEventChanged","oldevt","evt","note7","isArray","updateGrid","mainGridStyle","background-size","addNewEvent","newEvt","copy","collision","selected","raise","mouseMove","moveEvent","mouseMoveEvent","moveEventFromEvent","cancelMove","mouseUpResizeEvent","mouseUpEvent","mouseUp","mouseMoveResizeEvent","shadowMouseMove","deltaS","addFromShadow","preventCollision","savedEvt","apply","arguments","dragevt","mouseDown","eventSplit","ticks","originalL","eventLeftSplit","eventCenterSplit","eventRightSplit","mouseDblClickEvent","elementWidth","mouseDownEvent","preventDefault","blur","_cancelMove","mouseDownResizeEvent","clipL","findClipL","exactL","refs","ngfDropGetter","ngfDrop","allowDrag","dataTransfer","dropEffect","onDrop","$files","files","window","addEventListener","removeEventListener","ngfLoaderGetter","ngfLoader","onChange","val","off","background-position","moved","parentElement","timeToTicks","playing","getBpm","getZoomLevel","getBeatWidth","ticksToPX","callback","performance","now","displacement","css","requestAnimationFrame","requestId","_timeToTicks","_t0","baseTicks","cancelAnimationFrame","recipeBlinkGetter","recipeBlink","blinkElementId","blink","addClass","noblink","removeClass","registerEvent","getBlinks","indexOf","args","rtIdGetter","rtId","tooltipElementId","tooltipEnabled","onClick","stopImmediatePropagation","windowWidth","max","documentElement","innerWidth","el","offset","getBoundingClientRect","left","capRight","text","FileRepository","ErrMessage","observer","observeRecycled","searchRecycled","limit","results","slice","openRecycleBin","restoreFromRecycleBin","id","location","moveToRecycleBin","iconTypeName","typeIcon","factory","$q","pruneWrapper","fileOutputMap","WeakMap","options","nextId","_last_type","___cache","monitor","getConstructor","descriptor","channel","wrapped","music","buildComponents","componentName","createParametric","obj","all","objs","last_type","__cache","set","constructor","has","get","noid","createParametricFromStack","getObject","newArray","dataLink","notifyChangeFor","ee","emit","destroyAll","bases","prune","fcn","sfxBase","runFcn","EventEmitter","removeListener","service","Recordable","playable","_playable","_music","_name","prototype","recording","recordFileName","FunctionSeq","preciseTimeout","exportWAV","blob","createElement","body","appendChild","style","url","URL","createObjectURL","href","click","revokeObjectURL","duration","Context","resume","run","code","currentVersion","undo","redo","registerVersion","schedule","noteseq","eventPreprocessor","onStop","ctx","sort","e1","e2","scaledEvents","tc","paddingTo","pushCallback","NoteSequence","patternCompose","instruments","isTempoTrack","tempo","getEvents","byStart","songCtx","time","ticksToTime","ticks_per_beat","bpm_events","reduce","makePlayable","noteSequence","contexts","higher","computeMeasureCount","endTime","measureLength","getMutedState","someSolo","some","_not","self","nearest","c1","c2","allEvents","allOtherEvents","tr","clips","measureTicks","musicObjectFactory","trackControl","created","load","trackNo","_id","gain","getFile","contents","dispose","mute","muteState","Historial","Index","createdFilesIndex","createdFiles","builtIns","loadBuiltIn","uri","r","objectId","ref","builtIn","createDefault","content","noExportable","builtInLoaded","createId","random","join","genericStateEmmiter","recycledEmmiter","defaultFile","blocks","selectedTrack","scroll","hist","updateFile","localFile","storageIndex","getEntry","serialized","Formats","MultiSerializer","serialize","noHistory","JSON","stringify","setItem","recycleIndex","reload","destroyFile","removeItem","removeEntry","purgeFromRecycleBin","_restoreFromRecycleBin","createEntry","_moveToRecycleBin","getId","isProjectType","willRemove","getAll","getFreeItems","getOrphan","orphanFiles","console","getPatternSongs","byProject","byType","typeSong","loadFile","storage","builtin","fileIndexes","mode","_m","maxcount","getDefaultMeasure","getDefaultBPM","getItem","deserialize","getRefs","updated","parse","createFile","newid","defaultMeasure","defaultBPM","s0","JSONSerializer","s1","CachedSerializer","PackedJSONSerializer","s2","HuffmanSerializerWrapper","s3","s4","PackedJSONSerializerB","s5","setSerializers","serializer","blockId","getProjectFiles","projectId","oldVer","nextVer","updateIndex","attributes","updateEntry","getIndex","addListener","keyword","hasKeyword","filtered","reverse","total","search","updateSearch","notInRes","item","res","convertType","observe","cb","close","_wrapper","modWrapper","originalDispose","_lastmusic","_lastinstance","nowrap","$translate","modalIns","windowClass","resolve","exportContents","Blob","getRelatedIds","y","getFileWithRelated","relarray","rel","uniq","Object","keys","exportProject","exportFile","importFile","importItem","p","parsed","firstItem","Sync","CantRemove","Error","IndexFactory","indexName","entryChange","clearItem","c","sync","isolatedContext","ic","entry","extraIds","extraProjectIds","projectIds","ids","isOrphan","referenced","musicJs","midiSetupRequested","midiLoaded","midiAccessRequested","setupStore","storeInputEnabled","inputId","enabled","navigator","requestMIDIAccess","sysex","wrapInput","input","onmidimessage","midiAccess","next","done","getInputs","retInputs","eventListeners","cfg","reloadConfig","getConfig","setConfig","$rootScope","recipeList","blinks","currentRecipe","steps","currentStep","handleEvent","step","eventHandler","runRecipeStep","blink_id","tooltip_id","next_step_on","eventName","delay","ms","getLocaleName","stepIndex","tooltipName","loadEventHandler","eventHandlerData","inner","loadStep","stepData","createFiles","switchProject","recipeData","Date","loadTranslations","loadRecipeTranslation","lang","langIndex","tp","localeName","actions","recipeId","recipeTranslationData","promise","_args","_self","defer","reject","baseTranslation","addTranslations","typeTranslations","recipeTranslations","ObjectCache","wm","strobj","elem","make_mutable","cacheData","cacheWrap","baseMusic","originalPrune","params","getOriginal","current","instances","reusableNode","newBase","lastObjData","lastCurrent","proxy","newr","newobject","_components","instance","plugins","translation","m","pluginName","translateData","typeName","composition","description","loadPlugin","runnerCode","pluginsLoaded","skip","setSkip","releaseWithIndex","bytes","nextEntry","shift","release","newIndex","isretry","instrumentId","instrumentMap","block","indexMap","$scope","$uibModalInstance","numChannels","encoding","$routeParams","InstrumentSet","Export","SONG_MAX_TRACKS","instSet","playingStartOffset","pxToTicks","px","seek","currentRec","replay","patternEdit","exportItem","fileIndex","reloadFromRepo","checkPayload","fileChanged","encodingOptions","patterns","createPattern","songTrackIdx","changedBpm","Song","indexChanged","maxblocks","maxTrackIndex","trackIndex","mCount","payload","$data","$event","fromBlock","swapId","block_ids","ctrlKey","instrumentEdit","mutedState","updateMuted","removeTrack","trackIdx","addTrack","zoomIn","zoomOut","lastPlaying","beep","setTimeout","trackMuted","updateInstrument","musicObject","playButton","lastObj","playables","stopPlay","lazyLoadInstrument","instrumentPromise","innerInstrument","callStop","callPlay","innerNote","inst","instrumentExtend","stopDelay","createInstrumentFromFile","oldFile","outputFile","notify","resetStack","startPlay","WelcomeMessage","currentObserver","projectFilter","filesTotal","fileInputClick","fileImport","nextLocation","readTextFile","fileReader","FileReader","onload","onerror","readAsText","json","first","changeLanguage","langKey","use","currentLanguage","langLoaded","dontshowagain","activate","example","keywordUpdated","searchKeyword","removeProject","projectSettings","buttonText","newProject","projectName","openProject","moreImportant","file1","file2","better","newInstrument","newSong","newPattern","todo","updateConfig","immediateUpdateSearch","select","skipUpdated","updateSkip","tutorial"],"mappings":"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","file":"site.js","sourcesContent":["var musicShowCaseApp = angular.module(\"MusicShowCaseApp\", ['ui.codemirror', 'ngRoute', 'ui.bootstrap', 'ngDraggable', 'ngCookies', 'pascalprecht.translate']);\r\n\r\nmusicShowCaseApp.constant(\"MUSIC\", MUSIC);\r\nmusicShowCaseApp.constant(\"TICKS_PER_BEAT\", 96);\r\nmusicShowCaseApp.constant(\"SONG_MAX_TRACKS\", 32);\r\nmusicShowCaseApp.constant(\"localforage\", localforage);\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\nvar enTranslations = {\r\n  midi: {\r\n    settings: 'MIDI Settings',\r\n    inputs: 'Inputs',\r\n    connected: 'MIDI Input Connected',\r\n    disconnected: 'MIDI Input Disconnected (Click to setup)',\r\n    events: 'Events',\r\n    octave: 'Base Octave',\r\n    transpose: 'Transpose'\r\n  },\r\n  open_project: {\r\n    p1: 'Select the project you want to open',\r\n    title: 'Open Project'\r\n  },\r\n  array_editor: {\r\n    tooltip: {\r\n      remove_item: 'Removes the object from array',\r\n      add_item: 'Click to add a new object to array',\r\n      edit_item: 'Click to edit this object'\r\n    }\r\n  },\r\n  index: {\r\n    not_implemented: 'Sorry. Not implemented Yet :P',\r\n    filter: 'Type here the word to filter objects',\r\n    tooltip: {\r\n      type: {\r\n        instrument: 'This is a resource object of type instrument',\r\n        pattern: 'This is a resource object of type pattern',\r\n        song: 'This is a resource object of type song',\r\n        fx: 'This is a resource object of type fx'\r\n      },\r\n      type_p1: 'To use the resource, drag them from here into your creation on the right',\r\n      type_p2: 'To instead, *edit* the resource, double click it',\r\n      index: 'This is the object index, you can find here your crafting outputs and inputs'\r\n    }\r\n  },\r\n  project: {\r\n    basic_info: 'Properties',\r\n    references: 'References',\r\n    settings: 'Project Settings',\r\n    'new': 'New Project'\r\n  },\r\n  menu: {\r\n    'new': 'File',\r\n    new_instrument: 'New Instrument',\r\n    new_pattern: 'New Pattern',\r\n    new_song: 'New Song',\r\n    new_project: 'New Project...',\r\n    open_project: 'Open Project...',\r\n    file_import: 'Import...',\r\n    tools: 'Tools',\r\n    tools_preferences: 'Preferences',\r\n    help_view_help: 'View Help',\r\n    help_recipes: 'Recipes',\r\n    help_recipes_intro: 'Basic intro tour',\r\n    help_recipes_howto_create_song: 'How to create a song',\r\n    help_recipes_howto_create_instrument: 'How to create an instrument (square + 2 voices echo)',\r\n    help_contextual_help: 'Contextual Help',\r\n    help_welcome: 'Welcome!',\r\n    help_about: 'About Music.js',\r\n    recycle_bin: 'Recycle Bin...',\r\n    tooltip: {\r\n      'new': 'You can create new blank items from this option',\r\n      preferences: 'You can edit your preferences here',\r\n      help: 'Menu to access help options and about'\r\n    },\r\n    project: 'Project',\r\n    project_settings: 'Settings...',\r\n    project_remove_project: 'Remove Project',\r\n    project_export_project: 'Export Project'\r\n  },\r\n  contextual_help: {\r\n    enable: 'Enable Contextual Help',\r\n    disable: 'Disable Contextual Help'\r\n  },\r\n  recycle: {\r\n    p1: 'This is the recycle bin, from here, you can restore the items that have been removed',\r\n    p2: 'Remember: items in the recycle bin will be permanently deleted if and when available storage space runs out',\r\n    p3: '* Double-click the item you want to RESTORE',\r\n    title: 'Recycle Bin',\r\n    compact_title: 'Recycle Bin',\r\n    compact_hint_restore: '* Double-click the item you want to RESTORE',\r\n    compact_hint_open: '* Click here to open recycle bin window',\r\n    EMPTY: 'EMPTY'\r\n  },\r\n  welcome: {\r\n    title: 'Welcome to Music.js: 8bit Edition',\r\n    p1: 'Music.js is a web application that allows the composition of melodies powered (optionally) by javascript programming',\r\n    p2: 'This first basic edition, is fully oriented towards retro/8bit music by providing elemental oscillators, noise generators and basic modulation patterns',\r\n    p3: 'Do you want a basic tour?',\r\n    nevershow: 'Never show this message again'\r\n  },\r\n  about: {\r\n    title: 'About Music.js: 8bit Edition',\r\n    p3: 'In the long term, the goal of music.js is to cover all the layers needed between HTML5 Web Audio API provided by browsers and fully usable music composition application similar to known ones like FL Studio',\r\n    authors: 'AUTHORS',\r\n    i_am: 'I am Dario Seminara, but also I should give credit to some key library authors:',\r\n    credit: {\r\n      mohayonao: '@mohayonao (Author of Timbre.js)',\r\n      higuma: '@higuma (Author of WebAudioRecorder)',\r\n      kristopolous: '@kristopolous (Author of BOOTSTRA.386 Bootstrap Template)'\r\n    },\r\n    contribute: 'CONTRIBUTE',\r\n    contact_me: 'Contact me at github'\r\n  },\r\n  common: {\r\n    yes: 'Yes',\r\n    no: 'No',\r\n    ok: 'Ok',\r\n    dismiss: 'Dismiss',\r\n    cancel: 'Cancel',\r\n    create: 'Create',\r\n    open: 'Open',\r\n    name: 'Name',\r\n    language: 'Language:',\r\n    loader_error: 'Error when trying to load file',\r\n    cantremove_error: 'Can not delete the file if it is being used',\r\n    cantremove_project_error: 'Can not delete the project if it is being used in another project',\r\n    error_title: 'Error',\r\n    HELP: 'HELP',\r\n    more: 'more',\r\n    remove: 'Remove',\r\n    'export': 'Export',\r\n    reset: 'Reset',\r\n    play: 'Play',\r\n    pause: 'Pause',\r\n    stop: 'Stop',\r\n    record: 'Rec.',\r\n    bpm: 'Bpm',\r\n    bpm_lc: 'bpm',\r\n    add: 'Add',\r\n    tooltip: {\r\n      playing_speed: 'Playing speed, number of beats per minute',\r\n      remove_item: 'Removes item, you can restore it from recycle bin',\r\n      modulation: 'You can setup the effects modulation for {{name}} here. If you leave it empty, there will be no modulation at all'\r\n    },\r\n    new_instrument: 'New Instrument',\r\n    new_pattern: 'New Pattern',\r\n    new_song: 'New Song',\r\n    modulation: '{{name}} Modulation'\r\n  },\r\n  help: {\r\n    FLOW: 'MUSIC.JS FLOW',\r\n    RECIPES: 'RECIPES',\r\n    p1: 'In order to create a song, you need to craft it, and craft the materials.',\r\n    p2: 'Actually, there are three types of craftable resources: instruments, patterns and songs',\r\n    p3: 'While the right section shows the item being crafted. The left pannel shows the crafting materials',\r\n    p4: 'You can drop resources (instruments or patterns) into drop zones, when applicable',\r\n    p5: 'To use the resource on the item being crafted, you need to drag it to any of the dropzones',\r\n    p6: 'Following this principle, you can use instruments to compose patterns, and finally, patterns to compose songs',\r\n    p7: 'Furthermore, you can compose your custom instruments, from a range of effects:',\r\n    p8: 'Don\\'t worry, if you don\\'t get it at first, there are recipes and contextual help at your disposal',\r\n    recipes: {\r\n      p1: 'Recipes are interactive mini-tutorials on how to craft anything here (example: a song)',\r\n      p2: 'Some tutorials (such as \\'intro\\') only explain a few things about the main interface',\r\n      p3: 'It\\'s recommended to follow these recipes if you don\\'t know what to do or how to start using the app. The recipes are reachable from the help menu (?)'\r\n    },\r\n    CONTEXTUAL_HELP: \"CONTEXTUAL HELP\",\r\n    contextual_help: {\r\n      p1: 'There is a series of tooltips explaining on detail the different features of the app. You can enable or disable these tooltips by clicking on the box in the left-bottom corner of the screen'\r\n    }\r\n  },\r\n  stack: {\r\n    drop_elements_here: \"drop new elements here\",\r\n    tooltip: {\r\n      you_can_drop_new_effects_here: 'You can drop new effects from the object index here',\r\n      remove: 'Removes the effect element from the pipeline',\r\n      up: 'Changes the order of the element, to execute it AFTER',\r\n      down: 'Changes the order of the element, to execute it BEFORE',\r\n      expand: 'Expand/Shrink the display of advanced options for the element'\r\n    }\r\n  },\r\n  editor: {\r\n    keyboard_instructions: 'Use ZXCVBNM keys to play instrument, or hover mouse on virtual keyboard',\r\n    tooltip: {\r\n      test_instrument_here: 'Test the instrument here, using mouse or keyboard',\r\n      type_here_instrument: 'Type here the name of the instrument'\r\n    }\r\n  },\r\n  pattern: {\r\n    track_muted: 'Muted',\r\n    track_solo: 'Solo',\r\n    measure_beats: 'Measure beats',\r\n    amount_beats: 'Amount of beats per measure',\r\n    measure_count: 'Measure count',\r\n    zoom_level: 'Zoom level',\r\n    total_measures: 'Total count of measures on pattern',\r\n    tracks: 'Tracks',\r\n    drop_instrument: 'drop instrument here',\r\n    tooltip: {\r\n      change_name: 'Change the pattern name',\r\n      zoom_level: 'Zoom level for all tracks',\r\n      play: 'Click to play the pattern',\r\n      stop: 'Click to stop playing',\r\n      remove_track: 'Click to remove track',\r\n      compact_view_p1: 'Track compact view: see the notes without having to expand the track.',\r\n      compact_view_p2: 'Click here to expand the track',\r\n      drop_zone: 'Instrument drop zone, drop instruments from the left panel to use it on the track',\r\n      editor_notes_p1: 'Note area, add the notes here:',\r\n      editor_notes_p2: 'Click to add a new one, and drag to change value/time',\r\n      editor_notes_p3: 'CTRL+Z to undo changes',\r\n      editor_notes_p4: 'CTRL+Y to redo changes',\r\n      add_track: 'Click this button to add new empty tracks',\r\n      note_event_p1: 'Note event. Drag from the right edge to change the duration or press delete key to remove',\r\n      note_event_p2: 'Drag to change the value and/or starting time',\r\n      note_event_p3: 'Note event. Click to select and edit it',\r\n      muted: 'Disable the track in order to silence it',\r\n      solo: 'Isolate the track so that it is the only one that plays. Can be more than one',\r\n      instrument_edit: \"Click this button to edit the instrument\"\r\n    }\r\n  },\r\n  song: {\r\n    drop_pattern: \"Drop pattern here\",\r\n    tooltip: {\r\n      measure_beats: \"Amount of beats per measure. Make sure this value match the measure length of the patterns\",\r\n      play: \"Click to play/pause the song\",\r\n      stop: \"Click to stop playing the song\",\r\n      download: \"Click to record the song and download the audio file\",\r\n      drop_pattern: \"Drop zone for patterns, drop here a pattern from the panel on the left\",\r\n      remove_block: \"Click here to remove the pattern and leave the block empty\",\r\n      edit_block: \"Click here to edit the pattern used by this block\"\r\n    }\r\n  },\r\n  BUTTON_LANG_EN: 'English',\r\n  BUTTON_LANG_ES: 'Spanish'\r\n\r\n};\r\n\r\nmusicShowCaseApp.constant(\"enTranslations\", enTranslations);\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\nvar esTranslations = {\r\n  midi: {\r\n    settings: 'Opciones de MIDI',\r\n    inputs: 'Entradas',\r\n    connected: 'Entrada MIDI Conectada',\r\n    disconnected: 'Entrada MIDI Desconectada (Click para configurar)',\r\n    events: 'Eventos',\r\n    octave: 'Octava Base',\r\n    transpose: 'Transposicion'\r\n  },\r\n  open_project: {\r\n    p1: 'Selecciona el proyecto que quieras abrir',\r\n    title: 'Abrir Proyecto'\r\n  },\r\n  array_editor: {\r\n    tooltip: {\r\n      remove_item: 'Elimina el objeto de la coleccion',\r\n      add_item: 'Click para agregar un nuevo objeto a la coleccion',\r\n      edit_item: 'Click para editar este objeto'\r\n    }\r\n  },\r\n  index: {\r\n    not_implemented: 'Disculpa, funcionalidad no implementada',\r\n    filter: 'Tipea aqui las palabras clave para filtrar los objetos',\r\n    tooltip: {\r\n      type: {\r\n        instrument: 'Este es un recurso del tipo instrumento',\r\n        pattern: 'Este es un recurso del tipo patron',\r\n        song: 'Este es un recurso del tipo cancion',\r\n        fx: 'Este es un recurso del tipo fx (efecto)'\r\n      },\r\n      type_p1: 'Para usar este recurso, arrastralo desde aqui hasta tu creacion',\r\n      type_p2: 'Para, en lugar de eso, editarlo, haz doble click en el',\r\n      index: 'Este es el indice de objetos, puedes encontrar tus materiales y productos listados aqui'\r\n    }\r\n  },\r\n  project: {\r\n    basic_info: 'Propiedades del proyecto',\r\n    references: 'Referencias',\r\n    settings: 'Configuracion del Proyecto',\r\n    'new': 'Nuevo Proyecto'\r\n  },\r\n  menu: {\r\n    'new': 'Archivo',\r\n    new_instrument: 'Nuevo Instrumento',\r\n    new_pattern: 'Nuevo Patron',\r\n    new_song: 'Nueva Cancion',\r\n    new_project: 'Nuevo Proyecto...',\r\n    open_project: 'Abrir Proyecto...',\r\n    file_import: 'Importar...',\r\n    tools: 'Herramientas',\r\n    tools_preferences: 'Preferencias',\r\n    help_view_help: 'Ver Pagina de Ayuda',\r\n    help_recipes: 'Recetas',\r\n    help_recipes_intro: 'Recorrido Introductorio',\r\n    help_recipes_howto_create_song: 'Como crear una cancion',\r\n    help_recipes_howto_create_instrument: 'Como crear un instrumento (cuadrada + eco a dos voces)',\r\n    help_contextual_help: 'Ayuda Contextual',\r\n    help_welcome: '¡Bienvenido!',\r\n    help_about: 'Acerca de Music.js',\r\n    recycle_bin: 'Papelera de Reciclaje...',\r\n    tooltip: {\r\n      'new': 'Puedes crear nuevos items en blanco desde esta opcion',\r\n      preferences: 'Puedes editar tus preferencias aqui',\r\n      help: 'Menu para acceder a las opciones de ayuda y *Acerca De*'\r\n    },\r\n    project: 'Proyecto',\r\n    project_settings: 'Configuracion...',\r\n    project_remove_project: 'Eliminar Proyecto',\r\n    project_export_project: 'Exportar Proyecto'\r\n  },\r\n  contextual_help: {\r\n    enable: 'Activar Ayuda Contextual',\r\n    disable: 'Desactivar Ayuda Contextual'\r\n  },\r\n  recycle: {\r\n    p1: 'Esta es la papelera de reciclaje, desde aqui puedes restaurar los elementos que han sido eliminados',\r\n    p2: 'Recuerda que los elementos en la papelera se eliminaran permanentemente cuando se agote el espacio disponible',\r\n    p3: '* Haz doble-click en el elemento que quieras RESTAURAR',\r\n    title: 'Papelera de Reciclaje',\r\n    compact_title: 'Papelera de R.',\r\n    compact_hint_restore: '* Haz doble-click en el elemento que quieras RESTAURAR',\r\n    compact_hint_open: '* Haz click aqui para abrir la papelera de reciclaje',\r\n    EMPTY: 'Vacia'\r\n  },\r\n  welcome: {\r\n    title: 'Bienvenido a Music.js: Edicion de 8bit',\r\n    p1: 'Music.js es una aplicacion web que permite componer musica con el poder de javascript (opcional)',\r\n    p2: 'La primera version esta totalmente orientada a la musica retro/8bit mediante osciladores elementales, generadores de ruido y patrones de modulacion',\r\n    p3: '¿Quieres realizar un recorrido basico?',\r\n    nevershow: 'Nunca mostrar este mensaje de nuevo'\r\n  },\r\n  about: {\r\n    title: 'Acerca de Music.js: Edicion de 8bit',\r\n    p3: 'A largo plazo, el objetivo de music.js es cubrir todas las capas necesarias entre el API de Web Audio provista pòr los navegadores y una solucion completa de composicion musical similar a las mas conocidas como por ej FL Studio',\r\n    authors: 'AUTORES',\r\n    i_am: 'Yo soy Dario Seminara, pero tambien tengo que dar credito a autores de varias librerias que son clave:',\r\n    credit: {\r\n      mohayonao: '@mohayonao (Autor de Timbre.js)',\r\n      higuma: '@higuma (Autor de WebAudioRecorder)',\r\n      kristopolous: '@kristopolous (Autor de la plantilla de bootstrap BOOTSTRA.386)'\r\n    },\r\n    contribute: 'COMO CONTRIBUIR',\r\n    contact_me: 'Contactame a travez de github'\r\n  },\r\n  common: {\r\n    yes: 'Si',\r\n    no: 'No',\r\n    ok: 'Aceptar',\r\n    dismiss: 'Cerrar',\r\n    cancel: 'Cancelar',\r\n    create: 'Crear',\r\n    open: 'Abrir',\r\n    name: 'Nombre',\r\n    loader_error: 'Error al intentar cargar el archivo',\r\n    cantremove_error: 'No se puede eliminar el archivo si esta siendo utilizado',\r\n    cantremove_project_error: 'No se puede eliminar el proyecto si esta siendo usado desde otro proyecto',\r\n    error_title: 'Error',\r\n    language: 'Idioma:',\r\n    HELP: 'AYUDA',\r\n    more: 'mas',\r\n    remove: 'Elimi.',\r\n    'export': 'Exportar',\r\n    reset: 'Fabr.',\r\n    play: 'Reprod.',\r\n    pause: 'Pausar',\r\n    stop: 'Detener',\r\n    record: 'Rec.',\r\n    bpm: 'Ppm',\r\n    bpm_lc: 'ppm',\r\n    add: 'Agreg.',\r\n    tooltip: {\r\n      playing_speed: 'Velocidad de reproduccion, cantidad de pulsos por minuto',\r\n      remove_item: 'Elimina el elemento, puedes restaurarlo desde la papelera de reciclaje',\r\n      modulation: 'Puedes configurar los efectos de modulacion aqui. Si lo dejas vacio, no habra modulacion'\r\n    },\r\n    new_instrument: 'Nuevo Instrumento',\r\n    new_pattern: 'Nuevo Patron',\r\n    new_song: 'Nueva Cancion',\r\n    modulation: 'Modulacion de {{name}}'\r\n  },\r\n  help: {\r\n    FLOW: 'FLUJO DE MUSIC.JS',\r\n    RECIPES: 'RECETAS',\r\n    p1: 'Para crear una cancion, tienes que ensamblarla, asi como sus componentes',\r\n    p2: 'Hay tres tipos de recursos que se pueden crear: instrumentos, patrones y canciones',\r\n    p3: 'Mientras que la seccion de la derecha muestra el elemento que se esta creando, la seccion de la izquierda muestra los materiales que se pueden usar',\r\n    p4: 'Puedes arrastrar y soltar esos materiales en las zonas indicadas',\r\n    p5: 'Para usar algun recurso en algun elemento que estes creando, lo tienes que arrastrar a esas zonas',\r\n    p6: 'Siguiendo este principio, puedes usar instrumentos para componer patrones, y finalmente, los patrones para componer las canciones',\r\n    p7: 'Ademas, puedes crear tus propios instrumentos, combinando varios efectos:',\r\n    p8: 'No te preocupes si no lo entiendes ahora mismo, hay recetas y ayuda contextual que podras usar para familiarizarte con estos conceptos',\r\n    recipes: {\r\n      p1: 'Las recetas, son mini-tutoriales interactivos que explican como crear algo (por ejemplo, una cancion)',\r\n      p2: 'Algunos tutoriales (Como por ejemplo \\'Recorrido Introductorio\\') solo explican algunas cosas de la interfaz principal',\r\n      p3: 'Te recomiendo que sigas estas recetas si no sabes que hacer o como empezar a usar la aplicacion. Puedes acceder a las recetas desde el menu de ayuda (?)'\r\n    },\r\n    CONTEXTUAL_HELP: \"AYUDA CONTEXTUAL\",\r\n    contextual_help: {\r\n      p1: 'Hay una serie de tooltips que explican detalladamente las distintas funcionalidades de la aplicacion. Puedes activar o desactivar estas ayudas clickeando en el recuadro que aparece en la esquina inferior izquierda de la pantalla'\r\n    }\r\n  },\r\n  editor: {\r\n    keyboard_instructions: 'Usa las teclas ZXCVBNM para tocar el instrumento, o pasa el puntero del mouse sobre el teclado virtual',\r\n    tooltip: {\r\n      test_instrument_here: 'Prueba el instrumento aqui, usando el teclado o el mouse',\r\n      type_here_instrument: 'Escribe aqui el nombre para el instrumento'\r\n    }\r\n  },\r\n  pattern: {\r\n    track_muted: 'Apagado',\r\n    track_solo: 'Solo',\r\n    measure_beats: 'Pulsos/compas',\r\n    measure_count: 'Cant. de compases',\r\n    zoom_level: 'Nivel de zoom',\r\n    tracks: 'Pistas',\r\n    drop_instrument: 'Suelta el instrumento aqui',\r\n    tooltip: {\r\n      amount_beats: 'Cantidad de pulsos por compas',\r\n      total_measures: 'Cantidad total de compases en el patron',\r\n      change_name: 'Cambia el nombre del patron',\r\n      zoom_level: 'Nivel de zoom para todas las pistas',\r\n      play: 'Click para reproducir el patron',\r\n      stop: 'Click para detener la reproduccion',\r\n      remove_track: 'Click para eliminar la pista',\r\n      compact_view_p1: 'Vista compacta de la pista: muestra las notas sin necesidad de expandir la pista.',\r\n      compact_view_p2: 'Clickea aqui para expandir la pista',\r\n      drop_zone: 'Area para soltar el instrumento, arrastra aqui instrumentos del panel izquierdo para usarlos en la pista',\r\n      editor_notes_p1: 'Area de notas, puedes agregar las notas aqui:',\r\n      editor_notes_p2: 'Clickea para agregar una nueva nota, y arrastralas para cambiar su valor y su tiempo de inicio en la secuencia',\r\n      editor_notes_p3: 'CTRL+Z para deshacer cambios',\r\n      editor_notes_p4: 'CTRL+Y para rehacer cambios',\r\n      add_track: 'Clickea este boton para agregar una nueva pista vacia',\r\n\r\n      note_event_p1: 'Evento de nota. Arrastra desde el borde derecho para cambiar su duracion, o presiona la tecla SUPR. para eliminarlo',\r\n      note_event_p2: 'Arrastra para cambiar el valor o el tiempo de comienzo en la secuencia',\r\n      note_event_p3: 'Evento de nota. Clickea para seleccionarlo y editarlo',\r\n      muted: 'Desactiva la pista haciendo que no se reproduzca',\r\n      solo: 'Aisla la pista de manera que sea la unica que se reproduzca. Pueden aislarse varias',\r\n      instrument_edit: 'Clickea este boton para editar el instrumento'\r\n    }\r\n  },\r\n  song: {\r\n    drop_pattern: \"Suelta el patron aqui\",\r\n    tooltip: {\r\n      measure_beats: \"Pulsos/Compas. Tiene que coincidir con el de los patrones que se usan\",\r\n      play: \"Click para reproducir/pausar la cancion\",\r\n      stop: \"Click para detener la reproduccion\",\r\n      download: \"Click para grabar la cancion a un archivo de audio y descargarlo\",\r\n      drop_pattern: \"Area para soltar los patrones, arrastra aqui patrones desde el panel izquierdo\",\r\n      remove_block: \"Click aqui para eliminar el patron y dejar el bloque vacio\",\r\n      edit_block: \"Click aqui para saltar a la edicion del patron utilizado en este bloque\"\r\n    }\r\n  },\r\n  stack: {\r\n    drop_elements_here: \"suelta nuevos elementos aqui\",\r\n    tooltip: {\r\n      you_can_drop_new_effects_here: 'Puedes soltar nuevos efectos del indice aqui',\r\n      remove: 'Elimina el efecto de la secuencia',\r\n      up: 'Cambia el orden del elemento, para que se ejecute DESPUES',\r\n      down: 'Cambia el orden del elemento, para que se ejecute ANTES',\r\n      expand: 'Expande/Comprime la vista avanzada del elemento'\r\n    }\r\n  },\r\n  BUTTON_LANG_EN: 'Ingles',\r\n  BUTTON_LANG_ES: 'Español'\r\n};\r\n\r\nmusicShowCaseApp.constant(\"esTranslations\", esTranslations);\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\n\r\nmusicShowCaseApp.config(['$translateProvider', function ($translateProvider) {\r\n  var getBrowserLanguage = function() {\r\n    if (!$translateProvider.resolveClientLocale()) return 'en'\r\n    var langCode = $translateProvider.resolveClientLocale().split(\"-\")[0];\r\n    if (!langCode) return 'en';\r\n    return $translateProvider.translations()[langCode] ? langCode : 'en';\r\n  };\r\n\r\n  $translateProvider\r\n    .preferredLanguage(getBrowserLanguage());\r\n\r\n  $translateProvider\r\n    .fallbackLanguage('en');\r\n\r\n  $translateProvider.useSanitizeValueStrategy(null);\r\n  $translateProvider.useLoader('translationsLoader');\r\n\r\n}]);\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\n\r\nmusicShowCaseApp.config([\"$routeProvider\", \"$locationProvider\", function($routeProvider, $locationProvider) {\r\n  $routeProvider\r\n    .when('/editor/:project/instrument/:id', {\r\n      templateUrl: 'site/templates/editor.html',\r\n      controller: 'EditorController'\r\n    })\r\n    .when('/editor/:project/song/:id', {\r\n      templateUrl: 'site/templates/songEditor.html',\r\n      controller: 'SongEditorController'\r\n    })\r\n    .when('/editor/:project/pattern/:id', {\r\n      templateUrl: 'site/templates/patternEditor.html',\r\n      controller: 'PatternEditorController'\r\n    })\r\n    .when('/editor/:project', {\r\n      templateUrl: 'site/templates/dashboard.html',\r\n      controller: 'ProjectDashboardController'\r\n    })\r\n    .when('/', {\r\n      templateUrl: 'site/templates/dashboard.html',\r\n      controller: 'DashboardController'\r\n    });\r\n\r\n  // configure html5 to get links working on jsfiddle\r\n  //$locationProvider.html5Mode(true);\r\n}]);;\r\n\r\n\r\n\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\n\r\nmusicShowCaseApp.directive(\"musicObjectEditor\", [\"$timeout\", \"$http\", \"TypeService\", \"Recipe\", \"MusicObjectFactory\", function($timeout, $http, TypeService, Recipe, MusicObjectFactory) {\r\n  return {\r\n    scope: {\r\n      file: \"=file\"\r\n    },\r\n    templateUrl: \"site/templates/objectEditor.html\",\r\n    link: function(scope, element, attrs) {\r\n      var file;\r\n      var types = TypeService.getTypes();\r\n\r\n      scope.output = {};\r\n\r\n      scope.parameters = [];\r\n      scope.recipe = Recipe.start;\r\n      scope.termschanged = function() {\r\n        scope.$broadcast('termschanged');\r\n      };\r\n\r\n      scope.f_t = function(str, state) {\r\n        try {\r\n          var ret = eval(\"(function(t) { return \" + str + \"; })\");\r\n          delete state.error;\r\n\r\n          return ret;\r\n        } catch(e) {\r\n          state.error = e.toString();\r\n          throw e;\r\n        }\r\n      };\r\n\r\n      scope.oscTermsUpdateFromWaveForm = fn.debounce(function(waveform, terms, resolution) {\r\n\r\n        try {\r\n          var waveform = eval(\"(function(t) { return \" + waveform + \"; })\");\r\n          var count = resolution;\r\n          var values = new Array(count);\r\n          for (var i = 0; i < count; i++) {\r\n            values[i] = waveform(i/count);\r\n            if (isNaN(values[i])) throw \"Not a number: \" + values[i];\r\n          }\r\n\r\n          var ft = new DFT(values.length);\r\n          ft.forward(values);\r\n\r\n          for (var i=0;i<count;i++) {\r\n            terms.cos[i] = ft.real[i];\r\n            terms.sin[i] = ft.imag[i];\r\n          }\r\n          terms.cos.length = ft.real.length/2;\r\n          terms.sin.length = ft.imag.length/2;\r\n\r\n          var f = function(t){\r\n            var ret = 0;\r\n            for (var i=1;i<count/2;i++) {\r\n              var a = terms.sin[i];\r\n              var b = terms.cos[i];\r\n\r\n              ret = ret + a * Math.sin(t*2*Math.PI*i);\r\n              ret = ret + b * Math.cos(t*2*Math.PI*i);\r\n            }\r\n            return ret;\r\n          };\r\n\r\n          var maxvalue = 0;\r\n          var count = terms.sin.length;\r\n          for (var i=0; i<count; i++) {\r\n            var value = f(i/count);\r\n            if (value>maxvalue) {\r\n              maxvalue=value;\r\n            } else if (value<-maxvalue) {\r\n              maxvalue=-value;\r\n            }\r\n          }\r\n\r\n          for (var i=0;i<count;i++) {\r\n            terms.sin[i] = terms.sin[i] / maxvalue;\r\n            terms.cos[i] = terms.cos[i] / maxvalue;\r\n          }\r\n\r\n          $timeout(function() {\r\n            scope.invalidWaveform = false;\r\n          });\r\n          scope.$broadcast('termschanged');\r\n        } catch (err) {\r\n          $timeout(function() {\r\n            scope.invalidWaveform = err.toString();\r\n          });\r\n        }\r\n\r\n      },400);\r\n\r\n      scope.oscTermsUpdate = fn.debounce(function(serie, terms, errVar) {\r\n\r\n        try {\r\n          var serie = eval(\"(function(n) { return \" + serie + \"; })\");\r\n          for (var n=1;n<512;n++) {\r\n            terms[n]=serie(n);\r\n            if (isNaN(terms[n])) throw \"Not a number: \" + terms[n];\r\n  \r\n          }\r\n          scope[errVar] = false;\r\n          $timeout(function() {\r\n            scope.$broadcast('termschanged');\r\n          });\r\n        } catch (err) {\r\n          $timeout(function() {\r\n            scope[errVar] = err.toString();\r\n          });\r\n        }\r\n      },400);\r\n\r\n      scope.range = function(init, end) {\r\n        var x = [];\r\n        for (var i=init;i<=end;i++) {\r\n          x.push(i);\r\n        }\r\n        return x;\r\n      };\r\n\r\n      var truthy = function(x ) { return x; };\r\n      var updateObject = function(newValue) {\r\n        $timeout(function() {\r\n          if (scope.file && scope.file.changed) scope.file.changed();\r\n        });\r\n      };\r\n\r\n      var outputObserver;\r\n      scope.$on(\"$destroy\", function() {\r\n        if (outputObserver) outputObserver.destroy();\r\n      });\r\n\r\n      var updateTemplate = function(file) {\r\n        if (!file) return;\r\n\r\n        if (outputObserver) outputObserver.destroy();\r\n        var outputObserver = MusicObjectFactory().observeOutput(file, function(output) {\r\n          $timeout(function() {\r\n            scope.output = output;\r\n          });\r\n        });\r\n\r\n        types.then(function() {\r\n          $timeout(function() {\r\n            scope.selectedType = file.type;\r\n\r\n            TypeService.getType(file.type, function(type) {\r\n              $timeout(function() {\r\n                scope.templateUrl = type.templateUrl;\r\n                scope.type = type;\r\n\r\n                for (var k in type._default) {\r\n                  if (typeof file.data[k] === \"undefined\") {\r\n                    file.data[k] =type._default[k];\r\n                  }\r\n                }\r\n\r\n                if (type.parameters) {\r\n                  scope.parameters = type.parameters.map(function(parameter) {\r\n                    return {\r\n                      name: parameter.name,\r\n                      data: parameter,\r\n                      value: file.data && typeof file.data[parameter.name] !== \"undefined\" ? file.data[parameter.name] : parameter.value\r\n                    };\r\n                  });\r\n                }\r\n                if (type.components) {\r\n                  scope.modulations = (type.components||[]).map(function(component) {\r\n                    return {\r\n                      name: component,\r\n                      value: (file.data && file.data.modulation && file.data.modulation[component])|| {\r\n                        type: \"stack\",\r\n                        data: {\r\n                          array: []\r\n                        }\r\n                      }\r\n                    };\r\n                  });\r\n                }\r\n\r\n                updateObject(file.data);\r\n              });\r\n            });\r\n          });\r\n        });\r\n      };\r\n      if (scope.file) updateTemplate(scope.file);\r\n\r\n      types.then(function(types) {\r\n        scope.types = types;\r\n      });\r\n      \r\n      var changeType = function(newValue) {\r\n        if (!newValue) return;\r\n        if (!scope.file) return;\r\n        scope.file.type = newValue;\r\n        updateTemplate(scope.file);\r\n      };\r\n\r\n      scope.$watch(\"modulations\", function(newValue) {\r\n        if (!scope.modulations) return;\r\n        scope.modulations.forEach(function(modulation) {\r\n          scope.file.data.modulation = scope.file.data.modulation||{};\r\n          scope.file.data.modulation[modulation.name] = modulation.value;\r\n        }); \r\n        scope.$emit(\"objectChanged\");\r\n      }, true);\r\n\r\n      scope.$watch(\"parameters\", function(newValue) {\r\n        if (!scope.parameters) return;\r\n        scope.parameters.forEach(function(parameter) {\r\n          scope.file.data[parameter.data.name] = parameter.value;\r\n        }); \r\n        scope.$emit(\"objectChanged\");\r\n      }, true);\r\n      scope.$watch(\"selectedType\", changeType)\r\n      scope.$watch(\"file\", updateTemplate);\r\n      //scope.$watch(\"file.data\", fn.debounce(function(newValue) { debugger; },800), true);\r\n    }\r\n  };\r\n}]);\r\n\r\nmusicShowCaseApp.directive(\"arrayEditor\", [\"$timeout\", \"Recipe\", function($timeout, Recipe) {\r\n  return {\r\n    scope: {\r\n      data: \"=data\"\r\n    },\r\n    templateUrl: \"site/templates/arrayEditor.html\",\r\n    link: function(scope, element, attrs) {\r\n      scope.data.subobjects=scope.data.subobjects||[];\r\n      scope.maxElements = attrs.maxelements ? parseInt(attrs.maxelements) : Infinity;\r\n      scope.currentTab = 0;\r\n      scope.recipe = Recipe.start;\r\n\r\n      var addObject = function(newObject) {\r\n        $timeout(function() {\r\n          scope.data.subobjects=scope.data.subobjects||[];\r\n          scope.data.subobjects.push(newObject);\r\n          scope.setCurrentTab(scope.data.subobjects.length-1);\r\n        });\r\n      };\r\n\r\n      scope.setCurrentTab = function(idx) {\r\n        scope.currentTab = idx;\r\n      };\r\n\r\n      scope.removeObject = function(object) {\r\n        scope.data.subobjects = scope.data.subobjects.filter(function(o) {return o !== object; });\r\n      };\r\n\r\n      scope.addObject = function() {\r\n        addObject({data: {array: []}, type: \"stack\"})\r\n      };\r\n\r\n      if (scope.data.subobjects.length === 0) {\r\n        scope.addObject();\r\n      }\r\n    }\r\n  };\r\n}]);\r\n\r\nmusicShowCaseApp.directive(\"musicStack\", [\"$timeout\", \"Recipe\", \"TypeService\", function($timeout, Recipe, TypeService) {\r\n  return {\r\n    scope: {\r\n      initFile: \"=initFile\",\r\n      dropzoneExtraName: \"=dropzoneExtraName\"\r\n    },\r\n    templateUrl: \"site/templates/stack.html\",\r\n    link: function(scope, element, attrs) {\r\n      scope.recipe = Recipe.start;\r\n\r\n      var swap = function(idx1, idx2) {\r\n        scope.$emit(\"stackChanged\");\r\n\r\n        $timeout(function() {\r\n          var tmp = scope.file.array[idx1];\r\n          scope.file.array[idx1] = scope.file.array[idx2];\r\n          scope.file.array[idx2] = tmp;\r\n        });\r\n      };\r\n\r\n      var defaultStackAppend = function(file, data) {\r\n        file.array = [{\r\n          type: data.name,\r\n          data: {}\r\n        }].concat(file.array);\r\n      };\r\n\r\n      scope.onDropComplete = function(data, event) {\r\n        if (data.type === \"fx\") {\r\n          TypeService.getType(data.name)\r\n            .then(function(type) {\r\n              (type.stackAppend ||defaultStackAppend)(scope.file, data);\r\n              scope.$emit(\"stackChanged\");\r\n            });\r\n        }\r\n      };\r\n\r\n      scope.up = function(idx) {\r\n        swap(idx-1, idx);\r\n      };\r\n\r\n      scope.down = function(idx) {\r\n        swap(idx+1, idx);\r\n      };\r\n\r\n      scope.remove = function(idx) {\r\n        scope.$emit(\"stackChanged\");\r\n\r\n        $timeout(function() {\r\n          var oldCollection = scope.file.array;\r\n          scope.file.array = [];\r\n          for (var i=0; i<oldCollection.length; i++) {\r\n            if (i!==idx) scope.file.array.push(oldCollection[i]);\r\n          }\r\n        });\r\n      };\r\n\r\n      scope.add = function() {\r\n        scope.$emit(\"stackChanged\");\r\n\r\n        $timeout(function() {\r\n          scope.file.array.push({data: {}, type: \"null\"});\r\n        });\r\n      };\r\n\r\n      scope.$watch(\"initFile\", function(newFile) {\r\n        if (newFile) {\r\n          scope.file = newFile.data;\r\n        }\r\n      });\r\n    }\r\n  };  \r\n\r\n}]);\r\n\r\nmusicShowCaseApp.directive(\"customOscGraph\", [\"$timeout\", function($timeout) {\r\n  return {\r\n    scope: {\r\n      terms: \"=terms\"\r\n    },\r\n    template: '<function-graph f=\"f\" samples=64 t0=\"0\" tf=\"1\" scaley=\"0.8\"></function-graph>',\r\n    link: function(scope, element, attrs) {\r\n      var termsChanged = function() {\r\n        scope.f = function(t){\r\n          var ret = 0;\r\n          for (var i=1;i<scope.terms.sin.length;i++) {\r\n            var a = scope.terms.sin[i];\r\n            var b = scope.terms.cos[i];\r\n\r\n            ret = ret + a * Math.sin(t*2*Math.PI*i);\r\n            ret = ret + b * Math.cos(t*2*Math.PI*i);\r\n          }\r\n          return ret;\r\n        };\r\n      };\r\n\r\n      scope.f = function() { return 0; };\r\n      scope.$on(\"termschanged\", fn.debounce(termsChanged,10));\r\n\r\n      termsChanged();\r\n    }\r\n  };\r\n}]);\r\n\r\nmusicShowCaseApp.directive(\"showScale\", [\"$timeout\", function($timeout) {\r\n  return {\r\n    scope: {\r\n      scale: \"=scale\"\r\n    },\r\n    template: '<div class=\"note-cell\" ng-repeat=\"note in notes\">{{note}}</div><div class=\"note-cell\" ng-repeat=\"note in notes\">{{note}}</div>',\r\n    link: function(scope, element, attrs) {\r\n      var semitoneToNote = function(n) {\r\n        return [0,[0,1], 1, [1,2], 2, 3, [3,4], 4, [4,5], 5, [5,6], 6][n%12];\r\n      };\r\n\r\n      var noteToSemitone = function(n) {\r\n        return [0,2,4,5,7,9,11][n%7];\r\n      };\r\n\r\n      var notation7 = function(n) {\r\n        return [\"C\",\"D\",\"E\",\"F\",\"G\",\"A\",\"B\"][n % 7];\r\n      };\r\n\r\n      scope.$watch(\"scale\", function(newVal) {\r\n        $timeout(function() {\r\n          var scale = MUSIC.Utils.Scale(newVal);\r\n          var deltas = [0,1,2,3,4,5,6];\r\n\r\n          var initTone = semitoneToNote(newVal);\r\n          if (initTone.length) initTone = initTone[1];\r\n\r\n          scope.notes = deltas.map(function(d) {\r\n            var semitone = scale.add(newVal,d);\r\n            var tone = (initTone + d) % 7;\r\n            var alt = \"\";\r\n\r\n            if (noteToSemitone(tone) > semitone % 12) alt = \"b\";\r\n            if (noteToSemitone(tone) < semitone % 12) alt = \"#\";\r\n            return notation7(tone) + alt;\r\n          });\r\n        });\r\n      });\r\n    }\r\n  };\r\n}]);\r\n\r\nmusicShowCaseApp.directive(\"ngScrollTop\", [\"$parse\", \"$timeout\", function($parse, $timeout) {\r\n  return {\r\n    restrict: 'A',\r\n    link: function(scope, element, attrs) {\r\n      var scrollVarGetter = $parse(attrs.ngScrollTop);\r\n      var scrollVarSetter = scrollVarGetter.assign;\r\n\r\n      scope.$watch(attrs.ngScrollTop, function() {\r\n        $(element).scrollTop(scrollVarGetter(scope));\r\n      });\r\n\r\n      element.on('scroll', function() {\r\n        $timeout(function() {\r\n          scrollVarSetter(scope, $(element).scrollTop());\r\n        });\r\n      });\r\n    }\r\n  };\r\n}]);\r\n\r\nmusicShowCaseApp.directive(\"ngScrollLeft\", [\"$parse\", \"$timeout\", function($parse, $timeout) {\r\n  return {\r\n    restrict: 'A',\r\n    link: function(scope, element, attrs) {\r\n      var scrollVarGetter = $parse(attrs.ngScrollLeft);\r\n      var scrollVarSetter = scrollVarGetter.assign;\r\n\r\n      scope.$watch(attrs.ngScrollLeft, function() {\r\n        $(element).scrollLeft(scrollVarGetter(scope));\r\n      });\r\n\r\n      element.on('scroll', function() {\r\n        $timeout(function() {\r\n          scrollVarSetter(scope, $(element).scrollLeft());\r\n        });\r\n      });\r\n    }\r\n  };\r\n}]);\r\n\r\n","musicShowCaseApp.directive(\"functionGraph\", [\"$timeout\", \"$parse\", function($timeout, $parse) {\r\n  return {\r\n    scope: {},\r\n    replace: true,\r\n    template: '<canvas class=\"wavegraph\"></canvas>',\r\n    link: function(scope, element, attrs) {\r\n      var f;\r\n      var t0 = parseFloat(attrs.t0);\r\n      var tf = parseFloat(attrs.tf);\r\n      var samples = parseInt(attrs.samples);\r\n      var scaley = parseFloat(attrs.scaley);\r\n\r\n      scope.$parent.$watch(attrs.f, function(_f) {\r\n        f = _f;\r\n        if (f) redraw();\r\n      });\r\n\r\n      var redraw = function() {\r\n        var canvas = element[0];\r\n        var context = canvas.getContext('2d');\r\n\r\n        canvas.width = canvas.clientWidth/4;\r\n        canvas.height = canvas.clientHeight/4;\r\n\r\n        var drawLine = function(x0, y0, x1, y1, color) {\r\n          context.save();\r\n          context.beginPath();\r\n          context.moveTo(x0, y0);\r\n          context.lineTo(x1, y1);\r\n          context.strokeStyle = color;\r\n          context.lineWidth = 1;\r\n          context.stroke();\r\n          context.restore(); \r\n        };\r\n\r\n        var drawFunc = function(color) {\r\n          context.save();\r\n          context.save();\r\n          context.translate(0,canvas.height/2);\r\n          context.scale(canvas.width,canvas.height/2);\r\n\r\n          context.moveTo(0, -f(t0)*scaley);\r\n          for (var i=1; i<=samples; i++) {\r\n            var x = i/samples;\r\n            var t = (tf-t0) * x + t0;\r\n            context.lineTo(x, -f(t)*scaley);\r\n          }\r\n          context.restore();\r\n          context.lineJoin = 'round';\r\n          context.lineWidth = 1;\r\n          context.strokeStyle = color;\r\n          context.stroke();\r\n          context.restore();\r\n        };\r\n\r\n        drawLine(0, canvas.height/2, canvas.width, canvas.height/2, 'aqua');\r\n        drawFunc(\"#FFF\");\r\n      };\r\n    }\r\n  };\r\n}]);\r\n\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\nmusicShowCaseApp.directive(\"keyboard\", [\"$timeout\", \"$uibModal\", \"Midi\", \"MusicContext\", function($timeout, $uibModal, Midi, MusicContext) {\r\n  return {\r\n    scope: {\r\n      instrument: '=instrument'\r\n    },\r\n    templateUrl: \"site/templates/keyboard.html\",\r\n    link: function(scope, element, attrs) {\r\n      var inputs;\r\n      var onMIDIMessage = function(event) {\r\n        var command = event.data[0];\r\n        var value = event.data[1];\r\n        var velocity = event.data[2];\r\n\r\n        var octaveNumber = Math.floor(value/12);\r\n        if (octaveNumber < 0) return;\r\n\r\n        var oct = scope.octaves[octaveNumber];\r\n        if (!oct) return;\r\n\r\n        if (command === 144) {\r\n          oct.midi[value % 12] = true;\r\n          oct.update();\r\n        } else if (command === 128) {\r\n          oct.midi[value % 12] = false;\r\n          oct.update();\r\n        }\r\n      };\r\n      var listener = Midi.registerEventListener(onMIDIMessage);\r\n      var updateMidiStatus = function() {\r\n        Midi.getStatus()\r\n          .then(function(data) {\r\n            $timeout(function() {\r\n              scope.midiConnected = data.connected;\r\n            });\r\n          });\r\n      };\r\n\r\n      updateMidiStatus();\r\n\r\n      scope.$on(\"$destroy\", function() {\r\n        listener.destroy();\r\n      });\r\n\r\n      var keyCodeToNote = {\r\n              90: 'C', 83: 'C#', 88: 'D',  68: 'D#', 67: 'E',\r\n              86: 'F', 71: 'F#', 66: 'G', 72: 'G#', 78: 'A', \r\n              74: 'A#', 77: 'B'};\r\n\r\n      var stopAll = function(x) {\r\n        return x.stopAll();\r\n      };\r\n\r\n      var update = function(octave) {\r\n        return octave.update();\r\n      };\r\n\r\n      scope.midiSetup = function() {\r\n        var modalIns = $uibModal.open({\r\n          templateUrl: \"site/templates/modal/midiSettings.html\",\r\n          controller: \"midiSettingsModalCtrl\"\r\n        }).result.then(updateMidiStatus);\r\n      };\r\n\r\n      scope.stopAll = function() {\r\n        scope.octaves.forEach(stopAll);\r\n      };\r\n\r\n      var octave = function(base) {\r\n        return {\r\n          mouse: {},\r\n          key: {},\r\n          midi: {},\r\n          note: [],\r\n          play: function(idx) {\r\n            if (this.note[idx]) return;\r\n\r\n            this.note[idx] = scope.instrument.note(base+idx).play();\r\n          },\r\n          stop: function(idx) {\r\n            if (!this.note[idx])return;\r\n            this.note[idx].stop();\r\n            this.note[idx] = undefined;\r\n          },\r\n          update: function() {\r\n            for (var idx=0; idx<12; idx++) {\r\n              if (this.mouse[idx] || this.key[idx] || this.midi[idx]) {\r\n                this.play(idx);\r\n              } else {\r\n                this.stop(idx);\r\n              }\r\n            }\r\n\r\n            $timeout(function(){});\r\n          },\r\n          stopAll: function() {\r\n            this.note.forEach(function(note) {\r\n              if(note && note.stop) note.stop();\r\n            });\r\n            this.note = [];\r\n          }\r\n        };\r\n      };\r\n\r\n      var gesture = function() {\r\n        MusicContext.resumeAudio();\r\n      };\r\n\r\n      var mouseOff = function(octave) {\r\n        gesture();\r\n\r\n        octave.mouse = {};\r\n        octave.update();\r\n      };\r\n\r\n      scope.mouseLeave = function(octave, idx) {\r\n        gesture();\r\n\r\n        octave.mouse[idx] = false;\r\n        octave.update();\r\n      };\r\n\r\n      scope.mouseEnter = function(octave, idx) {\r\n        gesture();\r\n\r\n        scope.octaves.forEach(mouseOff);\r\n        octave.mouse[idx] = true;\r\n\r\n        scope.octaves.forEach(update);\r\n      };\r\n\r\n      var keyDownHandler = function(e) {\r\n        gesture();\r\n\r\n        if (document.activeElement.tagName.toLowerCase() === \"input\") return;\r\n\r\n        var keyCode = e.keyCode;\r\n        var noteName = keyCodeToNote[keyCode];\r\n        if (!noteName) return;\r\n\r\n        var idx = MUSIC.noteToNoteNum(noteName);\r\n        scope.octaves[1].key[idx] = true;\r\n        scope.octaves[1].update();\r\n\r\n        scope.$digest();\r\n      }\r\n\r\n      var keyUpHandler = function(e) {\r\n        gesture();\r\n\r\n        var keyCode = e.keyCode;\r\n        var noteName = keyCodeToNote[keyCode];\r\n        if (!noteName) return;\r\n\r\n        var idx = MUSIC.noteToNoteNum(noteName);\r\n        scope.octaves[1].key[idx] = false;\r\n        scope.octaves[1].update();\r\n\r\n        scope.$digest();\r\n      }\r\n\r\n      $(document).bind(\"keydown\", keyDownHandler);\r\n      $(document).bind(\"keyup\", keyUpHandler);\r\n      \r\n      var pianoFirstRow = $(element).find(\".piano-firstrow .key\");\r\n      var pianoSecondRow = $(element).find(\".piano-secondrow .key\");\r\n      \r\n      pianoFirstRow.bind(\"click\", gesture);\r\n      pianoSecondRow.bind(\"click\", gesture);\r\n\r\n      scope.$on(\"$destroy\", function() {\r\n        $(document).unbind(\"keydown\", keyDownHandler);\r\n        $(document).unbind(\"keyup\", keyUpHandler);\r\n\r\n        pianoFirstRow.unbind(\"click\", gesture);\r\n        pianoSecondRow.unbind(\"click\", gesture);\r\n\r\n        scope.octaves.forEach(function(octave) {\r\n          octave.stopAll();\r\n        });\r\n      });\r\n\r\n      scope.octaves = [24,36,48,60,72].map(octave);\r\n      scope.$watch(\"instrument\", function(instrument) {\r\n        scope.instrument = instrument;\r\n      });\r\n    }\r\n  };\r\n\r\n}]);\r\n","musicShowCaseApp.directive(\"musicEventEditor\", [\"$timeout\", \"TICKS_PER_BEAT\", \"Pattern\", \"MusicContext\", function($timeout, TICKS_PER_BEAT, Pattern, MusicContext) {\r\n  return {\r\n    scope: {\r\n      /* Current pattern */\r\n      pattern: \"=pattern\",\r\n      /* Current track */\r\n      track: \"=track\",\r\n      /* Display params */\r\n      zoomLevel: \"=zoomLevel\",\r\n      beatWidth: \"=beatWidth\",\r\n      /* File params (common to all tracks) */\r\n      measure: \"=measure\",\r\n      measureCount: \"=measureCount\",\r\n      recipe: '=recipe'\r\n    },\r\n    templateUrl: \"site/templates/directives/musicEventEditor.html\",\r\n    link: function(scope, element, attrs) {\r\n      scope.TICKS_PER_BEAT = TICKS_PER_BEAT;\r\n      var defaultL = TICKS_PER_BEAT;\r\n\r\n      var clearShadow = function() {\r\n        scope.shadowEvt = null;\r\n      };\r\n\r\n      var defaultMouseLeave = clearShadow;\r\n\r\n      var defaultMouseMove = function(event) {\r\n        var clipDistance = TICKS_PER_BEAT / scope.zoomLevel;\r\n        if (!event.target.classList.contains(\"event-list\")) {\r\n          return;\r\n        }\r\n\r\n\r\n        scope.shadowEvt = scope.shadowEvt || {};\r\n        scope.shadowEvt.n = Math.floor(upperLimit() - event.offsetY / 20);\r\n        scope.shadowEvt.l = defaultL;\r\n\r\n        if (scope.shadowEvt.s) {\r\n          var exactPosition = Math.floor(event.offsetX / scope.beatWidth / scope.zoomLevel * TICKS_PER_BEAT);\r\n          exactPosition = Math.floor(exactPosition);\r\n          var clipS = Pattern.findClipS(scope.pattern, scope.track, {s: exactPosition, l: defaultL}, exactPosition);\r\n\r\n          if (Math.abs(exactPosition - clipS - clipDistance / 2) < clipDistance) {\r\n            scope.shadowEvt.s = clipS;\r\n\r\n            Pattern.cutEvent(scope.pattern, scope.track, scope.shadowEvt);\r\n            return;\r\n          }\r\n        }\r\n\r\n        scope.shadowEvt.s = Math.floor(Math.floor(event.offsetX / 2 / scope.beatWidth) * 2 / scope.zoomLevel * TICKS_PER_BEAT);\r\n        if (scope.shadowEvt.s < 0) scope.shadowEvt.s = 0;\r\n        Pattern.cutEvent(scope.pattern, scope.track, scope.shadowEvt);\r\n      };\r\n\r\n      var semitoneToNote = function(n) {\r\n        return [0,[0,1], 1, [1,2], 2, 3, [3,4], 4, [4,5], 5, [5,6], 6][n%12];\r\n      };\r\n\r\n      var noteToSemitone = function(n) {\r\n        return [0,2,4,5,7,9,11][n%7];\r\n      };\r\n\r\n      var notation7 = function(n) {\r\n        return [\"C\",\"D\",\"E\",\"F\",\"G\",\"A\",\"B\"][n % 7];\r\n      };\r\n\r\n      scope.raiseEventChanged = function(oldevt, evt, track) {\r\n        scope.$emit('eventChanged', {oldevt: oldevt,evt: evt, track: track})\r\n      };\r\n\r\n      scope.noteName = function(n) {\r\n        var note7 = semitoneToNote(n);\r\n        var octave = Math.floor(n/12);\r\n\r\n        if (Array.isArray(note7)) {\r\n          note7 = note7[0]\r\n          return notation7(note7) + '#' + octave;\r\n        } else {\r\n          return notation7(note7) + octave;\r\n        }\r\n      };\r\n\r\n      var updateGrid = function() {\r\n        scope.mainGridStyle = {\"background-size\": (scope.measure*scope.beatWidth*scope.zoomLevel) + \"px 240px\"};\r\n      };\r\n\r\n      scope.$watch(\"[measure, beatWidth, zoomLevel]\", updateGrid);\r\n      scope.$watch(\"track.scroll\", function() {\r\n        scope.$emit(\"trackChanged\", scope.track);        \r\n      });\r\n\r\n      $timeout(updateGrid);\r\n\r\n      var addNewEvent = function(newEvt) {\r\n        if (scope.track.events.find(function(evt) {\r\n          return newEvt.s === evt.s && newEvt.n === evt.n;\r\n        })) {\r\n          return;\r\n        }\r\n\r\n        newEvt = angular.copy(newEvt);\r\n\r\n        if (Pattern.collision(scope.track, newEvt)) return;\r\n\r\n        scope.$emit(\"patternSelectEvent\", newEvt);\r\n        scope.selected = newEvt;\r\n\r\n        scope.recipe.raise('pattern_note_added');\r\n        scope.track.events.push(newEvt);\r\n\r\n        scope.$emit(\"trackChanged\", scope.track);\r\n        scope.$emit(\"eventChanged\", {oldevt:{}, evt:newEvt, track: scope.track});\r\n\r\n        scope.mouseMove = moveEvent(newEvt, 0);\r\n        scope.mouseMoveEvent = moveEventFromEvent(newEvt, 0);\r\n\r\n        clearShadow();\r\n\r\n        scope.mouseLeave = function() {\r\n          defaultMouseLeave();\r\n          cancelMove();\r\n        };\r\n\r\n        scope.mouseUpResizeEvent = cancelMove;\r\n        scope.mouseUpEvent = cancelMove;\r\n        scope.mouseUp = cancelMove;\r\n      };\r\n\r\n      scope.mouseMoveResizeEvent = function() {\r\n        clearShadow();\r\n      };\r\n\r\n      scope.shadowMouseMove = function(event) {\r\n        var deltaS = Math.floor(event.offsetX / 2 / scope.beatWidth) * 2 / scope.zoomLevel * TICKS_PER_BEAT;\r\n        if (deltaS > 0) scope.shadowEvt.s = scope.shadowEvt.s + deltaS;\r\n\r\n        Pattern.cutEvent(scope.pattern, scope.track, scope.shadowEvt);\r\n      };\r\n\r\n      scope.addFromShadow = function(event) {\r\n        addNewEvent(scope.shadowEvt);\r\n      };\r\n\r\n      scope.mouseUp = function(event) {\r\n        scope.mouseMove = defaultMouseMove;\r\n      };\r\n\r\n      scope.mouseLeave = function() {\r\n        defaultMouseLeave();\r\n        scope.mouseMove = defaultMouseMove;\r\n      };\r\n\r\n      scope.mouseMove = defaultMouseMove;\r\n      scope.mouseMoveEvent = clearShadow;\r\n\r\n      var upperLimit = function() {\r\n        return scope.track.instrument === 'tempo' ? 1024 : 120;\r\n      };\r\n\r\n      var max = function(c1, c2) {\r\n        return c1 > c2 ? c1 : c2;\r\n      };\r\n\r\n      var preventCollision = function(evt, f) {\r\n        return function() {\r\n          var savedEvt = angular.copy(evt);\r\n          var ret = f.apply(null, arguments);\r\n\r\n          if (Pattern.collision(scope.track, evt)) {\r\n            evt.n = savedEvt.n;\r\n            evt.s = savedEvt.s;\r\n            evt.l = savedEvt.l;\r\n            return;\r\n          }\r\n\r\n          if (evt.n !== savedEvt.n || evt.l !== savedEvt.l || evt.s !== savedEvt.s) {\r\n            scope.$emit(\"trackChanged\", scope.track);\r\n            scope.$emit(\"eventChanged\", {oldevt: savedEvt, evt:evt, track: scope.track});\r\n          }\r\n        };\r\n      };\r\n\r\n      var moveEvent = function(evt, offsetX) {\r\n        return function(event) {\r\n          MusicContext.resumeAudio();\r\n\r\n          var clipDistance = TICKS_PER_BEAT / scope.zoomLevel;\r\n          var oldevt = {n:evt.n, s:evt.s, l:evt.l};\r\n\r\n          var exactPosition = Math.floor((event.offsetX - offsetX) / scope.beatWidth / scope.zoomLevel * TICKS_PER_BEAT);\r\n          exactPosition = Math.floor(exactPosition);\r\n          var clipS = Pattern.findClipS(scope.pattern, scope.track, evt, exactPosition);\r\n\r\n          if (!event.target.classList.contains(\"event-list\")) return;\r\n\r\n          if (Math.abs(exactPosition - clipS - clipDistance / 2) < clipDistance) {\r\n            evt.s = clipS;\r\n          } else {\r\n            evt.s = Math.floor((event.offsetX - offsetX) / 2 / scope.beatWidth) * 2 / scope.zoomLevel * TICKS_PER_BEAT;\r\n            evt.s = Math.floor(evt.s);\r\n          }\r\n\r\n          if (evt.s < 0) evt.s = 0;\r\n\r\n          var oldN = evt.n;\r\n          evt.n = Math.floor(upperLimit() - event.offsetY / 20);\r\n        };\r\n      };\r\n\r\n      var moveEventFromEvent = function(evt, offsetX) {\r\n        clearShadow();\r\n        return function(dragevt, event) {\r\n          MusicContext.resumeAudio();\r\n\r\n          var clipDistance = TICKS_PER_BEAT / scope.zoomLevel;\r\n          var oldevt = {n:evt.n, s:evt.s, l:evt.l};\r\n\r\n          var exactPosition = dragevt.s + Math.floor((event.offsetX - offsetX) / scope.beatWidth / scope.zoomLevel * TICKS_PER_BEAT);\r\n          exactPosition = Math.floor(exactPosition);\r\n          var clipS = Pattern.findClipS(scope.pattern, scope.track, evt, exactPosition);\r\n\r\n          if (Math.abs(exactPosition - clipS - clipDistance / 2) < clipDistance) {\r\n            evt.s = clipS;\r\n          } else {\r\n            evt.s = dragevt.s + Math.floor((event.offsetX - offsetX) / 2 / scope.beatWidth) * 2 / scope.zoomLevel * TICKS_PER_BEAT;\r\n            evt.s = Math.floor(evt.s);\r\n          }\r\n\r\n          evt.n = dragevt.n;\r\n          if (evt.s < 0) evt.s = 0;\r\n        };\r\n      };\r\n\r\n      var cancelMove = function() {\r\n        scope.mouseMoveEvent = clearShadow;\r\n        scope.mouseMove = defaultMouseMove;\r\n        scope.mouseLeave = defaultMouseLeave;\r\n      };\r\n\r\n      scope.mouseDown = function(event) {\r\n        MusicContext.resumeAudio();\r\n\r\n        if (!event.target.classList.contains(\"event-list\")) return;\r\n        var newEvt = {\r\n          n: Math.floor(upperLimit() - event.offsetY / 20),\r\n          s: Math.floor(event.offsetX / scope.beatWidth) / scope.zoomLevel * TICKS_PER_BEAT,\r\n          l: defaultL\r\n        };\r\n\r\n        newEvt.s = Math.floor(newEvt.s);\r\n\r\n        Pattern.cutEvent(scope.pattern, scope.track, newEvt);\r\n        addNewEvent(newEvt);\r\n      };\r\n\r\n      var eventSplit = function(evt, ticks) {\r\n        var originalL = evt.l;\r\n        evt.l = ticks;\r\n        var newEvt = {\r\n          n: evt.n,\r\n          s: evt.s + evt.l,\r\n          l: originalL - ticks\r\n        };\r\n        scope.recipe.raise('pattern_note_added');\r\n        scope.track.events.push(newEvt);\r\n      }\r\n\r\n      var eventLeftSplit = function(evt) {\r\n        if (evt.l % 3 === 0) {\r\n          eventSplit(evt, evt.l / 3);\r\n        } else {\r\n          eventCenterSplit(evt);\r\n        }\r\n      };\r\n\r\n      var eventRightSplit = function(evt) {\r\n        if (evt.l % 3 === 0) {\r\n          eventSplit(evt, evt.l * 2 / 3);\r\n        } else {\r\n          eventCenterSplit(evt);\r\n        }\r\n      };\r\n\r\n      var eventCenterSplit = function(evt) {\r\n        if (evt.l % 2 === 0) {\r\n          eventSplit(evt, evt.l / 2);\r\n        }\r\n      };\r\n\r\n      scope.mouseDblClickEvent = function(evt, event) {\r\n        var elementWidth = $(event.target)[0].clientWidth+5;\r\n\r\n        if (event.offsetX < elementWidth/3) {\r\n          eventLeftSplit(evt);\r\n        } else if (event.offsetX > elementWidth*2/3) {\r\n          eventRightSplit(evt);\r\n        } else {\r\n          eventCenterSplit(evt);\r\n        }\r\n      };\r\n\r\n      scope.mouseDownEvent = function(evt, event) {\r\n        MusicContext.resumeAudio();\r\n\r\n        event.preventDefault();\r\n        document.activeElement.blur();\r\n\r\n        scope.$emit(\"eventSelected\", {evt: evt, track: scope.track});\r\n\r\n        scope.$emit(\"patternSelectEvent\", evt);\r\n        scope.selected = evt;\r\n\r\n        scope.mouseMove = preventCollision(evt, moveEvent(evt, event.offsetX));\r\n        scope.mouseMoveEvent = preventCollision(evt, moveEventFromEvent(evt, event.offsetX));\r\n\r\n        clearShadow();\r\n\r\n        scope.mouseLeave = function() {\r\n          defaultMouseLeave();\r\n          cancelMove();\r\n        };\r\n\r\n        var _cancelMove = function() {\r\n          scope.recipe.raise('pattern_note_drag');\r\n          cancelMove();\r\n        };\r\n\r\n        scope.mouseUpResizeEvent = _cancelMove;\r\n        scope.mouseUpEvent = _cancelMove;\r\n        scope.mouseUp = _cancelMove;\r\n      };\r\n\r\n      scope.mouseDownResizeEvent = function(evt, event) {\r\n        MusicContext.resumeAudio();\r\n\r\n        event.preventDefault();\r\n\r\n        scope.$emit(\"patternSelectEvent\", evt);\r\n        scope.selected = evt;\r\n\r\n        scope.mouseMove = preventCollision(evt, function(event) {\r\n          var oldevt = {n:evt.n, s:evt.s, l:evt.l};\r\n          var clipDistance = TICKS_PER_BEAT / scope.zoomLevel;\r\n          var clipL = Pattern.findClipL(scope.pattern, scope.track, evt, evt.s);\r\n\r\n          if (!event.target.classList.contains(\"event-list\")) return;\r\n\r\n          var exactL = Math.floor(event.offsetX / scope.beatWidth / scope.zoomLevel * TICKS_PER_BEAT) - evt.s;\r\n\r\n          if (Math.abs(exactL - clipL - clipDistance) < clipDistance) {\r\n            evt.l = clipL;\r\n          } else {\r\n            var refs = Math.floor(event.offsetX / scope.beatWidth / 2) * 2 / scope.zoomLevel * TICKS_PER_BEAT;\r\n            evt.l = refs - evt.s;\r\n            evt.l = Math.floor(evt.l);\r\n            if (evt.l<TICKS_PER_BEAT/scope.zoomLevel) evt.l=TICKS_PER_BEAT/scope.zoomLevel;\r\n\r\n            defaultL = evt.l;\r\n          }\r\n        });\r\n\r\n        scope.mouseMoveEvent = preventCollision(evt, function(dragevt, event) {\r\n          var oldevt = {n:evt.n, s:evt.s, l:evt.l};\r\n          var clipDistance = TICKS_PER_BEAT / scope.zoomLevel;\r\n          var clipL = Pattern.findClipL(scope.pattern, scope.track, evt, evt.s);\r\n\r\n          var exactL = dragevt.s + \r\n            Math.floor(event.offsetX / scope.beatWidth / scope.zoomLevel * TICKS_PER_BEAT) -\r\n            evt.s;\r\n\r\n          if (Math.abs(exactL - clipL - clipDistance) < clipDistance) {\r\n            evt.l = clipL;\r\n          } else {\r\n            var refs = dragevt.s + Math.floor(event.offsetX / scope.beatWidth / 2) * 2 / scope.zoomLevel * TICKS_PER_BEAT;\r\n            evt.l = refs - evt.s;\r\n            evt.l = Math.floor(evt.l);\r\n\r\n            if (evt.l<TICKS_PER_BEAT/scope.zoomLevel) evt.l=TICKS_PER_BEAT/scope.zoomLevel;\r\n\r\n            defaultL = evt.l;\r\n          }\r\n        });\r\n\r\n        scope.mouseUpResizeEvent = cancelMove;\r\n        scope.mouseUpEvent = cancelMove;\r\n        scope.mouseUp = cancelMove;\r\n      };\r\n\r\n      var keyDownHandler = function(e) {\r\n        if (document.activeElement.tagName.toLowerCase() === \"input\") return;\r\n\r\n        if (e.keyCode == 46) {\r\n          $timeout(function() {\r\n            scope.track.events = scope.track.events.filter(function(evt) { return evt !== scope.selected; });\r\n            scope.$emit(\"trackChanged\", scope.track);\r\n          });\r\n        }\r\n      };\r\n\r\n      $(document).bind(\"keydown\", keyDownHandler);\r\n      scope.$on(\"$destroy\", function() {\r\n        $(document).unbind(\"keydown\", keyDownHandler);\r\n      });\r\n\r\n      scope.$on(\"trackSelectEvent\", function(evt, event) {\r\n        scope.selected = event;\r\n      });\r\n    }\r\n  };\r\n}]);\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\nmusicShowCaseApp.directive(\"ngfDrop\", [\"$parse\", function($parse) {\r\n  return {\r\n    restrict: 'A',\r\n    link: function(scope, element, attrs) {\r\n      var ngfDropGetter = $parse(attrs.ngfDrop);\r\n\r\n      var allowDrag = function(e) {\r\n        e.dataTransfer.dropEffect = 'copy';\r\n        e.preventDefault();\r\n      }\r\n\r\n      var onDrop = function(e) {\r\n        ngfDropGetter(scope, {'$files': e.dataTransfer.files});\r\n        e.preventDefault();\r\n      };\r\n\r\n      window.addEventListener('dragenter', allowDrag);\r\n      window.addEventListener('dragover', allowDrag)\r\n      window.addEventListener('drop', onDrop);\r\n\r\n      scope.$on(\"$destroy\", function() {\r\n        window.removeEventListener('dragenter', allowDrag);\r\n        window.removeEventListener('dragover', allowDrag);\r\n        window.removeEventListener('drop', onDrop);\r\n      });\r\n    }\r\n  };\r\n}]);\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\nmusicShowCaseApp.directive(\"ngfLoader\", [\"$parse\", function($parse) {\r\n  return {\r\n    restrict: 'A',\r\n    link: function(scope, element, attrs) {\r\n      var ngfLoaderGetter = $parse(attrs.ngfLoader);\r\n      var onChange =  function(e) {\r\n        ngfLoaderGetter(scope, {'$files': e.target.files});\r\n        $(element).val(\"\");\r\n      };\r\n\r\n      $(element).on('change', onChange);\r\n      scope.$on('$destroy', function() {\r\n        $(element).off('change', onChange);\r\n      });\r\n    }\r\n  };\r\n}]);\r\n","musicShowCaseApp.directive(\"patternTrackCompactView\", [\"$timeout\", \"TICKS_PER_BEAT\", \"Recipe\", \"Pattern\", \"MusicContext\", function($timeout, TICKS_PER_BEAT, Recipe, Pattern, MusicContext) {\r\n  return {\r\n    scope: {\r\n      /* Current pattern */\r\n      pattern: \"=pattern\",\r\n      /* Current track */\r\n      track: \"=track\",\r\n      /* Display params */\r\n      zoomLevel: \"=zoomLevel\",\r\n      beatWidth: \"=beatWidth\",\r\n      /* File params (common to all tracks) */\r\n      measure: \"=measure\",\r\n      measureCount: \"=measureCount\"\r\n    },\r\n    templateUrl: \"site/templates/directives/patternTrackCompactView.html\",\r\n    link: function(scope, element) {\r\n      scope.recipe = Recipe.start;\r\n\r\n      scope.TICKS_PER_BEAT = TICKS_PER_BEAT;\r\n      var semitoneToNote = function(n) {\r\n        return [0,[0,1], 1, [1,2], 2, 3, [3,4], 4, [4,5], 5, [5,6], 6][n%12];\r\n      };\r\n      var notation7 = function(n) {\r\n        return [\"C\",\"D\",\"E\",\"F\",\"G\",\"A\",\"B\"][n % 7];\r\n      };\r\n      scope.noteName = function(n) {\r\n        var note7 = semitoneToNote(n);\r\n        var octave = Math.floor(n/12);\r\n\r\n        if (Array.isArray(note7)) {\r\n          note7 = note7[0]\r\n          return notation7(note7) + '#' + octave;\r\n        } else {\r\n          return notation7(note7) + octave;\r\n        }\r\n      };\r\n      \r\n      var updateGrid = function() {\r\n        scope.mainGridStyle = {\r\n          \"background-size\": (scope.measure*scope.beatWidth*scope.zoomLevel) + \"px 240px\",\r\n          \"background-position\": -scope.pattern.scrollLeft + \"px\"\r\n        };\r\n      };\r\n      scope.$watch(\"[measure, beatWidth, zoomLevel, pattern.scrollLeft]\", updateGrid);\r\n      scope.$on(\"trackSelectEvent\", function(evt, event) {\r\n        scope.selected = event;\r\n      });\r\n\r\n\r\n      var mouseUp = function(event) {\r\n        scope.$emit(\"enableTrack\", scope.track);\r\n        scope.mouseMove = function() {};\r\n      };\r\n\r\n      scope.mouseUp = mouseUp;\r\n\r\n      scope.mouseLeave = function() {\r\n        scope.mouseMove = function() {};\r\n      };\r\n\r\n      var cancelMove = function() {\r\n        scope.mouseMoveEvent = function(){};\r\n        scope.mouseMove = function(){};\r\n        scope.mouseLeave = function(){};\r\n      };\r\n\r\n      scope.mouseDownEvent = function(evt, event) {\r\n        var moved = false;\r\n\r\n        var moveEvent = function(evt, offsetX) {\r\n          return function(event) {\r\n            MusicContext.resumeAudio();\r\n\r\n            var clipDistance = TICKS_PER_BEAT / scope.zoomLevel;\r\n            var oldevt = {n:evt.n, s:evt.s, l:evt.l};\r\n\r\n            if (!event.target.parentElement.classList.contains(\"track-compact-view\")) return;\r\n\r\n            var exactPosition = Math.floor((event.offsetX - offsetX) / scope.beatWidth / scope.zoomLevel * TICKS_PER_BEAT);\r\n            exactPosition = Math.floor(exactPosition);\r\n            var clipS = Pattern.findClipS(scope.pattern, scope.track, evt, exactPosition);\r\n\r\n            if (Math.abs(exactPosition - clipS - clipDistance / 2) < clipDistance) {\r\n              evt.s = clipS;\r\n            } else {\r\n              evt.s = Math.floor((event.offsetX - offsetX) / 2 / scope.beatWidth) * 2 / scope.zoomLevel * TICKS_PER_BEAT;\r\n              evt.s = Math.floor(evt.s);\r\n            }\r\n\r\n            if (evt.s < 0) evt.s = 0;\r\n            if (evt.s !== oldevt.s) moved = true;\r\n\r\n            scope.$emit(\"trackChanged\", scope.track);\r\n            scope.$emit(\"eventChanged\", {oldevt: oldevt, evt:evt, track: scope.track});\r\n          };\r\n        };\r\n\r\n        var moveEventFromEvent = function(evt, offsetX) {\r\n          return function(dragevt, event) {\r\n            MusicContext.resumeAudio();\r\n\r\n            var clipDistance = TICKS_PER_BEAT / scope.zoomLevel;\r\n            var oldevt = {n:evt.n, s:evt.s, l:evt.l};\r\n\r\n            var exactPosition = dragevt.s + Math.floor((event.offsetX - offsetX) / scope.beatWidth / scope.zoomLevel * TICKS_PER_BEAT);\r\n            exactPosition = Math.floor(exactPosition);\r\n            var clipS = Pattern.findClipS(scope.pattern, scope.track, evt, exactPosition);\r\n\r\n            if (Math.abs(exactPosition - clipS - clipDistance / 2) < clipDistance) {\r\n              evt.s = clipS;\r\n            } else {\r\n              evt.s = dragevt.s + Math.floor((event.offsetX - offsetX) / 2 / scope.beatWidth) * 2 / scope.zoomLevel * TICKS_PER_BEAT;\r\n              evt.s = Math.floor(evt.s);\r\n            }\r\n\r\n            if (evt.s < 0) evt.s = 0;\r\n            if (evt.s !== oldevt.s) moved = true;\r\n\r\n            scope.$emit(\"trackChanged\", scope.track);\r\n            scope.$emit(\"eventChanged\", {oldevt: oldevt, evt:evt, track: scope.track});\r\n          };\r\n        };\r\n\r\n        event.preventDefault();\r\n        document.activeElement.blur();\r\n\r\n        scope.$emit(\"eventSelected\", {evt: evt, track: scope.track});\r\n\r\n        scope.mouseMove = moveEvent(evt, event.offsetX);\r\n        scope.mouseMoveEvent = moveEventFromEvent(evt, event.offsetX);\r\n\r\n        scope.mouseLeave = function() {\r\n          cancelMove();\r\n        };\r\n\r\n        var _cancelMove = function() {\r\n          scope.recipe.raise('pattern_note_drag');\r\n          cancelMove();\r\n        };\r\n\r\n        scope.mouseUpResizeEvent = _cancelMove;\r\n        scope.mouseUpEvent = _cancelMove;\r\n        scope.mouseUp = function() {\r\n          scope.mouseUp = mouseUp;\r\n\r\n          if (!moved) scope.$emit(\"enableTrack\", scope.track);\r\n\r\n          scope.$emit(\"patternSelectEvent\", evt);\r\n          _cancelMove();\r\n        };\r\n      };\r\n\r\n      scope.mouseDownResizeEvent = function(evt, event) {\r\n        var moved = false;\r\n\r\n        event.preventDefault();\r\n\r\n        scope.mouseMove = function(event) {\r\n          MusicContext.resumeAudio();\r\n\r\n          var oldevt = {n:evt.n, s:evt.s, l:evt.l};\r\n          var clipDistance = TICKS_PER_BEAT / scope.zoomLevel;\r\n          var clipL = Pattern.findClipL(scope.pattern, scope.track, evt, evt.s);\r\n\r\n          if (!event.target.parentElement.classList.contains(\"track-compact-view\")) return;\r\n\r\n          var exactL = Math.floor(event.offsetX / scope.beatWidth / scope.zoomLevel * TICKS_PER_BEAT) - evt.s;\r\n\r\n          if (Math.abs(exactL - clipL - clipDistance) < clipDistance) {\r\n            evt.l = clipL;\r\n          } else {\r\n            var refs = Math.floor(event.offsetX / scope.beatWidth / 2) * 2 / scope.zoomLevel * TICKS_PER_BEAT;\r\n            evt.l = refs - evt.s;\r\n            evt.l = Math.floor(evt.l);\r\n\r\n            if (evt.l<TICKS_PER_BEAT/scope.zoomLevel) evt.l=TICKS_PER_BEAT/scope.zoomLevel;\r\n            defaultL = evt.l;\r\n          }\r\n\r\n          if (evt.l !== oldevt.l) {\r\n            moved = true;\r\n          }\r\n\r\n          scope.$emit(\"trackChanged\", scope.track);\r\n          scope.$emit(\"eventChanged\", {oldevt:oldevt, evt:evt, track: scope.track});\r\n        };\r\n\r\n        scope.mouseMoveEvent = function(dragevt, event) {\r\n          MusicContext.resumeAudio();\r\n\r\n          var oldevt = {n:evt.n, s:evt.s, l:evt.l};\r\n          var clipDistance = TICKS_PER_BEAT / scope.zoomLevel;\r\n          var clipL = Pattern.findClipL(scope.pattern, scope.track, evt, evt.s);\r\n\r\n          var exactL = dragevt.s + \r\n            Math.floor(event.offsetX / scope.beatWidth / scope.zoomLevel * TICKS_PER_BEAT) -\r\n            evt.s;\r\n\r\n          if (Math.abs(exactL - clipL - clipDistance) < clipDistance) {\r\n            evt.l = clipL;\r\n          } else {\r\n            var refs = dragevt.s + Math.floor(event.offsetX / scope.beatWidth / 2) * 2 / scope.zoomLevel * TICKS_PER_BEAT;\r\n            evt.l = refs - evt.s;\r\n            evt.l = Math.floor(evt.l);\r\n\r\n            if (evt.l<TICKS_PER_BEAT/scope.zoomLevel) evt.l=TICKS_PER_BEAT/scope.zoomLevel;\r\n\r\n            defaultL = evt.l;\r\n          }\r\n\r\n          if (evt.l !== oldevt.l) {\r\n            moved = true;\r\n          }          \r\n\r\n          scope.$emit(\"trackChanged\", scope.track);\r\n          scope.$emit(\"eventChanged\", {oldevt:oldevt, evt:evt, track: scope.track});\r\n        };        \r\n\r\n        scope.mouseUpResizeEvent = cancelMove;\r\n        scope.mouseUpEvent = cancelMove;\r\n        scope.mouseUp = function() {\r\n          scope.mouseUp = mouseUp;\r\n\r\n          if (!moved) scope.$emit(\"enableTrack\", scope.track);\r\n\r\n          scope.$emit(\"patternSelectEvent\", evt);\r\n          cancelMove();\r\n        };\r\n      };\r\n\r\n    }\r\n  };\r\n}]);\r\n\r\n","musicShowCaseApp.directive(\"playingLine\", [\"$timeout\", \"$parse\", \"TICKS_PER_BEAT\", function($timeout, $parse, TICKS_PER_BEAT) {\r\n  return {\r\n    scope: {},\r\n    replace: true,\r\n    templateUrl: \"site/templates/directives/playingLine.html\",\r\n    link: function(scope, element, attrs) {\r\n      var t0;\r\n      var timeToTicks;\r\n      var playing = false;\r\n      var getBpm = $parse(attrs.bpm);\r\n      var getZoomLevel = $parse(attrs.zoomLevel);\r\n      var getBeatWidth = $parse(attrs.beatWidth);\r\n\r\n      var bpm, zoomLevel, beatWidth;\r\n\r\n      var ticksToPX = function(ticks) {\r\n        zoomLevel = getZoomLevel(scope.$parent);\r\n        beatWidth = getBeatWidth(scope.$parent);\r\n        return ticks*zoomLevel*beatWidth/TICKS_PER_BEAT;\r\n      };\r\n\r\n      var callback = function() {\r\n        if (bpm && playing) {\r\n          var ticks = timeToTicks((window.performance.now() - t0));\r\n          var displacement = ticksToPX(ticks);\r\n\r\n          element.css(\"left\", (displacement) + \"px\");\r\n        }\r\n        requestAnimationFrame(callback);\r\n      };\r\n\r\n      var playingLine = $(element);\r\n      var requestId = requestAnimationFrame(callback);\r\n\r\n      scope.$on('startClock', function(evt, _timeToTicks) {\r\n        var _t0 = window.performance.now();\r\n\r\n        playing = true;\r\n        bpm = getBpm(scope.$parent);\r\n\r\n        timeToTicks = _timeToTicks;\r\n        t0 = _t0;\r\n      });\r\n\r\n      scope.$on('stopClock', function(evt) {\r\n        playing = false;\r\n      });\r\n\r\n      scope.$on('pauseClock', function(evt) {\r\n        var ticks = timeToTicks((window.performance.now() - t0));\r\n        var displacement = ticksToPX(ticks || 0);\r\n\r\n        playing = false;\r\n        scope.$emit('pausedClock', ticks);\r\n        element.css(\"left\", (displacement) + \"px\");\r\n      });\r\n\r\n      scope.$on('resetClock', function(evt, baseTicks) {\r\n        var displacement = ticksToPX(baseTicks || 0);\r\n\r\n        playing = false;\r\n        element.css(\"left\", (displacement) + \"px\");\r\n      });\r\n\r\n\r\n      scope.$on('$destroy', function() {\r\n        cancelAnimationFrame(requestId);\r\n      });\r\n    }\r\n  };\r\n}]);\r\n\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\nmusicShowCaseApp.directive(\"recipeBlink\", [\"$parse\", \"$timeout\", \"Recipe\", function($parse, $timeout, Recipe) {\r\n  return {\r\n    restrict: 'A',\r\n    link: function(scope, element, attrs) {\r\n      var recipeBlinkGetter = $parse(attrs.recipeBlink);\r\n      var blinkElementId = recipeBlinkGetter(scope);\r\n\r\n      if (!Array.isArray(blinkElementId)) {\r\n        blinkElementId = [blinkElementId];\r\n      }\r\n\r\n      var blink = function() {\r\n        $timeout(function() {\r\n          $(element).addClass('blink');\r\n        });\r\n      };\r\n\r\n      var noblink = function() {\r\n        $timeout(function() {\r\n          $(element).removeClass('blink');\r\n        });\r\n      };\r\n\r\n      var registerEvent = function(blinkElementId) {\r\n        if (Recipe.getBlinks().indexOf(blinkElementId) !== -1) {\r\n          blink();\r\n        }\r\n\r\n        scope.$on(\"_blink_enable_\" + blinkElementId, function(event, args) {\r\n          blink();\r\n        });\r\n\r\n        scope.$on(\"_blink_disable_\" + blinkElementId, function() {\r\n          noblink();\r\n        });\r\n\r\n        scope.$on(\"__blink_disable_all\", function() {\r\n          noblink();\r\n        });\r\n      };\r\n\r\n      blinkElementId.forEach(registerEvent);\r\n    }\r\n  };\r\n}]);\r\n\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\nmusicShowCaseApp.directive(\"recipeTooltip\", [\"$parse\", \"$timeout\", function($parse, $timeout) {\r\n  return {\r\n    restrict: 'E',\r\n    scope: {},\r\n    template: '<div ng-click=\"onClick($event)\" ng-class=\"{\\'show-recipe-tooltip\\': tooltipEnabled, \\'cap-right\\': capRight}\" class=\"help-tooltip recipe-tooltip\"><p>{{text|translate}}</p></div>',\r\n    link: function(scope, element, attrs) {\r\n      var rtIdGetter = $parse(attrs.rtId);\r\n      var tooltipElementId = rtIdGetter(scope.$parent);\r\n\r\n      scope.tooltipEnabled = false;\r\n      scope.onClick = function(e) {\r\n        scope.$parent.recipe.raise(\"tooltip_click\");\r\n        e.stopImmediatePropagation();\r\n      };\r\n\r\n      scope.$on(\"_tooltip_display_\" + tooltipElementId, function(event, args) {\r\n        $timeout(function() {\r\n          var windowWidth = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);\r\n          var el = element[0];\r\n          var offset = windowWidth - el.getBoundingClientRect().left;\r\n\r\n          scope.capRight = offset < 300;\r\n\r\n          scope.text = args.text;\r\n          scope.tooltipEnabled = true;\r\n        })\r\n      });\r\n\r\n      scope.$on(\"_tooltip_hide_\" + tooltipElementId, function() {\r\n        scope.tooltipEnabled = false;\r\n      });\r\n\r\n      scope.$on(\"__tooltip_hide_all\", function() {\r\n        scope.tooltipEnabled = false;\r\n      });\r\n    }\r\n  };\r\n}]);\r\n\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\nmusicShowCaseApp.directive(\"recipeWizard\", [\"$timeout\", function($timeout) {\r\n  return {\r\n    restrict: 'E',\r\n    template: '<div class=\"recipe-wizard\"><p>{{text}}</p></div>',\r\n    link: function(scope, element, attrs) {\r\n    }\r\n  };\r\n}]);\r\n\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\nmusicShowCaseApp.directive(\"recycleBinCompactView\", [\"$timeout\", \"$uibModal\", \"FileRepository\", \"ErrMessage\", function($timeout, $uibModal, FileRepository, ErrMessage) {\r\n  return {\r\n    templateUrl: 'site/templates/directives/recycleBinCompactView.html',\r\n    scope: {},\r\n    link: function(scope, element, attrs) {\r\n      var observer = FileRepository.observeRecycled(function() {\r\n        FileRepository.searchRecycled(null, {limit: 10})\r\n          .then(function(result) {\r\n            $timeout(function() {\r\n              scope.files = result.results.slice(0, 4);\r\n            });\r\n          });\r\n      });\r\n\r\n      scope.$on(\"destroy\", observer.destroy);\r\n      \r\n      scope.openRecycleBin = function() {\r\n        // show recycle bin modal\r\n        var modalIns = $uibModal.open({\r\n          templateUrl: \"site/templates/modal/recycleBin.html\",\r\n          controller: \"recycleBinModalCtrl\"\r\n        });\r\n      };\r\n\r\n      scope.restore = function(file) {\r\n        FileRepository.restoreFromRecycleBin(file.id)\r\n          .then(function() {\r\n            if (file.type === 'project') {\r\n              document.location = \"#/editor/\" + file.id;\r\n            } else {\r\n              document.location = \"#/editor/\"+file.project+\"/\"+file.type+\"/\"+file.id;\r\n            }\r\n          });\r\n      };\r\n\r\n      scope.onDropComplete= function(file) {\r\n        FileRepository.moveToRecycleBin(file.id)\r\n          .catch(function(err) {\r\n            if (err.type && err.type === 'cantremove') {\r\n              ErrMessage('common.error_title', 'common.cantremove_error');\r\n            } else {\r\n              throw err;\r\n            }\r\n          });\r\n      };\r\n    }\r\n  };\r\n}]);\r\n\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\n\r\nmusicShowCaseApp.filter(\"icon_from_type\", function() {\r\n  return function(type) {\r\n    if (type === \"instrument\") return \"keyboard\";\r\n    if (type === \"tempo\") return \"clock\";\r\n    if (type === \"song\") return \"th\";\r\n    if (type === \"pattern\") return \"music\";\r\n    if (type === \"fx\") return \"magic\";\r\n    if (type === \"project\") return \"folder\";\r\n    return \"question\";\r\n  };\r\n});\r\n\r\nmusicShowCaseApp.directive(\"typeIcon\", [\"$parse\", function($parse) {\r\n  return {\r\n    restrict: 'A',\r\n    scope: {},\r\n    replace: true,\r\n    template: '<span class=\"fa fa-{{typeIcon | icon_from_type}}\">',\r\n    link: function(scope, element, attrs) {\r\n      var iconTypeName = $parse(attrs.typeIcon);\r\n\r\n      scope.$parent.$watch(iconTypeName, function(newValue) {\r\n        scope.typeIcon = iconTypeName(scope.$parent);\r\n      });\r\n    }\r\n  };\r\n}]);\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\n\r\nmusicShowCaseApp.factory(\"MusicObjectFactory\", [\"MusicContext\", \"$q\", \"TypeService\", \"pruneWrapper\", function(MusicContext, $q, TypeService, pruneWrapper) {\r\n  var fileOutputMap = new WeakMap();\r\n\r\n  return function(options) {\r\n    var nextId = 0;\r\n\r\n    var _last_type = {};\r\n    var ___cache = {};\r\n\r\n    var monitor = options && options.monitor;\r\n\r\n    var getConstructor = function(descriptor, channel) {\r\n        return TypeService.getType(descriptor.type)\r\n          .then(function(type) {\r\n            if (type.monitor && !monitor) {\r\n              return function(subobjects) {\r\n                var wrapped = subobjects[0];\r\n                return function(music) {\r\n                  return wrapped(music);\r\n                };\r\n              };\r\n            }\r\n\r\n            var ret = function(subobjects) {\r\n              var buildComponents = [];\r\n\r\n              if (type.components) {\r\n                type.components.forEach(function(componentName) {\r\n                  if (!descriptor.data.modulation) return;\r\n\r\n                  var value = descriptor.data.modulation[componentName];\r\n                  if (!value) return;\r\n                  if (!value.data) return;\r\n                  if (!value.data.array) return;\r\n                  if (value.data.array.length === 0) return;\r\n\r\n                  buildComponents.push(\r\n                    createParametric(value)\r\n                      .then(function(obj) {\r\n                        return {\r\n                          name: componentName,\r\n                          obj: obj\r\n                        };\r\n                      })\r\n                  );\r\n\r\n                });\r\n              }\r\n\r\n              return $q.all(buildComponents)\r\n                .then(function(objs) {\r\n                  var components = {};\r\n                  objs.forEach(function(obj) {\r\n                    components[obj.name] = obj.obj;\r\n                  });\r\n\r\n                  _last_type[channel] = _last_type[channel] || new WeakMap();\r\n                  ___cache[channel] = ___cache[channel] || new WeakMap();\r\n                  var last_type = _last_type[channel];\r\n                  var __cache = ___cache[channel];\r\n\r\n/*>                  if (!last_type.has(descriptor)||last_type.get(descriptor) === descriptor.type) {\r\n                    if (subobjects.length === 1) {\r\n                      if (__cache.has(descriptor) && __cache.get(descriptor)[subobjects[0].id]) {\r\n                        return $q(function(resolve) {\r\n                          resolve(__cache.get(descriptor)[subobjects[0].id]\r\n                                .update(descriptor.data, components));\r\n                        });\r\n                      }\r\n                    } else if (subobjects.length === 0) {\r\n                      if (__cache.has(descriptor) && __cache.get(descriptor).noid) {\r\n                        return $q(function(resolve) {\r\n                          resolve(__cache.get(descriptor).noid\r\n                                .update(descriptor.data, components));\r\n                        });\r\n                      }\r\n                    }\r\n                  }*/\r\n\r\n                  last_type.set(descriptor, descriptor.type);\r\n\r\n                  var ret = type.constructor(descriptor.data, subobjects, components);\r\n                  nextId++;\r\n                  ret.id = nextId;\r\n\r\n                  if (subobjects.length === 1) {\r\n                    if (!__cache.has(descriptor)) __cache.set(descriptor, {});\r\n                    __cache.get(descriptor)[subobjects[0].id] = ret;\r\n                  } else if (subobjects.length === 0) {\r\n                    if (!__cache.has(descriptor)) __cache.set(descriptor, {});\r\n                    __cache.get(descriptor).noid = ret;\r\n                  }\r\n\r\n                  return ret;\r\n\r\n                })\r\n            };\r\n\r\n            ret.subobjects = type.subobjects;\r\n\r\n            return ret;\r\n          });\r\n    };\r\n\r\n    var createParametricFromStack = function(array, idx, channel) {\r\n      if (array.length === 0) return $q.when(null);\r\n\r\n      var descriptor = array[idx];\r\n      channel = channel || 0;\r\n\r\n      return getConstructor(descriptor, channel)\r\n        .then(function(constructor) {\r\n          if (constructor.subobjects) {\r\n            var getObject = function(d, index) {\r\n              var newArray = d.data.array.concat(array.slice(idx+1));\r\n              return createParametricFromStack(newArray, 0, channel*16 + index);\r\n            };\r\n\r\n            return $q.all(descriptor.data.subobjects.map(getObject))\r\n              .then(function(objs) {\r\n                return constructor(objs);\r\n              });\r\n          }\r\n\r\n          if (array.length === 1) {\r\n            return constructor([]);\r\n          }\r\n\r\n          return createParametricFromStack(array.slice(idx+1), 0, channel)\r\n            .then(function(obj) {\r\n              return constructor([obj]);\r\n            });\r\n        })\r\n        .then(function(obj) {\r\n          if (obj && obj.dataLink) {\r\n            obj.dataLink(notifyChangeFor(descriptor));\r\n          }\r\n          return obj;\r\n        });\r\n    };\r\n\r\n    var notifyChangeFor = function(descriptor) {\r\n      return function(output) {\r\n        if (fileOutputMap.has(descriptor)) {\r\n          var ee = fileOutputMap.get(descriptor);\r\n          ee.emit('changed', output);\r\n        }\r\n      };\r\n    };\r\n\r\n    var createParametric = function(descriptor) {\r\n      if (descriptor.type === \"stack\") {\r\n        return createParametricFromStack(descriptor.data.array, 0)\r\n      } else {\r\n        return getConstructor(descriptor, 0)\r\n          .then(function(constructor) {\r\n            return constructor([]); \r\n          });\r\n      }\r\n    };\r\n\r\n    var destroyAll = function(obj) {\r\n      for (var channel in _last_type) {\r\n        _last_type[channel] = new WeakMap();\r\n      }\r\n      for (var channel in ___cache) {\r\n        ___cache[channel] = new WeakMap(); \r\n      }\r\n\r\n      bases.forEach(function(base) {\r\n        base.prune();\r\n      });\r\n\r\n      bases = [];\r\n\r\n      return $q.when(null);\r\n    };\r\n\r\n    var bases = [];\r\n    var create = function(descriptor, music) {\r\n      return createParametric(descriptor)\r\n        .then(function(fcn) {\r\n          if (!fcn) return;\r\n\r\n          if (music) {\r\n            var base= music.sfxBase();\r\n            bases.push(base);\r\n            return fcn(base);\r\n          }\r\n          return MusicContext.runFcn(function(music) {\r\n            var base = music.sfxBase();\r\n            bases.push(base);\r\n            return fcn(base);\r\n          });\r\n        });\r\n    };\r\n\r\n    var observeOutput = function(file, listener) {\r\n      var ee;\r\n\r\n      if (fileOutputMap.has(file)) {\r\n        ee = fileOutputMap.get(file);\r\n      } else {\r\n        ee = new EventEmitter();\r\n        fileOutputMap.set(file, ee)\r\n      }\r\n\r\n      ee.on('changed', listener);\r\n\r\n      return {\r\n        destroy: function() {\r\n          ee.removeListener('changed', listener);\r\n        }\r\n      }\r\n    };\r\n\r\n    return {\r\n      create: create,\r\n      destroyAll: destroyAll,\r\n      observeOutput: observeOutput\r\n    };\r\n  };\r\n}]);\r\n\r\nmusicShowCaseApp.service(\"MusicContext\", function() {\r\n  var music;\r\n  var context;\r\n\r\n  var Recordable = function(music, playable, name) {\r\n    this._playable = playable;\r\n    this._music = music;\r\n    this._name = name;\r\n  };\r\n\r\n  Recordable.prototype.record = function() {\r\n    var playable = this._playable;\r\n    var recording = music.record();\r\n    var recordFileName = this._name;\r\n    var playing = playable.play();\r\n\r\n    MUSIC.Utils.FunctionSeq.preciseTimeout(function(){\r\n      recording.stop();\r\n      recording.exportWAV(function(blob) {\r\n        var a = document.createElement(\"a\");\r\n        document.body.appendChild(a);\r\n        a.style = \"display: none\";\r\n\r\n        var url  = window.URL.createObjectURL(blob);\r\n        a.href = url;\r\n        a.download = recordFileName + \".wav\";\r\n        a.click();\r\n        window.URL.revokeObjectURL(url);\r\n      });\r\n    }, playable.duration());\r\n  };\r\n\r\n  return {\r\n    resumeAudio: function() {\r\n      if (!music) {\r\n        context = new MUSIC.Context();\r\n        music = context.sfxBase(); \r\n      }\r\n\r\n      context.resume();\r\n    },\r\n\r\n    runFcn: function(f) {\r\n      if (!music) {\r\n        context = new MUSIC.Context();\r\n        music = context.sfxBase(); \r\n      }\r\n      return f(music);\r\n    },\r\n\r\n    record: function(options, callback) {\r\n      return this.runFcn(function(){\r\n        return context.record(options, callback);\r\n      });\r\n    },\r\n\r\n    run: function(code) {\r\n      if (music) {\r\n        music.prune();\r\n      }\r\n      music = new MUSIC.Context().sfxBase();\r\n\r\n      try {\r\n        return {object: eval(\"(function() {\\n\" + code + \"\\n})\")()};\r\n      } catch(e) {\r\n        return {error: e.toString()};\r\n      }\r\n    }\r\n  };\r\n});\r\n\r\nmusicShowCaseApp.service(\"Historial\", [function() {\r\n  return function() {\r\n    var array = [];\r\n    var currentVersion = 0;\r\n\r\n    var undo = function() {\r\n      if (currentVersion > 0) currentVersion--;\r\n      return array[currentVersion];\r\n    };\r\n\r\n    var redo = function() {\r\n      if (currentVersion < array.length-1) currentVersion++;\r\n      return array[currentVersion];\r\n    };\r\n\r\n    var registerVersion = function(data) {\r\n      array = array.slice(0, currentVersion+1);\r\n      array.push(data);\r\n      if (array.length > 128) array = array.slice(1);\r\n      currentVersion = array.length-1;\r\n    };\r\n\r\n    return {\r\n      registerVersion: registerVersion,\r\n      undo: undo,\r\n      redo: redo\r\n    };\r\n  };\r\n}]);\r\n\r\nmusicShowCaseApp.service(\"Pattern\", [\"MUSIC\", 'TICKS_PER_BEAT', function(MUSIC, TICKS_PER_BEAT) {\r\n\r\n  var schedule = function(noteseq, file, track, eventPreprocessor, onStop, ctx) {\r\n    var events = track.events.sort(function(e1, e2) { return e1.s - e2.s; });\r\n    var scaledEvents = events.map(function(evt) {\r\n      return [evt.n, evt.s, evt.l, {tc: evt.tc}];\r\n    });\r\n\r\n    for (var i=0; i<scaledEvents.length; i++) {\r\n      var evt = scaledEvents[i];\r\n      noteseq.push(eventPreprocessor(evt, scaledEvents), ctx);\r\n    }\r\n\r\n    noteseq.paddingTo(TICKS_PER_BEAT * file.measureCount * file.measure);\r\n    noteseq.pushCallback([TICKS_PER_BEAT*file.measureCount * file.measure, onStop]);\r\n\r\n    var totalBeats = file.measure * file.measureCount;\r\n  };\r\n\r\n  var noteseq = function(file, track, eventPreprocessor, onStop) {\r\n    var noteseq = new MUSIC.NoteSequence();\r\n    schedule(noteseq, file, track, eventPreprocessor, onStop);\r\n    return noteseq;\r\n  };\r\n\r\n  var patternCompose = function(file, instruments, base, onStop, options) {\r\n    var start = (options && options.start) || 0;\r\n    var isTempoTrack = function(track, idx) {\r\n      idx = base + idx;\r\n      var instrument = instruments[track.instrument + '_' + idx];\r\n      return instrument && instrument.tempo;\r\n    };\r\n\r\n    var getEvents = function(track) {\r\n      return track.events;\r\n    };\r\n\r\n    var concat = function(a, b) {\r\n      return a.concat(b);\r\n    };\r\n\r\n    var byStart = function(a, b) {\r\n      return a.s-b.s;\r\n    };\r\n\r\n    var songCtx = {};\r\n    var noteseq = new MUSIC.NoteSequence(null,\r\n    {\r\n      time: MUSIC.Math.ticksToTime({\r\n        bpm: file.bpm,\r\n        ticks_per_beat: TICKS_PER_BEAT,\r\n        bpm_events: file.tracks.filter(isTempoTrack).map(getEvents).reduce(concat, []).sort(byStart),\r\n        start: start\r\n      }),\r\n      songCtx: songCtx\r\n    });\r\n\r\n    file.tracks.forEach(function(track, idx) {\r\n      idx = base + idx;\r\n\r\n      var instrument = instruments[track.instrument + '_' + idx];\r\n\r\n      if (instrument && !instrument.tempo) {\r\n        var eventPreprocessor = instrument.eventPreprocessor || function(x){ return x; };\r\n        var context = MUSIC.NoteSequence.context(instrument, null, songCtx);\r\n        schedule(noteseq, file, track, eventPreprocessor, onStop, context);\r\n      }\r\n    });\r\n\r\n    var ret = noteseq.makePlayable(null);\r\n    ret.schedule = function(noteSequence, songCtx) {\r\n      var contexts = [];\r\n      songCtx = songCtx || {};\r\n\r\n      file.tracks.forEach(function(track, idx) {\r\n        idx = base + idx;\r\n\r\n        var instrument = instruments[track.instrument + '_' + idx];\r\n\r\n        if (instrument) {\r\n          var eventPreprocessor = instrument.eventPreprocessor || function(x){ return x; };\r\n          var context = MUSIC.NoteSequence.context(instrument, null, songCtx);\r\n\r\n          contexts.push(context);\r\n          schedule(noteSequence, file, track, eventPreprocessor, onStop, context);\r\n        }\r\n      });\r\n\r\n      return contexts;\r\n    };\r\n\r\n    ret.timeToTicks = function() {\r\n      return MUSIC.Math.timeToTicks({\r\n        bpm: file.bpm,\r\n        ticks_per_beat: TICKS_PER_BEAT,\r\n        bpm_events: file.tracks.filter(isTempoTrack).map(getEvents).reduce(concat, []).sort(byStart),\r\n        start: start\r\n      });\r\n    }; \r\n\r\n    ret.bpm_events = file.tracks.filter(isTempoTrack).map(getEvents).reduce(concat, []).sort(byStart);\r\n\r\n    return ret;\r\n  };\r\n\r\n  var higher = function(a,b) {\r\n    return a>b ? a : b;\r\n  };\r\n\r\n  var computeMeasureCount = function(file, measure) {\r\n    if (measure<1) measure=1;\r\n    var endTime = file.tracks.map(function(track) {\r\n      return track.events.map(function(evt) {\r\n        return evt.s + evt.l;\r\n      }).reduce(higher, 0)\r\n    }).reduce(higher,0);\r\n\r\n    var measureLength = measure * TICKS_PER_BEAT;\r\n    var measureCount = Math.floor((endTime-1)/measureLength) + 1;\r\n    if (measureCount<1) return 1;\r\n    return measureCount;\r\n  };\r\n\r\n  var getMutedState = function(file) {\r\n    var someSolo = file.tracks.some(function(t) {return t.solo; });\r\n    return file.tracks.map(function(t) {\r\n      if (someSolo) {\r\n        return t.muted || !t.solo;\r\n      } else {\r\n        return t.muted || !t.instrument;\r\n      }\r\n    });\r\n  };\r\n\r\n  var concat = function(a, b) {\r\n    return a.concat(b);\r\n  };\r\n\r\n  var _not = function(self) {\r\n    return function(evt) {\r\n      return evt !== self;\r\n    };\r\n  };\r\n\r\n  var findClipS = function(pattern, track, self, s) {\r\n    var nearest = function(c1, c2) {\r\n      return Math.abs(self.s - c1) < Math.abs(self.s - c2) ? c1 : c2;\r\n    };\r\n\r\n    var allEvents = pattern.tracks.map(function(track) {\r\n      return track.events.filter(_not(self));\r\n    }).reduce(concat);\r\n\r\n    var allOtherEvents = pattern.tracks.map(function(tr) {\r\n      if (track === tr) return [];\r\n      return tr.events.filter(_not(self));\r\n    }).reduce(concat);\r\n\r\n    if (allEvents.length === 0) return 0;\r\n\r\n    var clips = allEvents.map(function(evt) {\r\n      return evt.s + evt.l;\r\n    }).concat(allEvents.map(function(evt) {\r\n      return evt.s - self.l;\r\n    })).concat(allOtherEvents.map(function(evt) {\r\n      return evt.s;\r\n    }));\r\n\r\n    return clips.reduce(nearest);\r\n  };       \r\n\r\n  var findClipL = function(pattern, track, self, s) {\r\n    var nearest = function(c1, c2) {\r\n      return Math.abs(self.s + self.l - c1) < Math.abs(self.s + self.l - c2) ? c1 : c2;\r\n    };\r\n\r\n    var allEvents = pattern.tracks.map(function(track) {\r\n      return track.events.filter(_not(self));\r\n    }).reduce(concat);\r\n\r\n    var allOtherEvents = pattern.tracks.map(function(tr) {\r\n      if (track === tr) return [];\r\n      return tr.events.filter(_not(self));\r\n    }).reduce(concat);\r\n\r\n    if (allEvents.length === 0) return 0;\r\n    var clips = allEvents.map(function(evt) {\r\n      return evt.s;\r\n    }).concat(allOtherEvents.map(function(evt) {\r\n      return evt.s + evt.l;\r\n    }));\r\n\r\n    return clips.reduce(nearest) - self.s;\r\n  };\r\n\r\n  var cutEvent = function(pattern, track, self) {\r\n    var allEvents = track.events.filter(_not(self));\r\n\r\n    allEvents.filter(function(evt) {\r\n      return evt.s > self.s;\r\n    }).forEach(function(evt) {\r\n      if (self.s + self.l > evt.s) {\r\n        self.l = evt.s - self.s;\r\n      }\r\n    });\r\n\r\n    var measureTicks = pattern.measure * TICKS_PER_BEAT;\r\n    if ((self.s + self.l) % measureTicks < self.s % measureTicks) {\r\n      self.l = self.l - (self.s + self.l) % measureTicks;\r\n    }\r\n  };\r\n\r\n  var collision = function(track, self) {\r\n    var allEvents = track.events.filter(_not(self));\r\n    return allEvents.some(function(evt) {\r\n      if (evt.n !== self.n) return false;\r\n      if (evt.s <= self.s && self.s < evt.s + evt.l) return true;\r\n      if (self.s <= evt.s && evt.s < self.s + self.l) return true;\r\n\r\n      return false;\r\n    });\r\n  };\r\n\r\n  return {\r\n    noteseq: noteseq,\r\n    patternCompose: patternCompose,\r\n    computeMeasureCount: computeMeasureCount,\r\n    getMutedState: getMutedState,\r\n    findClipL: findClipL,\r\n    findClipS: findClipS,\r\n    cutEvent: cutEvent,\r\n    collision: collision\r\n  };\r\n}]);\r\n\r\n\r\nmusicShowCaseApp.service(\"InstrumentSet\", [\"FileRepository\", \"MusicObjectFactory\", \"MusicContext\", function(FileRepository, MusicObjectFactory, MusicContext) {\r\n  var ret = function(music) {\r\n    var musicObjectFactory;\r\n    var trackControl = {};\r\n\r\n    var set = {};\r\n    var created = [];\r\n    var load = function(id, trackNo) {\r\n      trackNo = trackNo || 0;\r\n      var _id = id + \"_\" + trackNo;\r\n      if (!set[_id]) {\r\n        trackControl[trackNo] = trackControl[trackNo] || music.gain(1.0);\r\n\r\n        set[_id] = FileRepository.getFile(id)\r\n          .then(function(file) {\r\n            if (file.index.type === 'instrument') {\r\n              if (!musicObjectFactory) musicObjectFactory = MusicObjectFactory();\r\n              return musicObjectFactory.create(file.contents, trackControl[trackNo])\r\n                .then(function(obj){\r\n                  created.push(obj);\r\n                  return obj;\r\n                });\r\n\r\n            } else {\r\n              return {tempo: true};\r\n            }\r\n          });\r\n      } \r\n\r\n      return set[_id];\r\n    };\r\n\r\n    var dispose = function() {\r\n      created.forEach(function(instrument){\r\n        if (instrument.dispose) {\r\n          instrument.dispose();\r\n        }\r\n      });\r\n\r\n      if (musicObjectFactory) {\r\n        return musicObjectFactory.destroyAll();\r\n      }\r\n    };\r\n\r\n    var mute = function(trackNo, muteState) {\r\n      trackControl[trackNo] = trackControl[trackNo] || music.gain(1.0);\r\n      trackControl[trackNo].update(muteState ? 0.0 : 1.0);\r\n    };\r\n\r\n    return {\r\n      load: load,\r\n      mute: mute,\r\n      all: set,\r\n      dispose: dispose\r\n    };\r\n  };\r\n\r\n  return function(music) {\r\n    if (music) return ret(music);\r\n    return MusicContext.runFcn(ret);\r\n  };\r\n}]);\r\n\r\nmusicShowCaseApp.service(\"FileRepository\", [\"$http\", \"$q\", \"TypeService\", \"Historial\", \"Index\", \"_localforage\", function($http, $q, TypeService, Historial, Index, localforage) {\r\n  var createdFilesIndex = [];\r\n  var createdFiles = {};\r\n\r\n  var builtIns = [\r\n    \"site/builtin/defaultProject.json\",\r\n    \"site/builtin/samples.json\",\r\n    \"site/builtin/smb-underworld.json\",\r\n    \"site/builtin/smb-overworld.json\",\r\n    \"site/builtin/bomberman.json\",\r\n    \"site/builtin/entertainer.json\",\r\n    \"site/builtin/eva-thanatos.json\",\r\n    \"site/builtin/bioshock-solace.json\"\r\n  ];\r\n\r\n  var loadBuiltIn = function(uri) {\r\n    return $http.get(uri)\r\n      .then(function(r) {\r\n        r.data.forEach(function(obj) {\r\n          var objectId = obj.id;\r\n\r\n          createdFiles[objectId] = obj.contents;\r\n\r\n          createdFilesIndex.push({\r\n            project: obj.project,\r\n            type: obj.type,\r\n            name: obj.name,\r\n            id: objectId,\r\n            ref: obj.ref,\r\n            builtIn: true\r\n          });\r\n        });\r\n      });\r\n  };\r\n\r\n  var createDefault = function(id, type, name, content) {\r\n    createdFilesIndex.push({\r\n      project: \"default\",\r\n      type: type,\r\n      id: id,\r\n      name: name,\r\n      noExportable: true\r\n    });\r\n\r\n    createdFiles[id] = content;\r\n  };\r\n\r\n  createDefault('tempo', 'tempo', 'Tempo', {})\r\n\r\n  var builtInLoaded = $q.all(builtIns.map(loadBuiltIn));\r\n\r\n  var createId = function() {\r\n    var array = [];\r\n    for (var i = 0; i < 32; i++) {\r\n      var value = [0,1,2,3,4,5,6,7,8,9,'a','b','c','d','e','f'][Math.floor(Math.random()*16)];\r\n      array.push(value);\r\n    }\r\n\r\n    return array.join(\"\");\r\n  };\r\n\r\n  var genericStateEmmiter = new EventEmitter();\r\n  var recycledEmmiter = new EventEmitter();\r\n\r\n  var defaultFile = {\r\n    instrument: {\r\n      type: \"stack\",\r\n      data: {\r\n        array: []\r\n      }\r\n    },\r\n    song: {\r\n      measure: 4,\r\n      bpm: 140,\r\n      tracks: [\r\n        {blocks: [{},{},{}]},\r\n        {blocks: [{},{},{}]}\r\n      ]\r\n    },\r\n    pattern: {\r\n      measure: 4,\r\n      measureCount: 1,\r\n      bpm: 140,\r\n      selectedTrack: 0,\r\n      tracks:[\r\n        {scroll: 1000, events: []}\r\n      ],\r\n      scrollLeft: 0\r\n    }\r\n  };\r\n\r\n  var hist = new WeakMap();\r\n\r\n  var updateFile = function(id, contents, options) {\r\n    return $q.when()\r\n      .then(function() {\r\n        var localFile = createdFilesIndex.filter(function(x) {return x.id === id; })[0];\r\n        if (localFile) return localFile;\r\n\r\n        return storageIndex.getEntry(id);\r\n      })\r\n      .then(function(localFile) {\r\n        if (localFile) {\r\n          var serialized = MUSIC.Formats.MultiSerializer.serialize(localFile.type, contents);\r\n\r\n          if (!options || !options.noHistory) {\r\n            hist[id] = hist[id] || Historial();\r\n            hist[id].registerVersion(JSON.stringify(contents));\r\n          }\r\n\r\n          return localforage.setItem(id, serialized);\r\n        }\r\n      })\r\n      .then(function() {\r\n        return recycleIndex.reload();\r\n      })\r\n      .then(function() {\r\n        recycledEmmiter.emit(\"changed\");\r\n      });\r\n  };\r\n\r\n  var destroyFile = function(id) {\r\n    return localforage.removeItem(id)\r\n      .then(function() {\r\n        return $q.all({r: recycleIndex.removeEntry(id), l: storageIndex.removeEntry(id)});\r\n      })\r\n  };\r\n\r\n  var purgeFromRecycleBin = function(id) {\r\n    return recycleIndex.removeEntry(id);\r\n  };\r\n\r\n  var restoreFromRecycleBin = function(id) {\r\n    return _restoreFromRecycleBin(id)\r\n      .then(function() {\r\n        genericStateEmmiter.emit(\"changed\");\r\n        recycledEmmiter.emit(\"changed\");\r\n      });\r\n  };\r\n\r\n  var _restoreFromRecycleBin = function(id) {\r\n    return recycleIndex.getEntry(id)\r\n      .then(function(localFile) {\r\n        if (localFile) {\r\n          return recycleIndex.removeEntry(id)\r\n            .then(function() {\r\n              return storageIndex.createEntry(localFile);\r\n            })\r\n            .then(function() {\r\n              var refs = (localFile.ref||[])\r\n              if (localFile.project) refs.push(localFile.project);\r\n\r\n              return $q.all(refs.map(_restoreFromRecycleBin));\r\n            });\r\n        }\r\n      });\r\n  };\r\n\r\n  var moveToRecycleBin = function(id) {\r\n    return _moveToRecycleBin(id)\r\n      .then(function() {\r\n        genericStateEmmiter.emit(\"changed\");\r\n        recycledEmmiter.emit(\"changed\");\r\n      })\r\n  };\r\n\r\n  var _moveToRecycleBin = function(id) {\r\n    var getId = function(x){ return x.id; };\r\n    var isProjectType = function(file) {\r\n      return file.type === 'project';\r\n    };\r\n\r\n    return storageIndex.willRemove(id)\r\n      .then(function() {\r\n        return storageIndex.getEntry(id)\r\n          .then(function(localFile) {\r\n            if (localFile) {\r\n              return recycleIndex.getAll()\r\n                .then(function(idx) {\r\n                  if (idx && idx.length >= 100) {\r\n                    return recycleIndex.getFreeItems()\r\n                      .then(function(idx) {\r\n                        if (!idx[0]) return;\r\n\r\n                        return recycleIndex.removeEntry(idx[0].id)\r\n                          .then(function() {\r\n                            return localforage.removeItem(id);\r\n                          });\r\n                      });\r\n                  }\r\n                })\r\n                .then(function() {\r\n                  return storageIndex.removeEntry(id);\r\n                })\r\n                .then(function() {\r\n                  return recycleIndex.createEntry(localFile);\r\n                });\r\n            }\r\n          });\r\n      })\r\n      .then(function() {\r\n        return storageIndex.getOrphan(\r\n          createdFilesIndex.map(getId),\r\n          createdFilesIndex.filter(isProjectType).map(getId));\r\n      })\r\n      .then(function(orphanFiles) {\r\n        return $q.all(orphanFiles.map(getId).map(_moveToRecycleBin))\r\n          .catch(function(e) {\r\n            console.error(e);\r\n          });\r\n      });\r\n  };\r\n\r\n  var getPatternSongs = function(options) {\r\n    var byProject = function(file) {\r\n      return file.project === options.project;\r\n    };\r\n\r\n    var byType = function(file) {\r\n      return file.type === 'pattern' || file.type === 'song';\r\n    };\r\n\r\n    var typeSong = function(file) {\r\n      return file.type === 'song';\r\n    };\r\n\r\n    var loadFile = function(file) {\r\n      return getFile(file.id);\r\n    };\r\n\r\n    return $q.all({\r\n        storage: storageIndex.getAll(),\r\n        builtin: createdFilesIndex\r\n      }).then(function(result) {\r\n        var files = result.storage.concat(result.builtin);\r\n        var fileIndexes = files.filter(byProject).filter(byType);\r\n\r\n        if (fileIndexes.some(typeSong)) {\r\n          fileIndexes = fileIndexes.filter(typeSong);\r\n        }\r\n\r\n        return $q.all(fileIndexes.map(loadFile));\r\n      });\r\n  };\r\n\r\n  var mode = function(files, fcn) {\r\n    var obj = {};\r\n    files.forEach(function(file) {\r\n      var value = fcn(file);\r\n      obj[value] = (obj[value] || 0) + 1;\r\n    });\r\n\r\n    var maxcount = 0;\r\n    var _m;\r\n    for (var k in obj) {\r\n      var count = obj[k];\r\n      if (count > maxcount) {\r\n        _m = k;\r\n        maxcount = count;\r\n      }\r\n    };\r\n\r\n    return _m;\r\n  };\r\n\r\n  var getDefaultMeasure = function(options) {\r\n    return getPatternSongs(options)\r\n      .then(function(files) {\r\n        if (!files.length) return 4;\r\n\r\n        return mode(files, function(file) {\r\n          return file.contents.measure;\r\n        });\r\n      });\r\n  };\r\n\r\n  var getDefaultBPM = function(options) {\r\n    return getPatternSongs(options)\r\n      .then(function(files) {\r\n        if (!files.length) return 140;\r\n\r\n        return mode(files, function(file) {\r\n          return file.contents.bpm;\r\n        });\r\n      });\r\n  };\r\n\r\n  var getFile = function(id) {\r\n      var builtIn = false;\r\n      var changed = false;\r\n      return builtInLoaded\r\n        .then(function() {\r\n          var localFile = createdFilesIndex.filter(function(x) {return x.id === id; })[0];\r\n          if (localFile) {\r\n            builtIn = true;\r\n            return localFile;\r\n          }\r\n\r\n          return storageIndex.getEntry(id);\r\n        })\r\n        .then(function(localFile) {\r\n          return localforage.getItem(id)\r\n            .then(function(serialized) {\r\n              if (serialized) {\r\n                var contents = MUSIC.Formats.MultiSerializer.deserialize(localFile.type, serialized);\r\n                return {\r\n                  index: {\r\n                    name: localFile.name,\r\n                    id: localFile.id,\r\n                    builtIn: builtIn,\r\n                    type: localFile.type,\r\n                    ref: localFile.ref||getRefs(localFile.type, contents),\r\n                    updated: true,\r\n                    project: localFile.project\r\n                  },\r\n                  contents: contents\r\n                };\r\n              } else {\r\n                if (localFile) {\r\n                  return {\r\n                    index: {\r\n                      name: localFile.name,\r\n                      id: localFile.id,\r\n                      builtIn: builtIn,\r\n                      type: localFile.type,\r\n                      ref: localFile.ref,\r\n                      project: localFile.project,\r\n                      noExportable: localFile.noExportable\r\n                    },\r\n                    contents: JSON.parse(JSON.stringify(createdFiles[id]))\r\n                  };\r\n                };\r\n              }\r\n            });\r\n        });\r\n    };  \r\n\r\n  var createFile = function(options) {\r\n    var newid = options.id || createId();\r\n\r\n    var contents = options.contents || defaultFile[options.type] || {};\r\n\r\n    return $q.all({\r\n      defaultMeasure: getDefaultMeasure(options),\r\n      defaultBPM: getDefaultBPM(options)\r\n    }).then(function(value) {\r\n      contents.measure = parseInt(value.defaultMeasure);\r\n      contents.bpm = parseInt(value.defaultBPM);\r\n    }).then(function() {\r\n      hist[newid] = hist[newid] || Historial();\r\n      hist[newid].registerVersion(JSON.stringify(contents));\r\n\r\n      var serialized = MUSIC.Formats.MultiSerializer.serialize(options.type, contents);\r\n      return localforage.setItem(newid, serialized)\r\n    }).then(function() {\r\n        return storageIndex.createEntry({\r\n          type: options.type,\r\n          name: options.name,\r\n          project: options.project,\r\n          id: newid,\r\n          ref: options.ref\r\n        });\r\n    })\r\n    .then(function() {\r\n      return recycleIndex.reload();\r\n    })\r\n    .then(function() {\r\n        genericStateEmmiter.emit(\"changed\");\r\n        recycledEmmiter.emit(\"changed\");\r\n        return newid;\r\n    })\r\n    .catch(function(err) {\r\n      debugger;\r\n    });\r\n  };\r\n\r\n\r\n  var s0 = MUSIC.Formats.JSONSerializer;\r\n  var s1 = MUSIC.Formats.CachedSerializer(MUSIC.Formats.PackedJSONSerializer);\r\n  var s2 = MUSIC.Formats.HuffmanSerializerWrapper(s0);\r\n  var s3 = MUSIC.Formats.HuffmanSerializerWrapper(s1);\r\n  var s4 = MUSIC.Formats.CachedSerializer(MUSIC.Formats.PackedJSONSerializerB);\r\n  var s5 = MUSIC.Formats.HuffmanSerializerWrapper(s4);\r\n\r\n  MUSIC.Formats.MultiSerializer.setSerializers([\r\n    {serializer: s0, base: '0'},\r\n    {serializer: s1, base: '1'},\r\n    {serializer: s2, base: '2'},\r\n    {serializer: s3, base: '3'},\r\n    {serializer: s4, base: '4'},\r\n    {serializer: s5, base: '5'}\r\n  ]);\r\n\r\n  var storageIndex = Index(\"index\");\r\n  var recycleIndex = Index(\"recycle\");\r\n\r\n  recycleIndex.getAll().then(function() {\r\n    recycledEmmiter.emit(\"changed\");\r\n  });\r\n\r\n  var changed = function() {\r\n    genericStateEmmiter.emit(\"changed\");\r\n    recycledEmmiter.emit(\"changed\");\r\n  };\r\n\r\n  var getRefs = function(type, contents) {\r\n    var ref = [];\r\n    if (type === 'song') {\r\n      contents.tracks.forEach(function(track) {\r\n        for (var i=0;i<track.blocks.length;i++) {\r\n          var blockId = track.blocks[i].id;\r\n          if (blockId && ref.indexOf(blockId) === -1) ref.push(blockId);\r\n        }\r\n      });\r\n    } else if (type === 'pattern') {\r\n      contents.tracks.forEach(function(track) {\r\n        if (track.instrument && ref.indexOf(track.instrument) === -1) ref.push(track.instrument);\r\n      });\r\n    }\r\n\r\n    return ref;\r\n  };\r\n\r\n  var getProjectFiles = function(projectId) {\r\n    return storageIndex.getAll()\r\n      .then(function(idx) {\r\n        return idx.concat(createdFilesIndex).filter(function(file) {\r\n          return file.project === projectId || file.id === projectId;\r\n        });\r\n      });\r\n  };\r\n\r\n  return {\r\n    getRefs: getRefs,\r\n    getProjectFiles: getProjectFiles,\r\n    undo: function(id) {\r\n      var oldVer = hist[id].undo();\r\n      if (!oldVer) return;\r\n\r\n      return updateFile(id, JSON.parse(oldVer), {noHistory: true});\r\n    },\r\n    redo: function(id) {\r\n      var nextVer = hist[id].redo();\r\n      if (!nextVer) return;\r\n\r\n      return updateFile(id, JSON.parse(nextVer), {noHistory: true});\r\n    },\r\n    purgeFromRecycleBin: purgeFromRecycleBin,\r\n    moveToRecycleBin: moveToRecycleBin,\r\n    restoreFromRecycleBin: restoreFromRecycleBin,\r\n    destroyFile: destroyFile,\r\n    createFile: createFile,\r\n    changed: changed,\r\n    updateIndex: function(id, attributes) {\r\n      var localFile = createdFilesIndex.filter(function(x) { return x.id === id; })[0];\r\n      if (localFile) {\r\n        localFile.name = attributes.name;\r\n        genericStateEmmiter.emit(\"changed\");\r\n        return $q.when(localFile);\r\n      }\r\n\r\n      return storageIndex.updateEntry(id, attributes)\r\n        .then(function() {\r\n          genericStateEmmiter.emit(\"changed\");\r\n        });\r\n    },\r\n    getIndex: function(id) {\r\n      var localFile = createdFilesIndex.filter(function(x) { return x.id === id; })[0];\r\n      if (localFile) return $q.when(localFile);\r\n\r\n      return storageIndex.getEntry(id);\r\n    },\r\n    updateFile: updateFile,\r\n    getFile: getFile,\r\n    observeRecycled: function(callback) {\r\n      recycleIndex.reload()\r\n        .then(function() {\r\n          recycledEmmiter.emit(\"changed\");\r\n        });\r\n\r\n      recycledEmmiter.addListener(\"changed\", callback);\r\n\r\n      return {\r\n        destroy: function() {\r\n          recycledEmmiter.removeListener(\"changed\", callback);\r\n        }\r\n      };\r\n    },\r\n    searchRecycled: function(keyword, options) {\r\n      options = options || {};\r\n      var limit = typeof options.limit === 'undefined' ? 10 : options.limit;\r\n      var hasKeyword = function() { return true };\r\n      if (keyword && keyword.length > 0) {\r\n        keyword = keyword.toLowerCase();\r\n        hasKeyword = function(x) { return x.name.toLowerCase().indexOf(keyword) !== -1 };\r\n      }\r\n\r\n      return recycleIndex.getAll().then(function(index) {\r\n        var filtered = (index||[]).filter(hasKeyword).reverse();\r\n        return {\r\n          results: limit ? filtered.slice(0,limit) : filtered,\r\n          total: filtered.length\r\n        };\r\n      });\r\n    },\r\n    search: function(keyword, options) {\r\n      options = options || {};\r\n\r\n      var hasKeyword = function() { return true };\r\n      if (keyword && keyword.length > 0) {\r\n        keyword = keyword.toLowerCase();\r\n        hasKeyword = function(x) { return x.name.toLowerCase().indexOf(keyword) !== -1 };\r\n      }\r\n\r\n      var byProject = function() { return true };\r\n      if (options.project) {\r\n        byProject = function(x) {\r\n          if (options.type) {\r\n            if (options.type.indexOf(x.type) === -1) return false;\r\n          }\r\n          return x.type === 'tempo' || options.project.indexOf(x.project) !== -1;\r\n        };\r\n      } else {\r\n        if (options.type) {\r\n          byProject = function(x) {\r\n            if (options.type.indexOf(x.type) === -1) return false;\r\n            return true\r\n          };\r\n        }\r\n      }\r\n\r\n      var ee = new EventEmitter();\r\n      var updateSearch = function() {\r\n        builtInLoaded\r\n          .then(function() {\r\n            $q.all([\r\n              storageIndex.getAll(),\r\n              createdFilesIndex,\r\n              TypeService.getTypes(keyword)\r\n            ]).then(function(result) {\r\n              var notInRes = function(item) {\r\n                return true;\r\n//                return ids.indexOf(item.id) === -1;\r\n              };\r\n\r\n              var res = result[0]||[];\r\n              var ids = res.map(function(x){ return x.id; });\r\n              if (result[1]) res = res.concat(result[1].filter(notInRes));\r\n              res = res.concat(result[2].map(convertType));\r\n              res = res.filter(hasKeyword).filter(byProject);\r\n\r\n              ee.emit(\"changed\", {\r\n                results: res.slice(0,15),\r\n                total: res.length\r\n              });\r\n            });\r\n          });\r\n      };\r\n\r\n      return {\r\n        observe: function(cb) {\r\n          ee.addListener(\"changed\", cb);\r\n          genericStateEmmiter.addListener(\"changed\", updateSearch);\r\n          updateSearch();\r\n\r\n          return {\r\n            close: function() {\r\n              ee.removeListener(\"changed\", cb);\r\n              genericStateEmmiter.removeListener(\"changed\", updateSearch);\r\n            }\r\n          };\r\n        }\r\n      };\r\n    }\r\n  };\r\n}]);\r\n\r\nvar convertType = function(type) {\r\n  return {\r\n    type: \"fx\",\r\n    name: type.name,\r\n    id: \"type\"+ type.name,\r\n    project: 'core'\r\n  };\r\n};\r\n\r\nmusicShowCaseApp.factory(\"pruneWrapper\", function() {\r\n  return function(fcn) {\r\n    if (!fcn._wrapper) {\r\n      fcn._wrapper = function(music, modWrapper) {\r\n        var sfxBase = music.sfxBase();\r\n        var obj = fcn(sfxBase, modWrapper);\r\n        var originalDispose;\r\n\r\n        if (obj.dispose) {\r\n          originalDispose = obj.dispose.bind(obj); \r\n          obj.dispose = function() {\r\n            originalDispose();\r\n            sfxBase.prune();\r\n          };\r\n        } else {\r\n          obj.dispose = function() {\r\n            sfxBase.prune();\r\n          };\r\n        }\r\n\r\n        return obj;\r\n      };\r\n    }\r\n    return fcn._wrapper;\r\n  };\r\n});\r\n\r\nmusicShowCaseApp.factory(\"sfxBaseOneEntryCacheWrapper\", function() {\r\n    return function(fcn){\r\n      var _lastmusic;\r\n      var _lastinstance;\r\n      var ret = function(music, options) {\r\n        options = options ||{};\r\n\r\n        if (!options.nowrap) {\r\n          if (_lastmusic && _lastmusic === music) {\r\n            return _lastinstance;\r\n          }\r\n        }\r\n\r\n        _lastmusic = music;\r\n        _lastinstance = fcn(music, options);\r\n\r\n        return _lastinstance;\r\n      };\r\n\r\n      ret.update = function() {\r\n        fcn.update.bind(fcn).apply(null, arguments);\r\n        return ret;\r\n      };\r\n      return ret;\r\n    };\r\n});\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\nmusicShowCaseApp.factory(\"ErrMessage\", ['$uibModal', '$translate', function($uibModal, $translate) {\r\n  return function(title, text) {\r\n    var modalIns = $uibModal.open({\r\n      templateUrl: \"site/templates/modal/error.html\",\r\n      controller: \"errorModalCtrl\",\r\n      windowClass: 'error',\r\n      resolve: {\r\n        text: function() {\r\n          return $translate(text);\r\n        },\r\n        title: function() {\r\n          return $translate(title);\r\n        }\r\n      }\r\n    });\r\n\r\n    return modalIns;\r\n  };\r\n}]);\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\nmusicShowCaseApp.factory(\"Export\", ['$q', 'FileRepository', function($q, FileRepository) {\r\n  var exportContents = function(name, contents) {\r\n    var a = document.createElement(\"a\");\r\n    document.body.appendChild(a);\r\n    a.style = \"display: none\";\r\n\r\n    var blob = new Blob([JSON.stringify(contents)]);\r\n    var url  = window.URL.createObjectURL(blob);\r\n    a.href = url;\r\n    a.download = name + \".json\";\r\n    a.click();\r\n    window.URL.revokeObjectURL(url);\r\n  };\r\n\r\n  var getRelatedIds = function(file) {\r\n    if (file.index.type === 'project') {\r\n      return (file.index.ref||[]);\r\n    } else {\r\n      var ret = FileRepository.getRefs(file.index.type, file.contents);\r\n      if (file.index.project) ret.push(file.index.project);\r\n      return ret;\r\n    }\r\n  };\r\n\r\n  var concat = function(x, y) {return x.concat(y); };\r\n  var getFileWithRelated = function(id) {\r\n    var ret = [];\r\n    return FileRepository.getFile(id)\r\n      .then(function(file) {\r\n        if (!file) return [];\r\n        if (file.index.noExportable) {\r\n          return [];\r\n        }\r\n\r\n        ret.push({\r\n          name: file.index.name,\r\n          type: file.index.type,\r\n          id: file.index.id,\r\n          contents: file.contents,\r\n          project: file.index.project,\r\n          ref: file.index.ref\r\n        });\r\n\r\n        return $q.all(getRelatedIds(file).map(getFileWithRelated))\r\n          .then(function(relarray) {\r\n            relarray.forEach(function(rel) {\r\n              ret = ret.concat(rel);\r\n            });\r\n            return ret;\r\n          });\r\n      });\r\n  };\r\n\r\n  var uniq = function(array) {\r\n    var files = {};\r\n    array.forEach(function(file) {\r\n      files[file.id] = file;\r\n    });\r\n\r\n    return Object.keys(files).map(function(id) {\r\n      return files[id];\r\n    });\r\n  };\r\n\r\n  var exportProject = function(name, id) {\r\n    var getId = function(x) { return x.id; };\r\n\r\n    FileRepository.getProjectFiles(id)\r\n      .then(function(files) {\r\n        return $q.all(files.map(getId).map(getFileWithRelated));\r\n      })\r\n      .then(function(array){\r\n        array = array.reduce(concat, []);\r\n        exportContents(name, uniq(array));\r\n      });\r\n  };\r\n\r\n  var exportFile = function(name, id) {\r\n    return getFileWithRelated(id)\r\n      .then(function(array) {\r\n        exportContents(name, uniq(array));\r\n      });\r\n  };\r\n\r\n  var importFile = function(contents) {\r\n    var importItem = function(item) {\r\n      return function() {\r\n        return FileRepository.getIndex(item.id)\r\n          .then(function(index) {\r\n            if (index) {\r\n              return FileRepository.updateFile(item.id, item.contents)\r\n                .then(function() {\r\n                  return FileRepository.updateIndex(item.id, {\r\n                    name: item.name,\r\n                    project: item.project\r\n                  });\r\n                });\r\n            } else {\r\n              return FileRepository.purgeFromRecycleBin(item.id)\r\n                .then(function() {\r\n                  return FileRepository.createFile({\r\n                    id: item.id,\r\n                    contents: item.contents,\r\n                    type: item.type,\r\n                    name: item.name,\r\n                    project: item.project,\r\n                    ref: item.ref\r\n                  });\r\n                });\r\n            }\r\n          });\r\n      };\r\n    };\r\n\r\n    return $q.when()\r\n      .then(function() {\r\n        var p = null;\r\n        var parsed = JSON.parse(contents);\r\n        var firstItem = parsed[0];\r\n\r\n        parsed.forEach(function(item) {\r\n          if (p) {\r\n            p = p.then(importItem(item));\r\n          } else {\r\n            p = importItem(item)();\r\n          }\r\n        });\r\n\r\n        return p.then(function() {\r\n          return {id: firstItem.id, type: firstItem.type, project: firstItem.project};\r\n        });\r\n      });\r\n  };\r\n\r\n  return {\r\n    exportContents: exportContents,\r\n    exportFile: exportFile,\r\n    exportProject: exportProject,\r\n    importFile: importFile\r\n  };\r\n}]);\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\nmusicShowCaseApp.factory(\"Index\", ['$q', '$timeout', 'Sync', '_localforage', function($q, $timeout, Sync, localforage) {\r\n  function CantRemove(id, file) {\r\n      this.id = id;\r\n      this.file = file;\r\n      this.stack = (new Error()).stack;\r\n      this.type = \"cantremove\";\r\n  }\r\n  CantRemove.prototype = new Error\r\n\r\n  var IndexFactory = function(indexName) {\r\n    var entryChange = new Sync();\r\n\r\n    var reload = function() {\r\n      // load stoargeIndex\r\n      var storageIndex;\r\n      storageIndex = localforage.getItem(indexName)\r\n        .then(function(array){\r\n          return array||[];\r\n        });\r\n      return storageIndex;\r\n    };\r\n\r\n    var clearItem = function(data) {\r\n      var ret = {id: data.id, name: data.name, type: data.type, project: data.project, ref: data.ref};\r\n      if (data.c) ret.c=data.c;\r\n      return ret;\r\n    };\r\n\r\n    var removeEntry = entryChange.sync(function(id) {\r\n      return reload()\r\n        .then(function(index) {\r\n          if (!index) return;\r\n          index = index.filter(function(x) { return x.id !== id; });\r\n          return localforage.setItem(indexName, index.map(clearItem));\r\n        })\r\n        .then(reload);\r\n    });\r\n\r\n    var getEntry = function(id) {\r\n      return reload()\r\n        .then(function(index) {\r\n          if (!index) return null;\r\n          return index.filter(function(x) { return x.id === id; })[0];\r\n        });\r\n    };\r\n\r\n    var createEntry = entryChange.sync(function(data) {\r\n      return reload()\r\n        .then(function(index) {\r\n          index = index || [];\r\n\r\n          if (IndexFactory.isolatedContext) {\r\n            data.c = IndexFactory.isolatedContext;\r\n          }\r\n\r\n          index.push(data);\r\n          return localforage.setItem(indexName, index.map(clearItem));\r\n        })\r\n        .then(reload);\r\n    });\r\n\r\n    var updateEntry = entryChange.sync(function(id, attributes) {\r\n      return reload()\r\n        .then(function(index) {\r\n          var localFile = index.filter(function(x) { return x.id === id; })[0];\r\n          localFile.name = attributes.name;\r\n          localFile.ref = attributes.ref;\r\n\r\n          if (IndexFactory.isolatedContext) {\r\n            localFile.c = IndexFactory.isolatedContext;\r\n          }\r\n\r\n          return localforage.setItem(indexName, index.map(clearItem));\r\n        })\r\n        .then(reload);\r\n    });\r\n\r\n    var getAll = function() {\r\n      return reload()\r\n        .then(function(index) {\r\n          var ic = IndexFactory.isolatedContext;\r\n          if (ic) {\r\n            return index.filter(function(entry) {return entry.c === ic; });\r\n          }\r\n          return index;\r\n        });\r\n    };\r\n\r\n    var refs = function(index, id) {\r\n      return index.filter(function(file) {\r\n        return (file.ref||[]).indexOf(id) !== -1;\r\n      });\r\n    };\r\n\r\n    var isProjectType = function(file) {\r\n      return file.type === 'project';\r\n    };\r\n\r\n    var getId = function(file) {\r\n      return file.id;\r\n    };\r\n\r\n    var willRemove = function(id) {\r\n      return reload()\r\n        .then(function(index) {\r\n          var localFile = index.filter(function(x) { return x.id === id; })[0];\r\n\r\n          if (!localFile) return;\r\n\r\n          var r = refs(index, id);\r\n          // if the item has no references, it can be removed!\r\n          if (r.length === 0) return;\r\n\r\n          if (localFile.type === 'project') {\r\n            if (r.some(isProjectType)) {\r\n              throw new CantRemove(id, localFile);\r\n            }\r\n          } else {\r\n            throw new CantRemove(id, localFile);\r\n          }\r\n\r\n          return $q.all(r.map(getId).map(willRemove));\r\n        });\r\n    };\r\n\r\n    var getOrphan = function(extraIds, extraProjectIds) {\r\n      return reload()\r\n        .then(function(index) {\r\n          var projectIds = index.filter(isProjectType).map(getId).concat(extraProjectIds);\r\n          var ids = index.map(getId).concat(extraIds||[]);\r\n          var isOrphan = function(file) {\r\n            if (file.project) {\r\n              if (projectIds.indexOf(file.project) === -1) {\r\n                return true;\r\n              }\r\n            }\r\n            return (file.ref||[]).some(function(id) {\r\n              return ids.indexOf(id) === -1;\r\n            });\r\n          };\r\n\r\n          return index.filter(isOrphan);\r\n        });\r\n    };\r\n\r\n    var getFreeItems = function() {\r\n      return reload()\r\n        .then(function(index) {\r\n          var referenced = {};\r\n          index.forEach(function(file) {\r\n            (file.ref||[]).forEach(function(r) {\r\n              referenced[r]=true;\r\n            });\r\n          });\r\n\r\n          return index.filter(function(file) {\r\n            return !referenced[file.id];\r\n          });\r\n        });\r\n    };\r\n\r\n    reload();\r\n\r\n    return {\r\n      willRemove: willRemove,\r\n      reload: reload,\r\n      removeEntry: removeEntry,\r\n      getOrphan: getOrphan,\r\n      getEntry: getEntry,\r\n      getFreeItems: getFreeItems,\r\n      createEntry: createEntry,\r\n      updateEntry: updateEntry,\r\n      getAll: getAll\r\n    };\r\n  };\r\n\r\n  return IndexFactory;\r\n}]);\r\n","var musicJs = angular.module(\"MusicShowCaseApp\");\r\nmusicJs.factory(\"Midi\", ['$q', 'Sync', '_localforage', function($q, Sync, localforage) {\r\n  var setupStore = new Sync();\r\n  var midiSetupRequested;\r\n  var midiLoaded;\r\n  var storeInputEnabled = setupStore.sync(function(inputId, enabled) {\r\n    return localforage.getItem(\"midiSetup\")\r\n      .then(function(midiSetup) {\r\n        midiSetup = midiSetup || {};\r\n        midiSetup.inputs = midiSetup.inputs || {};\r\n        midiSetup.inputs[inputId] = enabled;\r\n\r\n        return localforage.setItem(\"midiSetup\", midiSetup);\r\n      });\r\n  });\r\n\r\n  var midiAccessRequested;\r\n  if (navigator.requestMIDIAccess) {\r\n      midiAccessRequested = navigator.requestMIDIAccess({ sysex: false });\r\n  }\r\n\r\n  var wrapInput = function(input) {\r\n    var enable = function() {\r\n      input.onmidimessage = onMIDIMessage;\r\n      input.enabled = true;\r\n\r\n      storeInputEnabled(input.id, true);\r\n    };\r\n\r\n    var disable = function() {\r\n      input.onmidimessage = null;\r\n      input.enabled = false;\r\n\r\n      storeInputEnabled(input.id, false);\r\n    };\r\n\r\n    var update = function() {\r\n      if (this.enabled) {\r\n        enable()\r\n      } else {\r\n        disable();\r\n      }\r\n    };\r\n\r\n    var ret = {\r\n      enabled: !!input.onmidimessage,\r\n      enable: enable,\r\n      disable: disable,\r\n      update: update,\r\n      name: input.name,\r\n      id: input.id\r\n    };\r\n\r\n    return ret;\r\n  };\r\n\r\n  var getStatus = function() {\r\n    return midiLoaded\r\n      .then(function() {\r\n        return midiAccessRequested\r\n      })\r\n      .then(function(midiAccess) {\r\n        var data = {connected: false};\r\n        var inputs = midiAccess.inputs.values();\r\n\r\n        for (var input = inputs.next(); input && !input.done; input = inputs.next()) {\r\n          if (input.value.onmidimessage) {\r\n            data.connected = true;\r\n          }\r\n        }\r\n        return data;\r\n      });\r\n  };\r\n\r\n  var getInputs = function() {\r\n    return midiAccessRequested\r\n      .then(function(midiAccess) {\r\n        var retInputs = [];\r\n        var inputs = midiAccess.inputs.values();\r\n\r\n        for (var input = inputs.next(); input && !input.done; input = inputs.next()) {\r\n            retInputs.push(wrapInput(input.value));\r\n        }\r\n        return retInputs;\r\n      });\r\n  };\r\n\r\n  var eventListeners = [];\r\n  var registerEventListener = function(callback) {\r\n    var destroy = function() {\r\n      eventListeners = eventListeners.filter(function(c) { return c !== callback; });\r\n    };\r\n\r\n    eventListeners.push(callback);\r\n\r\n    return {\r\n      destroy: destroy\r\n    };\r\n  };\r\n\r\n  var onMIDIMessage = function(event) {\r\n    midiSetupRequested.then(function(cfg) {\r\n      event.data[1] = event.data[1] - cfg.octave*12 + cfg.transpose;\r\n      eventListeners.forEach(function(callback) {\r\n        callback(event);\r\n      });\r\n    });\r\n  };\r\n\r\n  var reloadConfig = function() {\r\n    midiSetupRequested = localforage.getItem(\"midiSetup\")\r\n      .then(function(midiSetup) {\r\n        if (!midiSetup) midiSetup = {};\r\n        if (typeof midiSetup.octave === 'undefined') midiSetup.octave = 3;\r\n        if (typeof midiSetup.transpose === 'undefined') midiSetup.transpose = 0;\r\n\r\n        return midiSetup;\r\n      });\r\n  };\r\n\r\n  reloadConfig();\r\n\r\n  midiLoaded = $q.all({\r\n    inputs: getInputs(),\r\n    midiSetup: midiSetupRequested\r\n  }).then(function(result) {\r\n    var midiSetup = result.midiSetup;\r\n\r\n    if (midiSetup && midiSetup.inputs) {\r\n      result.inputs.forEach(function(input) {\r\n        if (midiSetup.inputs[input.id]) {\r\n          input.enable();\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n  var getConfig = function() {\r\n    return midiSetupRequested;\r\n  };\r\n\r\n  var setConfig = setupStore.sync(function(cfg) {\r\n    return localforage.getItem(\"midiSetup\")\r\n      .then(function(midiSetup) {\r\n        midiSetup = midiSetup || {};\r\n        midiSetup.inputs = midiSetup.inputs || {};\r\n        midiSetup.octave = cfg.octave;\r\n        midiSetup.transpose = cfg.transpose;\r\n\r\n        return localforage.setItem(\"midiSetup\", midiSetup);\r\n      })\r\n      .then(reloadConfig);\r\n  });\r\n\r\n  return {\r\n    getInputs: getInputs,\r\n    registerEventListener: registerEventListener,\r\n    getStatus: getStatus,\r\n    getConfig: getConfig,\r\n    setConfig: setConfig\r\n  };\r\n}]);\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\nmusicShowCaseApp.factory(\"Recipe\", ['$q', '$timeout', '$rootScope', '$http', 'Index', 'FileRepository', function($q, $timeout, $rootScope, $http, Index, FileRepository) {\r\n\r\n    var recipeList = ['intro', 'create_a_song', 'create_an_instrument'];\r\n    var blinks = [];\r\n\r\n    var currentRecipe = {\r\n      steps: [],\r\n      currentStep: 0\r\n    };\r\n\r\n    var handleEvent = function(event, args) {\r\n      var step = currentRecipe.steps[currentRecipe.currentStep];\r\n\r\n      if (!step) return;\r\n      if (step.eventHandler) step.eventHandler(event, args);\r\n    };\r\n\r\n    var runRecipeStep = function(currentStep) {\r\n      currentStep = currentStep||currentRecipe.currentStep;\r\n\r\n      var step = currentRecipe.steps[currentStep];\r\n\r\n      blinks = [];\r\n\r\n      $rootScope.$broadcast(\"__blink_disable_all\");\r\n      $rootScope.$broadcast(\"__tooltip_hide_all\");\r\n      if (!step) {\r\n        // recipe ends\r\n        Index.isolatedContext = null;\r\n        FileRepository.changed();\r\n\r\n        return;\r\n      }\r\n\r\n      (step.blink||[]).forEach(function(blink_id) {\r\n        blinks.push(blink_id);\r\n        $rootScope.$broadcast(\"_blink_enable_\" + blink_id);\r\n      });\r\n\r\n      for (var tooltip_id in step.tooltip||{}) {\r\n        $rootScope.$broadcast(\"_tooltip_display_\" + tooltip_id, {text: step.tooltip[tooltip_id]});\r\n      }\r\n\r\n      if (step.duration) {\r\n        $timeout(function() {\r\n          if (currentRecipe.currentStep <= currentStep) {\r\n            currentRecipe.currentStep = currentStep + 1;\r\n            runRecipeStep();\r\n          }\r\n        }, step.duration*1000);\r\n      }\r\n    };\r\n\r\n    var next_step_on = function(eventName) {\r\n      return function(event, args) {\r\n        if (event === eventName) {\r\n          currentRecipe.currentStep++;\r\n          runRecipeStep();\r\n        }\r\n      }\r\n    };\r\n\r\n    var delay = function(fcn, ms) {\r\n      return function(event, args) {\r\n        $timeout(function() {\r\n          fcn(event, args);\r\n        }, ms);\r\n      };\r\n    };\r\n\r\n    var getLocaleName = function(stepIndex, tooltipName) {\r\n       return \"s\"+stepIndex+\"_tooltip_\" + tooltipName;\r\n    };\r\n\r\n    var start = function(name) {\r\n      var loadEventHandler = function(eventHandlerData) {\r\n        if (eventHandlerData.next_step_on) {\r\n          return next_step_on(eventHandlerData.next_step_on);\r\n        } else if (eventHandlerData.delay) {\r\n          return delay(loadEventHandler(eventHandlerData.inner), eventHandlerData.delay);\r\n        }\r\n      };\r\n\r\n      var loadStep = function(stepData, stepIndex) {\r\n\r\n        var tr = {};\r\n        for (var k in stepData.tooltip) {\r\n          tr[k] = \"recipe\" + \".\" + name + \".\" + getLocaleName(stepIndex, k);\r\n        }\r\n\r\n        return {\r\n          blink: stepData.blink,\r\n          tooltip: tr,\r\n          eventHandler: loadEventHandler(stepData.eventHandler),\r\n          duration: stepData.duration\r\n        };\r\n      };\r\n\r\n      var createFile = function(file) {\r\n        return FileRepository.destroyFile(file.index.id)\r\n          .then(function() {\r\n            return FileRepository.createFile({\r\n              id: file.index.id,\r\n              type: file.index.type,\r\n              project: file.index.project,\r\n              name: file.index.name,\r\n              contents: file.contents\r\n            });\r\n          });\r\n      };\r\n\r\n      var createFiles = function(result) {\r\n        return $q.all((result.data.files||[]).map(createFile))\r\n          .then(function() {\r\n            return result;\r\n          });\r\n      };\r\n\r\n      var switchProject = function(result) {\r\n        if (result.data.project) {\r\n          document.location = \"#/editor/\"+ result.data.project;\r\n        }\r\n\r\n        return result;\r\n      };\r\n\r\n      return $http.get(\"recipes/\" + name +\".json\")\r\n        .then(createFiles)\r\n        .then(switchProject)\r\n        .then(function(result) {\r\n          var recipeData = result.data;\r\n\r\n          if (result.data.isolatedContext) {\r\n            Index.isolatedContext = result.data.isolatedContext + Math.floor(Date.now() / 1000);\r\n            FileRepository.changed();\r\n          }\r\n\r\n          currentRecipe.steps = recipeData.steps.map(loadStep);\r\n          currentRecipe.currentStep = 0;\r\n          runRecipeStep();     \r\n        });\r\n    };\r\n\r\n    start.raise = function(name) {\r\n      handleEvent(name);\r\n    };\r\n\r\n    var loadTranslations = function(options) {\r\n      var key = options.key;\r\n\r\n      var loadRecipeTranslation = function(name) {\r\n        return $http.get(\"recipes/\" + name +\".json\")\r\n          .then(function(result) {\r\n            var recipeData = result.data;\r\n            if (!recipeData.lang) return {};\r\n\r\n            var langIndex = recipeData.lang.indexOf(key);\r\n            if (langIndex === -1) return {}\r\n\r\n            var data = {};\r\n            recipeData.steps.forEach(function(step, stepIndex) {\r\n              if (step.tooltip) {\r\n                for (var k in step.tooltip) {\r\n                  var tp = step.tooltip[k];\r\n                  var localeName = getLocaleName(stepIndex, k);\r\n                  if (Array.isArray(tp)) {\r\n                    data[localeName] = tp[langIndex];\r\n                  } else {\r\n                    if (langIndex===0) {\r\n                      data[localeName] = tp;\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n            });\r\n\r\n            return data;\r\n          });\r\n      };\r\n\r\n      var actions = {};\r\n      recipeList.forEach(function(recipeId) {\r\n        actions[recipeId] = loadRecipeTranslation(recipeId);\r\n      });\r\n\r\n      return $q.all(actions)\r\n        .then(function(recipeTranslationData) {\r\n          return {\r\n            recipe: recipeTranslationData\r\n          };\r\n        })\r\n    };\r\n\r\n    var getBlinks = function() {\r\n      return blinks;\r\n    };\r\n\r\n    return {\r\n      start: start,\r\n      step: runRecipeStep,\r\n      handleEvent: handleEvent,\r\n      loadTranslations: loadTranslations,\r\n      getBlinks: getBlinks\r\n    };\r\n}]);\r\n","var musicJs = angular.module(\"MusicShowCaseApp\");\r\nmusicJs.factory(\"Sync\", ['$q', function($q) {\r\n  return function() {\r\n    var promise = $q.when();\r\n    this.sync = function(f) {\r\n      return function() {\r\n        var _args = arguments;\r\n        var _self = this;\r\n        var defer = $q.defer();\r\n\r\n        promise = promise.then(function() {\r\n          return f.apply(_self, _args)\r\n            .then(function(value) {\r\n              defer.resolve(value);\r\n            })\r\n            .catch(function(err) {\r\n              defer.reject(err);\r\n            });\r\n        });\r\n        return defer.promise;\r\n      };\r\n    };\r\n  };\r\n}]);\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\nmusicShowCaseApp.factory(\"translationsLoader\", ['$q', 'TypeService', 'esTranslations', 'enTranslations', 'Recipe', function($q, TypeService, esTranslations, enTranslations, Recipe) {\r\n    return function(options) {\r\n      var baseTranslation = {}\r\n\r\n      if (options.key==='es') {\r\n        baseTranslation = esTranslations;\r\n      }\r\n\r\n      if (options.key==='en') {\r\n        baseTranslation = enTranslations;\r\n      }\r\n\r\n      var addTranslations = function(tr) {\r\n        for (var k in tr) {\r\n          baseTranslation[k] = tr[k];\r\n        }\r\n      };\r\n\r\n      return $q.all({\r\n        typeTranslations: TypeService.loadTranslations(options),\r\n        recipeTranslations: Recipe.loadTranslations(options)\r\n      })\r\n        .then(function(result) {\r\n          addTranslations(result.typeTranslations);\r\n          addTranslations(result.recipeTranslations);\r\n\r\n          return baseTranslation;\r\n        })\r\n    };\r\n}]);\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\n\r\nvar ObjectCache = function() {\r\n  var wm = new WeakMap();\r\n  this.get = function(music, object) {\r\n    var array = wm.get(music);\r\n    var strobj = JSON.stringify(object);\r\n\r\n    if (!array) return undefined;\r\n\r\n    var elem = array.filter(function(x) {\r\n      return x.obj === strobj;\r\n    })[0];\r\n\r\n    return elem && elem.value;\r\n  };\r\n\r\n  this.set = function(music, object, value) {\r\n    var array = wm.get(music);\r\n    var strobj = JSON.stringify(object);\r\n\r\n    if (!array) {\r\n      array = [];\r\n    }\r\n\r\n    var elem = array.filter(function(x) {\r\n      return x.obj === strobj;\r\n    })[0];\r\n\r\n    if (elem) {\r\n      elem.value = value;\r\n    } else {\r\n      array.push({obj: strobj, value: value});\r\n    }\r\n\r\n    if (array.length > 8) array = array.slice(1);\r\n\r\n    wm.set(music, array);\r\n  };\r\n};\r\n\r\nmusicShowCaseApp.service(\"TypeService\", [\"$http\", \"$q\", function($http, $q) {\r\n  var make_mutable = function(fcn, options) {\r\n    var cacheData = new ObjectCache();\r\n\r\n    var cacheWrap = function(object, baseMusic) {\r\n      var originalPrune = baseMusic.prune;\r\n      baseMusic.prune = function() {\r\n        cacheData = new ObjectCache();\r\n\r\n        if (originalPrune) {\r\n          return originalPrune.apply(this, arguments);\r\n        }\r\n      };\r\n\r\n      return function(constructor) {\r\n        return function(music, params){\r\n          var key = baseMusic;\r\n          if (key.getOriginal) key = key.getOriginal();\r\n          cacheData.set(key, object, music)\r\n\r\n          return constructor(music, params);\r\n        };\r\n      };\r\n    };\r\n\r\n    return function(object, subobjects, components) {\r\n      var current;\r\n      var instances = [];\r\n\r\n      if (options && options.reusableNode) {\r\n        current = function(music, params) {\r\n          var wrapped = subobjects[0];\r\n          var constructor = fcn(object, subobjects.map(cacheWrap(object, music)), components); \r\n          var key = music;\r\n          if (key.getOriginal) key = key.getOriginal();\r\n\r\n          var newBase = cacheData.get(key, object);\r\n          if (newBase) {\r\n            return wrapped(newBase);\r\n          } else {\r\n            return constructor(music, params);\r\n          }\r\n        }\r\n      } else {\r\n        current = fcn(object, subobjects, components);\r\n      }\r\n\r\n      if (current.update) {\r\n        return current;\r\n      }\r\n\r\n      var ret = function(music, options) {\r\n        var r;\r\n        var wrapped = {};\r\n        var lastCurrent = current;\r\n        var proxy = function(name) {\r\n          wrapped[name] = function() {\r\n            if (lastCurrent != current) update();\r\n            return r[name].apply(r, arguments);\r\n          };\r\n        };\r\n\r\n        var update = function() {\r\n            var newr = current(music, options);\r\n            if (newr !== r && r && r.dispose) r.dispose();\r\n            r = newr;\r\n\r\n            instances.push(newr);\r\n\r\n            lastCurrent = current;\r\n            for (var k in r) proxy(k);\r\n        };\r\n\r\n        update();\r\n\r\n        return wrapped;\r\n      };\r\n\r\n      var lastObjData;\r\n      ret.update = function(newobject, _components) {\r\n        components = _components\r\n        if (JSON.stringify(newobject) === lastObjData) return ret;\r\n        lastObjData = JSON.stringify(newobject);\r\n\r\n        instances.forEach(function(instance) {\r\n          if(instance.dispose) instance.dispose();\r\n        });\r\n        instances = [];\r\n\r\n        current = fcn(newobject, subobjects, components);\r\n        return ret;\r\n      };\r\n\r\n      return ret;\r\n    };\r\n  };\r\n\r\n\r\n  var plugins = [\"core\"];\r\n  var types = [];\r\n  var translation = {};\r\n  var m = function(pluginName) {\r\n    return {\r\n      lang: function(key, translateData) {\r\n        translation[key] =translation[key]||{};\r\n        translation[key][pluginName] = translateData;\r\n      },\r\n      type: function(typeName, options, constructor) {\r\n        types.push({\r\n          templateUrl: \"site/plugin/\" + pluginName + \"/\" + options.template + \".html\",\r\n          parameters: options.parameters,\r\n          constructor: make_mutable(constructor, {reusableNode: options.reusableNode}),\r\n          name: typeName,\r\n          composition: options.composition,\r\n          components: options.components,\r\n          description: options.description,\r\n          _default: options._default,\r\n          subobjects: options.subobjects,\r\n          stackAppend: options.stackAppend,\r\n          monitor: options.monitor\r\n        })\r\n      }\r\n    };\r\n  };\r\n\r\n  var loadPlugin = function(pluginName) {\r\n    return $http.get(\"site/plugin/\" + pluginName + \"/index.js\")\r\n      .then(function(result) {\r\n        var runnerCode = result.data;\r\n        var module = {export: function(){}};\r\n        eval(runnerCode);\r\n\r\n        module.export(m(pluginName));\r\n      });\r\n  };\r\n\r\n  var pluginsLoaded = $q.all(plugins.map(loadPlugin));\r\n\r\n  var getTypes = function(keyword) {\r\n      var hasKeyword = function() {\r\n        return true;\r\n      };\r\n\r\n      if (keyword) {\r\n        keyword = keyword.toLowerCase();\r\n        hasKeyword = function(x) {\r\n          return x.name.toLowerCase().indexOf(keyword) !== -1;\r\n        };\r\n      }\r\n\r\n      return pluginsLoaded.then(function() {\r\n        return types.filter(hasKeyword);\r\n      });\r\n  };\r\n\r\n  var getType = function(typeName, callback) {\r\n    return pluginsLoaded\r\n      .then(function() {\r\n        var ret = types.filter(function(type) { return type.name === typeName; })[0]; \r\n        if (callback) callback(ret);\r\n        return ret;\r\n      });\r\n  };\r\n\r\n  var loadTranslations = function(options) {\r\n    return pluginsLoaded\r\n      .then(function() {\r\n        return translation[options.key]||{};\r\n      });\r\n  };\r\n\r\n  return {\r\n    getTypes: getTypes,\r\n    getType: getType,\r\n    loadTranslations: loadTranslations\r\n  };\r\n\r\n}]);\r\n\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\nmusicShowCaseApp.factory(\"WelcomeMessage\", ['localforage', function(localforage) {\r\n    var skip = function() {\r\n      return localforage.getItem(\"welcome_skip\")\r\n        .then(function(result) {\r\n          return !!result;\r\n        });\r\n    };\r\n\r\n    var setSkip = function(value) {\r\n      if (value) {\r\n        return localforage.setItem(\"welcome_skip\", value);\r\n      } else {\r\n        return localforage.removeItem(\"welcome_skip\");\r\n      }\r\n    };\r\n\r\n    return {\r\n      setSkip: setSkip,\r\n      skip: skip\r\n    };\r\n}]);\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\nmusicShowCaseApp.factory(\"_localforage\", ['$q', 'localforage', function($q, localforage) {\r\n  var getItem = localforage.getItem.bind(localforage);\r\n\r\n  var releaseWithIndex = function(index, bytes) {\r\n    if (index.length === 0) return $q.when(index);\r\n    if (bytes <= 0) return $q.when(index);\r\n\r\n    var nextEntry = index.shift();\r\n    return localforage.getItem(nextEntry.id)\r\n      .then(function(value) {\r\n        return localforage.removeItem(nextEntry.id)\r\n          .then(function() {\r\n             return releaseWithIndex(index, bytes - (value ? value.length : 0));\r\n          });\r\n      });\r\n  };\r\n\r\n  var clearItem = function(data) {\r\n    return {id: data.id, name: data.name, type: data.type};\r\n  };\r\n\r\n  var release = function(bytes) {\r\n    return localforage.getItem(\"recycle\")\r\n      .then(function(index) {\r\n        return releaseWithIndex(index, bytes);\r\n      })\r\n      .then(function(newIndex) {\r\n        return localforage.setItem(\"recycle\", newIndex.map(clearItem));\r\n      });\r\n  };\r\n\r\n  var setItem = function(key, object, isretry) {\r\n    return localforage.setItem(key, object)\r\n      .catch(function(err) {\r\n        if (!isretry) {\r\n          return release(object.length)\r\n            .then(function() {\r\n              return setItem(key, object, true);\r\n            });\r\n        }\r\n\r\n        throw err;\r\n      });\r\n  };\r\n\r\n\r\n  var removeItem = localforage.removeItem.bind(localforage);\r\n\r\n  return {\r\n    getItem: getItem,\r\n    setItem: setItem,\r\n    removeItem: removeItem\r\n  };\r\n}]);\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\n\r\nmusicShowCaseApp.filter(\"instrument_name\", function() {\r\n  return function(instrumentId, instrumentMap) {\r\n    return instrumentMap[instrumentId] && instrumentMap[instrumentId] ? instrumentMap[instrumentId].name : instrumentId;\r\n  };\r\n});\r\n\r\nmusicShowCaseApp.filter(\"instrument_type\", function() {\r\n  return function(instrumentId, instrumentMap) {\r\n    return instrumentMap[instrumentId] && instrumentMap[instrumentId] ? instrumentMap[instrumentId].type : 'instrument';\r\n  };\r\n});\r\n\r\nmusicShowCaseApp.filter(\"block_name\", function() {\r\n  return function(block, indexMap) {\r\n    return indexMap[block.id] && indexMap[block.id].index ? indexMap[block.id].index.name : block.id;\r\n  };\r\n});\r\n\r\nmusicShowCaseApp.filter(\"block_length\", [\"Pattern\", function(Pattern) {\r\n  return function(block, indexMap, measure) {\r\n    if (!block.id) return 1;\r\n    if (!indexMap[block.id]) return 1;\r\n    if (!indexMap[block.id].contents) return 1;\r\n\r\n    return Pattern.computeMeasureCount(indexMap[block.id].contents, measure);\r\n  };\r\n}]);\r\n\r\nmusicShowCaseApp.controller(\"recordOptionsCtrl\", [\"$scope\", \"$uibModalInstance\", \"Recipe\", function($scope, $uibModalInstance, Recipe) {\r\n  $scope.numChannels = 2;\r\n  $scope.encoding = \"wav\";\r\n  $scope.recipe = Recipe.start;\r\n\r\n  $scope.cancel = function() {\r\n    $uibModalInstance.dismiss();\r\n  };\r\n\r\n  $scope.start = function() {\r\n    $scope.recipe.raise(\"song_rec_confirm\");\r\n\r\n    $uibModalInstance.close({\r\n      encoding: $scope.encoding,\r\n      numChannels: $scope.numChannels\r\n    });\r\n  };\r\n}]);\r\n\r\nmusicShowCaseApp.controller(\"DashboardController\", [\"$scope\", function($scope) {\r\n  $scope.$emit('switchProject', \"default\");\r\n}]);\r\n\r\nmusicShowCaseApp.controller(\"ProjectDashboardController\", [\"$scope\", \"$routeParams\", function($scope, $routeParams) {\r\n  $scope.$emit('switchProject', $routeParams.project);\r\n}]);\r\n\r\nmusicShowCaseApp.controller(\"SongEditorController\", [\"$scope\", \"$uibModal\", \"$q\", \"$timeout\", \"$routeParams\", \"$http\", \"MusicContext\", \"FileRepository\", \"InstrumentSet\", \"Pattern\", \"Export\", \"TICKS_PER_BEAT\", \"SONG_MAX_TRACKS\", \r\n    function($scope, $uibModal, $q, $timeout, $routeParams, $http, MusicContext, FileRepository, InstrumentSet, Pattern, Export, TICKS_PER_BEAT, SONG_MAX_TRACKS) {\r\n\r\n  $scope.indexMap = {};\r\n  var id = $routeParams.id;\r\n  var instSet = InstrumentSet();\r\n  var playingStartOffset = 0;\r\n\r\n  $scope.$emit('switchProject', $routeParams.project);\r\n\r\n  var pxToTicks = function(px) {\r\n    var beatWidth = 154 / $scope.file.measure;\r\n    var zoomLevel = 1;\r\n    return TICKS_PER_BEAT*px/zoomLevel/beatWidth;\r\n  };\r\n\r\n  $scope.seek = function(event) {\r\n    if ($scope.currentRec) return;\r\n\r\n    playingStartOffset = pxToTicks(event.offsetX);\r\n    $scope.$broadcast(\"resetClock\", playingStartOffset);\r\n\r\n    if ($scope.playing) {\r\n      $scope.playing.stop();\r\n      $scope.playing = null;\r\n      $scope.replay();\r\n    }\r\n  };\r\n\r\n  $scope.patternEdit = function(block) {\r\n    document.location = \"#/editor/\" + $routeParams.project + \"/pattern/\" + block.id;\r\n  };\r\n\r\n  $scope.exportItem = function() {\r\n    Export.exportFile($scope.fileIndex.name, $scope.fileIndex.id);\r\n  };\r\n\r\n  $scope.removeItem = function() {\r\n    if ($scope.fileIndex.builtIn) {\r\n      $scope.file = null;\r\n      $scope.fileIndex = null;\r\n      FileRepository.destroyFile(id)\r\n        .then(function() {\r\n          reloadFromRepo();\r\n        });\r\n      return;\r\n    }\r\n\r\n    FileRepository.moveToRecycleBin(id)\r\n      .then(function() {\r\n        document.location = \"#/editor/\" + $routeParams.project;\r\n      });\r\n  };\r\n\r\n  $scope.remove = function(block) {\r\n    delete block.id;\r\n    checkPayload();\r\n    $scope.fileChanged();\r\n  };\r\n\r\n  $scope.currentRec = null;\r\n\r\n  $scope.record = function() {\r\n    if ($scope.playing) {\r\n      $scope.playing.stop();\r\n      $scope.playing = null;\r\n\r\n      $scope.$broadcast(\"pauseClock\");\r\n    }\r\n\r\n    var modalIns = $uibModal.open({\r\n      templateUrl: \"site/templates/modal/recordOptions.html\",\r\n      controller: \"recordOptionsCtrl\"\r\n    });\r\n\r\n    modalIns.result.then(function(encodingOptions) {\r\n      $scope.currentRec = MusicContext.record({\r\n        encoding: encodingOptions.encoding, \r\n        numChannels: encodingOptions.numChannels\r\n      }, function(blob) {\r\n        var a = document.createElement(\"a\");\r\n        document.body.appendChild(a);\r\n        a.style = \"display: none\";\r\n\r\n        var url  = window.URL.createObjectURL(blob);\r\n        a.href = url;\r\n        a.download = $scope.fileIndex.name + \".\" + encodingOptions.encoding;\r\n        a.click();\r\n        window.URL.revokeObjectURL(url);\r\n\r\n        $scope.recipe.raise('song_rec_stop');\r\n      });\r\n\r\n      $scope.play();\r\n    });\r\n  };\r\n\r\n  $scope.stop = function() {\r\n    playingStartOffset = 0;\r\n\r\n    $scope.$broadcast(\"stopClock\");\r\n    $scope.$broadcast(\"resetClock\", playingStartOffset);\r\n\r\n    if ($scope.playing) $scope.playing.stop();\r\n    $scope.recipe.raise(\"song_play_stopped\");\r\n    $scope.playing = null;\r\n  };\r\n\r\n  $scope.playing = null;\r\n\r\n  $scope.$on('pausedClock', function(evt, ticks) {\r\n    playingStartOffset = ticks;    \r\n  });\r\n\r\n  $scope.play = function() {\r\n    if ($scope.playing) {\r\n      $scope.playing.stop();\r\n      $scope.playing = null;\r\n\r\n      $scope.$broadcast(\"pauseClock\");\r\n      return;\r\n    }\r\n\r\n    $scope.replay();\r\n  };\r\n\r\n  $scope.replay = function() {\r\n    MusicContext.resumeAudio();\r\n\r\n    $q.all(instSet.all)\r\n      .then(function(instruments){\r\n        var patterns = {};\r\n\r\n        var createPattern = function(id, songTrackIdx) {\r\n          if (!id) return null;\r\n          if (patterns[id]) return patterns[id];\r\n\r\n          var pattern = $scope.indexMap[id].contents;\r\n          var changedBpm = Object.create(pattern);\r\n          changedBpm.bpm = $scope.file.bpm;\r\n\r\n          patterns[id] = Pattern.patternCompose(changedBpm, instruments, songTrackIdx*SONG_MAX_TRACKS, function() {});\r\n          return patterns[id];\r\n        };        \r\n\r\n        var song = new MUSIC.Song(\r\n          $scope.file.tracks.map(function(track, songTrackIdx) {\r\n            return track.blocks.map(function(block) {\r\n              return createPattern(block.id, songTrackIdx);\r\n            });\r\n          })\r\n        , {\r\n            measure: $scope.file.measure,\r\n            bpm: $scope.file.bpm,\r\n            ticks_per_beat: TICKS_PER_BEAT,\r\n            start: playingStartOffset\r\n          });\r\n\r\n        $scope.$broadcast(\"startClock\", song.timeToTicks());\r\n        $scope.playing = song.play({\r\n          onStop: function() {\r\n            $scope.$broadcast(\"stopClock\");\r\n            $scope.$broadcast(\"resetClock\", playingStartOffset);\r\n\r\n            $scope.recipe.raise(\"song_play_stopped\");\r\n            $scope.playing = null;\r\n            if ($scope.currentRec) $scope.currentRec.stop();\r\n            $scope.currentRec = null;\r\n            $timeout(function() {});\r\n          }\r\n        });\r\n\r\n      });\r\n  };\r\n\r\n  $scope.indexChanged = function() {\r\n    $scope.fileIndex.ref = FileRepository.getRefs(\"song\", $scope.file);\r\n    FileRepository.updateIndex(id, $scope.fileIndex);\r\n  };\r\n\r\n  $scope.fileChanged = fn.debounce(function() {\r\n    FileRepository.updateFile(id, $scope.file)\r\n      .then(function() {\r\n        $scope.indexChanged();\r\n      });\r\n  },100);\r\n\r\n  var checkPayload = function() {\r\n    var maxblocks = 0;\r\n    var maxTrackIndex = 0;\r\n\r\n    if (!$scope.file) return;\r\n    if (!$scope.file.tracks) return;\r\n\r\n    $scope.file.tracks.forEach(function(track, trackIndex) {\r\n      for (var i=0;i<track.blocks.length;i++) {\r\n        if (track.blocks[i].id){\r\n          var mCount = Pattern.computeMeasureCount($scope.indexMap[track.blocks[i].id].contents, $scope.file.measure);\r\n          if (i+mCount>maxblocks) maxblocks=i+mCount;\r\n          if (trackIndex > maxTrackIndex) maxTrackIndex = trackIndex;\r\n        }\r\n      }\r\n    });\r\n\r\n    if ($scope.file.tracks.length < maxTrackIndex+2 && $scope.file.tracks.length < SONG_MAX_TRACKS) {\r\n      $scope.file.tracks.push({\r\n        blocks: $scope.file.tracks[0].blocks.map(function() {return {};})\r\n      });\r\n    } else {\r\n      $scope.file.tracks = $scope.file.tracks.slice(0,maxTrackIndex+2);\r\n    }\r\n\r\n    var target = maxblocks + 1;\r\n    $scope.file.tracks.forEach(function(track) {\r\n      if (target > track.blocks.length) {\r\n        var payload = target-track.blocks.length;\r\n        for (var i=0;i<payload;i++) {\r\n          track.blocks.push({});\r\n        }\r\n      } else {\r\n        track.blocks = track.blocks.slice(0, target);\r\n      }\r\n    });\r\n    $scope.fileChanged();\r\n  };\r\n  $scope.$watch(\"file.measure\", checkPayload);\r\n\r\n  $scope.onDropComplete = function($data,$event,block,songTrackIdx) {\r\n    if ($data.fromBlock) {\r\n\r\n      var swapId = block.id;\r\n      block.id = $data.fromBlock.id;\r\n      $data.fromBlock.id = swapId;\r\n\r\n      checkPayload();\r\n      return;\r\n    }\r\n    if ($data.type !== 'pattern') return;\r\n\r\n    block.id = $data.id;\r\n    FileRepository.getFile($data.id)\r\n      .then(function(f) {\r\n        f.contents.tracks.forEach(function(track, idx) {\r\n          if (track.instrument) instSet.load(track.instrument, songTrackIdx*SONG_MAX_TRACKS + idx);\r\n        });\r\n\r\n        $scope.indexMap[$data.id] = f;\r\n        checkPayload();\r\n        $scope.fileChanged();\r\n\r\n        $scope.recipe.raise('song_pattern_dropped');\r\n      });\r\n    \r\n  };\r\n\r\n  var reloadFromRepo = function() {\r\n    var block_ids = {};\r\n\r\n    FileRepository.getFile(id).then(function(file) {\r\n      if (file) {\r\n        file.contents.tracks.forEach(function(track, idx) {\r\n          track.blocks.forEach(function(block){\r\n            if (block && block.id) {\r\n              if (!block_ids[block.id]){\r\n                block_ids[block.id] = FileRepository.getFile(block.id)\r\n                  .then(function(file) {\r\n                    return {\r\n                      file: file,\r\n                      idx: idx\r\n                    };\r\n                  });\r\n              }\r\n            }\r\n          })\r\n        });\r\n      };\r\n\r\n      return $q.all(block_ids)\r\n        .then(function(indexMap) {\r\n          $scope.indexMap = {};\r\n\r\n          for (var blockId in indexMap) {\r\n            var pattern = indexMap[blockId].file.contents;\r\n            var songTrackIdx = indexMap[blockId].idx;\r\n\r\n            $scope.indexMap[blockId] = indexMap[blockId].file;\r\n            pattern.tracks.forEach(function(track, idx) {\r\n              if (track.instrument) instSet.load(track.instrument, songTrackIdx*SONG_MAX_TRACKS + idx);\r\n            });\r\n          }\r\n        })\r\n        .then(function() {\r\n          $timeout(function() {\r\n            var outputFile = {};\r\n            $scope.fileIndex = file.index;\r\n            $scope.file = file.contents;\r\n          });\r\n        });\r\n    });\r\n  };\r\n\r\n  reloadFromRepo();\r\n\r\n  var keyDownHandler = function(evt) {\r\n    if (document.activeElement.tagName.toLowerCase() === \"input\") return;\r\n    \r\n    if (evt.keyCode === 90 && evt.ctrlKey) {\r\n      FileRepository.undo(id).then(reloadFromRepo);\r\n    }\r\n\r\n    if (evt.keyCode === 89 && evt.ctrlKey) {\r\n      FileRepository.redo(id).then(reloadFromRepo);\r\n    }\r\n  };\r\n\r\n  $(document).bind(\"keydown\", keyDownHandler);\r\n  $scope.$on(\"$destroy\", function() {\r\n    $(document).unbind(\"keydown\", keyDownHandler);\r\n    instSet.dispose();\r\n  });  \r\n}]);\r\n\r\nmusicShowCaseApp.controller(\"PatternEditorController\", [\"$q\", \"$translate\", \"$scope\", \"$timeout\", \"$routeParams\", \"$http\", \"TICKS_PER_BEAT\", \"MusicContext\", \"FileRepository\", \"Pattern\", \"InstrumentSet\", 'Export', 'ErrMessage',\r\n  function($q, $translate, $scope, $timeout, $routeParams, $http, TICKS_PER_BEAT, MusicContext, FileRepository, Pattern, InstrumentSet, Export, ErrMessage) {\r\n  var id = $routeParams.id;\r\n  var playingStartOffset = 0;\r\n\r\n  $scope.exportItem = function() {\r\n    Export.exportFile($scope.fileIndex.name, $scope.fileIndex.id);\r\n  };\r\n\r\n  $scope.$emit('switchProject', $routeParams.project); \r\n\r\n  $scope.instrumentEdit = function(track) {\r\n    document.location = \"#/editor/\" + $routeParams.project + \"/instrument/\" + track.instrument;\r\n  };\r\n\r\n  $scope.instrumentMap = {};\r\n  $scope.beatWidth = 10;\r\n  $scope.zoomLevel = 8;\r\n  $scope.selectedTrack = 0;\r\n  $scope.mutedState = [];\r\n\r\n  var instSet = InstrumentSet();\r\n\r\n  var pxToTicks = function(px) {\r\n    var beatWidth = 10;\r\n    return TICKS_PER_BEAT*px/$scope.zoomLevel/beatWidth;\r\n  };\r\n\r\n  $scope.seek = function(event) {\r\n    playingStartOffset = pxToTicks(event.offsetX + $scope.file.scrollLeft);\r\n    $scope.$broadcast(\"resetClock\", playingStartOffset);\r\n\r\n    if ($scope.playing) {\r\n      $scope.playing.stop();\r\n      $scope.playing = null;\r\n      $scope.replay();\r\n    }\r\n  };\r\n\r\n  $scope.updateMuted = function() {\r\n    $scope.mutedState = Pattern.getMutedState($scope.file);\r\n    $scope.fileChanged();\r\n\r\n    $scope.file.tracks.forEach(function(track, idx) {\r\n      instSet.mute(idx, $scope.mutedState[idx]);\r\n    });\r\n  };\r\n\r\n  $scope.removeItem = function() {\r\n    if ($scope.fileIndex.builtIn) {\r\n      $scope.file = null;\r\n      $scope.fileIndex = null;\r\n      FileRepository.destroyFile(id)\r\n        .then(function() {\r\n          reloadFromRepo();\r\n        });\r\n      return;\r\n    }\r\n\r\n    FileRepository.moveToRecycleBin(id)\r\n      .then(function() {\r\n        document.location = \"#/editor/\" + $routeParams.project;\r\n      })\r\n      .catch(function(err) {\r\n        if (err.type && err.type === 'cantremove') {\r\n          ErrMessage('common.error_title', 'common.cantremove_error');\r\n        } else {\r\n          throw err;\r\n        }\r\n      });\r\n  };\r\n\r\n  $scope.removeTrack = function(trackIdx) {\r\n    $scope.file.tracks = \r\n      $scope.file.tracks.slice(0, trackIdx)\r\n        .concat($scope.file.tracks.slice(trackIdx+1));\r\n\r\n    $scope.file.selectedTrack = $scope.file.selectedTrack % $scope.file.tracks.length;\r\n\r\n    $scope.updateMuted();\r\n    $scope.fileChanged();\r\n  };\r\n\r\n  $scope.addTrack = function() {\r\n    $scope.file.tracks.push({\r\n      events: [],\r\n      scroll: 1000\r\n    });\r\n\r\n    $scope.file.selectedTrack = $scope.file.tracks.length - 1;\r\n    $scope.updateMuted();\r\n    $scope.fileChanged();\r\n  };\r\n\r\n\r\n  $scope.stop = function() {\r\n    playingStartOffset = 0;\r\n\r\n    $scope.$broadcast(\"stopClock\");\r\n    $scope.$broadcast(\"resetClock\", playingStartOffset);\r\n\r\n    if ($scope.playing) $scope.playing.stop();\r\n    $scope.recipe.raise(\"song_play_stopped\");\r\n    $scope.playing = null;\r\n  };\r\n\r\n  $scope.$on('pausedClock', function(evt, ticks) {\r\n    playingStartOffset = ticks;    \r\n  });\r\n\r\n  $scope.play = function() {\r\n    if ($scope.playing) {\r\n      $scope.playing.stop();\r\n      $scope.playing = null;\r\n\r\n      $scope.$broadcast(\"pauseClock\");\r\n      return;\r\n    }\r\n\r\n    $scope.replay();\r\n  };\r\n\r\n  $scope.replay = function() {\r\n    MusicContext.resumeAudio();\r\n\r\n    var playingLine = $(\".playing-line\");\r\n\r\n    $q.all(instSet.all)\r\n      .then(function(instruments) {\r\n        if ($scope.playing) $scope.playing.stop();\r\n\r\n        var onStop = function() {\r\n          $scope.$broadcast(\"stopClock\");\r\n          $scope.$broadcast(\"resetClock\");\r\n          $scope.recipe.raise(\"pattern_play_stopped\");\r\n\r\n          $timeout(function() {\r\n            $scope.playing = null;\r\n          });\r\n\r\n          playingStartOffset = 0;\r\n        };\r\n\r\n        var pattern = Pattern.patternCompose($scope.file, instruments, 0, onStop, {\r\n          start: playingStartOffset\r\n        });\r\n\r\n        $scope.playing = pattern.play();\r\n\r\n        var timeToTicks = pattern.timeToTicks();\r\n        $scope.$broadcast(\"startClock\", timeToTicks);\r\n      });\r\n  };\r\n\r\n  $scope.zoomIn = function() {\r\n    $scope.zoomLevel = $scope.zoomLevel * 2;\r\n    if ($scope.zoomLevel > 32) $scope.zoomLevel = 32;\r\n  };\r\n\r\n  $scope.zoomOut = function() {\r\n    $scope.zoomLevel = $scope.zoomLevel / 2;\r\n    if ($scope.zoomLevel < 1) $scope.zoomLevel = 1;\r\n  };\r\n\r\n  $scope.indexChanged = function() {\r\n    $scope.fileIndex.ref = FileRepository.getRefs(\"pattern\", $scope.file);\r\n    FileRepository.updateIndex(id, $scope.fileIndex);\r\n  };\r\n\r\n  $scope.fileChanged = fn.debounce(function() {\r\n    FileRepository.updateFile(id, $scope.file)\r\n      .then($scope.indexChanged);\r\n  },100);\r\n\r\n  $scope.$on(\"trackChanged\", function(track) {\r\n    computeMeasureCount();\r\n    $scope.fileChanged();\r\n  });\r\n\r\n  var beep = function(instrument, n) {\r\n      if (!instrument) return;\r\n      if (!instrument.note) return;\r\n\r\n      if (lastPlaying) lastPlaying.stop();\r\n      lastPlaying = instrument.note(n).play();\r\n\r\n      setTimeout(function(){\r\n        if (lastPlaying) lastPlaying.stop();\r\n        lastPlaying = null;\r\n      },50);\r\n  };\r\n\r\n  var computeMeasureCount = function() {\r\n    if (!$scope.file) return;\r\n    if (!$scope.file.tracks[0]) return;\r\n\r\n    $scope.file.measureCount = Pattern.computeMeasureCount($scope.file, $scope.file.measure);\r\n  };\r\n\r\n  var lastPlaying;\r\n  var trackMuted = function(track) {\r\n    return $scope.mutedState[$scope.file.tracks.indexOf(track)];\r\n  };\r\n\r\n  $scope.$on(\"eventChanged\", function(evt, data) {\r\n    computeMeasureCount();\r\n\r\n    if (data.oldevt.n !== data.evt.n && !trackMuted(data.track)) beep(instrument.get(data.track), data.evt.n);\r\n\r\n    $scope.fileChanged();\r\n  });\r\n\r\n  $scope.$on(\"eventSelected\", function(evt, data) {\r\n    if (!trackMuted(data.track)) beep(instrument.get(data.track), data.evt.n);\r\n  });\r\n\r\n  $scope.$watch(\"file.measure\", computeMeasureCount);\r\n\r\n  var instrument = new WeakMap();\r\n\r\n  $scope.updateInstrument = function(trackNo) {\r\n    if (!$scope.file.tracks[trackNo]) return;\r\n    if (!$scope.file.tracks[trackNo].instrument) return;\r\n\r\n    return $q.all({\r\n      musicObject: instSet.load($scope.file.tracks[trackNo].instrument, trackNo),\r\n      index: FileRepository.getIndex($scope.file.tracks[trackNo].instrument)\r\n    }).then(function(result) {\r\n        $scope.instrumentMap[$scope.file.tracks[trackNo].instrument] = result.index;\r\n        if (result.musicObject) instrument.set($scope.file.tracks[trackNo], result.musicObject);\r\n        return result.musicObject;\r\n    });\r\n  };\r\n\r\n  $scope.onDropComplete = function(instrument,event) {\r\n    MusicContext.resumeAudio();\r\n\r\n    if (\r\n      instrument.type !== 'instrument' &&\r\n      instrument.type !== 'tempo'\r\n    ) return;\r\n\r\n    var trackNo = $scope.file.selectedTrack;\r\n\r\n    $scope.file.tracks = $scope.file.tracks || [];\r\n    $scope.file.tracks[trackNo] = $scope.file.tracks[trackNo] || {};\r\n    $scope.file.tracks[trackNo].instrument = instrument.id;\r\n\r\n    FileRepository.updateFile(id, $scope.file);\r\n    $scope.updateInstrument(trackNo)\r\n      .then(function(musicObject) {\r\n        $scope.updateMuted();\r\n        if (!$scope.mutedState[trackNo]) beep(musicObject, 36);\r\n      });\r\n  };\r\n\r\n  var reloadFromRepo = function() {\r\n    FileRepository.getFile(id).then(function(file) {\r\n      $timeout(function() {\r\n        var outputFile = {};\r\n        $scope.fileIndex = file.index;\r\n        $scope.file = file.contents;\r\n        $scope.mutedState = Pattern.getMutedState($scope.file);\r\n        $scope.updateMuted();\r\n\r\n        if (!$scope.file.tracks) $scope.file.tracks=[{}];\r\n\r\n        $scope.file.tracks.forEach(function(track, idx) {\r\n          track.events = track.events || [];\r\n          $scope.updateInstrument(idx);\r\n        });\r\n      });\r\n    });\r\n  };\r\n\r\n  reloadFromRepo();\r\n\r\n  // undo & redo\r\n\r\n  var keyDownHandler = function(evt) {\r\n    if (document.activeElement.tagName.toLowerCase() === \"input\") return;\r\n\r\n    if (evt.keyCode === 90 && evt.ctrlKey) {\r\n      FileRepository.undo(id).then(reloadFromRepo);\r\n    }\r\n\r\n    if (evt.keyCode === 89 && evt.ctrlKey) {\r\n      FileRepository.redo(id).then(reloadFromRepo);\r\n    }\r\n  };\r\n\r\n  var playButton = $(\"button.play-button\");\r\n\r\n  playButton.bind(\"click\", MusicContext.resumeAudio);\r\n  $(document).bind(\"keydown\", keyDownHandler);\r\n  $scope.$on(\"$destroy\", function() {\r\n    playButton.unbind(\"click\", MusicContext.resumeAudio);\r\n    $(document).unbind(\"keydown\", keyDownHandler);\r\n\r\n    instSet.dispose();\r\n  });\r\n\r\n  $scope.$on(\"enableTrack\", function(evt, track) {\r\n    $scope.file.selectedTrack = $scope.file.tracks.indexOf(track);\r\n  });\r\n\r\n  $scope.$on(\"patternSelectEvent\", function(evt, event) {\r\n    $timeout(function() {\r\n      $scope.$broadcast(\"trackSelectEvent\", event);\r\n    });\r\n  });\r\n}]);\r\n\r\nmusicShowCaseApp.controller(\"EditorController\", [\"$scope\", \"$q\", \"$timeout\", \"$routeParams\", \"$http\", \"MusicContext\", \"FileRepository\", \"MusicObjectFactory\", \"Export\", function($scope, $q, $timeout, $routeParams, $http, MusicContext, FileRepository, MusicObjectFactory, Export) {\r\n  var id = $routeParams.id;\r\n  $scope.$emit('switchProject', $routeParams.project);\r\n\r\n  $scope.exportItem = function() {\r\n    Export.exportFile($scope.fileIndex.name, $scope.fileIndex.id);\r\n  };\r\n\r\n  $scope.removeItem = function() {\r\n    destroyAll();\r\n\r\n    if ($scope.fileIndex.builtIn) {\r\n      $scope.file = null;\r\n      $scope.fileIndex = null;\r\n      FileRepository.destroyFile(id)\r\n        .then(function() {\r\n          reloadFromRepo();\r\n        });\r\n      return;\r\n    } else {\r\n      FileRepository.moveToRecycleBin(id)\r\n        .then(function() {\r\n          document.location = \"#/editor/\" + $routeParams.project;\r\n        })\r\n        .catch(function(err) {\r\n          if (err.type && err.type === 'cantremove') {\r\n            ErrMessage('common.error_title', 'common.cantremove_error');\r\n          } else {\r\n            throw err;\r\n          }\r\n        });\r\n    }\r\n  };\r\n\r\n  var lastObj;\r\n  var musicObjectFactory = MusicObjectFactory({monitor: true});\r\n\r\n  var destroyAll = function() {\r\n    ($scope.instruments||[]).forEach(function(instrument) {\r\n      if (instrument.dispose) instrument.dispose();\r\n    });\r\n\r\n    ($scope.playables||[]).forEach(function(playable) {\r\n      $scope.stopPlay(playable);\r\n    });    \r\n\r\n    return musicObjectFactory.destroyAll();\r\n  };\r\n\r\n  var lazyLoadInstrument = function(f) {\r\n    var callStop = function(p) { return p.stop(); };\r\n    var callPlay = function(p) { return p.play(); };\r\n\r\n    var instrumentPromise;\r\n    var innerInstrument;\r\n\r\n    var note = function(n) {\r\n      if (innerInstrument) return innerInstrument.note(n);\r\n      var innerNote;\r\n\r\n      if (!instrumentPromise) {\r\n        instrumentPromise = f();\r\n      }\r\n\r\n      innerNote = instrumentPromise.then(function(inst) {\r\n        innerInstrument = inst;\r\n        return inst.note(n);\r\n      });\r\n\r\n      var play = function() {\r\n        var playing = innerNote.then(callPlay);\r\n\r\n        var stop = function() {\r\n          return playing.then(callStop);\r\n        };\r\n\r\n        return {stop: stop};\r\n      };\r\n\r\n      return {play: play};\r\n    };\r\n\r\n    return MUSIC.instrumentExtend({\r\n      note: note\r\n    }).stopDelay(10);\r\n  };\r\n\r\n  var createInstrumentFromFile = function() {\r\n    return musicObjectFactory.create($scope.file);\r\n  };\r\n\r\n  var fileChanged = fn.debounce(function(newFile, oldFile) {\r\n    if (!$scope.file) return;\r\n   \r\n    $q.when(null)\r\n      .then(function() {\r\n        return destroyAll();\r\n      })\r\n      .then(function() {\r\n        return lazyLoadInstrument(createInstrumentFromFile);\r\n      })    \r\n      .then(function(obj) {\r\n          if (!obj) {\r\n            $scope.instruments = [];\r\n            $scope.playables = [];\r\n            return;\r\n          }\r\n\r\n          if (obj !== lastObj) {\r\n            $scope.instruments = [];\r\n            $scope.playables = [];\r\n            if (obj.note) {\r\n              // instrument\r\n              $scope.instruments.push(obj);\r\n            } else if (obj.play) {\r\n              $scope.playables.push(obj);\r\n            }\r\n          }\r\n\r\n          if (oldFile) {\r\n            FileRepository.updateFile(id, $scope.file);\r\n            $scope.fileIndex.updated = true;\r\n          }\r\n          lastObj = obj;\r\n      });\r\n  }, 250);\r\n  $scope.$watch('file', fileChanged, true);\r\n\r\n  $scope.indexChanged = function() {\r\n    FileRepository.updateIndex(id, $scope.fileIndex);\r\n  };\r\n\r\n  var reloadFromRepo = function() {\r\n    FileRepository.getFile(id).then(function(file) {\r\n      $timeout(function() {\r\n        var outputFile = {};\r\n\r\n        $scope.outputFile = outputFile;\r\n        $scope.file = file.contents;\r\n        $scope.fileIndex = file.index;\r\n        $scope.observer = {};\r\n\r\n        $scope.observer.notify = function() {\r\n          $timeout(function() {\r\n            $scope.instruments = [];\r\n            $scope.playables = [];\r\n          });\r\n        };\r\n\r\n      });\r\n    });\r\n  };\r\n\r\n  reloadFromRepo();\r\n\r\n  $scope.$on(\"stackChanged\", function() {\r\n    $scope.resetStack = true;\r\n    fileChanged();\r\n  });\r\n\r\n  $scope.$on(\"$destroy\", destroyAll);\r\n\r\n  $scope.startPlay = function(playable) {\r\n    playable.playing = playable.play();\r\n  };\r\n\r\n  $scope.stopPlay = function(playable) {\r\n    if (!playable.playing) return;\r\n    playable.playing.stop();\r\n    playable.playing = undefined;\r\n  };\r\n\r\n}]);\r\n\r\nmusicShowCaseApp.controller(\"MainController\", \r\n  [\"$q\", \"$scope\", \"$timeout\", \"$uibModal\", \"$translate\", \"MusicContext\", \"FileRepository\", \"Recipe\", \"WelcomeMessage\", \"localforage\", \"Export\", \"ErrMessage\",\r\n  function($q, $scope, $timeout, $uibModal, $translate, MusicContext, FileRepository, Recipe, WelcomeMessage, localforage, Export, ErrMessage) {\r\n  var music;\r\n\r\n  $scope.$on(\"switchProject\", function(evt, id) {\r\n    switchProject(id);\r\n  });\r\n\r\n  var concat = function(a, b) {\r\n    return a.concat(b);\r\n  };\r\n\r\n  var switchProject = function(projectId) {\r\n    var pFilter = [projectId];\r\n\r\n    return FileRepository.getFile(projectId).then(function(file) {\r\n      $scope.project = file;\r\n\r\n      return (file.index.ref||[]).concat([projectId]);\r\n    }).then(function(filter) {\r\n      $scope.projectFilter = filter.concat(['core']);\r\n      if (filter.indexOf('default') !== -1) $scope.projectFilter.push(undefined);\r\n    })\r\n    .then(updateSearch)\r\n    .catch(function() {\r\n      document.location = \"#\";\r\n    });\r\n  };\r\n\r\n  var updateSearch = fn.debounce(function() {\r\n    if (currentObserver) currentObserver.close();\r\n    currentObserver = FileRepository.search(null, {\r\n      project: $scope.projectFilter, type: ['instrument', 'pattern', 'song', 'fx']\r\n    }).observe(function(files) {\r\n      $timeout(function() {\r\n        $scope.filesTotal = files.total;\r\n        $scope.files = files.results;\r\n      }); \r\n    });\r\n  },100);\r\n\r\n  var currentObserver;\r\n  $scope.fileInputClick = function() {\r\n    $timeout(function() {\r\n      $(\".choose-file-import-container input[type=file]\").click();\r\n    });\r\n  };\r\n\r\n  $scope.fileImport = function(files) {\r\n    var readTextFile = function(file) {\r\n      return $q(function(resolve, reject) {\r\n        var fileReader = new FileReader();\r\n        fileReader.onload = function(e) {\r\n          resolve(e.target.result);\r\n        };\r\n\r\n        fileReader.onerror = function(err) {\r\n          reject(err);\r\n        };\r\n\r\n        fileReader.readAsText(file);\r\n      });\r\n    };\r\n\r\n    var nextLocation;\r\n    var importFile = function(file) {\r\n      return function(options) {\r\n        return readTextFile(file)\r\n          .then(function(json) {\r\n            return Export.importFile(json)\r\n              .then(function(file) {\r\n                if (options && options.first) {\r\n                  if (file.type === 'project') {\r\n                    nextLocation = \"#/editor/\"+ file.id;\r\n                  } else {\r\n                    nextLocation = \"#/editor/\"+ file.project + \"/\"+ file.type + \"/\" +file.id;\r\n                  }\r\n                }\r\n              });\r\n          });\r\n      };\r\n    };\r\n\r\n    var p = null;\r\n    for (var i=0; i<files.length; i++) {\r\n      if (p) {\r\n        p = p.then(importFile(files[i]));\r\n      } else {\r\n        p = importFile(files[i])({first: true});\r\n      }\r\n    }\r\n\r\n    if (p) {\r\n      p.then(function(index) {\r\n        if (nextLocation) document.location = nextLocation;\r\n      }).catch(function(err) {\r\n        var modalIns = $uibModal.open({\r\n          templateUrl: \"site/templates/modal/error.html\",\r\n          controller: \"errorModalCtrl\",\r\n          windowClass: 'error',\r\n          resolve: {\r\n            text: function() {\r\n              return $translate('common.loader_error');\r\n            },\r\n            title: function() {\r\n              return $translate('common.error_title');\r\n            }\r\n          }\r\n        });\r\n      });\r\n    }\r\n  };\r\n\r\n  $scope.changeLanguage = function (langKey) {\r\n    localforage.setItem('lang', langKey);\r\n    $translate.use(langKey);\r\n  };\r\n\r\n  localforage.getItem(\"lang\")\r\n    .then(function(currentLanguage) {\r\n      if (currentLanguage) $scope.changeLanguage(currentLanguage);\r\n\r\n      $timeout(function() {\r\n        $scope.langLoaded = true;\r\n      });\r\n    });\r\n\r\n  $scope.welcome = function() {\r\n    // show welcome modal\r\n    var modalIns = $uibModal.open({\r\n      templateUrl: \"site/templates/modal/welcome.html\",\r\n      controller: \"welcomeModalCtrl\",\r\n      resolve: {\r\n        dontshowagain: [\"WelcomeMessage\", function(WelcomeMessage) {\r\n          return WelcomeMessage.skip();\r\n        }]\r\n      }\r\n    });\r\n  };\r\n     \r\n  $scope.openRecycleBin = function() {\r\n    // show recycle bin modal\r\n    var modalIns = $uibModal.open({\r\n      templateUrl: \"site/templates/modal/recycleBin.html\",\r\n      controller: \"recycleBinModalCtrl\"\r\n    });\r\n  };\r\n\r\n\r\n  WelcomeMessage.skip()\r\n    .then(function(skip) {\r\n      if (!skip) $scope.welcome();\r\n    });\r\n\r\n  $scope.recipe = Recipe.start;\r\n\r\n  $scope.activate = function(example) {\r\n    if (example.type === \"instrument\"||example.type === \"song\"||example.type === \"pattern\") {\r\n      document.location = \"#/editor/\" + $scope.project.index.id + \"/\" +example.type+\"/\"+example.id;\r\n    }\r\n    if (example.type === \"project\") {\r\n      document.location = \"#/editor/\" + example.id;\r\n    }\r\n  };\r\n\r\n  $scope.keywordUpdated = fn.debounce(function() {\r\n    if (currentObserver) currentObserver.close();\r\n    currentObserver = FileRepository.search($scope.searchKeyword, {\r\n      project: $scope.projectFilter, type: ['instrument', 'pattern', 'song', 'fx', 'tempo']\r\n    }).observe(function(files) {\r\n      $scope.filesTotal = files.total;\r\n      $scope.files = files.results;\r\n    });\r\n  },200);\r\n\r\n  $scope.removeProject = function() {\r\n    FileRepository.moveToRecycleBin($scope.project.index.id)\r\n      .then(function() {\r\n        document.location = \"#\";\r\n      })\r\n      .catch(function(err) {\r\n        if (err.type && err.type === 'cantremove') {\r\n          ErrMessage('common.error_title', 'common.cantremove_project_error');\r\n        } else {\r\n          throw err;\r\n        }\r\n      });\r\n  };\r\n\r\n  $scope.exportProject = function() {\r\n    Export.exportProject($scope.project.index.name, $scope.project.index.id);\r\n  };\r\n\r\n  $scope.projectSettings = function() {\r\n    $uibModal.open({\r\n      templateUrl: \"site/templates/modal/projectSettings.html\",\r\n      controller: \"projectSettingsModalCtrl\",\r\n      resolve: {\r\n        project: {\r\n          name: $scope.project.index.name,\r\n          ref: $scope.project.index.ref\r\n        },\r\n        buttonText: function() { return 'common.ok'; }\r\n      }\r\n    }).result.then(function(project) {\r\n      $scope.project.index.name = project.name;\r\n      FileRepository.updateIndex($scope.project.index.id, {\r\n        type: 'project', \r\n        name: project.name,\r\n        ref: project.ref\r\n      })\r\n      .then(function() {\r\n        switchProject($scope.project.index.id);\r\n      });\r\n    });\r\n  };\r\n\r\n  $scope.newProject = function() {\r\n    // open \"project settings\" modal\r\n    $translate('project.new').then(function(projectName) {\r\n      $uibModal.open({\r\n        templateUrl: \"site/templates/modal/projectSettings.html\",\r\n        controller: \"projectSettingsModalCtrl\",\r\n        resolve: {\r\n          project: {name: projectName},\r\n          buttonText: function() { return 'common.create'; }\r\n        }\r\n      }).result.then(function(project) {\r\n        FileRepository.createFile({type: 'project', name: project.name, ref: project.ref})\r\n          .then(function(id) {\r\n            document.location=\"#/editor/\" + id;\r\n          });\r\n      });\r\n    });\r\n  };\r\n\r\n  $scope.openProject = function() {\r\n    $uibModal.open({\r\n      templateUrl: \"site/templates/modal/openProject.html\",\r\n      controller: \"openProjectModalCtrl\"\r\n    }).result.then(function(id) {\r\n      var moreImportant = function(file1, file2) {\r\n        if (file1.type !== file2.type) {\r\n          if (file1.type==='song') return file1;\r\n          if (file2.type==='song') return file2;\r\n\r\n          if (file1.type==='pattern') return file1;\r\n          if (file2.type==='pattern') return file2;\r\n        } else {\r\n          return (file1.ref||[]).length > (file2.ref||[]).length ? file1 : file2;\r\n        }\r\n\r\n        return file2;\r\n      };\r\n\r\n      // switch to main object\r\n      return FileRepository.getProjectFiles(id)\r\n        .then(function(files) {\r\n          if (files.length > 0) {\r\n            var better = files.reduce(moreImportant, files[0]);\r\n            if (better && better.type !== 'project') {\r\n              document.location = \"#/editor/\" + id + \"/\" + better.type+\"/\"+better.id;\r\n            } else {\r\n              document.location = \"#/editor/\" + id;\r\n            }\r\n          } else {\r\n            document.location = \"#/editor/\" + id;\r\n          }\r\n        });\r\n    });\r\n  };\r\n\r\n  $scope.newInstrument = function() {\r\n    $translate(\"common.new_instrument\")\r\n      .then(function(name) {\r\n        return FileRepository.createFile({\r\n          type: \"instrument\",\r\n          name: name,\r\n          project: $scope.project.index.id\r\n        });\r\n      })\r\n      .then(function(id) {\r\n        document.location = \"#/editor/\" + $scope.project.index.id + \"/instrument/\" + id;\r\n      })\r\n      .catch(function(err) {\r\n        debugger;\r\n      });\r\n  };\r\n\r\n  $scope.newSong = function() {\r\n    $translate(\"common.new_song\")\r\n      .then(function(name) {\r\n        return FileRepository.createFile({\r\n          type: \"song\", \r\n          name: name,\r\n          project: $scope.project.index.id\r\n        });\r\n      })\r\n      .then(function(id) {\r\n        document.location = \"#/editor/\" + $scope.project.index.id + \"/song/\"+id;\r\n      });\r\n  };\r\n\r\n  $scope.newPattern = function() {\r\n    $translate(\"common.new_pattern\")\r\n      .then(function(name) {\r\n        return FileRepository.createFile({\r\n          type: \"pattern\",\r\n          name: name,\r\n          project: $scope.project.index.id\r\n        });\r\n      })\r\n      .then(function(id) {\r\n        document.location = \"#/editor/\" + $scope.project.index.id + \"/pattern/\"+id;\r\n      });\r\n  };\r\n\r\n\r\n  $scope.about = function() {\r\n    $uibModal.open({\r\n      templateUrl: \"site/templates/modal/about.html\",\r\n      controller: \"infoModalCtrl\"\r\n    });\r\n  };\r\n\r\n  $scope.help = function() {\r\n    $uibModal.open({\r\n      templateUrl: \"site/templates/modal/help.html\",\r\n      controller: \"infoModalCtrl\"\r\n    });\r\n  };\r\n\r\n  $scope.todo = function() {\r\n    $uibModal.open({\r\n      templateUrl: \"todoModal.html\",\r\n      controller: \"todoModalCtrl\"\r\n    });\r\n  };\r\n}]);\r\n\r\nmusicShowCaseApp.controller(\"todoModalCtrl\", [\"$scope\", \"$uibModalInstance\", function($scope, $uibModalInstance) {\r\n  $scope.dismiss = function() {\r\n    $uibModalInstance.dismiss();\r\n  };\r\n}]);\r\n\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\nmusicShowCaseApp.controller(\"errorModalCtrl\", [\"$scope\", \"$uibModalInstance\", \"text\", \"title\", function($scope, $uibModalInstance, text, title) {\r\n  $scope.text = text;\r\n  $scope.title = title;\r\n  $scope.dismiss = function() {\r\n    $uibModalInstance.dismiss();\r\n  };\r\n}]);\r\n\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\nmusicShowCaseApp.controller(\"infoModalCtrl\", [\"$scope\", \"$uibModalInstance\", function($scope, $uibModalInstance) {\r\n  $scope.dismiss = function() {\r\n    $uibModalInstance.dismiss();\r\n  };\r\n}]);\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\nmusicShowCaseApp.controller(\"midiSettingsModalCtrl\", [\"$scope\", \"$q\", \"$timeout\", \"$uibModalInstance\", \"Midi\", function($scope, $q, $timeout, $uibModalInstance, Midi) {\r\n  Midi.getInputs().then(function(inputs) {\r\n    $scope.inputs = inputs;\r\n  });\r\n\r\n  Midi.getConfig().then(function(config) {\r\n    $scope.config = config;\r\n  });\r\n\r\n  $scope.updateConfig = function() {\r\n    Midi.setConfig($scope.config);\r\n  };\r\n\r\n  $scope.done = function() {\r\n    $uibModalInstance.close();\r\n  };\r\n}]);\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\nmusicShowCaseApp.controller(\"openProjectModalCtrl\", [\"$q\", \"$scope\", \"$uibModalInstance\", 'FileRepository', function($q, $scope, $uibModalInstance, FileRepository) {\r\n  var currentObserver;\r\n  var immediateUpdateSearch = function() {\r\n    if (currentObserver) currentObserver.close();\r\n    currentObserver = FileRepository.search($scope.searchKeyword, {type: ['project']})\r\n      .observe(function(files) {\r\n        $scope.filesTotal = files.total;\r\n        $scope.files = files.results;\r\n      });\r\n  };\r\n\r\n  $scope.updateSearch = fn.debounce(immediateUpdateSearch,250);\r\n  $scope.cancel = function() {\r\n    $uibModalInstance.dismiss();\r\n  };\r\n\r\n  $scope.select = function(projectId) {\r\n    $scope.selected = projectId;\r\n  };\r\n\r\n  $scope.open = function(projectId) {\r\n    $uibModalInstance.close(projectId);\r\n  };\r\n\r\n  immediateUpdateSearch();\r\n}]);\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\nmusicShowCaseApp.controller(\"projectSettingsModalCtrl\", [\"$q\", \"$scope\", \"$uibModalInstance\", \"FileRepository\", \"project\", \"buttonText\", function($q, $scope, $uibModalInstance, FileRepository, project, buttonText) {\r\n  var currentObserver;\r\n  var immediateUpdateSearch = function() {\r\n    if (currentObserver) currentObserver.close();\r\n    currentObserver = FileRepository.search($scope.searchKeyword, {type: ['project']})\r\n      .observe(function(files) {\r\n        $scope.filesTotal = files.total;\r\n        $scope.files = files.results;\r\n      });\r\n  };\r\n\r\n  $scope.project = project;\r\n  $scope.buttonText = buttonText;\r\n\r\n  var getIndex = function(id) {\r\n    return FileRepository.getFile(id)\r\n      .then(function(file) {\r\n        return file.index;\r\n      });\r\n  };\r\n\r\n  $scope.refs = [];\r\n  $q.all(($scope.project.ref||[]).map(getIndex))\r\n    .then(function(refs) {\r\n      $scope.refs = refs\r\n    });\r\n\r\n  $scope.updateSearch = fn.debounce(immediateUpdateSearch,250);\r\n  $scope.cancel = function() {\r\n    $uibModalInstance.dismiss();\r\n  };\r\n\r\n  $scope.done = function() {\r\n    $scope.project.ref = $scope.refs.map(getId);\r\n    $uibModalInstance.close($scope.project);\r\n  };\r\n\r\n  var getId = function(x) { return x.id; };\r\n  $scope.remove = function(file) {\r\n    $scope.refs = $scope.refs.filter(function(f) {\r\n      return f.id !== file.id;\r\n    });\r\n  };\r\n\r\n  $scope.add = function(file) {\r\n    if ($scope.refs.map(getId).indexOf(file.id) === -1) {\r\n      $scope.refs.push(file);\r\n    }\r\n  };\r\n\r\n  immediateUpdateSearch();\r\n}]);\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\nmusicShowCaseApp.controller(\"recycleBinModalCtrl\", [\"$scope\", \"$timeout\", \"$uibModalInstance\", \"FileRepository\", function($scope, $timeout, $uibModalInstance, FileRepository) {\r\n  $scope.dismiss = function() {\r\n    $uibModalInstance.dismiss();\r\n  };\r\n\r\n  var immediateUpdateSearch = function() {\r\n    FileRepository.searchRecycled($scope.searchKeyword, {limit: 10})\r\n      .then(function(results) {\r\n        $timeout(function() {\r\n          $scope.files = results.results;\r\n          $scope.filesTotal = results.total;\r\n        });\r\n      })\r\n  };\r\n\r\n  $scope.updateSearch = fn.debounce(immediateUpdateSearch,250);\r\n\r\n  $scope.restoreFromRecycleBin = function(file) {\r\n    FileRepository.restoreFromRecycleBin(file.id).then(immediateUpdateSearch);\r\n  };\r\n\r\n  immediateUpdateSearch();\r\n}]);\r\n\r\n","var musicShowCaseApp = angular.module(\"MusicShowCaseApp\");\r\nmusicShowCaseApp.controller(\"welcomeModalCtrl\", [\"$q\", \"$scope\", \"$uibModalInstance\", \"Recipe\", \"WelcomeMessage\", \"dontshowagain\", function($q, $scope, $uibModalInstance, Recipe, WelcomeMessage, dontshowagain) {\r\n  $scope.dontshowagain = dontshowagain;\r\n\r\n  var skipUpdated = $q.when(null);\r\n  $scope.updateSkip = function() {\r\n    skipUpdated = WelcomeMessage.setSkip($scope.dontshowagain);\r\n  };\r\n\r\n  $scope.dismiss = function() {\r\n    skipUpdated\r\n      .then(function() {\r\n        $uibModalInstance.dismiss();\r\n      });\r\n\r\n  };\r\n\r\n  $scope.tutorial = function() {\r\n    skipUpdated\r\n      .then(function() {\r\n        $uibModalInstance.dismiss();\r\n        Recipe.start('intro');\r\n      });\r\n  };\r\n}]);\r\n"],"sourceRoot":"site"}