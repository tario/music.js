var musicShowCaseApp=angular.module("MusicShowCaseApp",["ui.codemirror","ngRoute","ui.bootstrap","ngDraggable","ngCookies","pascalprecht.translate"]);musicShowCaseApp.constant("MUSIC",MUSIC),musicShowCaseApp.constant("TICKS_PER_BEAT",96),musicShowCaseApp.constant("SONG_MAX_TRACKS",32),musicShowCaseApp.constant("localforage",localforage);
var musicShowCaseApp=angular.module("MusicShowCaseApp"),enTranslations={midi:{settings:"MIDI Settings",inputs:"Inputs",connected:"MIDI Input Connected",disconnected:"MIDI Input Disconnected (Click to setup)",events:"Events",octave:"Base Octave",transpose:"Transpose"},open_project:{p1:"Select the project you want to open",title:"Open Project"},array_editor:{tooltip:{remove_item:"Removes the object from array",add_item:"Click to add a new object to array",edit_item:"Click to edit this object"}},index:{not_implemented:"Sorry. Not implemented Yet :P",filter:"Type here the word to filter objects",tooltip:{type:{instrument:"This is a resource object of type instrument",pattern:"This is a resource object of type pattern",song:"This is a resource object of type song",fx:"This is a resource object of type fx"},type_p1:"To use the resource, drag them from here into your creation on the right",type_p2:"To instead, *edit* the resource, double click it",index:"This is the object index, you can find here your crafting outputs and inputs"}},project:{basic_info:"Properties",references:"References",settings:"Project Settings","new":"New Project"},menu:{"new":"File",new_instrument:"New Instrument",new_pattern:"New Pattern",new_song:"New Song",new_project:"New Project...",open_project:"Open Project...",file_import:"Import...",tools:"Tools",tools_preferences:"Preferences",help_view_help:"View Help",help_recipes:"Recipes",help_recipes_intro:"Basic intro tour",help_recipes_howto_create_song:"How to create a song",help_recipes_howto_create_instrument:"How to create an instrument (square + 2 voices echo)",help_contextual_help:"Contextual Help",help_welcome:"Welcome!",help_about:"About Music.js",recycle_bin:"Recycle Bin...",tooltip:{"new":"You can create new blank items from this option",preferences:"You can edit your preferences here",help:"Menu to access help options and about"},project:"Project",project_settings:"Settings...",project_remove_project:"Remove Project",project_export_project:"Export Project"},contextual_help:{enable:"Enable Contextual Help",disable:"Disable Contextual Help"},recycle:{p1:"This is the recycle bin, from here, you can restore the items that have been removed",p2:"Remember: items in the recycle bin will be permanently deleted if and when available storage space runs out",p3:"* Double-click the item you want to RESTORE",title:"Recycle Bin",compact_title:"Recycle Bin",compact_hint_restore:"* Double-click the item you want to RESTORE",compact_hint_open:"* Click here to open recycle bin window",EMPTY:"EMPTY"},welcome:{title:"Welcome to Music.js: 8bit Edition",p1:"Music.js is a web application that allows the composition of melodies powered (optionally) by javascript programming",p2:"This first basic edition, is fully oriented towards retro/8bit music by providing elemental oscillators, noise generators and basic modulation patterns",p3:"Do you want a basic tour?",nevershow:"Never show this message again"},about:{title:"About Music.js: 8bit Edition",p3:"In the long term, the goal of music.js is to cover all the layers needed between HTML5 Web Audio API provided by browsers and fully usable music composition application similar to known ones like FL Studio",authors:"AUTHORS",i_am:"I am Dario Seminara, but also I should give credit to some key library authors:",credit:{mohayonao:"@mohayonao (Author of Timbre.js)",higuma:"@higuma (Author of WebAudioRecorder)",kristopolous:"@kristopolous (Author of BOOTSTRA.386 Bootstrap Template)"},contribute:"CONTRIBUTE",contact_me:"Contact me at github"},common:{yes:"Yes",no:"No",ok:"Ok",dismiss:"Dismiss",cancel:"Cancel",create:"Create",open:"Open",name:"Name",language:"Language:",loader_error:"Error when trying to load file",cantremove_error:"Can not delete the file if it is being used",cantremove_project_error:"Can not delete the project if it is being used in another project",error_title:"Error",HELP:"HELP",more:"more",remove:"Remove","export":"Export",reset:"Reset",play:"Play",pause:"Pause",stop:"Stop",record:"Rec.",bpm:"Bpm",bpm_lc:"bpm",add:"Add",tooltip:{playing_speed:"Playing speed, number of beats per minute",remove_item:"Removes item, you can restore it from recycle bin",modulation:"You can setup the effects modulation for {{name}} here. If you leave it empty, there will be no modulation at all"},new_instrument:"New Instrument",new_pattern:"New Pattern",new_song:"New Song",modulation:"{{name}} Modulation"},help:{FLOW:"MUSIC.JS FLOW",RECIPES:"RECIPES",p1:"In order to create a song, you need to craft it, and craft the materials.",p2:"Actually, there are three types of craftable resources: instruments, patterns and songs",p3:"While the right section shows the item being crafted. The left pannel shows the crafting materials",p4:"You can drop resources (instruments or patterns) into drop zones, when applicable",p5:"To use the resource on the item being crafted, you need to drag it to any of the dropzones",p6:"Following this principle, you can use instruments to compose patterns, and finally, patterns to compose songs",p7:"Furthermore, you can compose your custom instruments, from a range of effects:",p8:"Don't worry, if you don't get it at first, there are recipes and contextual help at your disposal",recipes:{p1:"Recipes are interactive mini-tutorials on how to craft anything here (example: a song)",p2:"Some tutorials (such as 'intro') only explain a few things about the main interface",p3:"It's recommended to follow these recipes if you don't know what to do or how to start using the app. The recipes are reachable from the help menu (?)"},CONTEXTUAL_HELP:"CONTEXTUAL HELP",contextual_help:{p1:"There is a series of tooltips explaining on detail the different features of the app. You can enable or disable these tooltips by clicking on the box in the left-bottom corner of the screen"}},stack:{drop_elements_here:"drop new elements here",tooltip:{you_can_drop_new_effects_here:"You can drop new effects from the object index here",remove:"Removes the effect element from the pipeline",up:"Changes the order of the element, to execute it AFTER",down:"Changes the order of the element, to execute it BEFORE",expand:"Expand/Shrink the display of advanced options for the element"}},editor:{keyboard_instructions:"Use ZXCVBNM keys to play instrument, or hover mouse on virtual keyboard",tooltip:{test_instrument_here:"Test the instrument here, using mouse or keyboard",type_here_instrument:"Type here the name of the instrument"}},pattern:{track_muted:"Muted",track_solo:"Solo",measure_beats:"Measure beats",amount_beats:"Amount of beats per measure",measure_count:"Measure count",zoom_level:"Zoom level",total_measures:"Total count of measures on pattern",tracks:"Tracks",drop_instrument:"drop instrument here",tooltip:{change_name:"Change the pattern name",zoom_level:"Zoom level for all tracks",play:"Click to play the pattern",stop:"Click to stop playing",remove_track:"Click to remove track",compact_view_p1:"Track compact view: see the notes without having to expand the track.",compact_view_p2:"Click here to expand the track",drop_zone:"Instrument drop zone, drop instruments from the left panel to use it on the track",editor_notes_p1:"Note area, add the notes here:",editor_notes_p2:"Click to add a new one, and drag to change value/time",editor_notes_p3:"CTRL+Z to undo changes",editor_notes_p4:"CTRL+Y to redo changes",add_track:"Click this button to add new empty tracks",note_event_p1:"Note event. Drag from the right edge to change the duration or press delete key to remove",note_event_p2:"Drag to change the value and/or starting time",note_event_p3:"Note event. Click to select and edit it",muted:"Disable the track in order to silence it",solo:"Isolate the track so that it is the only one that plays. Can be more than one",instrument_edit:"Click this button to edit the instrument"}},song:{drop_pattern:"Drop pattern here",tooltip:{measure_beats:"Amount of beats per measure. Make sure this value match the measure length of the patterns",play:"Click to play/pause the song",stop:"Click to stop playing the song",download:"Click to record the song and download the audio file",drop_pattern:"Drop zone for patterns, drop here a pattern from the panel on the left",remove_block:"Click here to remove the pattern and leave the block empty",edit_block:"Click here to edit the pattern used by this block"}},BUTTON_LANG_EN:"English",BUTTON_LANG_ES:"Spanish"};musicShowCaseApp.constant("enTranslations",enTranslations);
var musicShowCaseApp=angular.module("MusicShowCaseApp"),esTranslations={midi:{settings:"Opciones de MIDI",inputs:"Entradas",connected:"Entrada MIDI Conectada",disconnected:"Entrada MIDI Desconectada (Click para configurar)",events:"Eventos",octave:"Octava Base",transpose:"Transposicion"},open_project:{p1:"Selecciona el proyecto que quieras abrir",title:"Abrir Proyecto"},array_editor:{tooltip:{remove_item:"Elimina el objeto de la coleccion",add_item:"Click para agregar un nuevo objeto a la coleccion",edit_item:"Click para editar este objeto"}},index:{not_implemented:"Disculpa, funcionalidad no implementada",filter:"Tipea aqui las palabras clave para filtrar los objetos",tooltip:{type:{instrument:"Este es un recurso del tipo instrumento",pattern:"Este es un recurso del tipo patron",song:"Este es un recurso del tipo cancion",fx:"Este es un recurso del tipo fx (efecto)"},type_p1:"Para usar este recurso, arrastralo desde aqui hasta tu creacion",type_p2:"Para, en lugar de eso, editarlo, haz doble click en el",index:"Este es el indice de objetos, puedes encontrar tus materiales y productos listados aqui"}},project:{basic_info:"Propiedades del proyecto",references:"Referencias",settings:"Configuracion del Proyecto","new":"Nuevo Proyecto"},menu:{"new":"Archivo",new_instrument:"Nuevo Instrumento",new_pattern:"Nuevo Patron",new_song:"Nueva Cancion",new_project:"Nuevo Proyecto...",open_project:"Abrir Proyecto...",file_import:"Importar...",tools:"Herramientas",tools_preferences:"Preferencias",help_view_help:"Ver Pagina de Ayuda",help_recipes:"Recetas",help_recipes_intro:"Recorrido Introductorio",help_recipes_howto_create_song:"Como crear una cancion",help_recipes_howto_create_instrument:"Como crear un instrumento (cuadrada + eco a dos voces)",help_contextual_help:"Ayuda Contextual",help_welcome:"¡Bienvenido!",help_about:"Acerca de Music.js",recycle_bin:"Papelera de Reciclaje...",tooltip:{"new":"Puedes crear nuevos items en blanco desde esta opcion",preferences:"Puedes editar tus preferencias aqui",help:"Menu para acceder a las opciones de ayuda y *Acerca De*"},project:"Proyecto",project_settings:"Configuracion...",project_remove_project:"Eliminar Proyecto",project_export_project:"Exportar Proyecto"},contextual_help:{enable:"Activar Ayuda Contextual",disable:"Desactivar Ayuda Contextual"},recycle:{p1:"Esta es la papelera de reciclaje, desde aqui puedes restaurar los elementos que han sido eliminados",p2:"Recuerda que los elementos en la papelera se eliminaran permanentemente cuando se agote el espacio disponible",p3:"* Haz doble-click en el elemento que quieras RESTAURAR",title:"Papelera de Reciclaje",compact_title:"Papelera de R.",compact_hint_restore:"* Haz doble-click en el elemento que quieras RESTAURAR",compact_hint_open:"* Haz click aqui para abrir la papelera de reciclaje",EMPTY:"Vacia"},welcome:{title:"Bienvenido a Music.js: Edicion de 8bit",p1:"Music.js es una aplicacion web que permite componer musica con el poder de javascript (opcional)",p2:"La primera version esta totalmente orientada a la musica retro/8bit mediante osciladores elementales, generadores de ruido y patrones de modulacion",p3:"¿Quieres realizar un recorrido basico?",nevershow:"Nunca mostrar este mensaje de nuevo"},about:{title:"Acerca de Music.js: Edicion de 8bit",p3:"A largo plazo, el objetivo de music.js es cubrir todas las capas necesarias entre el API de Web Audio provista pòr los navegadores y una solucion completa de composicion musical similar a las mas conocidas como por ej FL Studio",authors:"AUTORES",i_am:"Yo soy Dario Seminara, pero tambien tengo que dar credito a autores de varias librerias que son clave:",credit:{mohayonao:"@mohayonao (Autor de Timbre.js)",higuma:"@higuma (Autor de WebAudioRecorder)",kristopolous:"@kristopolous (Autor de la plantilla de bootstrap BOOTSTRA.386)"},contribute:"COMO CONTRIBUIR",contact_me:"Contactame a travez de github"},common:{yes:"Si",no:"No",ok:"Aceptar",dismiss:"Cerrar",cancel:"Cancelar",create:"Crear",open:"Abrir",name:"Nombre",loader_error:"Error al intentar cargar el archivo",cantremove_error:"No se puede eliminar el archivo si esta siendo utilizado",cantremove_project_error:"No se puede eliminar el proyecto si esta siendo usado desde otro proyecto",error_title:"Error",language:"Idioma:",HELP:"AYUDA",more:"mas",remove:"Elimi.","export":"Exportar",reset:"Fabr.",play:"Reprod.",pause:"Pausar",stop:"Detener",record:"Rec.",bpm:"Ppm",bpm_lc:"ppm",add:"Agreg.",tooltip:{playing_speed:"Velocidad de reproduccion, cantidad de pulsos por minuto",remove_item:"Elimina el elemento, puedes restaurarlo desde la papelera de reciclaje",modulation:"Puedes configurar los efectos de modulacion aqui. Si lo dejas vacio, no habra modulacion"},new_instrument:"Nuevo Instrumento",new_pattern:"Nuevo Patron",new_song:"Nueva Cancion",modulation:"Modulacion de {{name}}"},help:{FLOW:"FLUJO DE MUSIC.JS",RECIPES:"RECETAS",p1:"Para crear una cancion, tienes que ensamblarla, asi como sus componentes",p2:"Hay tres tipos de recursos que se pueden crear: instrumentos, patrones y canciones",p3:"Mientras que la seccion de la derecha muestra el elemento que se esta creando, la seccion de la izquierda muestra los materiales que se pueden usar",p4:"Puedes arrastrar y soltar esos materiales en las zonas indicadas",p5:"Para usar algun recurso en algun elemento que estes creando, lo tienes que arrastrar a esas zonas",p6:"Siguiendo este principio, puedes usar instrumentos para componer patrones, y finalmente, los patrones para componer las canciones",p7:"Ademas, puedes crear tus propios instrumentos, combinando varios efectos:",p8:"No te preocupes si no lo entiendes ahora mismo, hay recetas y ayuda contextual que podras usar para familiarizarte con estos conceptos",recipes:{p1:"Las recetas, son mini-tutoriales interactivos que explican como crear algo (por ejemplo, una cancion)",p2:"Algunos tutoriales (Como por ejemplo 'Recorrido Introductorio') solo explican algunas cosas de la interfaz principal",p3:"Te recomiendo que sigas estas recetas si no sabes que hacer o como empezar a usar la aplicacion. Puedes acceder a las recetas desde el menu de ayuda (?)"},CONTEXTUAL_HELP:"AYUDA CONTEXTUAL",contextual_help:{p1:"Hay una serie de tooltips que explican detalladamente las distintas funcionalidades de la aplicacion. Puedes activar o desactivar estas ayudas clickeando en el recuadro que aparece en la esquina inferior izquierda de la pantalla"}},editor:{keyboard_instructions:"Usa las teclas ZXCVBNM para tocar el instrumento, o pasa el puntero del mouse sobre el teclado virtual",tooltip:{test_instrument_here:"Prueba el instrumento aqui, usando el teclado o el mouse",type_here_instrument:"Escribe aqui el nombre para el instrumento"}},pattern:{track_muted:"Apagado",track_solo:"Solo",measure_beats:"Pulsos/compas",measure_count:"Cant. de compases",zoom_level:"Nivel de zoom",tracks:"Pistas",drop_instrument:"Suelta el instrumento aqui",tooltip:{amount_beats:"Cantidad de pulsos por compas",total_measures:"Cantidad total de compases en el patron",change_name:"Cambia el nombre del patron",zoom_level:"Nivel de zoom para todas las pistas",play:"Click para reproducir el patron",stop:"Click para detener la reproduccion",remove_track:"Click para eliminar la pista",compact_view_p1:"Vista compacta de la pista: muestra las notas sin necesidad de expandir la pista.",compact_view_p2:"Clickea aqui para expandir la pista",drop_zone:"Area para soltar el instrumento, arrastra aqui instrumentos del panel izquierdo para usarlos en la pista",editor_notes_p1:"Area de notas, puedes agregar las notas aqui:",editor_notes_p2:"Clickea para agregar una nueva nota, y arrastralas para cambiar su valor y su tiempo de inicio en la secuencia",editor_notes_p3:"CTRL+Z para deshacer cambios",editor_notes_p4:"CTRL+Y para rehacer cambios",add_track:"Clickea este boton para agregar una nueva pista vacia",note_event_p1:"Evento de nota. Arrastra desde el borde derecho para cambiar su duracion, o presiona la tecla SUPR. para eliminarlo",note_event_p2:"Arrastra para cambiar el valor o el tiempo de comienzo en la secuencia",note_event_p3:"Evento de nota. Clickea para seleccionarlo y editarlo",muted:"Desactiva la pista haciendo que no se reproduzca",solo:"Aisla la pista de manera que sea la unica que se reproduzca. Pueden aislarse varias",instrument_edit:"Clickea este boton para editar el instrumento"}},song:{drop_pattern:"Suelta el patron aqui",tooltip:{measure_beats:"Pulsos/Compas. Tiene que coincidir con el de los patrones que se usan",play:"Click para reproducir/pausar la cancion",stop:"Click para detener la reproduccion",download:"Click para grabar la cancion a un archivo de audio y descargarlo",drop_pattern:"Area para soltar los patrones, arrastra aqui patrones desde el panel izquierdo",remove_block:"Click aqui para eliminar el patron y dejar el bloque vacio",edit_block:"Click aqui para saltar a la edicion del patron utilizado en este bloque"}},stack:{drop_elements_here:"suelta nuevos elementos aqui",tooltip:{you_can_drop_new_effects_here:"Puedes soltar nuevos efectos del indice aqui",remove:"Elimina el efecto de la secuencia",up:"Cambia el orden del elemento, para que se ejecute DESPUES",down:"Cambia el orden del elemento, para que se ejecute ANTES",expand:"Expande/Comprime la vista avanzada del elemento"}},BUTTON_LANG_EN:"Ingles",BUTTON_LANG_ES:"Español"};musicShowCaseApp.constant("esTranslations",esTranslations);
var musicShowCaseApp=angular.module("MusicShowCaseApp");musicShowCaseApp.config(["$translateProvider",function(e){var a=function(){if(!e.resolveClientLocale())return"en";var a=e.resolveClientLocale().split("-")[0];return a&&e.translations()[a]?a:"en"};e.preferredLanguage(a()),e.fallbackLanguage("en"),e.useSanitizeValueStrategy(null),e.useLoader("translationsLoader")}]);
var musicShowCaseApp=angular.module("MusicShowCaseApp");musicShowCaseApp.config(["$routeProvider","$locationProvider",function(t,e){t.when("/editor/:project/instrument/:id",{templateUrl:"site/templates/editor.html",controller:"EditorController"}).when("/editor/:project/song/:id",{templateUrl:"site/templates/songEditor.html",controller:"SongEditorController"}).when("/editor/:project/pattern/:id",{templateUrl:"site/templates/patternEditor.html",controller:"PatternEditorController"}).when("/editor/:project",{templateUrl:"site/templates/dashboard.html",controller:"ProjectDashboardController"}).when("/",{templateUrl:"site/templates/dashboard.html",controller:"DashboardController"})}]);
var musicShowCaseApp=angular.module("MusicShowCaseApp");musicShowCaseApp.directive("musicObjectEditor",["$timeout","$http","TypeService","Recipe","MusicObjectFactory",function($timeout,$http,TypeService,Recipe,MusicObjectFactory){return{scope:{file:"=file"},templateUrl:"site/templates/objectEditor.html",link:function link(scope,element,attrs){var file,types=TypeService.getTypes();scope.output={},scope.parameters=[],scope.recipe=Recipe.start,scope.termschanged=function(){scope.$broadcast("termschanged")},scope.f_t=function(str,state){try{var ret=eval("(function(t) { return "+str+"; })");return delete state.error,ret}catch(e){throw state.error=e.toString(),e}},scope.oscTermsUpdateFromWaveForm=fn.debounce(function(waveform,terms,resolution){try{for(var waveform=eval("(function(t) { return "+waveform+"; })"),count=resolution,values=new Array(count),i=0;i<count;i++)if(values[i]=waveform(i/count),isNaN(values[i]))throw"Not a number: "+values[i];var ft=new DFT(values.length);ft.forward(values);for(var i=0;i<count;i++)terms.cos[i]=ft.real[i],terms.sin[i]=ft.imag[i];terms.cos.length=ft.real.length/2,terms.sin.length=ft.imag.length/2;for(var f=function(e){for(var t=0,a=1;a<count/2;a++){var n=terms.sin[a],o=terms.cos[a];t+=n*Math.sin(2*e*Math.PI*a),t+=o*Math.cos(2*e*Math.PI*a)}return t},maxvalue=0,count=terms.sin.length,i=0;i<count;i++){var value=f(i/count);value>maxvalue?maxvalue=value:value<-maxvalue&&(maxvalue=-value)}for(var i=0;i<count;i++)terms.sin[i]=terms.sin[i]/maxvalue,terms.cos[i]=terms.cos[i]/maxvalue;$timeout(function(){scope.invalidWaveform=!1}),scope.$broadcast("termschanged")}catch(err){$timeout(function(){scope.invalidWaveform=err.toString()})}},400),scope.oscTermsUpdate=fn.debounce(function(serie,terms,errVar){try{for(var serie=eval("(function(n) { return "+serie+"; })"),n=1;n<512;n++)if(terms[n]=serie(n),isNaN(terms[n]))throw"Not a number: "+terms[n];scope[errVar]=!1,$timeout(function(){scope.$broadcast("termschanged")})}catch(err){$timeout(function(){scope[errVar]=err.toString()})}},400),scope.range=function(e,t){for(var a=[],n=e;n<=t;n++)a.push(n);return a};var truthy=function(e){return e},updateObject=function(e){$timeout(function(){scope.file&&scope.file.changed&&scope.file.changed()})},outputObserver;scope.$on("$destroy",function(){outputObserver&&outputObserver.destroy()});var updateTemplate=function(e){if(e){t&&t.destroy();var t=MusicObjectFactory().observeOutput(e,function(e){$timeout(function(){scope.output=e})});types.then(function(){$timeout(function(){scope.selectedType=e.type,TypeService.getType(e.type,function(t){$timeout(function(){scope.templateUrl=t.templateUrl,scope.type=t;for(var a in t._default)"undefined"==typeof e.data[a]&&(e.data[a]=t._default[a]);t.parameters&&(scope.parameters=t.parameters.map(function(t){return{name:t.name,data:t,value:e.data&&"undefined"!=typeof e.data[t.name]?e.data[t.name]:t.value}})),t.components&&(scope.modulations=(t.components||[]).map(function(t){return{name:t,value:e.data&&e.data.modulation&&e.data.modulation[t]||{type:"stack",data:{array:[]}}}})),updateObject(e.data)})})})})}};scope.file&&updateTemplate(scope.file),types.then(function(e){scope.types=e});var changeType=function(e){e&&scope.file&&(scope.file.type=e,updateTemplate(scope.file))};scope.$watch("modulations",function(e){scope.modulations&&(scope.modulations.forEach(function(e){scope.file.data.modulation=scope.file.data.modulation||{},scope.file.data.modulation[e.name]=e.value}),scope.$emit("objectChanged"))},!0),scope.$watch("parameters",function(e){scope.parameters&&(scope.parameters.forEach(function(e){scope.file.data[e.data.name]=e.value}),scope.$emit("objectChanged"))},!0),scope.$watch("selectedType",changeType),scope.$watch("file",updateTemplate)}}}]),musicShowCaseApp.directive("arrayEditor",["$timeout","Recipe",function(e,t){return{scope:{data:"=data"},templateUrl:"site/templates/arrayEditor.html",link:function(a,n,o){a.data.subobjects=a.data.subobjects||[],a.maxElements=o.maxelements?parseInt(o.maxelements):1/0,a.currentTab=0,a.recipe=t.start;var r=function(t){e(function(){a.data.subobjects=a.data.subobjects||[],a.data.subobjects.push(t),a.setCurrentTab(a.data.subobjects.length-1)})};a.setCurrentTab=function(e){a.currentTab=e},a.removeObject=function(e){a.data.subobjects=a.data.subobjects.filter(function(t){return t!==e})},a.addObject=function(){r({data:{array:[]},type:"stack"})},0===a.data.subobjects.length&&a.addObject()}}}]),musicShowCaseApp.directive("musicStack",["$timeout","Recipe","TypeService",function(e,t,a){return{scope:{initFile:"=initFile",dropzoneExtraName:"=dropzoneExtraName"},templateUrl:"site/templates/stack.html",link:function(n,o,r){n.recipe=t.start;var c=function(t,a){n.$emit("stackChanged"),e(function(){var e=n.file.array[t];n.file.array[t]=n.file.array[a],n.file.array[a]=e})},i=function(e,t){e.array=[{type:t.name,data:{}}].concat(e.array)};n.onDropComplete=function(e,t){"fx"===e.type&&a.getType(e.name).then(function(t){(t.stackAppend||i)(n.file,e),n.$emit("stackChanged")})},n.up=function(e){c(e-1,e)},n.down=function(e){c(e+1,e)},n.remove=function(t){n.$emit("stackChanged"),e(function(){var e=n.file.array;n.file.array=[];for(var a=0;a<e.length;a++)a!==t&&n.file.array.push(e[a])})},n.add=function(){n.$emit("stackChanged"),e(function(){n.file.array.push({data:{},type:"null"})})},n.$watch("initFile",function(e){e&&(n.file=e.data)})}}}]),musicShowCaseApp.directive("customOscGraph",["$timeout",function(e){return{scope:{terms:"=terms"},template:'<function-graph f="f" samples=64 t0="0" tf="1" scaley="0.8"></function-graph>',link:function(e,t,a){var n=function(){e.f=function(t){for(var a=0,n=1;n<e.terms.sin.length;n++){var o=e.terms.sin[n],r=e.terms.cos[n];a+=o*Math.sin(2*t*Math.PI*n),a+=r*Math.cos(2*t*Math.PI*n)}return a}};e.f=function(){return 0},e.$on("termschanged",fn.debounce(n,10)),n()}}}]),musicShowCaseApp.directive("showScale",["$timeout",function(e){return{scope:{scale:"=scale"},template:'<div class="note-cell" ng-repeat="note in notes">{{note}}</div><div class="note-cell" ng-repeat="note in notes">{{note}}</div>',link:function(t,a,n){var o=function(e){return[0,[0,1],1,[1,2],2,3,[3,4],4,[4,5],5,[5,6],6][e%12]},r=function(e){return[0,2,4,5,7,9,11][e%7]},c=function(e){return["C","D","E","F","G","A","B"][e%7]};t.$watch("scale",function(a){e(function(){var e=MUSIC.Utils.Scale(a),n=[0,1,2,3,4,5,6],i=o(a);i.length&&(i=i[1]),t.notes=n.map(function(t){var n=e.add(a,t),o=(i+t)%7,s="";return r(o)>n%12&&(s="b"),r(o)<n%12&&(s="#"),c(o)+s})})})}}}]),musicShowCaseApp.directive("ngScrollTop",["$parse","$timeout",function(e,t){return{restrict:"A",link:function(a,n,o){var r=e(o.ngScrollTop),c=r.assign;a.$watch(o.ngScrollTop,function(){$(n).scrollTop(r(a))}),n.on("scroll",function(){t(function(){c(a,$(n).scrollTop())})})}}}]),musicShowCaseApp.directive("ngScrollLeft",["$parse","$timeout",function(e,t){return{restrict:"A",link:function(a,n,o){var r=e(o.ngScrollLeft),c=r.assign;a.$watch(o.ngScrollLeft,function(){$(n).scrollLeft(r(a))}),n.on("scroll",function(){t(function(){c(a,$(n).scrollLeft())})})}}}]);
musicShowCaseApp.directive("functionGraph",["$timeout","$parse",function(e,t){return{scope:{},replace:!0,template:'<canvas class="wavegraph"></canvas>',link:function(e,t,a){var i,n=parseFloat(a.t0),r=parseFloat(a.tf),o=parseInt(a.samples),s=parseFloat(a.scaley);e.$parent.$watch(a.f,function(e){i=e,i&&h()});var h=function(){var e=t[0],a=e.getContext("2d");e.width=e.clientWidth/4,e.height=e.clientHeight/4;var h=function(e,t,i,n,r){a.save(),a.beginPath(),a.moveTo(e,t),a.lineTo(i,n),a.strokeStyle=r,a.lineWidth=1,a.stroke(),a.restore()},l=function(t){a.save(),a.save(),a.translate(0,e.height/2),a.scale(e.width,e.height/2),a.moveTo(0,-i(n)*s);for(var h=1;h<=o;h++){var l=h/o,c=(r-n)*l+n;a.lineTo(l,-i(c)*s)}a.restore(),a.lineJoin="round",a.lineWidth=1,a.strokeStyle=t,a.stroke(),a.restore()};h(0,e.height/2,e.width,e.height/2,"aqua"),l("#FFF")}}}}]);
var musicShowCaseApp=angular.module("MusicShowCaseApp");musicShowCaseApp.directive("keyboard",["$timeout","$uibModal","Midi","MusicContext",function(t,n,e,o){return{scope:{instrument:"=instrument"},templateUrl:"site/templates/keyboard.html",link:function(i,u,a){var s=function(t){var n=t.data[0],e=t.data[1],o=(t.data[2],Math.floor(e/12));if(!(o<0)){var u=i.octaves[o];u&&(144===n?(u.midi[e%12]=!0,u.update()):128===n&&(u.midi[e%12]=!1,u.update()))}},c=e.registerEventListener(s),d=function(){e.getStatus().then(function(n){t(function(){i.midiConnected=n.connected})})};d(),i.$on("$destroy",function(){c.destroy()});var r={90:"C",83:"C#",88:"D",68:"D#",67:"E",86:"F",71:"F#",66:"G",72:"G#",78:"A",74:"A#",77:"B"},m=function(t){return t.stopAll()},f=function(t){return t.update()};i.midiSetup=function(){n.open({templateUrl:"site/templates/modal/midiSettings.html",controller:"midiSettingsModalCtrl"}).result.then(d)},i.stopAll=function(){i.octaves.forEach(m)};var p=function(n){return{mouse:{},key:{},midi:{},note:[],play:function(t){this.note[t]||(this.note[t]=i.instrument.note(n+t).play())},stop:function(t){this.note[t]&&(this.note[t].stop(),this.note[t]=void 0)},update:function(){for(var n=0;n<12;n++)this.mouse[n]||this.key[n]||this.midi[n]?this.play(n):this.stop(n);t(function(){})},stopAll:function(){this.note.forEach(function(t){t&&t.stop&&t.stop()}),this.note=[]}}},l=function(){o.resumeAudio()},v=function(t){l(),t.mouse={},t.update()};i.mouseLeave=function(t,n){l(),t.mouse[n]=!1,t.update()},i.mouseEnter=function(t,n){l(),i.octaves.forEach(v),t.mouse[n]=!0,i.octaves.forEach(f)};var h=function(t){if(l(),"input"!==document.activeElement.tagName.toLowerCase()){var n=t.keyCode,e=r[n];if(e){var o=MUSIC.noteToNoteNum(e);i.octaves[1].key[o]=!0,i.octaves[1].update(),i.$digest()}}},y=function(t){l();var n=t.keyCode,e=r[n];if(e){var o=MUSIC.noteToNoteNum(e);i.octaves[1].key[o]=!1,i.octaves[1].update(),i.$digest()}};$(document).bind("keydown",h),$(document).bind("keyup",y);var k=$(u).find(".piano-firstrow .key"),C=$(u).find(".piano-secondrow .key");k.bind("click",l),C.bind("click",l),i.$on("$destroy",function(){$(document).unbind("keydown",h),$(document).unbind("keyup",y),k.unbind("click",l),C.unbind("click",l),i.octaves.forEach(function(t){t.stopAll()})}),i.octaves=[24,36,48,60,72].map(p),i.$watch("instrument",function(t){i.instrument=t})}}}]);
musicShowCaseApp.directive("musicEventEditor",["$timeout","TICKS_PER_BEAT","Pattern","MusicContext",function(e,t,o,n){return{scope:{pattern:"=pattern",track:"=track",zoomLevel:"=zoomLevel",beatWidth:"=beatWidth",measure:"=measure",measureCount:"=measureCount",recipe:"=recipe"},templateUrl:"site/templates/directives/musicEventEditor.html",link:function(a,s,r){a.TICKS_PER_BEAT=t;var i=t,l=function(){a.shadowEvt=null},v=l,u=function(e){var n=t/a.zoomLevel;if(e.target.classList.contains("event-list")){if(a.shadowEvt=a.shadowEvt||{},a.shadowEvt.n=Math.floor(h()-e.offsetY/20),a.shadowEvt.l=i,a.shadowEvt.s){var s=Math.floor(e.offsetX/a.beatWidth/a.zoomLevel*t);s=Math.floor(s);var r=o.findClipS(a.pattern,a.track,{s:s,l:i},s);if(Math.abs(s-r-n/2)<n)return a.shadowEvt.s=r,void o.cutEvent(a.pattern,a.track,a.shadowEvt)}a.shadowEvt.s=Math.floor(2*Math.floor(e.offsetX/2/a.beatWidth)/a.zoomLevel*t),a.shadowEvt.s<0&&(a.shadowEvt.s=0),o.cutEvent(a.pattern,a.track,a.shadowEvt)}},c=function(e){return[0,[0,1],1,[1,2],2,3,[3,4],4,[4,5],5,[5,6],6][e%12]},f=function(e){return["C","D","E","F","G","A","B"][e%7]};a.raiseEventChanged=function(e,t,o){a.$emit("eventChanged",{oldevt:e,evt:t,track:o})},a.noteName=function(e){var t=c(e),o=Math.floor(e/12);return Array.isArray(t)?(t=t[0],f(t)+"#"+o):f(t)+o};var m=function(){a.mainGridStyle={"background-size":a.measure*a.beatWidth*a.zoomLevel+"px 240px"}};a.$watch("[measure, beatWidth, zoomLevel]",m),a.$watch("track.scroll",function(){a.$emit("trackChanged",a.track)}),e(m);var d=function(e){a.track.events.find(function(t){return e.s===t.s&&e.n===t.n})||(e=angular.copy(e),o.collision(a.track,e)||(a.$emit("patternSelectEvent",e),a.selected=e,a.recipe.raise("pattern_note_added"),a.track.events.push(e),a.$emit("trackChanged",a.track),a.$emit("eventChanged",{oldevt:{},evt:e,track:a.track}),a.mouseMove=E(e,0),a.mouseMoveEvent=M(e,0),l(),a.mouseLeave=function(){v(),k()},a.mouseUpResizeEvent=k,a.mouseUpEvent=k,a.mouseUp=k))};a.mouseMoveResizeEvent=function(){l()},a.shadowMouseMove=function(e){var n=2*Math.floor(e.offsetX/2/a.beatWidth)/a.zoomLevel*t;n>0&&(a.shadowEvt.s=a.shadowEvt.s+n),o.cutEvent(a.pattern,a.track,a.shadowEvt)},a.addFromShadow=function(e){d(a.shadowEvt)},a.mouseUp=function(e){a.mouseMove=u},a.mouseLeave=function(){v(),a.mouseMove=u},a.mouseMove=u,a.mouseMoveEvent=l;var h=function(){return"tempo"===a.track.instrument?1024:120},p=function(e,t){return function(){var n=angular.copy(e);t.apply(null,arguments);return o.collision(a.track,e)?(e.n=n.n,e.s=n.s,void(e.l=n.l)):void(e.n===n.n&&e.l===n.l&&e.s===n.s||(a.$emit("trackChanged",a.track),a.$emit("eventChanged",{oldevt:n,evt:e,track:a.track})))}},E=function(e,s){return function(r){n.resumeAudio();var i=t/a.zoomLevel,l=({n:e.n,s:e.s,l:e.l},Math.floor((r.offsetX-s)/a.beatWidth/a.zoomLevel*t));l=Math.floor(l);var v=o.findClipS(a.pattern,a.track,e,l);if(r.target.classList.contains("event-list")){Math.abs(l-v-i/2)<i?e.s=v:(e.s=2*Math.floor((r.offsetX-s)/2/a.beatWidth)/a.zoomLevel*t,e.s=Math.floor(e.s)),e.s<0&&(e.s=0);e.n;e.n=Math.floor(h()-r.offsetY/20)}}},M=function(e,s){return l(),function(r,i){n.resumeAudio();var l=t/a.zoomLevel,v=({n:e.n,s:e.s,l:e.l},r.s+Math.floor((i.offsetX-s)/a.beatWidth/a.zoomLevel*t));v=Math.floor(v);var u=o.findClipS(a.pattern,a.track,e,v);Math.abs(v-u-l/2)<l?e.s=u:(e.s=r.s+2*Math.floor((i.offsetX-s)/2/a.beatWidth)/a.zoomLevel*t,e.s=Math.floor(e.s)),e.n=r.n,e.s<0&&(e.s=0)}},k=function(){a.mouseMoveEvent=l,a.mouseMove=u,a.mouseLeave=v};a.mouseDown=function(e){if(n.resumeAudio(),e.target.classList.contains("event-list")){var s={n:Math.floor(h()-e.offsetY/20),s:Math.floor(e.offsetX/a.beatWidth)/a.zoomLevel*t,l:i};s.s=Math.floor(s.s),o.cutEvent(a.pattern,a.track,s),d(s)}};var L=function(e,t){var o=e.l;e.l=t;var n={n:e.n,s:e.s+e.l,l:o-t};a.recipe.raise("pattern_note_added"),a.track.events.push(n)},z=function(e){e.l%3===0?L(e,e.l/3):b(e)},w=function(e){e.l%3===0?L(e,2*e.l/3):b(e)},b=function(e){e.l%2===0&&L(e,e.l/2)};a.mouseDblClickEvent=function(e,t){var o=$(t.target)[0].clientWidth+5;t.offsetX<o/3?z(e):t.offsetX>2*o/3?w(e):b(e)},a.mouseDownEvent=function(e,t){n.resumeAudio(),t.preventDefault(),document.activeElement.blur(),a.$emit("eventSelected",{evt:e,track:a.track}),a.$emit("patternSelectEvent",e),a.selected=e,a.mouseMove=p(e,E(e,t.offsetX)),a.mouseMoveEvent=p(e,M(e,t.offsetX)),l(),a.mouseLeave=function(){v(),k()};var o=function(){a.recipe.raise("pattern_note_drag"),k()};a.mouseUpResizeEvent=o,a.mouseUpEvent=o,a.mouseUp=o},a.mouseDownResizeEvent=function(e,s){n.resumeAudio(),s.preventDefault(),a.$emit("patternSelectEvent",e),a.selected=e,a.mouseMove=p(e,function(n){var s=({n:e.n,s:e.s,l:e.l},t/a.zoomLevel),r=o.findClipL(a.pattern,a.track,e,e.s);if(n.target.classList.contains("event-list")){var l=Math.floor(n.offsetX/a.beatWidth/a.zoomLevel*t)-e.s;if(Math.abs(l-r-s)<s)e.l=r;else{var v=2*Math.floor(n.offsetX/a.beatWidth/2)/a.zoomLevel*t;e.l=v-e.s,e.l=Math.floor(e.l),e.l<t/a.zoomLevel&&(e.l=t/a.zoomLevel),i=e.l}}}),a.mouseMoveEvent=p(e,function(n,s){var r=({n:e.n,s:e.s,l:e.l},t/a.zoomLevel),l=o.findClipL(a.pattern,a.track,e,e.s),v=n.s+Math.floor(s.offsetX/a.beatWidth/a.zoomLevel*t)-e.s;if(Math.abs(v-l-r)<r)e.l=l;else{var u=n.s+2*Math.floor(s.offsetX/a.beatWidth/2)/a.zoomLevel*t;e.l=u-e.s,e.l=Math.floor(e.l),e.l<t/a.zoomLevel&&(e.l=t/a.zoomLevel),i=e.l}}),a.mouseUpResizeEvent=k,a.mouseUpEvent=k,a.mouseUp=k};var C=function(t){"input"!==document.activeElement.tagName.toLowerCase()&&46==t.keyCode&&e(function(){a.track.events=a.track.events.filter(function(e){return e!==a.selected}),a.$emit("trackChanged",a.track)})};$(document).bind("keydown",C),a.$on("$destroy",function(){$(document).unbind("keydown",C)}),a.$on("trackSelectEvent",function(e,t){a.selected=t})}}}]);
var musicShowCaseApp=angular.module("MusicShowCaseApp");musicShowCaseApp.directive("ngfDrop",["$parse",function(e){return{restrict:"A",link:function(n,r,t){var o=e(t.ngfDrop),i=function(e){e.dataTransfer.dropEffect="copy",e.preventDefault()},d=function(e){o(n,{$files:e.dataTransfer.files}),e.preventDefault()};window.addEventListener("dragenter",i),window.addEventListener("dragover",i),window.addEventListener("drop",d),n.$on("$destroy",function(){window.removeEventListener("dragenter",i),window.removeEventListener("dragover",i),window.removeEventListener("drop",d)})}}}]);
var musicShowCaseApp=angular.module("MusicShowCaseApp");musicShowCaseApp.directive("ngfLoader",["$parse",function(e){return{restrict:"A",link:function(n,a,o){var i=e(o.ngfLoader),r=function(e){i(n,{$files:e.target.files}),$(a).val("")};$(a).on("change",r),n.$on("$destroy",function(){$(a).off("change",r)})}}}]);
musicShowCaseApp.directive("patternTrackCompactView",["$timeout","TICKS_PER_BEAT","Recipe","Pattern","MusicContext",function(e,t,o,a,n){return{scope:{pattern:"=pattern",track:"=track",zoomLevel:"=zoomLevel",beatWidth:"=beatWidth",measure:"=measure",measureCount:"=measureCount"},templateUrl:"site/templates/directives/patternTrackCompactView.html",link:function(e,r){e.recipe=o.start,e.TICKS_PER_BEAT=t;var s=function(e){return[0,[0,1],1,[1,2],2,3,[3,4],4,[4,5],5,[5,6],6][e%12]},i=function(e){return["C","D","E","F","G","A","B"][e%7]};e.noteName=function(e){var t=s(e),o=Math.floor(e/12);return Array.isArray(t)?(t=t[0],i(t)+"#"+o):i(t)+o};var l=function(){e.mainGridStyle={"background-size":e.measure*e.beatWidth*e.zoomLevel+"px 240px","background-position":-e.pattern.scrollLeft+"px"}};e.$watch("[measure, beatWidth, zoomLevel, pattern.scrollLeft]",l),e.$on("trackSelectEvent",function(t,o){e.selected=o});var c=function(t){e.$emit("enableTrack",e.track),e.mouseMove=function(){}};e.mouseUp=c,e.mouseLeave=function(){e.mouseMove=function(){}};var u=function(){e.mouseMoveEvent=function(){},e.mouseMove=function(){},e.mouseLeave=function(){}};e.mouseDownEvent=function(o,r){var s=!1,i=function(o,r){return function(i){n.resumeAudio();var l=t/e.zoomLevel,c={n:o.n,s:o.s,l:o.l};if(i.target.parentElement.classList.contains("track-compact-view")){var u=Math.floor((i.offsetX-r)/e.beatWidth/e.zoomLevel*t);u=Math.floor(u);var v=a.findClipS(e.pattern,e.track,o,u);Math.abs(u-v-l/2)<l?o.s=v:(o.s=2*Math.floor((i.offsetX-r)/2/e.beatWidth)/e.zoomLevel*t,o.s=Math.floor(o.s)),o.s<0&&(o.s=0),o.s!==c.s&&(s=!0),e.$emit("trackChanged",e.track),e.$emit("eventChanged",{oldevt:c,evt:o,track:e.track})}}},l=function(o,r){return function(i,l){n.resumeAudio();var c=t/e.zoomLevel,u={n:o.n,s:o.s,l:o.l},v=i.s+Math.floor((l.offsetX-r)/e.beatWidth/e.zoomLevel*t);v=Math.floor(v);var m=a.findClipS(e.pattern,e.track,o,v);Math.abs(v-m-c/2)<c?o.s=m:(o.s=i.s+2*Math.floor((l.offsetX-r)/2/e.beatWidth)/e.zoomLevel*t,o.s=Math.floor(o.s)),o.s<0&&(o.s=0),o.s!==u.s&&(s=!0),e.$emit("trackChanged",e.track),e.$emit("eventChanged",{oldevt:u,evt:o,track:e.track})}};r.preventDefault(),document.activeElement.blur(),e.$emit("eventSelected",{evt:o,track:e.track}),e.mouseMove=i(o,r.offsetX),e.mouseMoveEvent=l(o,r.offsetX),e.mouseLeave=function(){u()};var v=function(){e.recipe.raise("pattern_note_drag"),u()};e.mouseUpResizeEvent=v,e.mouseUpEvent=v,e.mouseUp=function(){e.mouseUp=c,s||e.$emit("enableTrack",e.track),e.$emit("patternSelectEvent",o),v()}},e.mouseDownResizeEvent=function(o,r){var s=!1;r.preventDefault(),e.mouseMove=function(r){n.resumeAudio();var i={n:o.n,s:o.s,l:o.l},l=t/e.zoomLevel,c=a.findClipL(e.pattern,e.track,o,o.s);if(r.target.parentElement.classList.contains("track-compact-view")){var u=Math.floor(r.offsetX/e.beatWidth/e.zoomLevel*t)-o.s;if(Math.abs(u-c-l)<l)o.l=c;else{var v=2*Math.floor(r.offsetX/e.beatWidth/2)/e.zoomLevel*t;o.l=v-o.s,o.l=Math.floor(o.l),o.l<t/e.zoomLevel&&(o.l=t/e.zoomLevel),defaultL=o.l}o.l!==i.l&&(s=!0),e.$emit("trackChanged",e.track),e.$emit("eventChanged",{oldevt:i,evt:o,track:e.track})}},e.mouseMoveEvent=function(r,i){n.resumeAudio();var l={n:o.n,s:o.s,l:o.l},c=t/e.zoomLevel,u=a.findClipL(e.pattern,e.track,o,o.s),v=r.s+Math.floor(i.offsetX/e.beatWidth/e.zoomLevel*t)-o.s;if(Math.abs(v-u-c)<c)o.l=u;else{var m=r.s+2*Math.floor(i.offsetX/e.beatWidth/2)/e.zoomLevel*t;o.l=m-o.s,o.l=Math.floor(o.l),o.l<t/e.zoomLevel&&(o.l=t/e.zoomLevel),defaultL=o.l}o.l!==l.l&&(s=!0),e.$emit("trackChanged",e.track),e.$emit("eventChanged",{oldevt:l,evt:o,track:e.track})},e.mouseUpResizeEvent=u,e.mouseUpEvent=u,e.mouseUp=function(){e.mouseUp=c,s||e.$emit("enableTrack",e.track),e.$emit("patternSelectEvent",o),u()}}}}}]);
musicShowCaseApp.directive("playingLine",["$timeout","$parse","TICKS_PER_BEAT",function(n,e,t){return{scope:{},replace:!0,templateUrl:"site/templates/directives/playingLine.html",link:function(n,o,i){var r,a,c,p,s,l=!1,m=e(i.bpm),u=e(i.zoomLevel),f=e(i.beatWidth),w=function(e){return p=u(n.$parent),s=f(n.$parent),e*p*s/t},d=function C(){if(c&&l){var n=a(window.performance.now()-r),e=w(n);o.css("left",e+"px")}requestAnimationFrame(C)},v=($(o),requestAnimationFrame(d));n.$on("startClock",function(e,t){var o=window.performance.now();l=!0,c=m(n.$parent),a=t,r=o}),n.$on("stopClock",function(n){l=!1}),n.$on("pauseClock",function(e){var t=a(window.performance.now()-r),i=w(t||0);l=!1,n.$emit("pausedClock",t),o.css("left",i+"px")}),n.$on("resetClock",function(n,e){var t=w(e||0);l=!1,o.css("left",t+"px")}),n.$on("$destroy",function(){cancelAnimationFrame(v)})}}}]);
var musicShowCaseApp=angular.module("MusicShowCaseApp");musicShowCaseApp.directive("recipeBlink",["$parse","$timeout","Recipe",function(n,i,e){return{restrict:"A",link:function(o,a,c){var l=n(c.recipeBlink),r=l(o);Array.isArray(r)||(r=[r]);var t=function(){i(function(){$(a).addClass("blink")})},u=function(){i(function(){$(a).removeClass("blink")})},s=function(n){e.getBlinks().indexOf(n)!==-1&&t(),o.$on("_blink_enable_"+n,function(n,i){t()}),o.$on("_blink_disable_"+n,function(){u()}),o.$on("__blink_disable_all",function(){u()})};r.forEach(s)}}}]);
var musicShowCaseApp=angular.module("MusicShowCaseApp");musicShowCaseApp.directive("recipeTooltip",["$parse","$timeout",function(t,i){return{restrict:"E",scope:{},template:'<div ng-click="onClick($event)" ng-class="{\'show-recipe-tooltip\': tooltipEnabled, \'cap-right\': capRight}" class="help-tooltip recipe-tooltip"><p>{{text|translate}}</p></div>',link:function(o,e,n){var l=t(n.rtId),p=l(o.$parent);o.tooltipEnabled=!1,o.onClick=function(t){o.$parent.recipe.raise("tooltip_click"),t.stopImmediatePropagation()},o.$on("_tooltip_display_"+p,function(t,n){i(function(){var t=Math.max(document.documentElement.clientWidth,window.innerWidth||0),i=e[0],l=t-i.getBoundingClientRect().left;o.capRight=l<300,o.text=n.text,o.tooltipEnabled=!0})}),o.$on("_tooltip_hide_"+p,function(){o.tooltipEnabled=!1}),o.$on("__tooltip_hide_all",function(){o.tooltipEnabled=!1})}}}]);
var musicShowCaseApp=angular.module("MusicShowCaseApp");musicShowCaseApp.directive("recipeWizard",["$timeout",function(e){return{restrict:"E",template:'<div class="recipe-wizard"><p>{{text}}</p></div>',link:function(e,i,t){}}}]);
var musicShowCaseApp=angular.module("MusicShowCaseApp");musicShowCaseApp.directive("recycleBinCompactView",["$timeout","$uibModal","FileRepository","ErrMessage",function(e,t,o,c){return{templateUrl:"site/templates/directives/recycleBinCompactView.html",scope:{},link:function(i,n,r){var l=o.observeRecycled(function(){o.searchRecycled(null,{limit:10}).then(function(t){e(function(){i.files=t.results.slice(0,4)})})});i.$on("destroy",l.destroy),i.openRecycleBin=function(){t.open({templateUrl:"site/templates/modal/recycleBin.html",controller:"recycleBinModalCtrl"})},i.restore=function(e){o.restoreFromRecycleBin(e.id).then(function(){"project"===e.type?document.location="#/editor/"+e.id:document.location="#/editor/"+e.project+"/"+e.type+"/"+e.id})},i.onDropComplete=function(e){o.moveToRecycleBin(e.id)["catch"](function(e){if(!e.type||"cantremove"!==e.type)throw e;c("common.error_title","common.cantremove_error")})}}}}]);
var musicShowCaseApp=angular.module("MusicShowCaseApp");musicShowCaseApp.filter("icon_from_type",function(){return function(e){return"instrument"===e?"keyboard":"tempo"===e?"clock":"song"===e?"th":"pattern"===e?"music":"fx"===e?"magic":"project"===e?"folder":"question"}}),musicShowCaseApp.directive("typeIcon",["$parse",function(e){return{restrict:"A",scope:{},replace:!0,template:'<span class="fa fa-{{typeIcon | icon_from_type}}">',link:function(t,n,c){var o=e(c.typeIcon);t.$parent.$watch(o,function(e){t.typeIcon=o(t.$parent)})}}}]);
var musicShowCaseApp=angular.module("MusicShowCaseApp");musicShowCaseApp.factory("MusicObjectFactory",["MusicContext","$q","TypeService","pruneWrapper",function(e,n,t,r){var u=new WeakMap;return function(r){var i=0,o={},a={},c=r&&r.monitor,s=function(e,r){return t.getType(e.type).then(function(t){if(t.monitor&&!c)return function(e){var n=e[0];return function(e){return n(e)}};var u=function(u){var c=[];return t.components&&t.components.forEach(function(n){if(e.data.modulation){var t=e.data.modulation[n];t&&t.data&&t.data.array&&0!==t.data.array.length&&c.push(p(t).then(function(e){return{name:n,obj:e}}))}}),n.all(c).then(function(n){var c={};n.forEach(function(e){c[e.name]=e.obj}),o[r]=o[r]||new WeakMap,a[r]=a[r]||new WeakMap;var s=o[r],f=a[r];s.set(e,e.type);var l=t.constructor(e.data,u,c);return i++,l.id=i,1===u.length?(f.has(e)||f.set(e,{}),f.get(e)[u[0].id]=l):0===u.length&&(f.has(e)||f.set(e,{}),f.get(e).noid=l),l})};return u.subobjects=t.subobjects,u})},f=function y(e,t,r){if(0===e.length)return n.when(null);var u=e[t];return r=r||0,s(u,r).then(function(i){if(i.subobjects){var o=function(n,u){var i=n.data.array.concat(e.slice(t+1));return y(i,0,16*r+u)};return n.all(u.data.subobjects.map(o)).then(function(e){return i(e)})}return 1===e.length?i([]):y(e.slice(t+1),0,r).then(function(e){return i([e])})}).then(function(e){return e&&e.dataLink&&e.dataLink(l(u)),e})},l=function(e){return function(n){if(u.has(e)){var t=u.get(e);t.emit("changed",n)}}},p=function(e){return"stack"===e.type?f(e.data.array,0):s(e,0).then(function(e){return e([])})},m=function(e){for(var t in o)o[t]=new WeakMap;for(var t in a)a[t]=new WeakMap;return d.forEach(function(e){e.prune()}),d=[],n.when(null)},d=[],h=function(n,t){return p(n).then(function(n){if(n){if(t){var r=t.sfxBase();return d.push(r),n(r)}return e.runFcn(function(e){var t=e.sfxBase();return d.push(t),n(t)})}})},v=function(e,n){var t;return u.has(e)?t=u.get(e):(t=new EventEmitter,u.set(e,t)),t.on("changed",n),{destroy:function(){t.removeListener("changed",n)}}};return{create:h,destroyAll:m,observeOutput:v}}}]),musicShowCaseApp.service("MusicContext",function(){var music,context,Recordable=function(e,n,t){this._playable=n,this._music=e,this._name=t};return Recordable.prototype.record=function(){var e=this._playable,n=music.record(),t=this._name;e.play();MUSIC.Utils.FunctionSeq.preciseTimeout(function(){n.stop(),n.exportWAV(function(e){var n=document.createElement("a");document.body.appendChild(n),n.style="display: none";var r=window.URL.createObjectURL(e);n.href=r,n.download=t+".wav",n.click(),window.URL.revokeObjectURL(r)})},e.duration())},{resumeAudio:function(){music||(context=new MUSIC.Context,music=context.sfxBase()),context.resume()},runFcn:function(e){return music||(context=new MUSIC.Context,music=context.sfxBase()),e(music)},record:function(e,n){return this.runFcn(function(){return context.record(e,n)})},run:function run(code){music&&music.prune(),music=(new MUSIC.Context).sfxBase();try{return{object:eval("(function() {\n"+code+"\n})")()}}catch(e){return{error:e.toString()}}}}}),musicShowCaseApp.service("Historial",[function(){return function(){var e=[],n=0,t=function(){return n>0&&n--,e[n]},r=function(){return n<e.length-1&&n++,e[n]},u=function(t){e=e.slice(0,n+1),e.push(t),e.length>128&&(e=e.slice(1)),n=e.length-1};return{registerVersion:u,undo:t,redo:r}}}]),musicShowCaseApp.service("Pattern",["MUSIC","TICKS_PER_BEAT",function(e,n){var t=function(e,t,r,u,i,o){for(var a=r.events.sort(function(e,n){return e.s-n.s}),c=a.map(function(e){return[e.n,e.s,e.l,{tc:e.tc}]}),s=0;s<c.length;s++){var f=c[s];e.push(u(f,c),o)}e.paddingTo(n*t.measureCount*t.measure),e.pushCallback([n*t.measureCount*t.measure,i]);t.measure*t.measureCount},r=function d(n,r,u,i){var d=new e.NoteSequence;return t(d,n,r,u,i),d},u=function(r,u,i,o,a){var c=a&&a.start||0,s=function(e,n){n=i+n;var t=u[e.instrument+"_"+n];return t&&t.tempo},f=function(e){return e.events},l=function(e,n){return e.concat(n)},p=function(e,n){return e.s-n.s},m={},d=new e.NoteSequence(null,{time:e.Math.ticksToTime({bpm:r.bpm,ticks_per_beat:n,bpm_events:r.tracks.filter(s).map(f).reduce(l,[]).sort(p),start:c}),songCtx:m});r.tracks.forEach(function(n,a){a=i+a;var c=u[n.instrument+"_"+a];if(c&&!c.tempo){var s=c.eventPreprocessor||function(e){return e},f=e.NoteSequence.context(c,null,m);t(d,r,n,s,o,f)}});var h=d.makePlayable(null);return h.schedule=function(n,a){var c=[];return a=a||{},r.tracks.forEach(function(s,f){f=i+f;var l=u[s.instrument+"_"+f];if(l){var p=l.eventPreprocessor||function(e){return e},m=e.NoteSequence.context(l,null,a);c.push(m),t(n,r,s,p,o,m)}}),c},h.timeToTicks=function(){return e.Math.timeToTicks({bpm:r.bpm,ticks_per_beat:n,bpm_events:r.tracks.filter(s).map(f).reduce(l,[]).sort(p),start:c})},h.bpm_events=r.tracks.filter(s).map(f).reduce(l,[]).sort(p),h},i=function(e,n){return e>n?e:n},o=function(e,t){t<1&&(t=1);var r=e.tracks.map(function(e){return e.events.map(function(e){return e.s+e.l}).reduce(i,0)}).reduce(i,0),u=t*n,o=Math.floor((r-1)/u)+1;return o<1?1:o},a=function(e){var n=e.tracks.some(function(e){return e.solo});return e.tracks.map(function(e){return n?e.muted||!e.solo:e.muted||!e.instrument})},c=function(e,n){return e.concat(n)},s=function(e){return function(n){return n!==e}},f=function(e,n,t,r){var u=function(e,n){return Math.abs(t.s-e)<Math.abs(t.s-n)?e:n},i=e.tracks.map(function(e){return e.events.filter(s(t))}).reduce(c),o=e.tracks.map(function(e){return n===e?[]:e.events.filter(s(t))}).reduce(c);if(0===i.length)return 0;var a=i.map(function(e){return e.s+e.l}).concat(i.map(function(e){return e.s-t.l})).concat(o.map(function(e){return e.s}));return a.reduce(u)},l=function(e,n,t,r){var u=function(e,n){return Math.abs(t.s+t.l-e)<Math.abs(t.s+t.l-n)?e:n},i=e.tracks.map(function(e){return e.events.filter(s(t))}).reduce(c),o=e.tracks.map(function(e){return n===e?[]:e.events.filter(s(t))}).reduce(c);if(0===i.length)return 0;var a=i.map(function(e){return e.s}).concat(o.map(function(e){return e.s+e.l}));return a.reduce(u)-t.s},p=function(e,t,r){var u=t.events.filter(s(r));u.filter(function(e){return e.s>r.s}).forEach(function(e){r.s+r.l>e.s&&(r.l=e.s-r.s)});var i=e.measure*n;(r.s+r.l)%i<r.s%i&&(r.l=r.l-(r.s+r.l)%i)},m=function(e,n){var t=e.events.filter(s(n));return t.some(function(e){return e.n===n.n&&(e.s<=n.s&&n.s<e.s+e.l||n.s<=e.s&&e.s<n.s+n.l)})};return{noteseq:r,patternCompose:u,computeMeasureCount:o,getMutedState:a,findClipL:l,findClipS:f,cutEvent:p,collision:m}}]),musicShowCaseApp.service("InstrumentSet",["FileRepository","MusicObjectFactory","MusicContext",function(e,n,t){var r=function(t){var r,u={},i={},o=[],a=function(a,c){c=c||0;var s=a+"_"+c;return i[s]||(u[c]=u[c]||t.gain(1),i[s]=e.getFile(a).then(function(e){return"instrument"===e.index.type?(r||(r=n()),r.create(e.contents,u[c]).then(function(e){return o.push(e),e})):{tempo:!0}})),i[s]},c=function(){if(o.forEach(function(e){e.dispose&&e.dispose()}),r)return r.destroyAll()},s=function(e,n){u[e]=u[e]||t.gain(1),u[e].update(n?0:1)};return{load:a,mute:s,all:i,dispose:c}};return function(e){return e?r(e):t.runFcn(r)}}]),musicShowCaseApp.service("FileRepository",["$http","$q","TypeService","Historial","Index","_localforage",function(e,n,t,r,u,i){var o=[],a={},c=["site/builtin/defaultProject.json","site/builtin/samples.json","site/builtin/smb-underworld.json","site/builtin/smb-overworld.json","site/builtin/bomberman.json","site/builtin/entertainer.json","site/builtin/eva-thanatos.json","site/builtin/bioshock-solace.json"],s=function(n){return e.get(n).then(function(e){e.data.forEach(function(e){var n=e.id;a[n]=e.contents,o.push({project:e.project,type:e.type,name:e.name,id:n,ref:e.ref,builtIn:!0})})})},f=function(e,n,t,r){o.push({project:"default",type:n,id:e,name:t,noExportable:!0}),a[e]=r};f("tempo","tempo","Tempo",{});var l=n.all(c.map(s)),p=function(){for(var e=[],n=0;n<32;n++){var t=[0,1,2,3,4,5,6,7,8,9,"a","b","c","d","e","f"][Math.floor(16*Math.random())];e.push(t)}return e.join("")},m=new EventEmitter,d=new EventEmitter,h={instrument:{type:"stack",data:{array:[]}},song:{measure:4,bpm:140,tracks:[{blocks:[{},{},{}]},{blocks:[{},{},{}]}]},pattern:{measure:4,measureCount:1,bpm:140,selectedTrack:0,tracks:[{scroll:1e3,events:[]}],scrollLeft:0}},v=new WeakMap,y=function(e,t,u){return n.when().then(function(){var n=o.filter(function(n){return n.id===e})[0];return n?n:T.getEntry(e)}).then(function(n){if(n){var o=MUSIC.Formats.MultiSerializer.serialize(n.type,t);return u&&u.noHistory||(v[e]=v[e]||r(),v[e].registerVersion(JSON.stringify(t))),i.setItem(e,o)}}).then(function(){return R.reload()}).then(function(){d.emit("changed")})},g=function(e){return i.removeItem(e).then(function(){return n.all({r:R.removeEntry(e),l:T.removeEntry(e)})})},b=function(e){return R.removeEntry(e)},S=function(e){return C(e).then(function(){m.emit("changed"),d.emit("changed")})},C=function P(e){return R.getEntry(e).then(function(t){if(t)return R.removeEntry(e).then(function(){return T.createEntry(t)}).then(function(){var e=t.ref||[];return t.project&&e.push(t.project),n.all(e.map(P))})})},M=function(e){return w(e).then(function(){m.emit("changed"),d.emit("changed")})},w=function J(e){var t=function(e){return e.id},r=function(e){return"project"===e.type};return T.willRemove(e).then(function(){return T.getEntry(e).then(function(n){if(n)return R.getAll().then(function(n){if(n&&n.length>=100)return R.getFreeItems().then(function(n){if(n[0])return R.removeEntry(n[0].id).then(function(){return i.removeItem(e)})})}).then(function(){return T.removeEntry(e)}).then(function(){return R.createEntry(n)})})}).then(function(){return T.getOrphan(o.map(t),o.filter(r).map(t))}).then(function(e){return n.all(e.map(t).map(J))["catch"](function(e){console.error(e)})})},k=function(e){var t=function(n){return n.project===e.project},r=function(e){return"pattern"===e.type||"song"===e.type},u=function(e){return"song"===e.type},i=function(e){return I(e.id)};return n.all({storage:T.getAll(),builtin:o}).then(function(e){var o=e.storage.concat(e.builtin),a=o.filter(t).filter(r);return a.some(u)&&(a=a.filter(u)),n.all(a.map(i))})},x=function(e,n){var t={};e.forEach(function(e){var r=n(e);t[r]=(t[r]||0)+1});var r,u=0;for(var i in t){var o=t[i];o>u&&(r=i,u=o)}return r},E=function(e){return k(e).then(function(e){return e.length?x(e,function(e){return e.contents.measure}):4})},j=function(e){return k(e).then(function(e){return e.length?x(e,function(e){return e.contents.bpm}):140})},I=function(e){var n=!1;return l.then(function(){var t=o.filter(function(n){return n.id===e})[0];return t?(n=!0,t):T.getEntry(e)}).then(function(t){return i.getItem(e).then(function(r){if(r){var u=MUSIC.Formats.MultiSerializer.deserialize(t.type,r);return{index:{name:t.name,id:t.id,builtIn:n,type:t.type,ref:t.ref||N(t.type,u),updated:!0,project:t.project},contents:u}}if(t)return{index:{name:t.name,id:t.id,builtIn:n,type:t.type,ref:t.ref,project:t.project,noExportable:t.noExportable},contents:JSON.parse(JSON.stringify(a[e]))}})})},F=function(e){var t=e.id||p(),u=e.contents||h[e.type]||{};return n.all({defaultMeasure:E(e),defaultBPM:j(e)}).then(function(e){u.measure=parseInt(e.defaultMeasure),u.bpm=parseInt(e.defaultBPM)}).then(function(){v[t]=v[t]||r(),v[t].registerVersion(JSON.stringify(u));var n=MUSIC.Formats.MultiSerializer.serialize(e.type,u);return i.setItem(t,n)}).then(function(){return T.createEntry({type:e.type,name:e.name,project:e.project,id:t,ref:e.ref})}).then(function(){return R.reload()}).then(function(){return m.emit("changed"),d.emit("changed"),t})["catch"](function(e){})},O=MUSIC.Formats.JSONSerializer,z=MUSIC.Formats.CachedSerializer(MUSIC.Formats.PackedJSONSerializer),U=MUSIC.Formats.HuffmanSerializerWrapper(O),_=MUSIC.Formats.HuffmanSerializerWrapper(z),A=MUSIC.Formats.CachedSerializer(MUSIC.Formats.PackedJSONSerializerB),L=MUSIC.Formats.HuffmanSerializerWrapper(A);MUSIC.Formats.MultiSerializer.setSerializers([{serializer:O,base:"0"},{serializer:z,base:"1"},{serializer:U,base:"2"},{serializer:_,base:"3"},{serializer:A,base:"4"},{serializer:L,base:"5"}]);var T=u("index"),R=u("recycle");R.getAll().then(function(){d.emit("changed")});var B=function(){m.emit("changed"),d.emit("changed")},N=function(e,n){var t=[];return"song"===e?n.tracks.forEach(function(e){for(var n=0;n<e.blocks.length;n++){var r=e.blocks[n].id;r&&t.indexOf(r)===-1&&t.push(r)}}):"pattern"===e&&n.tracks.forEach(function(e){e.instrument&&t.indexOf(e.instrument)===-1&&t.push(e.instrument)}),t},W=function(e){return T.getAll().then(function(n){return n.concat(o).filter(function(n){return n.project===e||n.id===e})})};return{getRefs:N,getProjectFiles:W,undo:function(e){var n=v[e].undo();if(n)return y(e,JSON.parse(n),{noHistory:!0})},redo:function(e){var n=v[e].redo();if(n)return y(e,JSON.parse(n),{noHistory:!0})},purgeFromRecycleBin:b,moveToRecycleBin:M,restoreFromRecycleBin:S,destroyFile:g,createFile:F,changed:B,updateIndex:function(e,t){var r=o.filter(function(n){return n.id===e})[0];return r?(r.name=t.name,m.emit("changed"),n.when(r)):T.updateEntry(e,t).then(function(){m.emit("changed")})},getIndex:function(e){var t=o.filter(function(n){return n.id===e})[0];return t?n.when(t):T.getEntry(e)},updateFile:y,getFile:I,observeRecycled:function(e){return R.reload().then(function(){d.emit("changed")}),d.addListener("changed",e),{destroy:function(){d.removeListener("changed",e)}}},searchRecycled:function(e,n){n=n||{};var t="undefined"==typeof n.limit?10:n.limit,r=function(){return!0};return e&&e.length>0&&(e=e.toLowerCase(),r=function(n){return n.name.toLowerCase().indexOf(e)!==-1}),R.getAll().then(function(e){var n=(e||[]).filter(r).reverse();return{results:t?n.slice(0,t):n,total:n.length}})},search:function(e,r){r=r||{};var u=function(){return!0};e&&e.length>0&&(e=e.toLowerCase(),u=function(n){return n.name.toLowerCase().indexOf(e)!==-1});var i=function(){return!0};r.project?i=function(e){return(!r.type||r.type.indexOf(e.type)!==-1)&&("tempo"===e.type||r.project.indexOf(e.project)!==-1)}:r.type&&(i=function(e){return r.type.indexOf(e.type)!==-1});var a=new EventEmitter,c=function(){l.then(function(){n.all([T.getAll(),o,t.getTypes(e)]).then(function(e){var n=function(e){return!0},t=e[0]||[];t.map(function(e){return e.id});e[1]&&(t=t.concat(e[1].filter(n))),t=t.concat(e[2].map(convertType)),t=t.filter(u).filter(i),a.emit("changed",{results:t.slice(0,15),total:t.length})})})};return{observe:function(e){return a.addListener("changed",e),m.addListener("changed",c),c(),{close:function(){a.removeListener("changed",e),m.removeListener("changed",c)}}}}}}}]);var convertType=function(e){return{type:"fx",name:e.name,id:"type"+e.name,project:"core"}};musicShowCaseApp.factory("pruneWrapper",function(){return function(e){return e._wrapper||(e._wrapper=function(n,t){var r,u=n.sfxBase(),i=e(u,t);return i.dispose?(r=i.dispose.bind(i),i.dispose=function(){r(),u.prune()}):i.dispose=function(){u.prune()},i}),e._wrapper}}),musicShowCaseApp.factory("sfxBaseOneEntryCacheWrapper",function(){return function(e){var n,t,r=function(r,u){return u=u||{},!u.nowrap&&n&&n===r?t:(n=r,t=e(r,u))};return r.update=function(){return e.update.bind(e).apply(null,arguments),r},r}});
var musicShowCaseApp=angular.module("MusicShowCaseApp");musicShowCaseApp.factory("ErrMessage",["$uibModal","$translate",function(r,e){return function(t,o){var a=r.open({templateUrl:"site/templates/modal/error.html",controller:"errorModalCtrl",windowClass:"error",resolve:{text:function(){return e(o)},title:function(){return e(t)}}});return a}}]);
var musicShowCaseApp=angular.module("MusicShowCaseApp");musicShowCaseApp.factory("Export",["$q","FileRepository",function(n,e){var t=function(n,e){var t=document.createElement("a");document.body.appendChild(t),t.style="display: none";var r=new Blob([JSON.stringify(e)]),o=window.URL.createObjectURL(r);t.href=o,t.download=n+".json",t.click(),window.URL.revokeObjectURL(o)},r=function(n){if("project"===n.index.type)return n.index.ref||[];var t=e.getRefs(n.index.type,n.contents);return n.index.project&&t.push(n.index.project),t},o=function(n,e){return n.concat(e)},i=function d(t){var o=[];return e.getFile(t).then(function(e){return e?e.index.noExportable?[]:(o.push({name:e.index.name,type:e.index.type,id:e.index.id,contents:e.contents,project:e.index.project,ref:e.index.ref}),n.all(r(e).map(d)).then(function(n){return n.forEach(function(n){o=o.concat(n)}),o})):[]})},c=function(n){var e={};return n.forEach(function(n){e[n.id]=n}),Object.keys(e).map(function(n){return e[n]})},u=function(r,u){var p=function(n){return n.id};e.getProjectFiles(u).then(function(e){return n.all(e.map(p).map(i))}).then(function(n){n=n.reduce(o,[]),t(r,c(n))})},p=function(n,e){return i(e).then(function(e){t(n,c(e))})},a=function(t){var r=function(n){return function(){return e.getIndex(n.id).then(function(t){return t?e.updateFile(n.id,n.contents).then(function(){return e.updateIndex(n.id,{name:n.name,project:n.project})}):e.purgeFromRecycleBin(n.id).then(function(){return e.createFile({id:n.id,contents:n.contents,type:n.type,name:n.name,project:n.project,ref:n.ref})})})}};return n.when().then(function(){var n=null,e=JSON.parse(t),o=e[0];return e.forEach(function(e){n=n?n.then(r(e)):r(e)()}),n.then(function(){return{id:o.id,type:o.type,project:o.project}})})};return{exportContents:t,exportFile:p,exportProject:u,importFile:a}}]);
var musicShowCaseApp=angular.module("MusicShowCaseApp");musicShowCaseApp.factory("Index",["$q","$timeout","Sync","_localforage",function(t,n,e,r){function u(t,n){this.id=t,this.file=n,this.stack=(new Error).stack,this.type="cantremove"}u.prototype=new Error;var i=function o(n){var i=new e,c=function(){var t;return t=r.getItem(n).then(function(t){return t||[]})},f=function(t){var n={id:t.id,name:t.name,type:t.type,project:t.project,ref:t.ref};return t.c&&(n.c=t.c),n},a=i.sync(function(t){return c().then(function(e){if(e)return e=e.filter(function(n){return n.id!==t}),r.setItem(n,e.map(f))}).then(c)}),l=function(t){return c().then(function(n){return n?n.filter(function(n){return n.id===t})[0]:null})},p=i.sync(function(t){return c().then(function(e){return e=e||[],o.isolatedContext&&(t.c=o.isolatedContext),e.push(t),r.setItem(n,e.map(f))}).then(c)}),s=i.sync(function(t,e){return c().then(function(u){var i=u.filter(function(n){return n.id===t})[0];return i.name=e.name,i.ref=e.ref,o.isolatedContext&&(i.c=o.isolatedContext),r.setItem(n,u.map(f))}).then(c)}),h=function(){return c().then(function(t){var n=o.isolatedContext;return n?t.filter(function(t){return t.c===n}):t})},m=function(t,n){return t.filter(function(t){return(t.ref||[]).indexOf(n)!==-1})},d=function(t){return"project"===t.type},y=function(t){return t.id},v=function g(n){return c().then(function(e){var r=e.filter(function(t){return t.id===n})[0];if(r){var i=m(e,n);if(0!==i.length){if("project"!==r.type)throw new u(n,r);if(i.some(d))throw new u(n,r);return t.all(i.map(y).map(g))}}})},w=function(t,n){return c().then(function(e){var r=e.filter(d).map(y).concat(n),u=e.map(y).concat(t||[]),i=function(t){return!(!t.project||r.indexOf(t.project)!==-1)||(t.ref||[]).some(function(t){return u.indexOf(t)===-1})};return e.filter(i)})},x=function(){return c().then(function(t){var n={};return t.forEach(function(t){(t.ref||[]).forEach(function(t){n[t]=!0})}),t.filter(function(t){return!n[t.id]})})};return c(),{willRemove:v,reload:c,removeEntry:a,getOrphan:w,getEntry:l,getFreeItems:x,createEntry:p,updateEntry:s,getAll:h}};return i}]);
var musicJs=angular.module("MusicShowCaseApp");musicJs.factory("Midi",["$q","Sync","_localforage",function(n,e,t){var i,u,r,o=new e,s=o.sync(function(n,e){return t.getItem("midiSetup").then(function(i){return i=i||{},i.inputs=i.inputs||{},i.inputs[n]=e,t.setItem("midiSetup",i)})});navigator.requestMIDIAccess&&(r=navigator.requestMIDIAccess({sysex:!1}));var a=function(n){var e=function(){n.onmidimessage=m,n.enabled=!0,s(n.id,!0)},t=function(){n.onmidimessage=null,n.enabled=!1,s(n.id,!1)},i=function(){this.enabled?e():t()},u={enabled:!!n.onmidimessage,enable:e,disable:t,update:i,name:n.name,id:n.id};return u},c=function(){return u.then(function(){return r}).then(function(n){for(var e={connected:!1},t=n.inputs.values(),i=t.next();i&&!i.done;i=t.next())i.value.onmidimessage&&(e.connected=!0);return e})},f=function(){return r.then(function(n){for(var e=[],t=n.inputs.values(),i=t.next();i&&!i.done;i=t.next())e.push(a(i.value));return e})},d=[],p=function(n){var e=function(){d=d.filter(function(e){return e!==n})};return d.push(n),{destroy:e}},m=function(n){i.then(function(e){n.data[1]=n.data[1]-12*e.octave+e.transpose,d.forEach(function(e){e(n)})})},v=function(){i=t.getItem("midiSetup").then(function(n){return n||(n={}),"undefined"==typeof n.octave&&(n.octave=3),"undefined"==typeof n.transpose&&(n.transpose=0),n})};v(),u=n.all({inputs:f(),midiSetup:i}).then(function(n){var e=n.midiSetup;e&&e.inputs&&n.inputs.forEach(function(n){e.inputs[n.id]&&n.enable()})});var l=function(){return i},g=o.sync(function(n){return t.getItem("midiSetup").then(function(e){return e=e||{},e.inputs=e.inputs||{},e.octave=n.octave,e.transpose=n.transpose,t.setItem("midiSetup",e)}).then(v)});return{getInputs:f,registerEventListener:p,getStatus:c,getConfig:l,setConfig:g}}]);
var musicShowCaseApp=angular.module("MusicShowCaseApp");musicShowCaseApp.factory("Recipe",["$q","$timeout","$rootScope","$http","Index","FileRepository",function(t,n,e,r,o,i){var a=["intro","create_a_song","create_an_instrument"],u=[],c={steps:[],currentStep:0},l=function(t,n){var e=c.steps[c.currentStep];e&&e.eventHandler&&e.eventHandler(t,n)},p=function x(t){t=t||c.currentStep;var r=c.steps[t];if(u=[],e.$broadcast("__blink_disable_all"),e.$broadcast("__tooltip_hide_all"),!r)return o.isolatedContext=null,void i.changed();(r.blink||[]).forEach(function(t){u.push(t),e.$broadcast("_blink_enable_"+t)});for(var a in r.tooltip||{})e.$broadcast("_tooltip_display_"+a,{text:r.tooltip[a]});r.duration&&n(function(){c.currentStep<=t&&(c.currentStep=t+1,x())},1e3*r.duration)},s=function(t){return function(n,e){n===t&&(c.currentStep++,p())}},d=function(t,e){return function(r,o){n(function(){t(r,o)},e)}},f=function(t,n){return"s"+t+"_tooltip_"+n},_=function(n){var e=function v(t){return t.next_step_on?s(t.next_step_on):t.delay?d(v(t.inner),t.delay):void 0},a=function(t,r){var o={};for(var i in t.tooltip)o[i]="recipe."+n+"."+f(r,i);return{blink:t.blink,tooltip:o,eventHandler:e(t.eventHandler),duration:t.duration}},u=function(t){return i.destroyFile(t.index.id).then(function(){return i.createFile({id:t.index.id,type:t.index.type,project:t.index.project,name:t.index.name,contents:t.contents})})},l=function(n){return t.all((n.data.files||[]).map(u)).then(function(){return n})},_=function(t){return t.data.project&&(document.location="#/editor/"+t.data.project),t};return r.get("recipes/"+n+".json").then(l).then(_).then(function(t){var n=t.data;t.data.isolatedContext&&(o.isolatedContext=t.data.isolatedContext+Math.floor(Date.now()/1e3),i.changed()),c.steps=n.steps.map(a),c.currentStep=0,p()})};_.raise=function(t){l(t)};var v=function(n){var e=n.key,o=function(t){return r.get("recipes/"+t+".json").then(function(t){var n=t.data;if(!n.lang)return{};var r=n.lang.indexOf(e);if(r===-1)return{};var o={};return n.steps.forEach(function(t,n){if(t.tooltip)for(var e in t.tooltip){var i=t.tooltip[e],a=f(n,e);Array.isArray(i)?o[a]=i[r]:0===r&&(o[a]=i)}}),o})},i={};return a.forEach(function(t){i[t]=o(t)}),t.all(i).then(function(t){return{recipe:t}})},h=function(){return u};return{start:_,step:p,handleEvent:l,loadTranslations:v,getBlinks:h}}]);
var musicJs=angular.module("MusicShowCaseApp");musicJs.factory("Sync",["$q",function(n){return function(){var t=n.when();this.sync=function(r){return function(){var c=arguments,e=this,u=n.defer();return t=t.then(function(){return r.apply(e,c).then(function(n){u.resolve(n)})["catch"](function(n){u.reject(n)})}),u.promise}}}}]);
var musicShowCaseApp=angular.module("MusicShowCaseApp");musicShowCaseApp.factory("translationsLoader",["$q","TypeService","esTranslations","enTranslations","Recipe",function(n,a,e,r,s){return function(o){var i={};"es"===o.key&&(i=e),"en"===o.key&&(i=r);var t=function(n){for(var a in n)i[a]=n[a]};return n.all({typeTranslations:a.loadTranslations(o),recipeTranslations:s.loadTranslations(o)}).then(function(n){return t(n.typeTranslations),t(n.recipeTranslations),i})}}]);
var musicShowCaseApp=angular.module("MusicShowCaseApp"),ObjectCache=function(){var n=new WeakMap;this.get=function(e,t){var r=n.get(e),i=JSON.stringify(t);if(r){var u=r.filter(function(n){return n.obj===i})[0];return u&&u.value}},this.set=function(e,t,r){var i=n.get(e),u=JSON.stringify(t);i||(i=[]);var a=i.filter(function(n){return n.obj===u})[0];a?a.value=r:i.push({obj:u,value:r}),i.length>8&&(i=i.slice(1)),n.set(e,i)}};musicShowCaseApp.service("TypeService",["$http","$q",function($http,$q){var make_mutable=function(n,e){var t=new ObjectCache,r=function(n,e){var r=e.prune;return e.prune=function(){if(t=new ObjectCache,r)return r.apply(this,arguments)},function(r){return function(i,u){var a=e;return a.getOriginal&&(a=a.getOriginal()),t.set(a,n,i),r(i,u)}}};return function(i,u,a){var o,s=[];if(o=e&&e.reusableNode?function(e,o){var s=u[0],p=n(i,u.map(r(i,e)),a),l=e;l.getOriginal&&(l=l.getOriginal());var c=t.get(l,i);return c?s(c):p(e,o)}:n(i,u,a),o.update)return o;var p,l=function(n,e){var t,r={},i=o,u=function(n){r[n]=function(){return i!=o&&a(),t[n].apply(t,arguments)}},a=function(){var r=o(n,e);r!==t&&t&&t.dispose&&t.dispose(),t=r,s.push(r),i=o;for(var a in t)u(a)};return a(),r};return l.update=function(e,t){return a=t,JSON.stringify(e)===p?l:(p=JSON.stringify(e),s.forEach(function(n){n.dispose&&n.dispose()}),s=[],o=n(e,u,a),l)},l}},plugins=["core"],types=[],translation={},m=function(n){return{lang:function(e,t){translation[e]=translation[e]||{},translation[e][n]=t},type:function(e,t,r){types.push({templateUrl:"site/plugin/"+n+"/"+t.template+".html",parameters:t.parameters,constructor:make_mutable(r,{reusableNode:t.reusableNode}),name:e,composition:t.composition,components:t.components,description:t.description,_default:t._default,subobjects:t.subobjects,stackAppend:t.stackAppend,monitor:t.monitor})}}},loadPlugin=function loadPlugin(pluginName){return $http.get("site/plugin/"+pluginName+"/index.js").then(function(result){var runnerCode=result.data,module={"export":function(){}};eval(runnerCode),module["export"](m(pluginName))})},pluginsLoaded=$q.all(plugins.map(loadPlugin)),getTypes=function(n){var e=function(){return!0};return n&&(n=n.toLowerCase(),e=function(e){return e.name.toLowerCase().indexOf(n)!==-1}),pluginsLoaded.then(function(){return types.filter(e)})},getType=function(n,e){return pluginsLoaded.then(function(){var t=types.filter(function(e){return e.name===n})[0];return e&&e(t),t})},loadTranslations=function(n){return pluginsLoaded.then(function(){return translation[n.key]||{}})};return{getTypes:getTypes,getType:getType,loadTranslations:loadTranslations}}]);
var musicShowCaseApp=angular.module("MusicShowCaseApp");musicShowCaseApp.factory("WelcomeMessage",["localforage",function(e){var o=function(){return e.getItem("welcome_skip").then(function(e){return!!e})},t=function(o){return o?e.setItem("welcome_skip",o):e.removeItem("welcome_skip")};return{setSkip:t,skip:o}}]);
var musicShowCaseApp=angular.module("MusicShowCaseApp");musicShowCaseApp.factory("_localforage",["$q","localforage",function(e,t){var n=t.getItem.bind(t),r=function m(n,r){if(0===n.length)return e.when(n);if(r<=0)return e.when(n);var u=n.shift();return t.getItem(u.id).then(function(e){return t.removeItem(u.id).then(function(){return m(n,r-(e?e.length:0))})})},u=function(e){return{id:e.id,name:e.name,type:e.type}},i=function(e){return t.getItem("recycle").then(function(t){return r(t,e)}).then(function(e){return t.setItem("recycle",e.map(u))})},o=function f(e,n,r){return t.setItem(e,n)["catch"](function(t){if(!r)return i(n.length).then(function(){return f(e,n,!0)});throw t})},c=t.removeItem.bind(t);return{getItem:n,setItem:o,removeItem:c}}]);
var musicShowCaseApp=angular.module("MusicShowCaseApp");musicShowCaseApp.filter("instrument_name",function(){return function(e,t){return t[e]&&t[e]?t[e].name:e}}),musicShowCaseApp.filter("instrument_type",function(){return function(e,t){return t[e]&&t[e]?t[e].type:"instrument"}}),musicShowCaseApp.filter("block_name",function(){return function(e,t){return t[e.id]&&t[e.id].index?t[e.id].index.name:e.id}}),musicShowCaseApp.filter("block_length",["Pattern",function(e){return function(t,n,o){return t.id&&n[t.id]&&n[t.id].contents?e.computeMeasureCount(n[t.id].contents,o):1}}]),musicShowCaseApp.controller("recordOptionsCtrl",["$scope","$uibModalInstance","Recipe",function(e,t,n){e.numChannels=2,e.encoding="wav",e.recipe=n.start,e.cancel=function(){t.dismiss()},e.start=function(){e.recipe.raise("song_rec_confirm"),t.close({encoding:e.encoding,numChannels:e.numChannels})}}]),musicShowCaseApp.controller("DashboardController",["$scope",function(e){e.$emit("switchProject","default")}]),musicShowCaseApp.controller("ProjectDashboardController",["$scope","$routeParams",function(e,t){e.$emit("switchProject",t.project)}]),musicShowCaseApp.controller("SongEditorController",["$scope","$uibModal","$q","$timeout","$routeParams","$http","MusicContext","FileRepository","InstrumentSet","Pattern","Export","TICKS_PER_BEAT","SONG_MAX_TRACKS",function(e,t,n,o,i,r,c,l,a,u,s,f,p){e.indexMap={};var d=i.id,m=a(),h=0;e.$emit("switchProject",i.project);var y=function(t){var n=154/e.file.measure,o=1;return f*t/o/n};e.seek=function(t){e.currentRec||(h=y(t.offsetX),e.$broadcast("resetClock",h),e.playing&&(e.playing.stop(),e.playing=null,e.replay()))},e.patternEdit=function(e){document.location="#/editor/"+i.project+"/pattern/"+e.id},e.exportItem=function(){s.exportFile(e.fileIndex.name,e.fileIndex.id)},e.removeItem=function(){return e.fileIndex.builtIn?(e.file=null,e.fileIndex=null,void l.destroyFile(d).then(function(){k()})):void l.moveToRecycleBin(d).then(function(){document.location="#/editor/"+i.project})},e.remove=function(t){delete t.id,g(),e.fileChanged()},e.currentRec=null,e.record=function(){e.playing&&(e.playing.stop(),e.playing=null,e.$broadcast("pauseClock"));var n=t.open({templateUrl:"site/templates/modal/recordOptions.html",controller:"recordOptionsCtrl"});n.result.then(function(t){e.currentRec=c.record({encoding:t.encoding,numChannels:t.numChannels},function(n){var o=document.createElement("a");document.body.appendChild(o),o.style="display: none";var i=window.URL.createObjectURL(n);o.href=i,o.download=e.fileIndex.name+"."+t.encoding,o.click(),window.URL.revokeObjectURL(i),e.recipe.raise("song_rec_stop")}),e.play()})},e.stop=function(){h=0,e.$broadcast("stopClock"),e.$broadcast("resetClock",h),e.playing&&e.playing.stop(),e.recipe.raise("song_play_stopped"),e.playing=null},e.playing=null,e.$on("pausedClock",function(e,t){h=t}),e.play=function(){return e.playing?(e.playing.stop(),e.playing=null,void e.$broadcast("pauseClock")):void e.replay()},e.replay=function(){c.resumeAudio(),n.all(m.all).then(function(t){var n={},i=function(o,i){if(!o)return null;if(n[o])return n[o];var r=e.indexMap[o].contents,c=Object.create(r);return c.bpm=e.file.bpm,n[o]=u.patternCompose(c,t,i*p,function(){}),n[o]},r=new MUSIC.Song(e.file.tracks.map(function(e,t){return e.blocks.map(function(e){return i(e.id,t)})}),{measure:e.file.measure,bpm:e.file.bpm,ticks_per_beat:f,start:h});e.$broadcast("startClock",r.timeToTicks()),e.playing=r.play({onStop:function(){e.$broadcast("stopClock"),e.$broadcast("resetClock",h),e.recipe.raise("song_play_stopped"),e.playing=null,e.currentRec&&e.currentRec.stop(),e.currentRec=null,o(function(){})}})})},e.indexChanged=function(){e.fileIndex.ref=l.getRefs("song",e.file),l.updateIndex(d,e.fileIndex)},e.fileChanged=fn.debounce(function(){l.updateFile(d,e.file).then(function(){e.indexChanged()})},100);var g=function(){var t=0,n=0;if(e.file&&e.file.tracks){e.file.tracks.forEach(function(o,i){for(var r=0;r<o.blocks.length;r++)if(o.blocks[r].id){var c=u.computeMeasureCount(e.indexMap[o.blocks[r].id].contents,e.file.measure);r+c>t&&(t=r+c),i>n&&(n=i)}}),e.file.tracks.length<n+2&&e.file.tracks.length<p?e.file.tracks.push({blocks:e.file.tracks[0].blocks.map(function(){return{}})}):e.file.tracks=e.file.tracks.slice(0,n+2);var o=t+1;e.file.tracks.forEach(function(e){if(o>e.blocks.length)for(var t=o-e.blocks.length,n=0;n<t;n++)e.blocks.push({});else e.blocks=e.blocks.slice(0,o)}),e.fileChanged()}};e.$watch("file.measure",g),e.onDropComplete=function(t,n,o,i){if(t.fromBlock){var r=o.id;return o.id=t.fromBlock.id,t.fromBlock.id=r,void g()}"pattern"===t.type&&(o.id=t.id,l.getFile(t.id).then(function(n){n.contents.tracks.forEach(function(e,t){e.instrument&&m.load(e.instrument,i*p+t)}),e.indexMap[t.id]=n,g(),e.fileChanged(),e.recipe.raise("song_pattern_dropped")}))};var k=function(){var t={};l.getFile(d).then(function(i){return i&&i.contents.tracks.forEach(function(e,n){e.blocks.forEach(function(e){e&&e.id&&(t[e.id]||(t[e.id]=l.getFile(e.id).then(function(e){return{file:e,idx:n}})))})}),n.all(t).then(function(t){e.indexMap={};for(var n in t){var o=t[n].file.contents,i=t[n].idx;e.indexMap[n]=t[n].file,o.tracks.forEach(function(e,t){e.instrument&&m.load(e.instrument,i*p+t)})}}).then(function(){o(function(){e.fileIndex=i.index,e.file=i.contents})})})};k();var v=function(e){"input"!==document.activeElement.tagName.toLowerCase()&&(90===e.keyCode&&e.ctrlKey&&l.undo(d).then(k),89===e.keyCode&&e.ctrlKey&&l.redo(d).then(k))};$(document).bind("keydown",v),e.$on("$destroy",function(){$(document).unbind("keydown",v),m.dispose()})}]),musicShowCaseApp.controller("PatternEditorController",["$q","$translate","$scope","$timeout","$routeParams","$http","TICKS_PER_BEAT","MusicContext","FileRepository","Pattern","InstrumentSet","Export","ErrMessage",function(e,t,n,o,i,r,c,l,a,u,s,f,p){var d=i.id,m=0;n.exportItem=function(){f.exportFile(n.fileIndex.name,n.fileIndex.id)},n.$emit("switchProject",i.project),n.instrumentEdit=function(e){document.location="#/editor/"+i.project+"/instrument/"+e.instrument},n.instrumentMap={},n.beatWidth=10,n.zoomLevel=8,n.selectedTrack=0,n.mutedState=[];var h=s(),y=function(e){var t=10;return c*e/n.zoomLevel/t};n.seek=function(e){m=y(e.offsetX+n.file.scrollLeft),n.$broadcast("resetClock",m),n.playing&&(n.playing.stop(),n.playing=null,n.replay())},n.updateMuted=function(){n.mutedState=u.getMutedState(n.file),n.fileChanged(),n.file.tracks.forEach(function(e,t){h.mute(t,n.mutedState[t])})},n.removeItem=function(){return n.fileIndex.builtIn?(n.file=null,n.fileIndex=null,void a.destroyFile(d).then(function(){b()})):void a.moveToRecycleBin(d).then(function(){document.location="#/editor/"+i.project})["catch"](function(e){if(!e.type||"cantremove"!==e.type)throw e;p("common.error_title","common.cantremove_error")})},n.removeTrack=function(e){n.file.tracks=n.file.tracks.slice(0,e).concat(n.file.tracks.slice(e+1)),n.file.selectedTrack=n.file.selectedTrack%n.file.tracks.length,n.updateMuted(),n.fileChanged()},n.addTrack=function(){n.file.tracks.push({events:[],scroll:1e3}),n.file.selectedTrack=n.file.tracks.length-1,n.updateMuted(),n.fileChanged()},n.stop=function(){m=0,n.$broadcast("stopClock"),n.$broadcast("resetClock",m),n.playing&&n.playing.stop(),n.recipe.raise("song_play_stopped"),n.playing=null},n.$on("pausedClock",function(e,t){m=t}),n.play=function(){return n.playing?(n.playing.stop(),n.playing=null,void n.$broadcast("pauseClock")):void n.replay()},n.replay=function(){l.resumeAudio();$(".playing-line");e.all(h.all).then(function(e){n.playing&&n.playing.stop();var t=function(){n.$broadcast("stopClock"),n.$broadcast("resetClock"),n.recipe.raise("pattern_play_stopped"),o(function(){n.playing=null}),m=0},i=u.patternCompose(n.file,e,0,t,{start:m});n.playing=i.play();var r=i.timeToTicks();n.$broadcast("startClock",r)})},n.zoomIn=function(){n.zoomLevel=2*n.zoomLevel,n.zoomLevel>32&&(n.zoomLevel=32)},n.zoomOut=function(){n.zoomLevel=n.zoomLevel/2,n.zoomLevel<1&&(n.zoomLevel=1)},n.indexChanged=function(){n.fileIndex.ref=a.getRefs("pattern",n.file),a.updateIndex(d,n.fileIndex)},n.fileChanged=fn.debounce(function(){a.updateFile(d,n.file).then(n.indexChanged)},100),n.$on("trackChanged",function(e){v(),n.fileChanged()});var g,k=function(e,t){e&&e.note&&(g&&g.stop(),g=e.note(t).play(),setTimeout(function(){g&&g.stop(),g=null},50))},v=function(){n.file&&n.file.tracks[0]&&(n.file.measureCount=u.computeMeasureCount(n.file,n.file.measure))},C=function(e){return n.mutedState[n.file.tracks.indexOf(e)]};n.$on("eventChanged",function(e,t){v(),t.oldevt.n===t.evt.n||C(t.track)||k(x.get(t.track),t.evt.n),n.fileChanged()}),n.$on("eventSelected",function(e,t){C(t.track)||k(x.get(t.track),t.evt.n)}),n.$watch("file.measure",v);var x=new WeakMap;n.updateInstrument=function(t){if(n.file.tracks[t]&&n.file.tracks[t].instrument)return e.all({musicObject:h.load(n.file.tracks[t].instrument,t),index:a.getIndex(n.file.tracks[t].instrument)}).then(function(e){return n.instrumentMap[n.file.tracks[t].instrument]=e.index,e.musicObject&&x.set(n.file.tracks[t],e.musicObject),e.musicObject})},n.onDropComplete=function(e,t){if(l.resumeAudio(),"instrument"===e.type||"tempo"===e.type){var o=n.file.selectedTrack;n.file.tracks=n.file.tracks||[],n.file.tracks[o]=n.file.tracks[o]||{},n.file.tracks[o].instrument=e.id,a.updateFile(d,n.file),n.updateInstrument(o).then(function(e){n.updateMuted(),n.mutedState[o]||k(e,36)})}};var b=function(){a.getFile(d).then(function(e){o(function(){n.fileIndex=e.index,n.file=e.contents,n.mutedState=u.getMutedState(n.file),n.updateMuted(),n.file.tracks||(n.file.tracks=[{}]),n.file.tracks.forEach(function(e,t){e.events=e.events||[],n.updateInstrument(t)})})})};b();var j=function(e){"input"!==document.activeElement.tagName.toLowerCase()&&(90===e.keyCode&&e.ctrlKey&&a.undo(d).then(b),89===e.keyCode&&e.ctrlKey&&a.redo(d).then(b))},w=$("button.play-button");w.bind("click",l.resumeAudio),$(document).bind("keydown",j),n.$on("$destroy",function(){w.unbind("click",l.resumeAudio),$(document).unbind("keydown",j),h.dispose()}),n.$on("enableTrack",function(e,t){n.file.selectedTrack=n.file.tracks.indexOf(t)}),n.$on("patternSelectEvent",function(e,t){o(function(){n.$broadcast("trackSelectEvent",t)})})}]),musicShowCaseApp.controller("EditorController",["$scope","$q","$timeout","$routeParams","$http","MusicContext","FileRepository","MusicObjectFactory","Export",function(e,t,n,o,i,r,c,l,a){var u=o.id;e.$emit("switchProject",o.project),e.exportItem=function(){a.exportFile(e.fileIndex.name,e.fileIndex.id)},e.removeItem=function(){return p(),e.fileIndex.builtIn?(e.file=null,e.fileIndex=null,void c.destroyFile(u).then(function(){y()})):void c.moveToRecycleBin(u).then(function(){document.location="#/editor/"+o.project})["catch"](function(e){if(!e.type||"cantremove"!==e.type)throw e;ErrMessage("common.error_title","common.cantremove_error")})};var s,f=l({monitor:!0}),p=function(){return(e.instruments||[]).forEach(function(e){e.dispose&&e.dispose()}),(e.playables||[]).forEach(function(t){e.stopPlay(t)}),f.destroyAll()},d=function(e){var t,n,o=function(e){return e.stop()},i=function(e){return e.play()},r=function(r){if(n)return n.note(r);var c;t||(t=e()),c=t.then(function(e){return n=e,e.note(r)});var l=function(){var e=c.then(i),t=function(){return e.then(o)};return{stop:t}};return{play:l}};return MUSIC.instrumentExtend({note:r}).stopDelay(10)},m=function(){return f.create(e.file)},h=fn.debounce(function(n,o){e.file&&t.when(null).then(function(){return p()}).then(function(){return d(m)}).then(function(t){return t?(t!==s&&(e.instruments=[],e.playables=[],t.note?e.instruments.push(t):t.play&&e.playables.push(t)),o&&(c.updateFile(u,e.file),e.fileIndex.updated=!0),void(s=t)):(e.instruments=[],void(e.playables=[]))})},250);e.$watch("file",h,!0),e.indexChanged=function(){c.updateIndex(u,e.fileIndex)};var y=function(){c.getFile(u).then(function(t){n(function(){var o={};e.outputFile=o,e.file=t.contents,e.fileIndex=t.index,e.observer={},e.observer.notify=function(){n(function(){e.instruments=[],e.playables=[]})}})})};y(),e.$on("stackChanged",function(){e.resetStack=!0,h()}),e.$on("$destroy",p),e.startPlay=function(e){e.playing=e.play()},e.stopPlay=function(e){e.playing&&(e.playing.stop(),e.playing=void 0)}}]),musicShowCaseApp.controller("MainController",["$q","$scope","$timeout","$uibModal","$translate","MusicContext","FileRepository","Recipe","WelcomeMessage","localforage","Export","ErrMessage",function(e,t,n,o,i,r,c,l,a,u,s,f){t.$on("switchProject",function(e,t){d(t)});var p,d=function(e){return c.getFile(e).then(function(n){return t.project=n,(n.index.ref||[]).concat([e])}).then(function(e){t.projectFilter=e.concat(["core"]),e.indexOf("default")!==-1&&t.projectFilter.push(void 0)}).then(m)["catch"](function(){document.location="#"})},m=fn.debounce(function(){p&&p.close(),p=c.search(null,{project:t.projectFilter,type:["instrument","pattern","song","fx"]}).observe(function(e){n(function(){t.filesTotal=e.total,t.files=e.results})})},100);t.fileInputClick=function(){n(function(){$(".choose-file-import-container input[type=file]").click()})},t.fileImport=function(t){for(var n,r=function(t){return e(function(e,n){var o=new FileReader;o.onload=function(t){e(t.target.result)},o.onerror=function(e){n(e)},o.readAsText(t)})},c=function(e){return function(t){return r(e).then(function(e){return s.importFile(e).then(function(e){t&&t.first&&(n="project"===e.type?"#/editor/"+e.id:"#/editor/"+e.project+"/"+e.type+"/"+e.id)})})}},l=null,a=0;a<t.length;a++)l=l?l.then(c(t[a])):c(t[a])({first:!0});l&&l.then(function(e){n&&(document.location=n)})["catch"](function(e){o.open({templateUrl:"site/templates/modal/error.html",controller:"errorModalCtrl",windowClass:"error",resolve:{text:function(){return i("common.loader_error")},title:function(){return i("common.error_title")}}})})},t.changeLanguage=function(e){u.setItem("lang",e),i.use(e)},u.getItem("lang").then(function(e){e&&t.changeLanguage(e),n(function(){t.langLoaded=!0})}),t.welcome=function(){o.open({templateUrl:"site/templates/modal/welcome.html",controller:"welcomeModalCtrl",resolve:{dontshowagain:["WelcomeMessage",function(e){return e.skip()}]}})},t.openRecycleBin=function(){o.open({templateUrl:"site/templates/modal/recycleBin.html",controller:"recycleBinModalCtrl"})},a.skip().then(function(e){e||t.welcome()}),t.recipe=l.start,t.activate=function(e){"instrument"!==e.type&&"song"!==e.type&&"pattern"!==e.type||(document.location="#/editor/"+t.project.index.id+"/"+e.type+"/"+e.id),"project"===e.type&&(document.location="#/editor/"+e.id)},t.keywordUpdated=fn.debounce(function(){p&&p.close(),p=c.search(t.searchKeyword,{project:t.projectFilter,type:["instrument","pattern","song","fx","tempo"]}).observe(function(e){t.filesTotal=e.total,t.files=e.results})},200),t.removeProject=function(){c.moveToRecycleBin(t.project.index.id).then(function(){document.location="#"})["catch"](function(e){if(!e.type||"cantremove"!==e.type)throw e;f("common.error_title","common.cantremove_project_error")})},t.exportProject=function(){s.exportProject(t.project.index.name,t.project.index.id)},t.projectSettings=function(){o.open({templateUrl:"site/templates/modal/projectSettings.html",controller:"projectSettingsModalCtrl",resolve:{project:{name:t.project.index.name,ref:t.project.index.ref},buttonText:function(){return"common.ok"}}}).result.then(function(e){t.project.index.name=e.name,c.updateIndex(t.project.index.id,{type:"project",name:e.name,ref:e.ref}).then(function(){d(t.project.index.id)})})},t.newProject=function(){i("project.new").then(function(e){o.open({templateUrl:"site/templates/modal/projectSettings.html",controller:"projectSettingsModalCtrl",resolve:{project:{name:e},buttonText:function(){return"common.create"}}}).result.then(function(e){c.createFile({type:"project",name:e.name,ref:e.ref}).then(function(e){document.location="#/editor/"+e})})})},t.openProject=function(){o.open({templateUrl:"site/templates/modal/openProject.html",controller:"openProjectModalCtrl"}).result.then(function(e){var t=function(e,t){return e.type===t.type?(e.ref||[]).length>(t.ref||[]).length?e:t:"song"===e.type?e:"song"===t.type?t:"pattern"===e.type?e:"pattern"===t.type?t:t};return c.getProjectFiles(e).then(function(n){if(n.length>0){var o=n.reduce(t,n[0]);o&&"project"!==o.type?document.location="#/editor/"+e+"/"+o.type+"/"+o.id:document.location="#/editor/"+e}else document.location="#/editor/"+e})})},t.newInstrument=function(){i("common.new_instrument").then(function(e){return c.createFile({type:"instrument",name:e,project:t.project.index.id})}).then(function(e){document.location="#/editor/"+t.project.index.id+"/instrument/"+e})["catch"](function(e){})},t.newSong=function(){i("common.new_song").then(function(e){return c.createFile({type:"song",name:e,project:t.project.index.id})}).then(function(e){document.location="#/editor/"+t.project.index.id+"/song/"+e})},t.newPattern=function(){i("common.new_pattern").then(function(e){return c.createFile({type:"pattern",name:e,project:t.project.index.id})}).then(function(e){document.location="#/editor/"+t.project.index.id+"/pattern/"+e})},t.about=function(){o.open({templateUrl:"site/templates/modal/about.html",controller:"infoModalCtrl"})},t.help=function(){o.open({templateUrl:"site/templates/modal/help.html",controller:"infoModalCtrl"})},t.todo=function(){o.open({templateUrl:"todoModal.html",controller:"todoModalCtrl"})}}]),musicShowCaseApp.controller("todoModalCtrl",["$scope","$uibModalInstance",function(e,t){e.dismiss=function(){t.dismiss()}}]);
var musicShowCaseApp=angular.module("MusicShowCaseApp");musicShowCaseApp.controller("errorModalCtrl",["$scope","$uibModalInstance","text","title",function(s,t,e,i){s.text=e,s.title=i,s.dismiss=function(){t.dismiss()}}]);
var musicShowCaseApp=angular.module("MusicShowCaseApp");musicShowCaseApp.controller("infoModalCtrl",["$scope","$uibModalInstance",function(s,o){s.dismiss=function(){o.dismiss()}}]);
var musicShowCaseApp=angular.module("MusicShowCaseApp");musicShowCaseApp.controller("midiSettingsModalCtrl",["$scope","$q","$timeout","$uibModalInstance","Midi",function(n,o,i,t,e){e.getInputs().then(function(o){n.inputs=o}),e.getConfig().then(function(o){n.config=o}),n.updateConfig=function(){e.setConfig(n.config)},n.done=function(){t.close()}}]);
var musicShowCaseApp=angular.module("MusicShowCaseApp");musicShowCaseApp.controller("openProjectModalCtrl",["$q","$scope","$uibModalInstance","FileRepository",function(e,o,c,s){var n,t=function(){n&&n.close(),n=s.search(o.searchKeyword,{type:["project"]}).observe(function(e){o.filesTotal=e.total,o.files=e.results})};o.updateSearch=fn.debounce(t,250),o.cancel=function(){c.dismiss()},o.select=function(e){o.selected=e},o.open=function(e){c.close(e)},t()}]);
var musicShowCaseApp=angular.module("MusicShowCaseApp");musicShowCaseApp.controller("projectSettingsModalCtrl",["$q","$scope","$uibModalInstance","FileRepository","project","buttonText",function(e,t,n,o,r,c){var i,s=function(){i&&i.close(),i=o.search(t.searchKeyword,{type:["project"]}).observe(function(e){t.filesTotal=e.total,t.files=e.results})};t.project=r,t.buttonText=c;var u=function(e){return o.getFile(e).then(function(e){return e.index})};t.refs=[],e.all((t.project.ref||[]).map(u)).then(function(e){t.refs=e}),t.updateSearch=fn.debounce(s,250),t.cancel=function(){n.dismiss()},t.done=function(){t.project.ref=t.refs.map(f),n.close(t.project)};var f=function(e){return e.id};t.remove=function(e){t.refs=t.refs.filter(function(t){return t.id!==e.id})},t.add=function(e){t.refs.map(f).indexOf(e.id)===-1&&t.refs.push(e)},s()}]);
var musicShowCaseApp=angular.module("MusicShowCaseApp");musicShowCaseApp.controller("recycleBinModalCtrl",["$scope","$timeout","$uibModalInstance","FileRepository",function(e,o,i,c){e.dismiss=function(){i.dismiss()};var n=function(){c.searchRecycled(e.searchKeyword,{limit:10}).then(function(i){o(function(){e.files=i.results,e.filesTotal=i.total})})};e.updateSearch=fn.debounce(n,250),e.restoreFromRecycleBin=function(e){c.restoreFromRecycleBin(e.id).then(n)},n()}]);
var musicShowCaseApp=angular.module("MusicShowCaseApp");musicShowCaseApp.controller("welcomeModalCtrl",["$q","$scope","$uibModalInstance","Recipe","WelcomeMessage","dontshowagain",function(n,o,i,s,t,a){o.dontshowagain=a;var e=n.when(null);o.updateSkip=function(){e=t.setSkip(o.dontshowagain)},o.dismiss=function(){e.then(function(){i.dismiss()})},o.tutorial=function(){e.then(function(){i.dismiss(),s.start("intro")})}}]);
//# sourceMappingURL=site.js.map
