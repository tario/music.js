{"version":3,"sources":["typecast.js","music.js","effects.js","instruments.js","lemonade.js","math.js","noteSequence.js","pattern.js","sequenceParser.js","song.js","utils.js","wave.js","serializer/CachedSerializer.js","serializer/HuffmanSerializerWrapper.js","serializer/JSONSerializer.js","serializer/MultiSerializer.js","serializer/PackedJSONSerializer.js","serializer/PackedJSONSerializerB.js"],"names":["TypeConversor","typeName","conversorArray","this","add","conversor","push","cast","obj","i","length","converted","TypeCast","typeConversors","register","typeConversor","window","MUSIC","Types","SoundLib","Effects","playablePipeExtend","during","duration","original","play","stopped","playable","wrapper","stop","setTimeout","stopDelay","delay","param","playing","bind","onError","fcn","e","console","error","onStop","EffectsPipeline","audio","audioDestination","_audio","_audioDestination","defaultWrapFcn","compose","f","g","prototype","_wrapFcn","wrap","ret","DummyNode","ret2","sfxBase","objects","dispose","sfxBaseWrapper","elem","removeElem","x","originalDispose","filter","call","sfxPrune","forEach","getOriginal","prune","constant","options","Constant","oscillator","Oscillator","soundfont","SoundfontInstrument","sound","path","request","XMLHttpRequest","open","responseType","audioBuffer","onerror","err","onload","decodeAudioData","response","buffer","send","bufferSource","createBufferSource","connect","_destination","start","currentTime","disconnect","formulaGenerator","FormulaGenerator","signal_and","value","gain","signal_nand","signal_not","signal_or","signal_nor","negateModl","modl","apply","audioParam","music","modulatorFactory","andNode","update","signal_scale","top","base","c1","gainUpdate","gainDispose","constantUpdate","constantDispose","a","b","T","arguments","noise","Noise","pink_noise","PinkNoise","red_noise","RedNoise","Object","create","args","api","context","gainNode","createGain","recv","Targuments","synth","output","disconnected","removeAll","cancel","unlisten","next","effectName","audioContext","AudioContext","webkitAudioContext","Context","nooutput","destination","resume","state","record","callback","recorder","WebAudioRecorder","workerDir","encoding","numChannels","onComplete","blob","startRecording","finishRecording","nextProvider","Formula","input","t","b0","b1","b2","b3","b4","b5","b6","noiseGenerator","white","Math","random","setValue","lastOut","bufferSize","sampleRate","noiseBuffer","createBuffer","getChannelData","whiteNoise","loop","Wave","period","sampleCount","floor","dataArray","recording","getBuffer","data","originalDataArray","value1","AudioDestinationWrapper","modulator","_f","combineFunc","audioParamModulation","len","constantArrayBuffer","Float32Array","buffer1","constantNode","createConstantSource","offset","set","noop","setParam","paramName","setParamTarget","target","timeConstant","cancelScheduledValues","setTargetAtTime","freq","newFreq","setFreq","reset","detune","effects","frequency","time_constant","isFinite","isNaN","osc","createOscillator","appliedAudioParam","type","real","terms","sin","imag","cos","periodicWave","createPeriodicWave","setPeriodicWave","schedule_freq","tc","fixed_frequency","noteOptions","setFreqOnTime","disposeNode","wtPosition","ta","optionsFrequency","at","tb","deltatime","lastTime","wave","newOptions","Loop","times","lastPlay","startTime","performance","now","currentIteration","nextIteration","clearInterval","inter","setInterval","Silence","time","effectsObject","cb","sfx","WebAudioNodeWrapper","audioNode","onDispose","rec","Recorder","workerPath","scriptNode","createScriptProcessor","iteration","onaudioprocess","audioProcessingEvent","inputBuffer","outputBuffer","channel","numberOfChannels","inputData","outputData","sample","isFormula","BiQuad","biquadFilter","createBiquadFilter","gainModulation","nodispose","qModulation","frequencyModulation","detuneModulation","biquadType","assignParam","orig","Q","filterName","canMutate","updateFcn","volumeModulation","delayNode","createDelay","delayModulation","delayTime","Echo","att","gainNode2","WaveShaper","samples","makeDistortionCurve","array","waveShaperNode","createWaveShaper","curve","oversample","Curve","concat","time1","c2","time2","n","setValueCurveAtTime","Ramp","initValue","endValue","Periodic","attackTime","decayTime","sustainLevel","releaseTime","undefined","nextNodeFcn","node","attackCurve","decayCurve","startCurve","currentLevel","releaseCurve","stopCurve","_typeof","Symbol","iterator","constructor","notenum","pow","noteToNumMap","C","D","E","F","G","A","B","instrumentExtend","delayedPlaying","originalPlaying","ms","delayedNote","originalNote","note","noteNum","perNoteWrap","mapNote","eventPreprocessor","evt","schedule_note","noteToNoteNum","noteName","charAt","parseInt","PolyphonyInstrument","innerFactory","maxChannels","instrumentArray","onUse","queue","freeIdx","c","playingIdx","instrument","shift","event","events","MonoNoteInstrument","inner","noteInst","playingInst","count","setValueOnTime","Instrument","soundFactory","fr","soundInstance","MultiInstrument","Array","isArray","notePlay","noteStop","MultiNote","noteArray","notes","map","every","processedEvents","s","l","k","NOTES","noteNumToNoteName","octaveNum","PatchInstrument","sounds","_base64ToArrayBuffer","base64","binary_string","atob","bytes","Uint8Array","ascii","charCodeAt","noteAudio","index","encoded","split","source","soundGenerator","nullPlay","plainObject","StopEvent","paramObject","onplay","onstop","LemonadePlayable","outputFcn","ops","_music","_ops","_output","opsLength","signalArray","phaseArray","lastT","deltay","phase","bpmToSecondTick","bpm","ticks_per_beat","makeEvaluableInverseFunctionFromParts","part","makeEvaluableFunction","inverse_f","makeEvaluableInverseFunction","init","end","y","find","p","makeEvaluableFunctionFromParts","sqrt","integrate","lastPointValue","integrateBpmEvents","cutBpmEvent","bpmEvent1","bpm_events","bpmEvent2","cutL","max","firstEventStart","parts","bpm_event","next_bpm_event","init_second_tick","end_second_tick","integratedParts","integral","ticksToTime","ticks","scale","timeToTicks","inverseScale","NoteSequence","funseq","clock","songCtx","Utils","Clock","FunctionSeq","clearTimeout","referenceInstrument","sequenceStartTime","externalSchedule","_time","_funseq","_totalduration","_noteid","_contextList","Playable","noteseq","contextList","_noteseq","_instrument","_duration","_runningFunSeq","Playing","runningFunSeq","ctx","_context","paddingTo","padding","pushCallback","baseCtx","mynoteid","indexOf","setPlaying","warn","unsetPlaying","makePlayable","subctx","playingNotes","noteid","playingStop","MultiPlayable","playableArray","_playableArray","playablePlay","playingArray","higher","getDuration","reduce","ChangeTimeWrapper","extensionTime","_extensionTime","Pattern","pulseTime","seq","code","SequenceParser","parse","Cb","C#","Db","D#","Eb","E#","Fb","F#","Gb","G#","Ab","A#","Bb","B#","isNoteStart","chr","noteSplit","str","lastNote","pipeReplace","RegExp","noteSeq","currentNote","replace","currentNoteStr","noteDuration","equalIndex","slice","lastChar","octave","PlayingSong","patternContexts","_patternContexts","_funseqHandler","noPlay","defaultFromPatterns","patterns","patternOrName","hasScheduleMethod","pattern","schedule","hasNotScheduleMethod","Song","patternsOrOptions","self","getFromPatterns","measure","totalMeasures","byStart","j","displacedBpmEvents","sort","timeFunc","baseTicks","patternArray","schedulable","notSchedulable","multiPlayable","scheduleContexts","Scale","toneAdd","v","preciseTimer","interval","hndl","eventsArray","reject","parameter","e1","e2","dt","timeoutHandlers","eventCount","clockHandler","lastEvent","nextElement","callingCriteria","element","pending","processPending","currentPending","timeoutHandler","addSchedule","preciseTimeout","DelayedFunctionSeq","params","FunctionWave","twopi","PI","waveTransform","waveOps","reverse","factor","translate","disp","table","Table","combine","otherWave","otherFactor","thisWave","thisFactor","defaultInterpolation","interpolation","sine","square","dutyCycle","dutyLevel","offLevel","triangle","t2","sawtooth","Formats","CachedSerializer","innerSerializer","lastOutput","lastInput","lastType","serialize","jsonCurrentInput","JSON","stringify","deserialize","HuffmanSerializerWrapper","frequencies","text","huffman","Huffman","treeFromText","encode","decoded","decode","JSONSerializer","MultiSerializer","serializerArray","match","keys","key","wrapSerializer","serializer","recoveredInput","smallest","truthy","selector","Error","serialized","setSerializers","entry","PackedJSONSerializer","objToArrayPacker","pack","unpack","innerPacker","flatten","size","deflatted","patternPacker","patternIndexPacker","convertBlocks","block","id","convertTrack","track","blocks","newObject","tracks","substitution","idx","switchPacker","selectAttribute","packers","parent","booleanPacker","nullable","songPacker","recursiveInstrumentPacker","instrumentPacker","stackPacker","envelopePacker","oscillatorPacker","frequencyFilterPacker","noParametersPacker","multiInstrumentPacker","typeNames","monophonerPacker","polyphonerPacker","script","null","notesplit","rise","adsr","envelope","transpose","echo","lowpass","highpass","bandpass","lowshelf","highshelf","peaking","notch","allpass","reverb","arpeggiator","stack","multi_instrument","monophoner","polyphoner","packer","song","PackedJSONSerializerB","patternEventPacker","firstElement","notePaddingPacker","toModl","values","note_padding","note_condition","signal_monitor","signal_constant","note_delay","sample_rate_reduction","bit_crushing","note_frequency_generator","note_time_shift","wave_shaper"],"mappings":"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","file":"music.js","sourcesContent":["(function(){\r\n\r\nvar TypeConversor = function(typeName) {\r\n  var conversorArray = [];\r\n\r\n  this.add = function(conversor){\r\n    conversorArray.push(conversor);\r\n  };\r\n\r\n  this.cast = function(obj) {\r\n    for (var i=0; i<conversorArray.length;i++) {\r\n      var conversor = conversorArray[i];\r\n      var converted = conversor(obj);\r\n\r\n      if (converted) return converted;\r\n    }\r\n\r\n    throw \"Can't convert \" + obj + \" to \" + typeName;\r\n  };\r\n};\r\n\r\nvar TypeCast = function(){\r\n  var typeConversors = {};\r\n\r\n  this.register = function(typeName, conversor){\r\n    var typeConversor;\r\n    if (!typeConversors[typeName]) {\r\n      typeConversors[typeName] = new TypeConversor(typeName);\r\n    }\r\n\r\n    typeConversor = typeConversors[typeName];\r\n    typeConversor.add(conversor);\r\n  };\r\n\r\n  this.cast = function(typeName, obj) {\r\n    var typeConversor = typeConversors[typeName];\r\n    if (!typeConversor) throw \"unkown type \" + typeName;\r\n\r\n    return typeConversor.cast(obj);\r\n  };\r\n};\r\n\r\nwindow.MUSIC = window.MUSIC || {};\r\nwindow.MUSIC.Types = new TypeCast();\r\n\r\n})();","window.MUSIC = window.MUSIC || {};\r\n\r\n(function() {\r\nMUSIC.SoundLib = MUSIC.SoundLib || {};\r\nMUSIC.Effects = MUSIC.Effects || {};\r\n\r\nMUSIC.playablePipeExtend = function(obj) {\r\n  obj.during = function(duration) {\r\n    var original = this;\r\n    return MUSIC.playablePipeExtend({\r\n      play: function() {\r\n        var stopped = false;\r\n        var playable = original.play();\r\n        var wrapper = {\r\n          stop: function() {\r\n            if (!stopped) playable.stop();\r\n            stopped = true;\r\n          }\r\n        };\r\n        setTimeout(wrapper.stop, duration);\r\n        return wrapper;\r\n      },\r\n\r\n      duration: function() { return duration; }\r\n    });\r\n  };\r\n\r\n  obj.stopDelay = function(delay) {\r\n    var original = this;\r\n    return MUSIC.playablePipeExtend(\r\n      {\r\n        play: function(param) {\r\n          var playing = original.play(param);\r\n          return {\r\n            stop: function() {\r\n              setTimeout(playing.stop.bind(playing), delay);\r\n            }\r\n          };\r\n        }\r\n      }\r\n    );\r\n  };\r\n\r\n  obj.onError = function(fcn) {\r\n    var original = this;\r\n    return MUSIC.playablePipeExtend(\r\n      {\r\n        play: function(param) {\r\n          try {\r\n            var playing = original.play(param);\r\n            return {\r\n              stop: function() {\r\n                try {\r\n                  playing.stop();\r\n                } catch(e) {\r\n                  console.error(e);\r\n                  fcn(e);\r\n                }\r\n              }\r\n            };\r\n          } catch(e) {\r\n            console.error(e);\r\n            fcn(e);\r\n            throw e;\r\n          }\r\n        }\r\n      }\r\n    );\r\n  };\r\n\r\n  obj.onStop = function(fcn) {\r\n    var original = this;\r\n    return MUSIC.playablePipeExtend(\r\n      {\r\n        play: function(param) {\r\n          var playing = original.play(param);\r\n          return {\r\n            stop: function() {\r\n              playing.stop();\r\n              fcn(param);\r\n            }\r\n          };\r\n        }\r\n      }\r\n    );\r\n  };\r\n\r\n  return obj;\r\n};\r\n\r\nMUSIC.Types.register(\"playable\", function(playable) {\r\n  if (playable.play) {\r\n    return playable;\r\n  }\r\n});\r\n\r\nMUSIC.Types.register(\"playable\", function(fcn) {\r\n  if (typeof fcn === \"function\") {\r\n    return {\r\n      play: fcn\r\n    };\r\n  }\r\n});\r\n\r\nMUSIC.EffectsPipeline = function(audio, audioDestination) {\r\n  this._audio = audio;\r\n  this._audioDestination = audioDestination;\r\n};\r\n\r\nvar defaultWrapFcn = function(obj){\r\n  return obj;\r\n};\r\nvar compose = function(f,g) {\r\n  return function(obj) {\r\n    return g(f(obj));\r\n  };\r\n};\r\n\r\nMUSIC.EffectsPipeline.prototype = {\r\n\r\n  _wrapFcn: defaultWrapFcn,\r\n\r\n  wrap: function(f) {\r\n    var ret = new MUSIC.DummyNode(this)\r\n    if (this._wrapFcn !== defaultWrapFcn) {\r\n      f = compose(f, this._wrapFcn);\r\n    }\r\n    ret._wrapFcn = function(obj) {\r\n      var ret2 = f(obj);\r\n      ret2._wrapFcn = ret._wrapFcn;\r\n      return ret2;\r\n    };\r\n    return ret;\r\n  },\r\n\r\n  sfxBase: function() {\r\n    var objects = [];\r\n    var dispose = function(obj) {\r\n      obj.dispose();\r\n    };\r\n\r\n    var sfxBaseWrapper = function(elem) {\r\n      if (!elem.dispose) return elem;\r\n      \r\n      var removeElem = function(x) {\r\n        return x != elem;\r\n      };\r\n      var originalDispose = elem.dispose;\r\n      objects.push(elem);\r\n      elem.dispose = function() {\r\n        objects = objects.filter(removeElem);\r\n        originalDispose.call(elem);\r\n      };\r\n\r\n      return elem;\r\n    };\r\n\r\n    var sfxPrune = function() {\r\n      objects.forEach(dispose);\r\n    };\r\n\r\n    var ret = this.wrap(sfxBaseWrapper);\r\n    var original = this;\r\n    ret.getOriginal = function() {\r\n      if (original.getOriginal) return original.getOriginal();\r\n      return original;\r\n    };\r\n\r\n    ret.prune = sfxPrune;\r\n    return ret;\r\n  },\r\n\r\n  constant: function(options) {\r\n    return this._wrapFcn(new MUSIC.SoundLib.Constant(this._audio, this._audioDestination, options));\r\n  },\r\n\r\n  oscillator: function(options) {\r\n    return this._wrapFcn(new MUSIC.SoundLib.Oscillator(this._audio, this._audioDestination, options));\r\n  },\r\n\r\n  soundfont: function(param) {\r\n    return this._wrapFcn(new MUSIC.SoundfontInstrument(param, this._audio, this._audioDestination));\r\n  },\r\n\r\n  sound: function(path) {\r\n    var audio = this._audio;\r\n    var audioDestination = this._audioDestination;\r\n\r\n    var request = new XMLHttpRequest();\r\n    request.open(\"GET\", path, true);\r\n    request.responseType = \"arraybuffer\";\r\n    var audioBuffer;\r\n\r\n    request.onerror = function(err) {\r\n      console.error(err);\r\n    };\r\n\r\n    request.onload = function(e) {\r\n      audio.audio.decodeAudioData(request.response, function (buffer) {\r\n        audioBuffer = buffer;\r\n      });\r\n    };\r\n\r\n    request.send();\r\n    return MUSIC.playablePipeExtend({\r\n      play: function() {\r\n        var bufferSource = audio.audio.createBufferSource();\r\n        bufferSource.buffer = audioBuffer;\r\n        bufferSource.connect(audioDestination._destination);\r\n        bufferSource.start(audio.audio.currentTime);\r\n\r\n        return {\r\n          stop: function() {\r\n            bufferSource.stop();\r\n            bufferSource.disconnect(audioDestination._destination);\r\n          }\r\n        };\r\n      }\r\n    });\r\n  },\r\n  \r\n  formulaGenerator: function(fcn) {\r\n    return this._wrapFcn(new MUSIC.SoundLib.FormulaGenerator(this._audio, this._audioDestination, fcn));\r\n  },\r\n\r\n  signal_and: function(value) {\r\n    return this.gain(value||1);\r\n  },\r\n\r\n  signal_nand: function(value) {\r\n    return this.signal_not().signal_and(value||1);\r\n  },\r\n\r\n  signal_or: function(value) {\r\n    return this.signal_not().signal_nor(value||0);\r\n  },\r\n\r\n  signal_nor: function(value) {\r\n    var negateModl = function(modl) {\r\n      if (!modl.apply) return modl;\r\n\r\n      return {\r\n        apply: function(currentTime, audioParam, music) {\r\n          return modl.apply(currentTime, audioParam, music, function(modulatorFactory, f) {\r\n            return f(modulatorFactory.signal_not());\r\n          });\r\n        }\r\n      };\r\n    };\r\n\r\n    var andNode = this.signal_and(1);\r\n    var update = function(value) {\r\n      andNode.update(negateModl(value));\r\n    };\r\n    update(value);\r\n\r\n    var ret = andNode.signal_not();\r\n    ret.update = update;\r\n    return ret;\r\n  },\r\n\r\n  signal_not: function() {\r\n    return this.signal_scale({top: 0, base: 2});\r\n  },\r\n\r\n  signal_scale: function(options) {\r\n    var gain = this.gain(1.0);\r\n    var c1 = this.constant(0.0);\r\n\r\n    var gainUpdate = gain.update.bind(gain);\r\n    var gainDispose = gain.dispose.bind(gain);\r\n    var constantUpdate = c1.update.bind(c1);\r\n    var constantDispose = c1.dispose.bind(c1);\r\n\r\n    var dispose = function() {\r\n      gainDispose();\r\n      constantDispose();\r\n    };\r\n\r\n    var update = function(options) {\r\n      var a, b;\r\n      a = (options.top - options.base)/2;\r\n      b = options.base + a;\r\n\r\n      gainUpdate(a);\r\n      constantUpdate(b);\r\n    };\r\n\r\n    update(options);\r\n    gain.update = update;\r\n    gain.dispose = dispose;\r\n\r\n    return gain;\r\n  },\r\n\r\n\r\n  T: function() {\r\n    return this._wrapFcn(new MUSIC.T(arguments, this._audio, this._audioDestination));\r\n  },\r\n\r\n  noise: function() {\r\n    return this._wrapFcn(new MUSIC.SoundLib.Noise(this._audio, this._audioDestination));\r\n  },\r\n\r\n  pink_noise: function() {\r\n    return this._wrapFcn(new MUSIC.SoundLib.PinkNoise(this._audio, this._audioDestination));\r\n  },\r\n\r\n  red_noise: function() {\r\n    return this._wrapFcn(new MUSIC.SoundLib.RedNoise(this._audio, this._audioDestination));\r\n  }\r\n};\r\n\r\nMUSIC.DummyNode = function(music) {\r\n  MUSIC.EffectsPipeline.apply(this, [music._audio, music._audioDestination]);\r\n};\r\nMUSIC.DummyNode.prototype = Object.create(MUSIC.EffectsPipeline.prototype);\r\n\r\nMUSIC.T = function(args, music, audioDestination) {\r\n  var api = T(\"WebAudioAPI:recv\", music.audio /* audioContext */);\r\n  var context = api.context;\r\n  var gainNode = context.createGain(1.0);\r\n\r\n  api.recv(gainNode);\r\n  setTimeout(function() { // this hack prevents a bug in current version of chrome\r\n    gainNode.connect(audioDestination._destination);\r\n  });\r\n\r\n  var Targuments = [];\r\n  for (var i=0; i<args.length; i++) {\r\n    Targuments.push(args[i]);\r\n  };\r\n\r\n  Targuments.push(api);\r\n  var synth = T.apply(null, Targuments);// (\"reverb\", {room:0.95, damp:0.1, mix:0.75}, api);\r\n  var send = T(\"WebAudioAPI:send\", synth, music.audio /* audioContext */).send(audioDestination._destination);\r\n\r\n  this.output = function() {\r\n    return gainNode;\r\n  }; \r\n\r\n  var disconnected = false;\r\n  this.disconnect = function() {\r\n    if (disconnected) return;\r\n    disconnected = true;\r\n\r\n    gainNode.disconnect(audioDestination._destination);\r\n    send.removeAll();\r\n    api.cancel();\r\n    send.cancel();\r\n    synth.unlisten();\r\n  };\r\n\r\n  this.dispose = this.disconnect;\r\n\r\n  this._destination = gainNode;\r\n  this.next = function() {\r\n    return audioDestination;\r\n  };\r\n\r\n  MUSIC.EffectsPipeline.bind(this)(music, this);\r\n};\r\nMUSIC.T.prototype = Object.create(MUSIC.EffectsPipeline.prototype);\r\n\r\nMUSIC.Effects.register = function(effectName, fcn) {\r\n  MUSIC.EffectsPipeline.prototype[effectName] = function(value) {\r\n    return this._wrapFcn(fcn(this._audio, this._audioDestination, value));\r\n  };\r\n};\r\n\r\nvar audioContext = new (window.AudioContext || window.webkitAudioContext)();\r\n\r\nMUSIC.Context = function(options) {\r\n  var audio = audioContext;\r\n  var music = this;\r\n  var gainNode = audio.createGain();\r\n\r\n  options = options || {};\r\n  gainNode.gain.value = 1.0; \r\n  if (!options.nooutput) gainNode.connect(audio.destination);\r\n\r\n  music.audio = audio;\r\n  music._destination = gainNode;\r\n\r\n  this.resume = function() {\r\n    if (audioContext.state !== 'running') {\r\n      audioContext.resume();\r\n    }\r\n  };\r\n\r\n  this.record = function(options, callback) {\r\n    var recorder = new WebAudioRecorder(gainNode, {\r\n      workerDir: \"src/lib/recorder/worker/\",\r\n      encoding: options.encoding,\r\n      numChannels: options.numChannels\r\n    });\r\n    recorder.onComplete = function(recorder, blob) {\r\n      callback(blob);\r\n    };\r\n\r\n    recorder.startRecording();\r\n    //recorder.record();\r\n    return {\r\n      stop: function() {\r\n        recorder.finishRecording();\r\n      }\r\n    };\r\n  };\r\n\r\n  this.audio = audio;\r\n\r\n  MUSIC.EffectsPipeline.bind(this)(music, this);\r\n};\r\n\r\nMUSIC.Context.prototype = new MUSIC.EffectsPipeline();\r\n\r\nMUSIC.SoundLib.FormulaGenerator = function(audio, nextProvider, fcn) {\r\n  this.play = function(param) {\r\n    var audioDestination;\r\n    var formulaGenerator = new MUSIC.Effects.Formula(audio, nextProvider, function(input, t) {\r\n      return fcn(t);\r\n    });\r\n\r\n    return {\r\n      stop: function() {\r\n        formulaGenerator.disconnect(nextProvider._destination);\r\n      }\r\n    }\r\n  };\r\n\r\n  MUSIC.playablePipeExtend(this);\r\n};\r\n\r\nMUSIC.SoundLib.PinkNoise = function(audio, nextProvider) {\r\n  this.play = function(param) {\r\n    var audioDestination;\r\n    var b0, b1, b2, b3, b4, b5, b6;\r\n    b0 = b1 = b2 = b3 = b4 = b5 = b6 = 0.0;\r\n\r\n    var noiseGenerator = new MUSIC.Effects.Formula(audio, nextProvider, function() {\r\n      var white = Math.random() * 2 - 1;\r\n      b0 = 0.99886 * b0 + white * 0.0555179;\r\n      b1 = 0.99332 * b1 + white * 0.0750759;\r\n      b2 = 0.96900 * b2 + white * 0.1538520;\r\n      b3 = 0.86650 * b3 + white * 0.3104856;\r\n      b4 = 0.55000 * b4 + white * 0.5329522;\r\n      b5 = -0.7616 * b5 - white * 0.0168980;\r\n      var ret = b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362;\r\n      b6 = white * 0.115926;\r\n      return ret * 0.11;\r\n    });\r\n\r\n    return {\r\n      stop: function() {\r\n        noiseGenerator.disconnect(nextProvider._destination);\r\n      }\r\n    }\r\n  };\r\n\r\n  this.setValue = function() {\r\n  };\r\n\r\n  MUSIC.playablePipeExtend(this);\r\n};\r\n\r\nMUSIC.SoundLib.RedNoise = function(audio, nextProvider) {\r\n  this.play = function(param) {\r\n    var audioDestination;\r\n    var lastOut = 0.0;\r\n\r\n    var noiseGenerator = new MUSIC.Effects.Formula(audio, nextProvider, function() {\r\n      var white = Math.random() * 2 - 1;\r\n      var ret = (lastOut + (0.02 * white)) / 1.02;\r\n      lastOut = ret;\r\n      return ret * 3.5;\r\n    });\r\n\r\n    return {\r\n      stop: function() {\r\n        noiseGenerator.disconnect(nextProvider._destination);\r\n      }\r\n    }\r\n  };\r\n\r\n  this.setValue = function() {\r\n  };\r\n\r\n  MUSIC.playablePipeExtend(this);\r\n};\r\n\r\nMUSIC.SoundLib.Noise = function(audio, nextProvider) {\r\n  var audioContext = audio.audio;\r\n\r\n  var bufferSize = 2 * audioContext.sampleRate,\r\n      noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate),\r\n      output = noiseBuffer.getChannelData(0);\r\n  for (var i = 0; i < bufferSize; i++) {\r\n      output[i] = Math.random() * 2 - 1;\r\n  }\r\n\r\n  this.play = function(param) {\r\n    var whiteNoise = audioContext.createBufferSource();\r\n    whiteNoise.buffer = noiseBuffer;\r\n    whiteNoise.loop = true;\r\n    whiteNoise.start(0);\r\n\r\n    whiteNoise.connect(nextProvider._destination);\r\n\r\n    return {\r\n      stop: function() {\r\n        whiteNoise.stop();\r\n        whiteNoise.disconnect(nextProvider._destination);\r\n      }\r\n    }\r\n  };\r\n\r\n  this.setValue = function() {\r\n  };\r\n\r\n  MUSIC.playablePipeExtend(this);\r\n};\r\n\r\nMUSIC.SoundLib.Wave = function(path, period) {\r\n\r\n  var music = new MUSIC.Context({nooutput: true});\r\n  var sound = music.sound(path);\r\n  var sampleCount = Math.floor(period * music.audio.sampleRate / 1000);\r\n  var dataArray = [];\r\n\r\n  // fix race condition using callbacks\r\n  setTimeout(function() {\r\n    var recording = music.record();\r\n    sound.play();\r\n\r\n    setTimeout(function(){\r\n      recording.stop();\r\n      recording.getBuffer(function(data) {\r\n        var originalDataArray = data[0];\r\n        for (var i=0; i<sampleCount; i++) {\r\n          dataArray.push(originalDataArray[i]);\r\n        }\r\n      });\r\n    }, period+100);\r\n  }, 500);\r\n\r\n  this.f = function(t) {\r\n    if (t<0)return 0;\r\n    var value1 = dataArray[Math.floor(t*sampleCount)];\r\n    return value1;\r\n  };  \r\n};\r\n\r\nMUSIC.AudioDestinationWrapper = function(music, audioDestination) {\r\n    this._destination = audioDestination;\r\n    MUSIC.EffectsPipeline.bind(this)(music, this)\r\n};\r\nMUSIC.AudioDestinationWrapper.prototype = Object.create(MUSIC.EffectsPipeline.prototype);\r\n\r\nMUSIC.modulator = function(f) {\r\n  var _f = function(modulatorFactory, f) {\r\n    return f(modulatorFactory);\r\n  };\r\n\r\n  return {\r\n    apply: function(currentTime, audioParam, music, combineFunc) {\r\n      var modulatorFactory, modulator;\r\n      modulatorFactory = (new MUSIC.AudioDestinationWrapper(music, audioParam)).sfxBase();\r\n      modulatorFactory.audioParamModulation = audioParam;\r\n      modulator = (combineFunc||_f)(modulatorFactory, f);\r\n\r\n      return {\r\n        dispose: function() {\r\n          modulatorFactory.prune();\r\n        }\r\n      };\r\n    }\r\n  };\r\n};\r\n\r\n(function() {\r\n\r\nvar len = 128;\r\nvar constantArrayBuffer = new Float32Array(len);\r\nfor (var i=0; i<len; i++) {\r\n  constantArrayBuffer[i]=1;\r\n};\r\nvar buffer1;\r\n\r\nMUSIC.SoundLib.Constant = function(music, destination, options) {\r\n\r\n  var constantNode;\r\n  var bufferSource;\r\n  var buffer;\r\n  var audioContext = music._audio.audio;\r\n\r\n  if (audioContext.createConstantSource) {\r\n    constantNode = audioContext.createConstantSource();\r\n    this._destination = constantNode;\r\n\r\n    constantNode.offset.value = options.offset || 0.0;\r\n    constantNode.connect(destination._destination);\r\n    constantNode.start();\r\n  } else {\r\n    constantNode = audioContext.createGain();\r\n    bufferSource = audioContext.createBufferSource();\r\n\r\n    constantNode.gain.value = options.offset || 0.0;\r\n    \r\n    if (!buffer1) {\r\n      buffer1 = audioContext.createBuffer(1, constantArrayBuffer.length, music._audio.audio.sampleRate);\r\n      buffer1.getChannelData(0).set(constantArrayBuffer);\r\n    }\r\n\r\n    bufferSource.loop = true;\r\n    bufferSource.buffer = buffer1;\r\n    bufferSource.connect(constantNode);\r\n\r\n    constantNode.connect(destination._destination);\r\n\r\n    bufferSource.start();\r\n  }\r\n\r\n  var noop = function() {};\r\n\r\n  this.setParam = function(paramName, value) {\r\n    if (paramName === 'offset' && !audioContext.createConstantSource) paramName = 'gain';\r\n    value.apply(music.audio.currentTime, constantNode[paramName]);\r\n  };\r\n\r\n  this.setParamTarget = function(paramName, target, timeConstant) {\r\n    if (paramName === 'offset' && !audioContext.createConstantSource) paramName = 'gain';\r\n    var audioParam = constantNode[paramName];\r\n    audioParam.cancelScheduledValues(0.0);\r\n    audioParam.setTargetAtTime(target, music.audio.currentTime, timeConstant);\r\n  };\r\n\r\n  this.dispose = function() {\r\n    if (audioContext.createConstantSource) {\r\n      constantNode.stop();\r\n    } else {\r\n      bufferSource.stop();\r\n      bufferSource.disconnect(constantNode);\r\n    }\r\n    constantNode.disconnect(destination._destination);\r\n\r\n    this.dispose = function() {};\r\n  };\r\n\r\n  this.update = function(value) {\r\n    if (audioContext.createConstantSource) {\r\n      constantNode.offset.value = value;\r\n    } else {\r\n      constantNode.gain.value = value;\r\n    }\r\n  };\r\n\r\n  this.freq = function(newFreq) {\r\n    var playable = {};\r\n\r\n    playable.setFreq = noop;\r\n    playable.reset = noop;\r\n    playable.play = function() {\r\n      return {stop: noop}\r\n    };\r\n\r\n    MUSIC.playablePipeExtend(playable);\r\n    return playable;\r\n  };\r\n};\r\n\r\n})();\r\n\r\nMUSIC.SoundLib.Oscillator = function(music, destination, options) {\r\n  options = options || {};\r\n  var effects = options.effects;\r\n  var detune = options.detune;\r\n  var frequency = options.frequency;\r\n  var time_constant = options.time_constant;\r\n  var audioDestination;\r\n\r\n  audioDestination = destination._destination;\r\n\r\n  if (!isFinite(time_constant) || isNaN(time_constant) || time_constant <= 0) time_constant = 0.01;\r\n\r\n  var osc;\r\n\r\n  osc = music.audio.createOscillator();\r\n  osc.connect(audioDestination);\r\n\r\n  var appliedAudioParam;\r\n\r\n  if (frequency) {\r\n    osc.frequency.value = frequency;\r\n  }    \r\n\r\n  if (detune) {\r\n    if (detune.apply) {\r\n      appliedAudioParam = detune.apply(music.audio.currentTime, osc.detune, music);\r\n    } else {\r\n      osc.detune.value = detune;\r\n    }\r\n  }\r\n\r\n  if (options.type === \"custom\") {\r\n    var real = new Float32Array(options.terms.sin || []);\r\n    var imag = new Float32Array(options.terms.cos || []);\r\n\r\n    var periodicWave = music.audio.createPeriodicWave(real, imag);\r\n    osc.setPeriodicWave(periodicWave);\r\n  } else {\r\n    osc.type = options.type;    \r\n  }\r\n\r\n  this.currentTime = function() {\r\n    return music.audio.currentTime;\r\n  };\r\n\r\n  this.schedule_freq = function(newFreq, start) {\r\n    var tc;\r\n    tc = time_constant||0.1;\r\n\r\n    var stop = function() {};\r\n    var play = function() {\r\n      osc.frequency.setTargetAtTime(newFreq, start, tc);\r\n      return {\r\n        stop: stop\r\n      };\r\n    };\r\n\r\n    return {\r\n      play: play\r\n    };\r\n  };\r\n\r\n  this.freq = function(newFreq) {\r\n    var frequency = options.fixed_frequency ? options.fixed_frequency : newFreq\r\n\r\n    if (frequency) {\r\n      osc.frequency.value = frequency;\r\n    }    \r\n\r\n    var playable = {};\r\n\r\n    playable.setFreq = function(frequency, noteOptions) {\r\n      playable.setFreqOnTime(frequency, noteOptions, music.audio.currentTime);\r\n    };\r\n\r\n    playable.cancelScheduledValues = function() {\r\n      osc.frequency.cancelScheduledValues(0.0);\r\n    };\r\n\r\n    playable.setFreqOnTime = function(frequency, noteOptions, start) {\r\n      if (options.fixed_frequency) return;\r\n\r\n      var tc;\r\n\r\n      if (noteOptions && noteOptions.tc) {\r\n        tc = noteOptions.tc;\r\n      } else {\r\n        tc = time_constant||0.1;\r\n      }\r\n\r\n      osc.frequency.setTargetAtTime(frequency, start, tc);\r\n    };\r\n\r\n    playable.reset = function() {\r\n    };\r\n\r\n    playable.play = function(param) {\r\n      var nextNode;\r\n      var disposeNode;\r\n\r\n      disposeNode = function() {\r\n        if (osc) osc.disconnect(audioDestination);\r\n        osc = null;\r\n      };\r\n\r\n      osc.start(0);\r\n\r\n      return {\r\n        stop : function() {\r\n          if (appliedAudioParam && appliedAudioParam.dispose) {\r\n            appliedAudioParam.dispose();\r\n          }\r\n\r\n          if (osc) osc.stop(0);\r\n          disposeNode();\r\n        }\r\n      };\r\n    };\r\n\r\n    MUSIC.playablePipeExtend(playable);\r\n    return playable;\r\n  };\r\n\r\n  if (options.f) {\r\n    this.play = function(param) {\r\n      var wtPosition = options.wtPosition || 0;\r\n      var fcn = options.f;\r\n      var ta = 0;\r\n      var frequency;\r\n      var optionsFrequency = options.frequency;\r\n\r\n      if (optionsFrequency.at) {\r\n        frequency = optionsFrequency.at.bind(optionsFrequency);\r\n      } else {\r\n        frequency = function(t){ return optionsFrequency };\r\n      }\r\n      var deltatime = 0;\r\n      var lastTime = 0;\r\n      var tb;\r\n\r\n      if (wtPosition.at) {\r\n        var formulaGenerator = new MUSIC.Effects.Formula(music, destination, function(input, t) {\r\n          deltatime = t - lastTime;\r\n          ta += deltatime * frequency(t);\r\n          ta = ta % 1;\r\n\r\n          tb = ta + wtPosition.at(t);\r\n          tb = tb % 1;\r\n\r\n          if (tb < 0) tb++;\r\n          lastTime = t;\r\n          return fcn(tb);\r\n        });\r\n      } else {\r\n        var formulaGenerator = new MUSIC.Effects.Formula(music, destination, function(input, t) {\r\n          deltatime = t - lastTime;\r\n          ta += deltatime * frequency(t);\r\n          ta = ta % 1;\r\n\r\n          tb = ta + wtPosition;\r\n          tb = tb % 1;\r\n\r\n          if (tb < 0) tb++;\r\n          lastTime = t;\r\n          return fcn(tb);\r\n        });\r\n      }\r\n\r\n      return {\r\n        stop: function() {\r\n          formulaGenerator.disconnect(destination._destination);\r\n        }\r\n      }\r\n    };    \r\n  } else if (options.wave) {\r\n    var newOptions = Object.create(options);\r\n    newOptions.f = options.wave.f;\r\n    MUSIC.SoundLib.Oscillator.bind(this)(music, destination, newOptions);\r\n  } else {\r\n\r\n  }\r\n\r\n};\r\n\r\nMUSIC.Loop = function(playable, times) {\r\n  var original = playable;\r\n  var duration = playable.duration();\r\n  return {\r\n    play: function() {\r\n      var lastPlay;\r\n      var startTime = window.performance.now();\r\n      var lastTime = startTime;\r\n      var currentIteration = 0;\r\n\r\n      lastPlay = playable.play();\r\n\r\n      var nextIteration = function() {\r\n        var now = window.performance.now();\r\n        if (now - startTime > currentIteration * duration) { // ms\r\n          setTimeout(function(){\r\n              lastPlay = playable.play();\r\n          }, (currentIteration+1) * duration - now)\r\n          currentIteration++;\r\n          if (currentIteration == times-1) {\r\n            clearInterval(inter);\r\n          }\r\n        }\r\n      };\r\n\r\n      var inter = setInterval(nextIteration, duration);\r\n      return {\r\n        stop: function() {\r\n          clearInterval(inter)\r\n          if (lastPlay) lastPlay.stop();\r\n        }\r\n      };\r\n    }\r\n  };\r\n};\r\n\r\nMUSIC.Silence = function(time) {\r\n  return {\r\n    play : function() {\r\n      return {\r\n        stop: function(){\r\n\r\n        }\r\n      }\r\n    },\r\n\r\n    duration: function(){return time}\r\n  };\r\n};\r\n\r\n})();","MUSIC.Effects = MUSIC.Effects || {};\r\n\r\nvar effectsObject = {};\r\nMUSIC.Effects.forEach = function(cb) {\r\n  for (var sfx in effectsObject) {\r\n    cb(sfx, effectsObject[sfx]);\r\n  }\r\n};\r\n\r\nMUSIC.Effects.WebAudioNodeWrapper = function (music, audioNode, next, onDispose) {\r\n\r\n  this._destination = audioNode;\r\n  setTimeout(function() { // this hack prevents a bug in current version of chrome\r\n    audioNode.connect(next._destination);\r\n  });\r\n\r\n  this.next = function() {\r\n    return next;\r\n  };\r\n\r\n  var disconnected = false;\r\n  this.disconnect = function() {\r\n    if (disconnected) return;\r\n    if (onDispose) onDispose();\r\n    disconnected = true;\r\n    audioNode.disconnect(next._destination);\r\n  };\r\n\r\n  this.dispose = this.disconnect;\r\n\r\n  this.output = function() {\r\n    return audioNode;\r\n  };\r\n\r\n  this.currentTime = function() {\r\n    return music.audio.currentTime;\r\n  };\r\n\r\n  this.setParam = function(paramName, value) {\r\n    value.apply(music.audio.currentTime, audioNode[paramName]);\r\n  };\r\n\r\n  this.setParamTarget = function(paramName, target, timeConstant) {\r\n    var audioParam = audioNode[paramName];\r\n    audioParam.cancelScheduledValues(0.0);\r\n    audioParam.setTargetAtTime(target, music.audio.currentTime, timeConstant);\r\n  };\r\n\r\n  this.record = function() {\r\n    var rec = new Recorder(audioNode, {workerPath: \"lib/recorder/recorderWorker.js\"});\r\n\r\n    rec.record();\r\n    return rec;\r\n  };\r\n\r\n  MUSIC.EffectsPipeline.bind(this)(music, this);\r\n};\r\nMUSIC.Effects.WebAudioNodeWrapper.prototype = Object.create(MUSIC.EffectsPipeline.prototype);\r\n\r\nMUSIC.Effects.Formula = function(music, next, fcn) {\r\n  var scriptNode = music.audio.createScriptProcessor(1024, 1, 1);\r\n  var iteration = 0;\r\n  var sampleRate = music.audio.sampleRate;\r\n\r\n  scriptNode.onaudioprocess = function(audioProcessingEvent) {\r\n    // The input buffer is the song we loaded earlier\r\n    var inputBuffer = audioProcessingEvent.inputBuffer;\r\n\r\n    // The output buffer contains the samples that will be modified and played\r\n    var outputBuffer = audioProcessingEvent.outputBuffer;\r\n\r\n    // Loop through the output channels (in this case there is only one)\r\n    for (var channel = 0; channel < outputBuffer.numberOfChannels; channel++) {\r\n      var inputData = inputBuffer.getChannelData(channel);\r\n      var outputData = outputBuffer.getChannelData(channel);\r\n\r\n      // Loop through the 4096 samples\r\n      for (var sample = 0; sample < inputBuffer.length; sample++) {\r\n        // make output equal to the same as the input\r\n        outputData[sample] = fcn(inputData[sample], (inputBuffer.length * iteration + sample) / sampleRate);\r\n      }\r\n    }\r\n\r\n    iteration++;\r\n  }\r\n\r\n  setTimeout(function() { // this hack prevents a bug in current version of chrome\r\n    scriptNode.connect(next._destination);\r\n  });\r\n\r\n  this._destination = scriptNode;\r\n  \r\n  MUSIC.EffectsPipeline.bind(this)(music, this);\r\n\r\n  this.next = function() {\r\n    return next;\r\n  };\r\n\r\n  var disconnected = false;\r\n  this.disconnect = function() {\r\n    if (disconnected) return;\r\n    disconnected = true;\r\n    \r\n    setTimeout(function() { // this hack prevents a bug in current version of chrome\r\n      scriptNode.disconnect(next._destination);\r\n    });\r\n  };\r\n\r\n  this.dispose = this.disconnect;\r\n\r\n  this.update = function(_f) {\r\n    fcn = _f;\r\n    this.fcn = fcn;\r\n  };\r\n\r\n  this.fcn = fcn;\r\n\r\n  this.output = function() {\r\n    return scriptNode;\r\n  };\r\n\r\n  this.isFormula = true;\r\n}\r\nMUSIC.Effects.Formula.prototype = Object.create(MUSIC.EffectsPipeline.prototype);\r\n\r\n\r\nMUSIC.Effects.register(\"formula\", function(music, next, fcn) {\r\n  return new MUSIC.Effects.Formula(music, next, fcn)\r\n});\r\n\r\n\r\nMUSIC.Effects.BiQuad = function(music, next, options) {\r\n  var biquadFilter = music.audio.createBiquadFilter();\r\n  var gainModulation = nodispose;\r\n  var qModulation = nodispose;\r\n  var frequencyModulation = nodispose;\r\n  var detuneModulation = nodispose;\r\n\r\n  var biquadType = options.type;\r\n\r\n  this.update = function(options) {\r\n    biquadFilter.type = biquadType;\r\n\r\n    var assignParam = function(orig, audioParam) {\r\n      if (orig) {\r\n        if (orig.apply) {\r\n          return orig.apply(music.audio.currentTime, audioParam, music);\r\n        } else {\r\n          audioParam.value = orig;\r\n        }\r\n      }\r\n\r\n      return nodispose;\r\n    };\r\n\r\n    gainModulation.dispose();\r\n    qModulation.dispose();\r\n    frequencyModulation.dispose();\r\n    detuneModulation.dispose();\r\n\r\n    gainModulation = assignParam(options.gain, biquadFilter.gain);\r\n    qModulation = assignParam(options.Q, biquadFilter.Q);\r\n    frequencyModulation = assignParam(options.frequency, biquadFilter.frequency);\r\n    detuneModulation = assignParam(options.detune, biquadFilter.detune);\r\n  };\r\n\r\n  this.update(options);\r\n\r\n  MUSIC.Effects.WebAudioNodeWrapper.bind(this)(music, biquadFilter, next, function() {\r\n    gainModulation.dispose();\r\n    qModulation.dispose();\r\n    frequencyModulation.dispose();\r\n    detuneModulation.dispose();\r\n  });\r\n};\r\nMUSIC.Effects.BiQuad.prototype = Object.create(MUSIC.Effects.WebAudioNodeWrapper.prototype);\r\n\r\nMUSIC.Effects.register(\"biquad\", MUSIC.Effects.BiQuad);\r\n[\"lowpass\", \"highpass\", \"bandpass\", \"lowshelf\", \"highshelf\", \"peaking\", \"notch\", \"allpass\"]\r\n  .forEach(function(filterName) {\r\n    MUSIC.Effects.register(filterName, function(music, next, options) {\r\n      return new MUSIC.Effects.BiQuad(music, next, {type: filterName, frequency: options.frequency, Q: options.Q, detune: options.detune});\r\n    });\r\n  });\r\n\r\nvar canMutate = function(obj, updateFcn) {\r\n  obj.update = function(value) {\r\n    updateFcn(value);\r\n    return obj;\r\n  };\r\n  return obj;\r\n};\r\n\r\nvar nodispose = {\r\n  dispose: function(){}\r\n};\r\n\r\nMUSIC.Effects.register(\"gain\", function(music, next, value) {\r\n  var gainNode = music.audio.createGain();\r\n  var volumeModulation = nodispose;\r\n\r\n  return canMutate(\r\n    new MUSIC.Effects.WebAudioNodeWrapper(music, gainNode, next, function() {\r\n      volumeModulation.dispose();\r\n    }),\r\n    function(value) {\r\n      volumeModulation.dispose();\r\n\r\n      if (value.apply) {\r\n        gainNode.gain.value = 0.0;\r\n        volumeModulation = value.apply(music.audio.currentTime, gainNode.gain, music);\r\n      } else {\r\n        volumeModulation = nodispose;\r\n        gainNode.gain.value = value;\r\n      }\r\n    }\r\n  ).update(value);\r\n});\r\n\r\nMUSIC.Effects.register(\"delay\", function(music, next, value) {\r\n  var delayNode = music.audio.createDelay(60);\r\n  var delayModulation = nodispose;\r\n\r\n  return canMutate(\r\n    new MUSIC.Effects.WebAudioNodeWrapper(music, delayNode, next, function() {\r\n      delayModulation.dispose();\r\n    }),\r\n    function(value) {\r\n      delayModulation.dispose();\r\n\r\n      if (value.apply) {\r\n        delayModulation = value.apply(music.audio.currentTime, delayNode.delayTime, music);\r\n      } else {\r\n        delayModulation = nodispose;\r\n        delayNode.delayTime.value = value;\r\n      }\r\n    }\r\n  ).update(value);\r\n});\r\n\r\nvar Echo = function(music, next, options) {\r\n  this.update = function(options) {\r\n    delayNode.delayTime.value = options.delay || 0.02;\r\n    att.gain.value = options.gain === 0  ? 0 : (options.gain||0.2);\r\n\r\n    if (delayNode.delayTime.value < 0.01) delayNode.delayTime.value = 0.01;\r\n    if (delayNode.delayTime.value > 1) delayNode.delayTime.value = 1;\r\n    if (att.gain.value > 0.99) att.gain.value = 0.99;\r\n    if (att.gain.value < 0) att.gain.value = 0;\r\n  };\r\n\r\n  var delayNode = music.audio.createDelay(60);\r\n\r\n  var gainNode = music.audio.createGain();\r\n  var gainNode2 = music.audio.createGain();\r\n  gainNode.gain.value = 1.0;\r\n  gainNode2.gain.value = 1.0;\r\n\r\n  var att = music.audio.createGain();\r\n\r\n  this.update(options);\r\n\r\n  setTimeout(function() {\r\n    gainNode.connect(gainNode2);\r\n    gainNode.connect(delayNode);\r\n    delayNode.connect(att);\r\n    gainNode2.connect(next._destination);\r\n    gainNode2.connect(delayNode);\r\n    att.connect(gainNode2);\r\n  });\r\n\r\n  this._destination = gainNode;\r\n\r\n\r\n  this.next = function() {\r\n    return next;\r\n  };\r\n\r\n  var disconnected = false;\r\n  this.disconnect = function() {\r\n    if (disconnected) return;\r\n    disconnected = true;\r\n    gainNode.disconnect(gainNode2);\r\n    gainNode.disconnect(delayNode);\r\n    delayNode.disconnect(att);\r\n    gainNode2.disconnect(next._destination);\r\n    gainNode2.disconnect(delayNode);\r\n    att.disconnect(gainNode2);\r\n  };\r\n\r\n  this.dispose = this.disconnect;\r\n\r\n  this.output = function() {\r\n    return audioNode;\r\n  };\r\n\r\n  this.setParam = function(paramName, value) {\r\n    value.apply(music.audio.currentTime, audioNode[paramName]);\r\n  };\r\n\r\n  MUSIC.EffectsPipeline.bind(this)(music, this);\r\n};\r\nEcho.prototype = Object.create(MUSIC.EffectsPipeline.prototype);\r\n\r\nvar WaveShaper = function(music, next, options) {\r\n  options = options ||{};\r\n  var samples = options.samples || 8192;\r\n  var f = options.f || function(t){return t; };\r\n\r\n  var makeDistortionCurve = function() {\r\n    var array = new Float32Array(samples);\r\n    for (var i=0; i<samples; i++) {\r\n      array[i] = f(i*2 / samples - 1);\r\n    }\r\n\r\n    return array;\r\n  };\r\n\r\n  this.next = function() {\r\n    return next;\r\n  };\r\n\r\n  var waveShaperNode = music.audio.createWaveShaper();\r\n  waveShaperNode.curve = makeDistortionCurve();\r\n  waveShaperNode.oversample = '4x';\r\n\r\n  setTimeout(function() {\r\n    waveShaperNode.connect(next._destination);\r\n  });\r\n  this._destination = waveShaperNode;\r\n  var disconnected = false;\r\n\r\n  this.disconnect = function() {\r\n    if (disconnected) return;\r\n    disconnected = true;\r\n    waveShaperNode.disconnect(next._destination);\r\n  };\r\n\r\n  MUSIC.EffectsPipeline.bind(this)(music, this);\r\n}\r\nWaveShaper.prototype = Object.create(MUSIC.EffectsPipeline.prototype);\r\n\r\nMUSIC.Effects.register(\"echo\", function(music, next, options) {\r\n  return new Echo(music, next, options);\r\n});\r\n\r\nMUSIC.Effects.register(\"wave_shaper\", function(music, next, options) {\r\n  return new WaveShaper(music, next, options);\r\n});\r\n\r\nMUSIC.Curve = function(array) {\r\n  this.during = during(array);\r\n};\r\n\r\nMUSIC.Curve.concat = function(c1, time1, c2, time2, n) {\r\n  var time = time1 + time2;\r\n  if (!n) {\r\n    n=Math.floor(time*100)+1;\r\n  }\r\n\r\n  var at = function(t) {\r\n    if (t < time1){\r\n      return c1.at(t); \r\n    } else {\r\n      return c2.at(t-time1);\r\n    }\r\n  };\r\n\r\n  var array = new Float32Array(n+1);\r\n  for (var i = 0; i < n+1; i++ ) {\r\n    array[i] = at(time * (i / n));\r\n  };\r\n\r\n  return {\r\n    apply: function(currentTime, audioParam) {\r\n      audioParam.cancelScheduledValues(0.0);\r\n      audioParam.setValueCurveAtTime(array, currentTime, time)\r\n    },\r\n\r\n    at: at\r\n  };\r\n};\r\n\r\nvar during = function(fcn, n) {\r\n  return function(time) {\r\n    if (!n) {\r\n      n=Math.floor(time*100)+1;\r\n    }\r\n\r\n    var array = new Float32Array(n+1);\r\n    for (var i = 0; i < n+1; i++ ) {\r\n      array[i] = fcn(i / n);\r\n    };\r\n\r\n    return { \r\n      apply: function(currentTime, audioParam) {\r\n        audioParam.cancelScheduledValues(0.0);\r\n        audioParam.setValueCurveAtTime(array, currentTime, time);\r\n      },\r\n\r\n      at: function(t) {\r\n        return fcn(t/time);\r\n      }\r\n    };\r\n  };\r\n};\r\n\r\n\r\nMUSIC.Curve.Formula = function(fcn, n) {\r\n  this.during = during(fcn, n);\r\n}\r\n\r\nMUSIC.Curve.Ramp = function(initValue, endValue, n) {\r\n  MUSIC.Curve.Formula.bind(this)(function(t){return initValue + (endValue - initValue)*t;}, n);\r\n};\r\n\r\nMUSIC.Curve.Periodic = function(fcn, frequency) {\r\n  var ta = 0;\r\n  var delayTime;\r\n  var lastTime = 0;\r\n  var deltatime;\r\n  var tb;\r\n  var period = 1.0 / frequency;\r\n  if (frequency.at) {\r\n    this.at = function(t) {\r\n      deltatime = t - lastTime;\r\n      ta += deltatime * frequency.at(t);\r\n      ta = ta % 1;\r\n\r\n      lastTime = t;\r\n      return fcn(ta);\r\n    };\r\n  } else {\r\n    this.at = function(t) {\r\n      ta = (t % period) / period;\r\n      if (ta < 0) ta++;\r\n      return fcn(ta);\r\n    };\r\n  }\r\n};\r\n\r\nMUSIC.Effects.register(\"ADSR\", function(music, next, options) {\r\n  options = options || {};\r\n  var samples = options.samples || 100;\r\n  var attackTime = options.attackTime;\r\n  var decayTime = options.decayTime;\r\n  var sustainLevel = options.sustainLevel;\r\n  var releaseTime = options.releaseTime;\r\n\r\n  if (attackTime === undefined) attackTime = 0.1;\r\n  if (decayTime === undefined) decayTime = 0.1;\r\n  if (sustainLevel === undefined) sustainLevel = 0.8;\r\n  if (releaseTime === undefined) releaseTime = 0.1;\r\n\r\n  var nextNodeFcn = options.node;\r\n  var attackCurve = new MUSIC.Curve.Ramp(0.0, 1.0, samples).during(attackTime);\r\n  var decayCurve = new MUSIC.Curve.Ramp(1.0, sustainLevel, samples).during(decayTime);\r\n  var startCurve = MUSIC.Curve.concat(attackCurve, attackTime, decayCurve, decayTime);\r\n\r\n  var gainNode = next\r\n              .gain(sustainLevel);\r\n\r\n  gainNode.setParam('gain', startCurve);\r\n  \r\n  return nextNodeFcn(gainNode)\r\n    .onStop(function(){ gainNode.dispose(); }) // dispose gain node\r\n    .stopDelay(releaseTime * 1000)\r\n    .onStop(function(){ \r\n      var currentLevel = gainNode._destination.gain.value;\r\n      var releaseCurve = new MUSIC.Curve.Ramp(currentLevel, 0.0, samples).during(releaseTime)\r\n      gainNode.setParam('gain', releaseCurve); \r\n    }); // set gain curve\r\n\r\n});\r\n\r\nMUSIC.Effects.register(\"stopCurve\", function(music, next, options) {\r\n  options = options || {};\r\n  var samples = options.samples || 100;\r\n  var duration = options.duration || 0.4;\r\n  var nextNodeFcn = options.node;\r\n  var stopCurve = new MUSIC.Curve.Ramp(1.0, 0.0, samples).during(duration);\r\n  var gainNode = next\r\n              .gain(1.0);\r\n  \r\n  return nextNodeFcn(gainNode)\r\n    .onStop(function(){ gainNode.dispose(); }) // dispose gain node\r\n    .stopDelay(duration * 1000)\r\n    .onStop(function(){ gainNode.setParam('gain', stopCurve); }); // set gain curve\r\n\r\n});\r\n\r\n","(function() {\r\n\r\nvar frequency = function(notenum) {\r\n    return 16.35 * Math.pow(2, notenum/12);\r\n};\r\nvar noteToNumMap = {\r\n  'C': 0, \r\n  'D': 2, \r\n  'E': 4, \r\n  'F': 5, \r\n  'G': 7, \r\n  'A': 9, \r\n  'B': 11\r\n};\r\n\r\nvar instrumentExtend = function(obj) {\r\n  var delayedPlaying = function(originalPlaying, ms) {\r\n    return {\r\n      stop: function() {\r\n        setTimeout(originalPlaying.stop.bind(originalPlaying), ms);\r\n      } \r\n    };\r\n  };\r\n\r\n  var delayedNote = function(originalNote, ms) {\r\n    return {\r\n      play: function(param) {\r\n        var originalPlaying = originalNote.play(param);\r\n        return delayedPlaying(originalPlaying, ms);\r\n      }\r\n    };\r\n  };\r\n\r\n  obj.stopDelay = function(ms) {\r\n    return instrumentExtend({\r\n      note: function(noteNum, options) {\r\n        return delayedNote(obj.note(noteNum, options), ms);\r\n      }\r\n    });\r\n  };\r\n\r\n  obj.perNoteWrap = function(wrapper) {\r\n    return instrumentExtend({\r\n      note: function(noteNum, options) {\r\n        return wrapper(obj.note(noteNum, options));\r\n      }\r\n    });\r\n  };\r\n\r\n  obj.mapNote = function(fcn) {\r\n    return instrumentExtend({\r\n      note: function(noteNum, options) {\r\n        return obj.note(fcn(noteNum), options);\r\n      }\r\n    });\r\n  };\r\n\r\n  if (!obj.eventPreprocessor) {\r\n    obj.eventPreprocessor = function(evt) {\r\n      return evt;\r\n    };\r\n  }\r\n\r\n  if (!obj.note) {\r\n    obj.note = function(n, options) {\r\n      return this.schedule_note(n, options, 0.0);\r\n    };\r\n  }\r\n\r\n  return obj;\r\n};\r\n\r\nMUSIC.noteToNoteNum = function(noteName) {\r\n  var notenum;\r\n\r\n  notenum = noteToNumMap[noteName.charAt(0)]\r\n  if (notenum === undefined) return undefined\r\n  if (noteName.charAt(1) === '#') notenum++;\r\n  if (noteName.charAt(1) === 'b') notenum--;\r\n  if (noteName.charAt(2) !== \"\") notenum += (12 * parseInt(noteName.charAt(2)));\r\n  return notenum;\r\n};\r\n\r\nMUSIC.PolyphonyInstrument = function(innerFactory, maxChannels) {\r\n  var instrumentArray = [];\r\n  var onUse = [];\r\n  var queue = [];\r\n\r\n  var freeIdx = function(maxChannels) {\r\n    for (var i=0; i<maxChannels; i++) {\r\n      if (!onUse[i]) return i;\r\n    }\r\n    return queue[0]||0;\r\n  };\r\n\r\n  this.note = function(notenum, options) {\r\n    var c = maxChannels();\r\n    var playingIdx = freeIdx(c);\r\n    var instrument = instrumentArray[playingIdx];\r\n\r\n    if (!instrument) {\r\n      instrument = innerFactory();\r\n      instrumentArray[playingIdx] = instrument;\r\n    }\r\n\r\n    queue.push(playingIdx);\r\n    if (queue.length > c) queue.shift();\r\n\r\n    onUse[playingIdx] = true;\r\n    return instrument.note(notenum, options)\r\n      .onStop(function() {\r\n        onUse[playingIdx] = false;\r\n      });\r\n  };\r\n\r\n  instrumentExtend(this);\r\n\r\n  this.eventPreprocessor = function(event, events) {\r\n    var instrument = instrumentArray[0]\r\n    if (!instrument) {\r\n      instrument = innerFactory();\r\n      instrumentArray[0] = instrument;\r\n    }\r\n\r\n    return (instrument.eventPreprocessor||function(x){return x; })(event, events);\r\n  };\r\n};\r\n\r\nMUSIC.MonoNoteInstrument = function(inner) {\r\n  var noteInst;\r\n  var playingInst;\r\n  var count = 0;\r\n\r\n  this.note = function(notenum, options) {\r\n    if (!noteInst) {\r\n      noteInst = inner.note(notenum, options);\r\n    }\r\n\r\n    return MUSIC.playablePipeExtend({\r\n      play: function(param) {\r\n        if (!playingInst) {\r\n          playingInst = noteInst.play(param);\r\n        }\r\n\r\n        noteInst.setValue(notenum, options);\r\n\r\n        count++;\r\n        return {stop: function() {\r\n          count--;\r\n          if (noteInst.reset && count === 0) noteInst.reset();\r\n        }};\r\n      } \r\n    });\r\n  };\r\n\r\n  this.currentTime = function() {\r\n    return inner.currentTime();\r\n  };\r\n\r\n  this.schedule_note = function(notenum, options, start) {\r\n    if (!noteInst) {\r\n      noteInst = inner.note(notenum, options);\r\n    }\r\n\r\n    return MUSIC.playablePipeExtend({\r\n      play: function(param) {\r\n        if (!playingInst) {\r\n          playingInst = noteInst.play(param);\r\n        }\r\n\r\n        noteInst.setValueOnTime(notenum, options, start);\r\n\r\n        return {stop: function() {\r\n          noteInst.cancelScheduledValues();\r\n        }};\r\n      } \r\n    });\r\n  };\r\n\r\n  this.dispose = function() {\r\n    if (playingInst) {\r\n      playingInst.stop();\r\n    }\r\n\r\n    if (inner.dispose) inner.dispose();\r\n  };\r\n\r\n  instrumentExtend(this);\r\n};\r\n\r\nMUSIC.Instrument = function(soundFactory) {\r\n  if (soundFactory.schedule_freq) {\r\n    this.currentTime = function() {\r\n      return soundFactory.currentTime();\r\n    };\r\n\r\n    this.schedule_note = function(notenum, options, startTime, duration) {\r\n      if (notenum === undefined) return undefined;\r\n      var freq = frequency(notenum);\r\n\r\n      return MUSIC.playablePipeExtend({\r\n        play: function(param) {\r\n          var fr = soundFactory.schedule_freq(freq, startTime);\r\n          var soundInstance = fr.play(param);\r\n          return {\r\n            stop: function() {\r\n              soundInstance.stop();\r\n            }\r\n          }\r\n        }\r\n      });\r\n    };\r\n  }\r\n\r\n  this.note = function(notenum) {\r\n    if (notenum === undefined) return undefined;\r\n\r\n    var freq = frequency(notenum);\r\n    return MUSIC.playablePipeExtend({\r\n      play: function(param) {\r\n        var fr = soundFactory.freq(freq);\r\n        var soundInstance = fr.play(param);\r\n\r\n        if (fr.setFreq) {\r\n          this.setValue = function(n, options) {\r\n            fr.setFreq(frequency(n), options);\r\n          };\r\n\r\n          this.reset = fr.reset.bind(fr);\r\n        }\r\n\r\n        if (fr.cancelScheduledValues) {\r\n          this.cancelScheduledValues = fr.cancelScheduledValues.bind(fr);\r\n        }\r\n\r\n        if (fr.setFreqOnTime) {\r\n          this.setValueOnTime = function(n, options, start) {\r\n            fr.setFreqOnTime(frequency(n), options, start);\r\n          };\r\n\r\n          this.reset = fr.reset.bind(fr);\r\n        }\r\n\r\n        return {\r\n          stop: function() {\r\n            soundInstance.stop();\r\n          }\r\n        }\r\n      }\r\n    });\r\n  };\r\n\r\n  instrumentExtend(this);\r\n};\r\n\r\nMUSIC.instrumentExtend = instrumentExtend;\r\nMUSIC.Instrument.frequency = frequency;\r\n\r\nMUSIC.MultiInstrument = function(instrumentArray) {\r\n  if (Array.isArray(instrumentArray)) return MUSIC.MultiInstrument.bind(this)(function() {\r\n    return instrumentArray;\r\n  });\r\n\r\n  var notePlay = function(note) { return note.play(); };\r\n  var noteStop = function(note) { return note.stop(); };\r\n\r\n  var MultiNote = function(noteArray) {\r\n    this.play = function() {\r\n      var notes = noteArray.map(notePlay);\r\n      return {\r\n        stop: function() {\r\n          notes.forEach(noteStop);\r\n        }\r\n      };\r\n    }\r\n  };\r\n\r\n  this.note = function(noteNum, options) {\r\n    return MUSIC.playablePipeExtend(new MultiNote(instrumentArray().map(function(instrument){ \r\n      return instrument.note(noteNum, options);\r\n    })));\r\n  };\r\n\r\n  this.dispose = function() {\r\n    instrumentArray().forEach(function(i) {\r\n      if (i.dispose) i.dispose();\r\n    });\r\n  };\r\n\r\n  if (instrumentArray().every(function(i) { return i.schedule_note; })) {\r\n    this.currentTime = function() {\r\n\r\n      var instrument = instrumentArray().filter(function(i) { return i.currentTime; })[0];\r\n      if (!instrument) return 0;\r\n\r\n      return instrument.currentTime();\r\n    };\r\n\r\n    this.schedule_note = function(noteNum, options, startTime, duration) {\r\n      return MUSIC.playablePipeExtend(new MultiNote(instrumentArray().map(function(instrument){ \r\n        return instrument.schedule_note(noteNum, options, startTime, duration);\r\n      })));\r\n    };\r\n  }\r\n\r\n  instrumentExtend(this);\r\n\r\n  this.eventPreprocessor = function(event, events) {\r\n    var array = instrumentArray();\r\n    if (!array.length) return event;\r\n\r\n    var processedEvents = array.map(function(instrument) {\r\n      if (instrument.eventPreprocessor) {\r\n        return instrument.eventPreprocessor(event, events);\r\n      } else {\r\n        return event;\r\n      }\r\n    });\r\n\r\n    if (processedEvents.length === 1) {\r\n      return processedEvents[0];\r\n    } else {\r\n      var n = 0, s = 0, l = 0;\r\n      var options = {};\r\n\r\n      for (var i=0; i<processedEvents.length; i++) {\r\n        var evt = processedEvents[i];\r\n        n = n + evt[0];\r\n        s = s + evt[1];\r\n        l = l + evt[2];\r\n\r\n        if (evt[3]) {\r\n          for (var k in evt[3]) {\r\n            options[k] = evt[3][k];\r\n          }\r\n        }\r\n      }\r\n\r\n      return [\r\n        Math.floor(n/processedEvents.length),\r\n        s/processedEvents.length,\r\n        l/processedEvents.length,\r\n        options\r\n      ];\r\n    }\r\n  };\r\n};\r\n\r\nvar NOTES = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];\r\nvar noteNumToNoteName = function(noteNum) {\r\n  var noteName = NOTES[noteNum % 12];\r\n  var octaveNum = (Math.floor(noteNum / 12 + 1));\r\n\r\n  return noteName + octaveNum;\r\n};\r\n\r\nMUSIC.PatchInstrument = function(notes) {\r\n  var noteNum;\r\n  var sounds = [];\r\n\r\n  for (var noteName in notes) {\r\n    var playable = MUSIC.Types.cast(\"playable\", notes[noteName]);\r\n    noteNum = MUSIC.noteToNoteNum(noteName);\r\n    sounds[noteNum] = playable;\r\n  };\r\n\r\n  this.note = function(noteNum) {\r\n    var s = sounds[noteNum];\r\n    if (!s) return s;\r\n    return MUSIC.playablePipeExtend({\r\n      play: s.play\r\n    });\r\n  };\r\n\r\n  instrumentExtend(this);\r\n};\r\n\r\nMUSIC.SoundfontInstrument = function(sounds, audio, audioDestination) {\r\n\r\n  var noteAudio = [];\r\n\r\nfunction _base64ToArrayBuffer(base64) {\r\n    var binary_string =  window.atob(base64);\r\n    var len = binary_string.length;\r\n    var bytes = new Uint8Array( len );\r\n    for (var i = 0; i < len; i++)        {\r\n        var ascii = binary_string.charCodeAt(i);\r\n        bytes[i] = ascii;\r\n    }\r\n    return bytes.buffer;\r\n};\r\n  audio = audio.audio\r\n  \r\n  for (var i = 0; i<72; i++) {\r\n    (function() {\r\n      var index = i;\r\n      var xmlhttp=new XMLHttpRequest();\r\n      var noteName = noteNumToNoteName(i);\r\n      var data = sounds[noteName];\r\n      var encoded = data.split(\",\")[1];\r\n\r\n      audio.decodeAudioData(_base64ToArrayBuffer(encoded), function(buffer) {\r\n        noteAudio[index] = buffer;\r\n      }, function(err) {\r\n        console.error(\"error \" + err + \" loading \" + index);\r\n      });\r\n\r\n    })();\r\n  };\r\n\r\n  this.note = function(notenum) {\r\n    var source = audio.createBufferSource();\r\n    return MUSIC.playablePipeExtend({\r\n      play: function() {\r\n        var source = audio.createBufferSource();\r\n        source.buffer = noteAudio[notenum];\r\n        source.connect(audioDestination._destination);\r\n        source.start(0);\r\n        return {\r\n          stop: function() {\r\n            source.stop(0);\r\n            source.disconnect(audioDestination._destination);\r\n          }\r\n        };\r\n      }\r\n    });\r\n  };\r\n\r\n  instrumentExtend(this);\r\n\r\n};\r\n\r\nMUSIC.Types.register(\"instrument\", function(instrument) {\r\n  if (instrument.note) return instrument;\r\n});\r\n\r\nMUSIC.Types.register(\"instrument\", function(soundGenerator) {\r\n  if (soundGenerator.freq) {\r\n    return new MUSIC.Instrument(soundGenerator);\r\n  }\r\n});\r\n\r\nMUSIC.Types.register(\"instrument\", function(playable) {\r\n  if (playable.play) {\r\n    return {\r\n      note: function(){\r\n        return playable;\r\n      }\r\n    };\r\n  }\r\n});\r\n\r\nvar nullPlay = {\r\n  play: function(){\r\n    return {stop: function(){}};\r\n  }\r\n};\r\n\r\nMUSIC.Types.register(\"instrument\", function(fcn) {\r\n  if (typeof fcn === \"function\") {\r\n    return {\r\n      note: function(n) {\r\n        return fcn(n) || nullPlay;\r\n      }\r\n    };\r\n  }\r\n});\r\n\r\nMUSIC.Types.register(\"instrument\", function(array) {\r\n  if (array instanceof Array) {\r\n    return new MUSIC.MultiInstrument(array);\r\n  }\r\n});\r\n\r\nMUSIC.Types.register(\"instrument\", function(plainObject) {\r\n  if (typeof plainObject === \"object\" && plainObject.constructor === Object) {\r\n    return new MUSIC.PatchInstrument(plainObject)\r\n  }\r\n});\r\n\r\nMUSIC.StopEvent = function() {\r\n  return function(note) {\r\n      return MUSIC.playablePipeExtend({\r\n          play: function() {\r\n              var paramObject = {\r\n                  onplay: function() {},\r\n                  onstop: function() {}\r\n              };\r\n\r\n              var originalNote = note.play(paramObject);\r\n              paramObject.onplay();\r\n              return {\r\n                  stop: function() {\r\n                      paramObject.onstop();\r\n                      originalNote.stop();\r\n                  }\r\n              };\r\n          }\r\n      });\r\n  };\r\n};\r\n\r\n})();","MUSIC.Effects = MUSIC.Effects || {};\r\n\r\nvar LemonadePlayable = function(music, destination, outputFcn, ops) {\r\n  this._destination = destination;\r\n  this._music = music;\r\n  this._ops = ops;\r\n  this._output = outputFcn;\r\n};\r\n\r\nLemonadePlayable.prototype.play = function() {\r\n  var destination = this._destination;\r\n  var ops = this._ops;\r\n  var opsLength = ops.length;\r\n  var signalArray = [];\r\n  var phaseArray = [];\r\n\r\n\r\n  for (var i=0; i<opsLength; i++) {\r\n    signalArray[i] = 0;\r\n    phaseArray[i] = 0;\r\n    ops[i].wave = MUSIC.Types.cast(\"function\", ops[i].wave)\r\n  }\r\n\r\n  var lastT = 0;\r\n  var outputFcn = this._output;\r\n  var formulaGenerator = new MUSIC.Effects.Formula(this._music, destination, function(input, t) {\r\n    var deltay = t-lastT;\r\n    for (var i=0; i<opsLength; i++) {\r\n      lastT = t;\r\n      // EULER\r\n      phaseArray[i] = phaseArray[i] + deltay * ops[i].frequency.apply(null, signalArray);\r\n\r\n      var phase = phaseArray[i] % 1;\r\n      if (phase < 0) phase++;\r\n      signalArray[i] = ops[i].wave(phase)\r\n    };\r\n\r\n    return outputFcn.apply(null, signalArray);\r\n  });\r\n  return {\r\n    stop: function() {\r\n      formulaGenerator.disconnect(destination._destination);\r\n    }\r\n  };\r\n};\r\n\r\nMUSIC.playablePipeExtend(LemonadePlayable.prototype);\r\n\r\nMUSIC.Effects.register(\"lemonade\", function(music, next, options) {\r\n  return new LemonadePlayable(music, next._audioDestination, options.output, options.ops);\r\n});","(function() {\r\nMUSIC.Math = MUSIC.Math || {};\r\n\r\nMUSIC.Math.bpmToSecondTick = function(options, bpm) {\r\n  return 60000 / bpm / options.ticks_per_beat;\r\n};\r\n\r\nvar makeEvaluableInverseFunctionFromParts = function(array) {\r\n  array = array.map(function(part) {\r\n    var f = makeEvaluableFunction(part.f);\r\n    var inverse_f = makeEvaluableInverseFunction(part.f);\r\n    return {\r\n      init: f(part.init),\r\n      end: f(part.end),\r\n      f: inverse_f\r\n    };\r\n  });\r\n\r\n  return function(y) {\r\n    var part = array.find(function(p) {\r\n      return y >= p.init && (!p.end || y <= p.end);\r\n    });\r\n\r\n    if (!part) return 0;\r\n    return part.f(y);\r\n  };  \r\n};\r\n\r\nvar makeEvaluableFunctionFromParts = function(array) {\r\n  array = array.map(function(part) {\r\n    return {\r\n      init: part.init,\r\n      end: part.end,\r\n      f: makeEvaluableFunction(part.f)\r\n    };\r\n  });\r\n\r\n  return function(x) {\r\n    var part = array.find(function(p) {\r\n      return x >= p.init && (!p.end || x <= p.end);\r\n    });\r\n\r\n    if (!part) return 0;\r\n    return part.f(x);\r\n  };\r\n};\r\n\r\nvar makeEvaluableInverseFunction = function(array) {\r\n  if (array.length == 2) {\r\n    var b = array[1];\r\n    var a = array[0];\r\n    return function(y) {\r\n      return (y - a)/b;  // y = b*x + a  ;   y - a = b*x; (y - a) / b = x;\r\n    };\r\n  } else if (array.length == 3) {\r\n    var a = array[2];\r\n    var b = array[1];\r\n    var c = array[0];      \r\n\r\n    if (a === 0) {\r\n      return makeEvaluableInverseFunction([c,b]);\r\n    } else {\r\n      return function(y) {\r\n        return 2*(c-y) / (-b - Math.sqrt(b*b - 4*a*(c-y)));\r\n      };\r\n    }\r\n  }\r\n};\r\n\r\n\r\nvar makeEvaluableFunction = function(array) {\r\n  if (array.length == 2) {\r\n    var b = array[1];\r\n    var a = array[0];\r\n    return function(x) {\r\n      return b*x + a;\r\n    };\r\n  } else if (array.length == 3) {\r\n    var a = array[2];\r\n    var b = array[1];\r\n    var c = array[0];\r\n    return function(x) {\r\n      return a*x*x + b*x + c;\r\n    };\r\n  }\r\n};\r\n\r\nvar integrate = function(array, lastPointValue) {\r\n  var x = lastPointValue[0];\r\n  var y = lastPointValue[1];\r\n\r\n  if (array.length == 1) {\r\n    var c = -array[0]*x + y;\r\n    return [c, array[0]];\r\n  } else if (array.length == 2) {\r\n    var c = y - x*array[0] - x*x*array[1]/2;\r\n    return [c, array[0], array[1]/2];\r\n  }\r\n};\r\n\r\nMUSIC.Math.integrateBpmEvents = function(options) {\r\n  var cutBpmEvent = function(bpmEvent1) {\r\n    var l = bpmEvent1.l;\r\n    options.bpm_events.forEach(function(bpmEvent2) {\r\n      if (bpmEvent2 !== bpmEvent1 && bpmEvent2.s >= bpmEvent1.s) {\r\n        if (bpmEvent2.s < bpmEvent1.s + l) {\r\n          var cutL = bpmEvent2.s - bpmEvent1.s;\r\n          if (cutL < l) l = cutL;\r\n        }\r\n      }\r\n    });\r\n\r\n    return {\r\n      s: bpmEvent1.s,\r\n      l: l,\r\n      n: Math.max(bpmEvent1.n, 1)\r\n    };\r\n  };\r\n\r\n  options.bpm_events = options.bpm_events.map(cutBpmEvent);\r\n\r\n  var firstEventStart = options.bpm_events[0].s;\r\n  var parts = [{\r\n    init: 0,\r\n    end: firstEventStart,\r\n    f: [MUSIC.Math.bpmToSecondTick(options, options.bpm)]\r\n  }];\r\n\r\n  for (var i=0; i<options.bpm_events.length; i++) {\r\n    var bpm_event = options.bpm_events[i];\r\n    var next_bpm_event = options.bpm_events[i+1];\r\n\r\n    var init_second_tick = MUSIC.Math.bpmToSecondTick(options, \r\n      i == 0 ? options.bpm : options.bpm_events[i-1].n);\r\n    var end_second_tick = MUSIC.Math.bpmToSecondTick(options, bpm_event.n);\r\n\r\n    var b = (end_second_tick - init_second_tick) / bpm_event.l;\r\n    var a = init_second_tick - b * bpm_event.s;\r\n\r\n    // f(bpm_event.s) =  init_second_tick\r\n    // f(bpm_event.s + bpm_event.l) =  init_second_tick - b * bpm_event.s + b * (bpm_event.s + bpm_event.l)\r\n    // f(bpm_event.s + bpm_event.l) =  init_second_tick + b * bpm_event.l\r\n    // f(bpm_event.s + bpm_event.l) =  end_second_tick\r\n\r\n    if (bpm_event.l === 0) {\r\n      parts.push({\r\n        init: bpm_event.s,\r\n        end: next_bpm_event && next_bpm_event.s,\r\n        f: [end_second_tick]\r\n      });\r\n    } else {\r\n      parts.push({\r\n        init: bpm_event.s,\r\n        end: bpm_event.s + bpm_event.l,\r\n        f: [a, b]\r\n      });\r\n\r\n      parts.push({\r\n        init: bpm_event.s + bpm_event.l,\r\n        end: next_bpm_event && next_bpm_event.s,\r\n        f: [end_second_tick]\r\n      });\r\n    }\r\n  };\r\n\r\n  var integratedParts = [];\r\n  var lastPointValue = [0,0];\r\n\r\n  for (var i=0; i<parts.length; i++) {\r\n    var part = parts[i];\r\n    var integral = integrate(part.f, lastPointValue);\r\n\r\n    integratedParts.push({\r\n      init: part.init,\r\n      end: part.end,\r\n      f: integrate(part.f, lastPointValue)\r\n    });\r\n\r\n    lastPointValue = [part.end, makeEvaluableFunction(integral)(part.end)];\r\n  };\r\n\r\n  return integratedParts;\r\n};\r\n\r\nMUSIC.Math.ticksToTime = function(options) {\r\n  if (options.start) {\r\n    var time = MUSIC.Math.ticksToTime({\r\n      bpm: options.bpm,\r\n      ticks_per_beat: options.ticks_per_beat,\r\n      bpm_events: options.bpm_events\r\n    });\r\n\r\n    var startTime = time(options.start);\r\n    return function(ticks) {\r\n      return time(ticks) - startTime;\r\n    };\r\n  }\r\n\r\n  var bpm = options.bpm;\r\n  var ticks_per_beat = options.ticks_per_beat;\r\n\r\n  if (options.bpm_events && options.bpm_events.length) {\r\n    var integral = MUSIC.Math.integrateBpmEvents(options);\r\n    return makeEvaluableFunctionFromParts(integral);\r\n  } else {\r\n    var scale = 60000 / bpm / ticks_per_beat;\r\n    return function(ticks) {\r\n      return ticks*scale;\r\n    };\r\n  }\r\n};\r\n\r\nMUSIC.Math.timeToTicks = function(options) {\r\n  if (options.start) {\r\n    var ret = MUSIC.Math.timeToTicks({\r\n      bpm: options.bpm,\r\n      ticks_per_beat: options.ticks_per_beat,\r\n      bpm_events: options.bpm_events\r\n    });\r\n\r\n    var time = MUSIC.Math.ticksToTime({\r\n      bpm: options.bpm,\r\n      ticks_per_beat: options.ticks_per_beat,\r\n      bpm_events: options.bpm_events\r\n    });\r\n\r\n    var startTime = time(options.start);\r\n    return function(time) {\r\n      return ret(time + startTime);\r\n    };\r\n  }\r\n\r\n  var bpm = options.bpm;\r\n  var ticks_per_beat = options.ticks_per_beat;\r\n\r\n  if (options.bpm_events && options.bpm_events.length) {\r\n    var integral = MUSIC.Math.integrateBpmEvents(options);\r\n    return makeEvaluableInverseFunctionFromParts(integral);\r\n  } else {\r\n    var inverseScale = ticks_per_beat * bpm / 60000;\r\n    return function(time) {\r\n      return time*inverseScale;\r\n    };\r\n  }\r\n};\r\n\r\n})();","(function() {\r\n\r\nMUSIC.NoteSequence = function(funseq, options) {\r\n  var clock;\r\n  var songCtx = options && options.songCtx;\r\n\r\n  if (!funseq){\r\n    clock = MUSIC.Utils.Clock(\r\n      window.performance.now.bind(window.performance),\r\n      setInterval,\r\n      clearInterval,\r\n      500);\r\n    funseq = MUSIC.Utils.FunctionSeq(clock, setTimeout, clearTimeout);\r\n    funseq.push({t: 0, f: function() {\r\n      if (songCtx.referenceInstrument) {\r\n        songCtx.sequenceStartTime = songCtx.referenceInstrument.currentTime();\r\n      }\r\n    }, externalSchedule: true});\r\n  }\r\n\r\n  this._time = options && options.time;\r\n  this._funseq = funseq;\r\n  this._totalduration = 0;\r\n  this._noteid = 0;\r\n  this._contextList = [];\r\n};\r\n\r\nMUSIC.NoteSequence.Playable = function(noteseq, instrument, duration, contextList) {\r\n  this._noteseq = noteseq;\r\n  this._instrument = instrument;\r\n  this._duration = duration;\r\n  this._contextList = contextList || [];\r\n};\r\n\r\nMUSIC.NoteSequence.Playable.prototype.loop = function(times) {\r\n  return MUSIC.Loop(this, times);\r\n};\r\n\r\nMUSIC.NoteSequence.Playable.prototype.duration = function() {\r\n  return this._duration;\r\n};\r\n\r\nMUSIC.NoteSequence.Playable.prototype.play = function(options) {\r\n  var context = MUSIC.NoteSequence.context(this._instrument, this._contextList);\r\n  this._runningFunSeq = this._noteseq._funseq.start(context);\r\n  return new MUSIC.NoteSequence.Playing(this._runningFunSeq, context);\r\n};\r\n\r\nMUSIC.NoteSequence.Playing = function(runningFunSeq, ctx) {\r\n  this._runningFunSeq = runningFunSeq;\r\n  this._context = ctx;\r\n};\r\n\r\nMUSIC.NoteSequence.Playing.prototype.stop = function() {\r\n  if (this._context.playing) this._context.playing.stop();\r\n  this._context.stop();\r\n  this._runningFunSeq.stop();\r\n};\r\n\r\nMUSIC.NoteSequence.prototype.paddingTo = function(ticks){\r\n  this._totalduration = this._time(ticks);\r\n};\r\n\r\nMUSIC.NoteSequence.prototype.padding = function(time){\r\n  this._totalduration = this._totalduration + time;\r\n};\r\n\r\nMUSIC.NoteSequence.prototype.pushCallback = function(array){\r\n  var startTime = this._time(array[0]);\r\n  if (startTime < 0) return;\r\n\r\n  var f = array[1];\r\n  this._funseq.push({t:startTime, f: f});\r\n};\r\n\r\nMUSIC.NoteSequence.prototype.push = function(array, baseCtx){\r\n  var noteNum = array[0];\r\n  var startTime = this._time(array[1]);\r\n  var duration = this._time(array[1]+array[2]) - startTime;\r\n\r\n  if (startTime < 0) {\r\n    if (startTime + duration < 0) {\r\n      return;\r\n    } else {\r\n      duration = duration + startTime;\r\n      startTime = 0;\r\n    }\r\n  }\r\n\r\n  var options = array[3];\r\n\r\n  this._noteid++;\r\n  var mynoteid = this._noteid;\r\n\r\n  if (baseCtx) {\r\n    if (this._contextList.indexOf(baseCtx)===-1) {\r\n      this._contextList.push(baseCtx);\r\n    }\r\n  }\r\n\r\n  if (baseCtx && baseCtx.instrument && baseCtx.instrument.schedule_note) {\r\n    if (baseCtx.instrument.currentTime) {\r\n      baseCtx.songCtx.referenceInstrument = baseCtx.instrument;\r\n    }\r\n\r\n    this._funseq.push({t:startTime, f: function(param) {\r\n      var playing = baseCtx.instrument.schedule_note(\r\n        noteNum,\r\n        options,\r\n        baseCtx.sequenceStartTime() + startTime/1000,\r\n        duration/1000);\r\n\r\n      baseCtx.setPlaying(mynoteid, playing);\r\n    }, externalSchedule: true});\r\n  } else {\r\n\r\n    console.warn(\"UNSUPPORTED WEBAUDIO SCHEDULE FOR note n=\" + noteNum + \" at \" + startTime + \" (fallback to setTimeout)\");\r\n\r\n    this._funseq.push({t:startTime, f: function(param){\r\n      var ctx = baseCtx || param;\r\n      if (!ctx.instrument.note) return;\r\n      var playing = ctx.instrument.note(noteNum, options);\r\n      ctx.setPlaying(mynoteid, playing);\r\n    }});\r\n    this._funseq.push({t:startTime + duration, f: function(param){\r\n      var ctx = baseCtx || param;\r\n      ctx.unsetPlaying(mynoteid);\r\n    }});\r\n  }\r\n\r\n  if (startTime + duration > this._totalduration) this._totalduration = startTime + duration;\r\n};\r\n\r\nMUSIC.NoteSequence.prototype.makePlayable = function(instrument) {\r\n  return new MUSIC.NoteSequence.Playable(this, instrument, this._totalduration, this._contextList);\r\n};\r\n\r\nMUSIC.NoteSequence.context = function(instrument, subctx, songCtx) {\r\n  var playingNotes = {};\r\n  var setPlaying = function(noteid, p) {\r\n    playingNotes[noteid] = p.play();\r\n  };\r\n  var unsetPlaying = function(noteid) {\r\n    var playing = playingNotes[noteid]; \r\n    if (playing) {\r\n      playing.stop();\r\n      delete playingNotes[noteid];\r\n    }\r\n  };\r\n\r\n  var stop = function() {\r\n    if (subctx) {\r\n      for (var i=0; i<subctx.length; i++) {\r\n        subctx[i].stop();\r\n      }\r\n    }\r\n\r\n    for (var noteid in playingNotes) {\r\n      playingNotes[noteid].stop();\r\n    }\r\n\r\n    playingNotes = {};\r\n  };\r\n\r\n  var sequenceStartTime = function() {\r\n    if (!songCtx.sequenceStartTime) {\r\n      songCtx.sequenceStartTime = this.instrument.currentTime();\r\n    }\r\n\r\n    return songCtx.sequenceStartTime;\r\n  };\r\n\r\n  return {\r\n    sequenceStartTime: sequenceStartTime,\r\n    setPlaying: setPlaying,\r\n    unsetPlaying: unsetPlaying,\r\n    instrument: instrument,\r\n    stop: stop,\r\n    songCtx: songCtx\r\n  };\r\n};\r\n\r\n})();","(function() {\r\nvar playingStop = function(playing) { playing.stop(); };\r\n\r\nMUSIC.MultiPlayable = function(playableArray) {\r\n  this._playableArray = playableArray;\r\n\r\n  MUSIC.playablePipeExtend(this);\r\n};\r\n\r\nMUSIC.MultiPlayable.prototype.play = function(options) {\r\n  var playablePlay = function(playable) { return playable.play(options); };\r\n  var playingArray = this._playableArray.map(playablePlay);\r\n\r\n  return {\r\n    stop: function() {\r\n      playingArray.forEach(playingStop);\r\n    }\r\n  };\r\n};\r\n\r\nvar higher = function(a,b){ return a > b ? a : b; };\r\nvar getDuration = function(playable) { return playable && playable.duration ? playable.duration() : 0; };\r\nMUSIC.MultiPlayable.prototype.duration = function() {\r\n  return this._playableArray.map(getDuration).reduce(higher, 0);\r\n};\r\n\r\nMUSIC.ChangeTimeWrapper = function(noteseq, extensionTime) {\r\n  this._noteseq=noteseq;\r\n  this._extensionTime=extensionTime;\r\n};\r\n\r\nMUSIC.ChangeTimeWrapper.prototype.push = function(input) {\r\n  this._noteseq.push([input[0], input[1]*this._extensionTime, input[2]*this._extensionTime]);\r\n};\r\n\r\nMUSIC.Pattern = function(input, options) {\r\n  var playableArray = [];\r\n  options = options || {};\r\n  options.pulseTime = options.pulseTime || 50;\r\n\r\n  playableArray = input.map(function(seq) {\r\n    var code = seq[0];\r\n    var instrument = MUSIC.Types.cast(\"instrument\", seq[1]);\r\n\r\n    var noteseq = new MUSIC.NoteSequence();\r\n    MUSIC.SequenceParser.parse(code, new MUSIC.ChangeTimeWrapper(noteseq,options.pulseTime));\r\n    return noteseq.makePlayable(instrument);\r\n  });\r\n\r\n  return new MUSIC.MultiPlayable(playableArray);\r\n\r\n};\r\n\r\n})();","(function() {\r\nMUSIC.SequenceParser = {};\r\nvar notes = {\r\n  \"Cb\": -1,\r\n  \"C\": 0,\r\n  \"C#\": 1,\r\n  \"Db\": 1,\r\n  \"D\": 2,\r\n  \"D#\": 3,\r\n  \"Eb\": 3,\r\n  \"E\": 4,\r\n  \"E#\": 5,\r\n  \"Fb\": 4,\r\n  \"F\": 5,\r\n  \"F#\": 6,\r\n  \"Gb\": 6,\r\n  \"G\": 7,\r\n  \"G#\": 8,\r\n  \"Ab\": 8,\r\n  \"A\": 9,\r\n  \"A#\": 10,\r\n  \"Bb\": 10,\r\n  \"B\": 11,\r\n  \"B#\": 12\r\n};\r\n\r\nvar isNoteStart = function(chr) {\r\n  return \"CDEFGAB\".indexOf(chr) !== -1;\r\n};\r\n\r\nvar noteSplit = function(str) {\r\n  var ret = [];\r\n  var lastNote = \"\";\r\n  for (var i = 0; i < str.length; i++) {\r\n    if (isNoteStart(str[i])) {\r\n      if (lastNote !== \"\") ret.push(lastNote);\r\n      lastNote = \"\";\r\n    }\r\n\r\n    if (str[i] === \" \" || str[i] === \".\") {\r\n      if (lastNote !== \"\") ret.push(lastNote);\r\n      lastNote = \"\";\r\n    }\r\n\r\n    lastNote += str[i];\r\n  }\r\n  if (lastNote !== \"\") ret.push(lastNote);\r\n  return ret;\r\n};\r\n\r\nvar pipeReplace = new RegExp(\"\\\\|\", \"g\");\r\nMUSIC.SequenceParser.parse = function(input, noteSeq) {\r\n  var currentNote;\r\n  var currentCharacter;\r\n  if (input === \"\") return;\r\n  input = input.replace(pipeReplace, \"\");\r\n\r\n  var noteArray = noteSplit(input);\r\n  var currentTime = 0;\r\n  for (var i=0; i<noteArray.length; i++) {\r\n    var currentNoteStr = noteArray[i];\r\n    var noteDuration = currentNoteStr.length;\r\n    var equalIndex = currentNoteStr.indexOf(\"=\");\r\n    if (equalIndex != -1) currentNoteStr = currentNoteStr.slice(0, equalIndex);\r\n\r\n    var lastChar = currentNoteStr.slice(-1);\r\n    var octave = parseInt(lastChar);\r\n    if (isNaN(octave)) {\r\n      octave = 0;\r\n    } else {\r\n      currentNoteStr = currentNoteStr.slice(0, currentNoteStr.length-1);\r\n    }\r\n\r\n    var currentNote = notes[currentNoteStr];\r\n    if (currentNote !== undefined){\r\n      noteSeq.push([currentNote + octave*12, currentTime, noteDuration])\r\n    };\r\n    currentTime += noteDuration;\r\n  }\r\n};\r\n\r\n})();","(function() {\r\n\r\nvar PlayingSong = function(funseq, patternContexts, options) {\r\n  this._context = {playing: [], onStop: options && options.onStop};\r\n  this._patternContexts = patternContexts;\r\n  this._funseqHandler = funseq.start(this._context);\r\n};\r\n\r\nPlayingSong.prototype.stop = function() {\r\n  if (this._patternContexts && this._patternContexts.length) {\r\n    this._patternContexts.forEach(function(ctx) {\r\n      ctx.stop();\r\n    });\r\n  }\r\n\r\n  this._context.playing.forEach(function(playing) {\r\n    playing.stop();\r\n  });\r\n\r\n  this._funseqHandler.stop();\r\n\r\n  if (this._context.onStop){\r\n    this._context.onStop();\r\n  }\r\n};\r\n\r\nvar noPlay = {\r\n  play: function() {\r\n    return {\r\n      stop: function() {}\r\n    };\r\n  }\r\n};\r\n\r\nvar defaultFromPatterns = function(patterns) {\r\n  return function(patternOrName) {\r\n    if (typeof patternOrName === 'string') return patterns[patternOrName];\r\n    return patternOrName || noPlay;\r\n  };\r\n};\r\n\r\nvar nullPlay = {stop: function(){}};\r\nvar hasScheduleMethod = function(pattern) {\r\n  return !!pattern.schedule;\r\n};\r\n\r\nvar hasNotScheduleMethod = function(pattern) {\r\n  return !pattern.schedule;\r\n};\r\n\r\nMUSIC.Song = function(input, patternsOrOptions, options){\r\n  var patterns;\r\n  var self = this;\r\n\r\n  if (arguments.length === 2) {\r\n    return MUSIC.Song.bind(this)(input, {}, patternsOrOptions);\r\n  } else {\r\n    patterns = patternsOrOptions;\r\n  }\r\n\r\n  options = options || {};\r\n  var getFromPatterns = options.pattern|| defaultFromPatterns(patterns);\r\n  var measure = (options.measure || 500) * options.ticks_per_beat;\r\n  var funseq;\r\n  if (!funseq){\r\n    var clock = MUSIC.Utils.Clock(\r\n      window.performance.now.bind(window.performance),\r\n      setInterval,\r\n      clearInterval,\r\n      500);\r\n    funseq = MUSIC.Utils.FunctionSeq(clock, setTimeout, clearTimeout);\r\n  }\r\n\r\n\r\n  var totalMeasures = input[0].length;\r\n\r\n  this._funseq = funseq;\r\n\r\n  var byStart = function(a, b) {\r\n    return a.s-b.s;\r\n  };\r\n\r\n  // tempo events \r\n  var bpm_events = [];\r\n  for (var j = 0; j < totalMeasures; j++) {\r\n    var patternArray = [];\r\n    for (var i = 0 ; i < input.length; i++) {\r\n      var pattern = getFromPatterns(input[i][j]);\r\n      if (pattern.bpm_events) {\r\n        var displacedBpmEvents = pattern.bpm_events.map(function(evt) {\r\n          return {n: evt.n, s: evt.s + j*measure, l: evt.l};\r\n        });\r\n        bpm_events = bpm_events.concat(displacedBpmEvents);\r\n      }\r\n    };\r\n  }\r\n\r\n  bpm_events = bpm_events.sort(byStart);\r\n\r\n  var time = MUSIC.Math.ticksToTime({\r\n    bpm: options.bpm,\r\n    ticks_per_beat: options.ticks_per_beat,\r\n    bpm_events: bpm_events,\r\n    start: options.start || 0\r\n  });\r\n\r\n  this.timeToTicks = function() {\r\n    return MUSIC.Math.timeToTicks({\r\n      bpm: options.bpm,\r\n      ticks_per_beat: options.ticks_per_beat,\r\n      bpm_events: bpm_events,\r\n      start: options.start || 0\r\n    });\r\n  };\r\n\r\n  var timeFunc = function(baseTicks) {\r\n    return function(ticks) {\r\n      return time(baseTicks+ticks);\r\n    };\r\n  };\r\n\r\n  this._duration = time(totalMeasures * measure);\r\n  this.songCtx = {};\r\n\r\n  funseq.push({t: 0, f: function() {\r\n    if (self.songCtx.referenceInstrument) {\r\n      self.songCtx.sequenceStartTime = self.songCtx.referenceInstrument.currentTime();\r\n    }\r\n  }, externalSchedule: true});\r\n\r\n  for (var j = 0; j < totalMeasures; j++) {\r\n    (function() {\r\n      var patternArray = [];\r\n      for (var i = 0 ; i < input.length; i++) {\r\n        patternArray.push(input[i][j]);\r\n      };\r\n      var playableArray = patternArray.map(getFromPatterns) \r\n\r\n      var schedulable = playableArray.filter(hasScheduleMethod);\r\n      var notSchedulable = playableArray.filter(hasNotScheduleMethod);\r\n\r\n      if (notSchedulable.length > 0) {\r\n        var multiPlayable = new MUSIC.MultiPlayable(notSchedulable);\r\n        var playing = nullPlay;\r\n        var duration = multiPlayable.duration();\r\n\r\n        funseq.push({t: j*measure, f: function(context) {\r\n          playing = multiPlayable.play();\r\n          context.playing.push(playing);\r\n        }});\r\n        funseq.push({t: j*measure+duration, f: function(context) {\r\n          playing.stop();\r\n          context.playing = context.playing.filter(function(x){ return x != playing; });\r\n        }});\r\n      }\r\n\r\n      schedulable.forEach(function(s) {\r\n        var scheduleContexts = s.schedule(new MUSIC.NoteSequence(funseq, {\r\n          time: timeFunc(j*measure)\r\n        }), self.songCtx);\r\n        self._patternContexts = (self._patternContexts||[]).concat(scheduleContexts);\r\n      });\r\n\r\n    })();\r\n  };\r\n\r\n  funseq.push({t: timeFunc(0)(totalMeasures*measure), f: function(context) {\r\n    if (context.onStop) {\r\n      context.onStop();\r\n    }\r\n  }});\r\n\r\n};\r\n\r\nMUSIC.Song.prototype.duration = function() {\r\n  return this._duration;\r\n};\r\n\r\nMUSIC.Song.prototype.play = function(options) {\r\n  return new PlayingSong(this._funseq,  this._patternContexts, options);\r\n};\r\n\r\n})();","(function() {\r\nMUSIC.Utils = MUSIC.Utils || {};\r\nMUSIC.Utils.Scale = function(base) {\r\n  var toneAdd;\r\n  var v;\r\n\r\n  toneAdd = {};\r\n  v = [0,2,5,7,9];\r\n  for (var i=0; i<v.length; i++) {\r\n    toneAdd[(base+v[i]) % 12 ] = true;\r\n  }\r\n\r\n  return {\r\n    add: function(notenum, notes) {\r\n      var ret = notenum;\r\n      while (notes > 0) {\r\n        ret+= toneAdd[ret % 12] ? 2 : 1;\r\n        notes--;\r\n      }\r\n      return ret;\r\n    }\r\n  };\r\n};\r\n\r\nMUSIC.Utils.Clock = function(preciseTimer, setInterval, clearInterval, interval) {\r\n  var start = function(fcn) {\r\n    var startTime = preciseTimer();\r\n    fcn(0);\r\n    var hndl = setInterval(function(){\r\n      var t = preciseTimer();\r\n      fcn(t - startTime);\r\n    }, interval);\r\n\r\n    return {\r\n      stop: function() {\r\n        clearInterval(hndl);\r\n      }\r\n    }\r\n  };\r\n\r\n  return {\r\n    start: start\r\n  };\r\n};\r\n\r\nMUSIC.Utils.FunctionSeq = function(clock, setTimeout, clearTimeout) {\r\n  var eventsArray = [];\r\n\r\n  var reject = function(x) {\r\n    return function(y) {\r\n      return x!=y;\r\n    };\r\n  };\r\n\r\n  var start = function(parameter) {\r\n    var array = eventsArray.slice(0).sort(function(e1, e2) {\r\n      var dt = e1.t - e2.t;\r\n      if (dt===0) {\r\n        return eventsArray.indexOf(e1) - eventsArray.indexOf(e2);\r\n      }\r\n\r\n      return dt;\r\n    });\r\n\r\n    var timeoutHandlers = [];\r\n    var eventCount = array.length;\r\n\r\n    var clockHandler = clock.start(function(t) {\r\n      var lastEvent;\r\n      var callingCriteria = function(element) {\r\n        return element.t - t < 1000 && element.t - t >= 0;\r\n      };\r\n\r\n      var pending = [];\r\n      var processPending = function() {\r\n        if (!pending.length) return;\r\n\r\n        var currentPending = pending;\r\n        pending = [];\r\n\r\n        for (var i=0; i<currentPending.length; i++) {\r\n          if (currentPending[i].externalSchedule) {\r\n            currentPending[i].f(parameter, currentPending[i].t - t);\r\n          }\r\n        }\r\n\r\n        var timeoutHandler = setTimeout(function() {\r\n          timeoutHandlers = timeoutHandlers.filter(reject(timeoutHandler))\r\n\r\n          for (var i=0; i<currentPending.length; i++) {\r\n            if (!currentPending[i].externalSchedule) {\r\n              currentPending[i].f(parameter, 0);\r\n              eventCount--;\r\n              if (eventCount === 0) clockHandler.stop();\r\n            }\r\n          }\r\n        }, currentPending[0].t - t);\r\n        timeoutHandlers.push(timeoutHandler);\r\n      };\r\n\r\n      var addSchedule = function(event) {\r\n        if (lastEvent && lastEvent.t - t !== event.t - t) {\r\n          processPending();\r\n        }\r\n\r\n        pending.push(event);\r\n        lastEvent = event;\r\n      };\r\n\r\n      var nextElement;\r\n\r\n      while(1) {\r\n        if (array.length > 0) {\r\n          nextElement = array[0];\r\n          if (callingCriteria(nextElement)) {\r\n            addSchedule(nextElement);\r\n            array.shift(); // remove first element\r\n          } else {\r\n            break;\r\n          }\r\n        } else {\r\n          break;\r\n        }\r\n      }\r\n\r\n      processPending();\r\n    });\r\n\r\n    return {\r\n      stop: function(){\r\n        for (var i=0; i<timeoutHandlers.length;i++){\r\n          clearTimeout(timeoutHandlers[i]);\r\n        };\r\n        clockHandler.stop();\r\n      }\r\n    };\r\n  };\r\n\r\n  var push = eventsArray.push.bind(eventsArray);\r\n\r\n  return {\r\n    start: start,\r\n    push: push\r\n  };\r\n};\r\n\r\nMUSIC.Utils.FunctionSeq.preciseTimeout = function(fcn, ms) {\r\n  var funseq;\r\n  clock = MUSIC.Utils.Clock(\r\n    window.performance.now.bind(window.performance),\r\n    setInterval,\r\n    clearInterval,\r\n    500);\r\n  funseq = MUSIC.Utils.FunctionSeq(clock, setTimeout, clearTimeout);\r\n\r\n  var runningFunSeq;\r\n\r\n  funseq.push({f: function() {\r\n    if (runningFunSeq) {\r\n      runningFunSeq.stop();\r\n    }\r\n    fcn();\r\n  }, t: ms});\r\n  runningFunSeq = funseq.start();\r\n};\r\n\r\nMUSIC.Utils.DelayedFunctionSeq = function(inner, delay) {\r\n  var start = function(params) {\r\n    return inner.start(params);\r\n  };\r\n\r\n  var push = function(params) {\r\n    return inner.push({\r\n      f: params.f,\r\n      t: params.t + delay,\r\n      externalSchedule: params.externalSchedule\r\n    });\r\n  };\r\n\r\n  return {\r\n    start: start,\r\n    push: push\r\n  };\r\n};\r\n\r\n\r\n})();","(function() {\r\n  MUSIC = MUSIC ||{};\r\n\r\n  MUSIC.Types.register(\"function\", function(wave) {\r\n    if (typeof wave.at === \"function\") {\r\n      return wave.at.bind(wave);\r\n    }\r\n  });\r\n\r\n  MUSIC.Types.register(\"function\", function(fcn) {\r\n    if (typeof fcn === \"function\") {\r\n      return fcn;\r\n    }\r\n  });\r\n\r\n  MUSIC.Types.register(\"wave\", function(fcn) {\r\n    if (typeof fcn === \"function\") {\r\n      return new MUSIC.Wave.FunctionWave(fcn);\r\n    }\r\n  });\r\n\r\n  MUSIC.Types.register(\"wave\", function(wave) {\r\n    if (typeof wave.at === \"function\") {\r\n      return wave;\r\n    }\r\n  });\r\n\r\n\r\n  var twopi = Math.PI*2;\r\n  MUSIC.Wave = {};\r\n\r\n  var waveTransform = function(fcn) {\r\n    return function() {\r\n      var wave = this;\r\n      return {\r\n        at: function(t) {\r\n          wave.at(fcn(t));\r\n        }\r\n      };\r\n    }\r\n  };\r\n  var waveOps = {\r\n    reverse: waveTransform(function(t){return t-1; }),\r\n    scale: function(factor) {\r\n      var wave = this;\r\n      return new MUSIC.Wave.FunctionWave(function(t) {\r\n        return wave.at(t*factor);\r\n      }); \r\n    },\r\n    translate: function(disp) {\r\n      var wave = this;\r\n      return new MUSIC.Wave.FunctionWave(function(t) {\r\n        return wave.at(t+disp);\r\n      });\r\n    },\r\n    table: function(options) {\r\n      return new MUSIC.Wave.Table(this, options);\r\n    },\r\n    combine: function(otherWave, otherFactor) {\r\n      var thisWave = this;\r\n      otherFactor = otherFactor || 0.5;\r\n      var thisFactor = 1-otherFactor;\r\n      otherWave = MUSIC.Types.cast(\"wave\", otherWave);\r\n      return new MUSIC.Wave.FunctionWave(function(t) {\r\n        return otherWave.at(t) * otherFactor + thisWave.at(t) * thisFactor;\r\n      });\r\n    }\r\n  };\r\n\r\n  var defaultInterpolation = function(table){\r\n    var length = table.length;\r\n    return function(t) {\r\n      var index = Math.floor(t*table.length)\r\n      return table[index];\r\n    };\r\n  };\r\n\r\n  MUSIC.Wave.Table = function(wave, options) {\r\n    options = options || {};\r\n    var sampleCount = options.samples || 100;\r\n    var interpolation = options.interpolation || defaultInterpolation;\r\n\r\n    var sample = [];\r\n    for (var i=0; i<sampleCount; i++) {\r\n      sample[i] = wave.at(i/sampleCount);\r\n    }\r\n\r\n    this.at = interpolation(sample);\r\n  };\r\n  MUSIC.Wave.Table.prototype = waveOps;\r\n\r\n  MUSIC.Wave.FunctionWave = function(fcn) {\r\n    this.at = fcn;\r\n  };\r\n  MUSIC.Wave.FunctionWave.prototype = waveOps;\r\n\r\n\r\n  MUSIC.Wave.sine = function() {\r\n    return new MUSIC.Wave.FunctionWave(function(t) {\r\n      return Math.sin(twopi*t);\r\n    });\r\n  };\r\n\r\n  MUSIC.Wave.square = function(options) {\r\n    options = options || {};\r\n    var dutyCycle = options.dutyCycle || 0.5;\r\n    var dutyLevel = options.dutyLevel || 1;\r\n    var offLevel = options.offLevel || -1;\r\n    return new MUSIC.Wave.FunctionWave(function(t) {\r\n      if (t<dutyCycle){\r\n        return dutyLevel\r\n      } else {\r\n        return offLevel;\r\n      }\r\n    });\r\n  };\r\n\r\n  MUSIC.Wave.triangle = function() {\r\n    return new MUSIC.Wave.FunctionWave(function(t) {\r\n      var t2 = t-0.25;\r\n      if (t2<0) t2++;\r\n      if (t2<0.5) {\r\n        return 1-t2*4;\r\n      } else {\r\n        return -1+(t2-0.5)*4;\r\n      }\r\n    });\r\n  };\r\n\r\n  MUSIC.Wave.sawtooth = function() {\r\n    return new MUSIC.Wave.FunctionWave(function(t) {\r\n      return t*2-1;\r\n    });\r\n  };\r\n\r\n})();\r\n\r\n","MUSIC = MUSIC ||{};\r\nMUSIC.Formats = MUSIC.Formats||{};\r\nMUSIC.Formats.CachedSerializer = function(innerSerializer) {\r\n  var lastOutput;\r\n  var lastInput;\r\n  var lastType;\r\n\r\n  return {\r\n    serialize: function(type, input) {\r\n      var jsonCurrentInput;\r\n      if (lastType && lastInput) {\r\n        jsonCurrentInput = JSON.stringify(input)\r\n        if (lastType === type && lastInput === jsonCurrentInput) return lastOutput;\r\n      }\r\n\r\n      lastType = type;\r\n      lastInput = jsonCurrentInput || JSON.stringify(input);\r\n      lastOutput = innerSerializer.serialize(type, input);\r\n      return lastOutput;\r\n    },\r\n\r\n    deserialize: innerSerializer.deserialize.bind(innerSerializer)\r\n  };\r\n};\r\n","MUSIC = MUSIC ||{};\r\nMUSIC.Formats = MUSIC.Formats||{};\r\n\r\n(function() {\r\n\r\nMUSIC.Formats.HuffmanSerializerWrapper = function(innerSerializer) {\r\n  var frequencies = [\r\n    [\",\", 100],\r\n    [\"[]\", 20],\r\n    [\"0123456789\", 10],\r\n    [\"abcdef.-{}\", 4],\r\n    [\"t+-*/()<>=? \", 1]\r\n  ];\r\n\r\n  var times = function(str, n) {\r\n    var ret = \"\";\r\n    for (var i =0;i<n; i++) ret = ret + str;\r\n    return ret;\r\n  };\r\n\r\n  var concat = function(a, b){ return a.concat(b); };\r\n  var text = frequencies.map(function(freq) {\r\n    return times(freq[0], freq[1]);\r\n  }).reduce(concat);\r\n\r\n  text = text + \"!\\\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\\\]^_`abcdefghijklmnopqrstuvwxyz{|}~\"\r\n  var huffman = Huffman.treeFromText(text);\r\n\r\n  var serialize = function(type, obj) {\r\n    var str = innerSerializer.serialize(type, obj);\r\n    return huffman.encode(str);\r\n  };\r\n\r\n  var deserialize = function(type, str) {\r\n    var decoded = huffman.decode(str);\r\n    return innerSerializer.deserialize(type, decoded);\r\n  };\r\n\r\n  return {\r\n    serialize: serialize,\r\n    deserialize: deserialize\r\n  };\r\n};\r\n\r\n\r\n})();\r\n","MUSIC = MUSIC ||{};\r\nMUSIC.Formats = MUSIC.Formats||{};\r\nMUSIC.Formats.JSONSerializer = {};\r\n\r\nMUSIC.Formats.JSONSerializer.serialize = function(type, obj) {\r\n  return JSON.stringify(obj);\r\n};\r\n\r\nMUSIC.Formats.JSONSerializer.deserialize = function(type, str) {\r\n  return JSON.parse(str);\r\n};\r\n","MUSIC = MUSIC ||{};\r\nMUSIC.Formats = MUSIC.Formats||{};\r\nMUSIC.Formats.MultiSerializer = {};\r\n(function() {\r\n\r\nvar serializerArray = [];\r\n\r\nvar match = function(a, b) {\r\n  if (typeof a !== typeof b) return false;\r\n\r\n  if (Array.isArray(a) && !Array.isArray(b)) return false;\r\n  if (Array.isArray(b) && !Array.isArray(a)) return false;\r\n\r\n  if (Array.isArray(a)) {\r\n    if (a.length !== b.length) return false;\r\n    for (var i=0; i<a.length; i++) {\r\n      if (!match(a[i], b[i])) return false;\r\n    }\r\n    return true;\r\n  } else if (typeof a === 'object') {\r\n    return Object.keys(a).every(function(key) {\r\n      return match(a[key], b[key]);\r\n    });\r\n  } else {\r\n    return a === b;\r\n  }\r\n};\r\n\r\nMUSIC.Formats.MultiSerializer.match = match;\r\n\r\nMUSIC.Formats.MultiSerializer.wrapSerializer = function(serializer) {\r\n  return {\r\n    serialize: function(type, obj) {\r\n      try {\r\n        var output = serializer.serialize(type, obj);\r\n        var recoveredInput = serializer.deserialize(type, output);\r\n        return MUSIC.Formats.MultiSerializer.match(obj, recoveredInput) ? output : null;\r\n      }catch(e) {\r\n        return null; // failed serializations are discarded\r\n      }\r\n    },\r\n    deserialize: serializer.deserialize\r\n  };\r\n};\r\n\r\nvar smallest = function(a, b) {\r\n  return a.length < b.length ? a : b;\r\n};\r\n\r\nvar truthy = function(a) { return !!a };\r\n\r\nMUSIC.Formats.MultiSerializer.selector = function(array) {\r\n  array = array.filter(truthy);\r\n  if (array.length) return array.filter(truthy).reduce(smallest);\r\n\r\n  throw new Error(\"serialization not found\");\r\n};\r\n\r\nMUSIC.Formats.MultiSerializer.serialize = function(type, obj) {\r\n  return MUSIC.Formats.MultiSerializer.selector(\r\n    serializerArray.map(function(s) {\r\n      var serialized = s.serializer.serialize(type, obj);\r\n      if (!serialized) return serialized;\r\n      return s.base.concat(serialized);\r\n    })\r\n  );\r\n};\r\n\r\nMUSIC.Formats.MultiSerializer.deserialize = function(type, obj) {\r\n  for (var i=0;i<serializerArray.length;i++) {\r\n    if (obj[0]===serializerArray[i].base) return serializerArray[i].serializer.deserialize(type, obj.slice(1));\r\n  }\r\n\r\n  throw new Error(\"Unsupported format\");\r\n};\r\n\r\nMUSIC.Formats.MultiSerializer.setSerializers = function(array) {\r\n  serializerArray = array.map(function(entry) {\r\n    return {\r\n      serializer: MUSIC.Formats.MultiSerializer.wrapSerializer(entry.serializer),\r\n      base: entry.base\r\n    };\r\n  });\r\n};\r\n\r\n})();\r\n","MUSIC = MUSIC ||{};\r\nMUSIC.Formats = MUSIC.Formats||{};\r\nMUSIC.Formats.PackedJSONSerializer = {};\r\n\r\n(function() {\r\n\r\nvar objToArrayPacker = function(keys) {\r\n  var pack = function(obj) {\r\n    var array = [];\r\n    for (var i=0; i<keys.length; i++) {\r\n      var key = keys[i];\r\n      if (Array.isArray(key)) {\r\n        array.push(key[1].pack(obj[key[0]], obj));\r\n      } else {\r\n        if (obj[key]!==null && obj[key]!==undefined) array.push(obj[key]);\r\n      }\r\n    }\r\n    return array;\r\n  };\r\n\r\n  var unpack = function(array) {\r\n    var obj = {};\r\n    for (var i=0; i<array.length; i++) {\r\n      var key = keys[i];\r\n      if (Array.isArray(key)) {\r\n        obj[key[0]] = key[1].unpack(array[i], obj);\r\n      } else {\r\n        if (array[i]!==null && array[i]!==undefined) obj[key] = array[i];\r\n      }\r\n    }\r\n    return obj;\r\n  };\r\n\r\n  return {pack: pack, unpack: unpack};\r\n};\r\n\r\nvar array = function(innerPacker) {\r\n  var pack = function(obj) {\r\n    return obj.map(innerPacker.pack);\r\n  };\r\n\r\n  var unpack = function(array) {\r\n    return array.map(innerPacker.unpack);\r\n  };\r\n\r\n  return {pack: pack, unpack: unpack};\r\n};\r\n\r\nvar concat = function(a, b){return a.concat(b); };\r\nvar flatten = function(innerPacker, size) {\r\n  var pack = function(obj) {\r\n    var ret = innerPacker.pack(obj);\r\n    return ret.reduce(concat, []);\r\n  };\r\n\r\n  var unpack = function(array) {\r\n    var deflatted = [];\r\n    for (var i=0; i<array.length; i+=size) {\r\n      deflatted.push(array.slice(i,i+size));\r\n    }\r\n    return innerPacker.unpack(deflatted);\r\n  };\r\n\r\n  return {pack: pack, unpack: unpack};\r\n};\r\n\r\nvar patternPacker = objToArrayPacker([\r\n  \"measure\",\r\n  \"measureCount\",\r\n  \"bpm\",\r\n  \"selectedTrack\",\r\n  \"scrollLeft\",\r\n  [\"tracks\", flatten(array(\r\n    objToArrayPacker([\"scroll\",[\"events\", flatten(array(objToArrayPacker([\"n\",\"s\",\"l\"])),3)], \"instrument\"])\r\n  ),3)]\r\n]);\r\n\r\nvar patternIndexPacker = function(inner) {\r\n  var pack = function(obj) {\r\n    var patterns = [];\r\n    var convertBlocks = function(block) {\r\n      if(block.id) {\r\n        if (patterns.indexOf(block.id)===-1) patterns.push(block.id);\r\n        return {id: patterns.indexOf(block.id)+1};\r\n      } else {\r\n        return {id: 0};\r\n      }\r\n    };\r\n\r\n    var convertTrack = function(track) {\r\n      return {\r\n        blocks: track.blocks.map(convertBlocks)\r\n      };\r\n    };\r\n\r\n    var newObject = {\r\n      patterns: patterns,\r\n      measure: obj.measure,\r\n      bpm: obj.bpm,\r\n      tracks: obj.tracks.map(convertTrack)\r\n    };\r\n\r\n    return inner.pack(newObject);\r\n  };\r\n\r\n  var unpack = function(obj) {\r\n    var ret = inner.unpack(obj);\r\n    ret.tracks.forEach(function(track) {\r\n      track.blocks.forEach(function(block) {\r\n        if (block.id === 0) {\r\n          delete block.id;\r\n        } else {\r\n          block.id = ret.patterns[block.id-1];\r\n        }\r\n      });\r\n    });\r\n\r\n    return {\r\n      measure: ret.measure,\r\n      bpm: ret.bpm,\r\n      tracks: ret.tracks\r\n    };\r\n  };\r\n\r\n  return {pack: pack, unpack: unpack};\r\n};\r\n\r\nvar substitution = function(keys) {\r\n  var pack = function(obj) {\r\n    var idx = keys.indexOf(obj);\r\n    if (idx === -1) return obj;\r\n    return idx;\r\n  };\r\n\r\n  var unpack = function(obj) {\r\n    if (isNaN(obj)) return obj;\r\n    return keys[obj];\r\n  };\r\n\r\n  return {pack: pack, unpack: unpack};\r\n};\r\n\r\nvar switchPacker = function(selectAttribute, packers) {\r\n\r\n  var pack = function(obj, parent) {\r\n    var innerPacker = packers[parent[selectAttribute]];\r\n    if (!innerPacker) {\r\n      return obj;\r\n    }\r\n\r\n    return innerPacker.pack(obj);\r\n  };\r\n\r\n  var unpack = function(obj, parent) {\r\n    var innerPacker = packers[parent[selectAttribute]];\r\n    if (!innerPacker) {\r\n      return obj;\r\n    }\r\n\r\n    return innerPacker.unpack(obj);\r\n  };\r\n\r\n  return {pack: pack, unpack: unpack};\r\n};\r\n\r\nvar booleanPacker = {\r\n  pack: function(obj) {\r\n    if (obj === undefined) return 3;\r\n    if (obj === null) return 4;\r\n\r\n    return !!obj ? 1 : 0;\r\n  },\r\n\r\n  unpack: function(obj) {\r\n    if (obj===3) return undefined;\r\n    if (obj===4) return null;\r\n\r\n    return obj === 1 ? true : false\r\n  }\r\n};\r\n\r\nvar nullable = function(innerPacker) {\r\n  var pack = function(obj) {\r\n    if (obj === undefined) return 0;\r\n    if (obj === null) return 1;\r\n\r\n    return innerPacker? innerPacker.pack(obj) : obj;\r\n  };\r\n\r\n  var unpack = function(obj) {\r\n    if (obj===0) return undefined;\r\n    if (obj===1) return null;\r\n\r\n    return innerPacker ? innerPacker.unpack(obj) : obj;\r\n  };\r\n\r\n  return {pack: pack, unpack: unpack};\r\n};\r\n\r\n\r\n\r\nvar songPacker = patternIndexPacker(objToArrayPacker([\r\n  \"patterns\",\r\n  \"measure\",\r\n  \"bpm\",\r\n  [\"tracks\", flatten(array(objToArrayPacker([\r\n    [\"blocks\", flatten(array(objToArrayPacker([\"id\"])),1)]\r\n  ])),1)]\r\n]));\r\n\r\nvar recursiveInstrumentPacker = {\r\n  pack: function(obj) {\r\n    return instrumentPacker.pack(obj);\r\n  },\r\n\r\n  unpack: function(obj) {\r\n    return instrumentPacker.unpack(obj);\r\n  }\r\n};\r\n\r\nvar stackPacker = objToArrayPacker([\r\n  [\"array\", array(recursiveInstrumentPacker)]\r\n]);\r\n\r\nvar envelopePacker = objToArrayPacker([\"attackTime\",\"decayTime\",\"sustainLevel\",\"releaseTime\", [\"reset_on_cut\", booleanPacker]]);\r\nvar oscillatorPacker = objToArrayPacker([\r\n  [\"oscillatorType\", substitution([\"sine\", \"square\", \"sawtooth\", \"triangle\", \"custom\"])],\r\n  [\"fixed_frequency\", booleanPacker],\r\n  [\"frequency\", nullable()],\r\n  [\"waveform\", nullable()],\r\n  [\"serie\", nullable(objToArrayPacker([\"sin\", \"cos\"]))],\r\n  [\"terms\", nullable(objToArrayPacker([\"sin\", \"cos\"]))],\r\n  [\"modulation\", nullable(objToArrayPacker([\r\n    [\"detune\", recursiveInstrumentPacker]\r\n  ]))],\r\n  \"time_constant\"\r\n]);\r\n\r\nvar frequencyFilterPacker = objToArrayPacker([\r\n  \"frequency\",\r\n  \"detune\",\r\n  \"Q\",\r\n  [\"modulation\", objToArrayPacker([\r\n    [\"frequency\", recursiveInstrumentPacker],\r\n    [\"detune\", recursiveInstrumentPacker],\r\n    [\"Q\", recursiveInstrumentPacker]\r\n  ])]\r\n]);\r\n\r\nvar noParametersPacker = objToArrayPacker([]);\r\n\r\nvar multiInstrumentPacker = objToArrayPacker([\r\n  [\"subobjects\", flatten(array(recursiveInstrumentPacker), 2)]\r\n]);\r\n\r\nvar typeNames = [\"script\",\"null\",\"oscillator\",\"notesplit\",\"rise\",\"adsr\",\r\n\"envelope\",\"transpose\",\"scale\",\"gain\",\"echo\",\"lowpass\",\r\n\"highpass\",\"bandpass\",\"lowshelf\",\"highshelf\",\"peaking\",\r\n\"notch\",\"allpass\",\"reverb\",\"noise\",\"pink_noise\",\"red_noise\",\r\n\"arpeggiator\",\"stack\", \"multi_instrument\", \"monophoner\", \"polyphoner\"];\r\n\r\nvar monophonerPacker = objToArrayPacker([\r\n  [\"force_note_cut\", booleanPacker]\r\n]);\r\nvar polyphonerPacker = objToArrayPacker([\"maxChannels\"]);\r\n\r\nvar instrumentPacker = objToArrayPacker([\r\n  [\"type\", substitution(typeNames)],\r\n  [\"data\", switchPacker('type', {\r\n      script: objToArrayPacker([\"code\"]),\r\n      'null': noParametersPacker,\r\n      oscillator: oscillatorPacker,\r\n      notesplit: objToArrayPacker([\"delay\"]),\r\n      rise: objToArrayPacker([\"time\", \"target\"]),\r\n      adsr: envelopePacker,\r\n      envelope: envelopePacker,\r\n      transpose: objToArrayPacker([\"amount\"]),\r\n      scale: objToArrayPacker([\"base\", \"top\"]),\r\n      gain: objToArrayPacker([\"gain\"]),\r\n      echo: objToArrayPacker([\"gain\", \"delay\"]),\r\n      lowpass: frequencyFilterPacker,\r\n      highpass: frequencyFilterPacker,\r\n      bandpass: frequencyFilterPacker,\r\n      lowshelf: frequencyFilterPacker,\r\n      highshelf: frequencyFilterPacker,\r\n      peaking: frequencyFilterPacker,\r\n      notch: frequencyFilterPacker,\r\n      allpass: frequencyFilterPacker,\r\n      reverb: objToArrayPacker([\"room\", \"damp\", \"mix\"]),\r\n      noise: noParametersPacker,\r\n      pink_noise: noParametersPacker,\r\n      red_noise: noParametersPacker,\r\n      arpeggiator: objToArrayPacker([\"scale\", \"interval\", \"duration\", \"gap\"]),\r\n      stack: stackPacker,\r\n      multi_instrument: multiInstrumentPacker,\r\n      monophoner: monophonerPacker,\r\n      polyphoner: polyphonerPacker\r\n    }\r\n  )],\r\n]);\r\n\r\nvar packer = {\r\n  pattern: patternPacker,\r\n  song: songPacker,\r\n  instrument: instrumentPacker\r\n};\r\n\r\nMUSIC.Formats.PackedJSONSerializer.serialize = function(type, obj) {\r\n  if (packer[type]) {\r\n    var str = JSON.stringify(packer[type].pack(obj));\r\n    str = str.slice(1, str.length-1);\r\n    return str\r\n  }\r\n\r\n  return JSON.stringify(obj);\r\n};\r\n\r\nMUSIC.Formats.PackedJSONSerializer.deserialize = function(type, str) {\r\n  if (packer[type]) {\r\n    return packer[type].unpack(JSON.parse('['+str+']'));\r\n  }\r\n\r\n  return JSON.parse(str);\r\n};\r\n\r\n})();\r\n","MUSIC = MUSIC ||{};\r\nMUSIC.Formats = MUSIC.Formats||{};\r\nMUSIC.Formats.PackedJSONSerializerB = {};\r\n\r\n(function() {\r\n\r\nvar objToArrayPacker = function(keys) {\r\n  var pack = function(obj) {\r\n    var array = [];\r\n    for (var i=0; i<keys.length; i++) {\r\n      var key = keys[i];\r\n      if (Array.isArray(key)) {\r\n        array.push(key[1].pack(obj[key[0]], obj));\r\n      } else {\r\n        if (obj[key]!==null && obj[key]!==undefined) array.push(obj[key]);\r\n      }\r\n    }\r\n    return array;\r\n  };\r\n\r\n  var unpack = function(array) {\r\n    var obj = {};\r\n    for (var i=0; i<array.length; i++) {\r\n      var key = keys[i];\r\n      if (Array.isArray(key)) {\r\n        obj[key[0]] = key[1].unpack(array[i], obj);\r\n      } else {\r\n        if (array[i]!==null && array[i]!==undefined) obj[key] = array[i];\r\n      }\r\n    }\r\n    return obj;\r\n  };\r\n\r\n  return {pack: pack, unpack: unpack};\r\n};\r\n\r\nvar array = function(innerPacker) {\r\n  var pack = function(obj) {\r\n    return obj.map(innerPacker.pack);\r\n  };\r\n\r\n  var unpack = function(array) {\r\n    return array.map(innerPacker.unpack);\r\n  };\r\n\r\n  return {pack: pack, unpack: unpack};\r\n};\r\n\r\nvar concat = function(a, b){return a.concat(b); };\r\nvar flatten = function(innerPacker, size) {\r\n  var pack = function(obj) {\r\n    var ret = innerPacker.pack(obj);\r\n    return ret.reduce(concat, []);\r\n  };\r\n\r\n  var unpack = function(array) {\r\n    var deflatted = [];\r\n    for (var i=0; i<array.length; i+=size) {\r\n      deflatted.push(array.slice(i,i+size));\r\n    }\r\n    return innerPacker.unpack(deflatted);\r\n  };\r\n\r\n  return {pack: pack, unpack: unpack};\r\n};\r\n\r\nvar booleanPacker = {\r\n  pack: function(obj) {\r\n    if (obj === undefined) return 3;\r\n    if (obj === null) return 4;\r\n\r\n    return !!obj ? 1 : 0;\r\n  },\r\n\r\n  unpack: function(obj) {\r\n    if (obj===3) return undefined;\r\n    if (obj===4) return null;\r\n\r\n    return obj === 1 ? true : false\r\n  }\r\n};\r\n\r\nvar patternEventPacker = {\r\n  pack: function(obj) {\r\n    var firstElement = obj.n;\r\n    for (var k in obj) {\r\n      if (k!=='n' && k!=='s' && k !== 'l') {\r\n        if (firstElement === obj.n) {\r\n          firstElement = {n: obj.n};\r\n        }\r\n        firstElement[k] = obj[k];\r\n      }\r\n    };\r\n\r\n    return [firstElement, obj.s, obj.l];\r\n  },\r\n  unpack: function(array) {\r\n    var firstElement = array[0];\r\n    if (typeof firstElement === 'number') {\r\n      return {\r\n        n: array[0],\r\n        s: array[1],\r\n        l: array[2]\r\n      };\r\n    } else {\r\n      var ret = {};\r\n      for (var k in firstElement) {\r\n        ret[k] = firstElement[k];\r\n      }\r\n      ret.s = array[1];\r\n      ret.l = array[2];\r\n      return ret;\r\n    }\r\n  }\r\n};\r\n\r\nvar patternPacker = objToArrayPacker([\r\n  \"measure\",\r\n  \"measureCount\",\r\n  \"bpm\",\r\n  \"selectedTrack\",\r\n  \"scrollLeft\",\r\n  [\"tracks\", array(\r\n    objToArrayPacker([[\"muted\", booleanPacker], [\"solo\", booleanPacker], \"scroll\",[\"events\", flatten(array(patternEventPacker),3)], \"instrument\"])\r\n  )]\r\n]);\r\n\r\nvar patternIndexPacker = function(inner) {\r\n  var pack = function(obj) {\r\n    var patterns = [];\r\n    var convertBlocks = function(block) {\r\n      if(block.id) {\r\n        if (patterns.indexOf(block.id)===-1) patterns.push(block.id);\r\n        return {id: patterns.indexOf(block.id)+1};\r\n      } else {\r\n        return {id: 0};\r\n      }\r\n    };\r\n\r\n    var convertTrack = function(track) {\r\n      return {\r\n        blocks: track.blocks.map(convertBlocks)\r\n      };\r\n    };\r\n\r\n    var newObject = {\r\n      patterns: patterns,\r\n      measure: obj.measure,\r\n      bpm: obj.bpm,\r\n      tracks: obj.tracks.map(convertTrack)\r\n    };\r\n\r\n    return inner.pack(newObject);\r\n  };\r\n\r\n  var unpack = function(obj) {\r\n    var ret = inner.unpack(obj);\r\n    ret.tracks.forEach(function(track) {\r\n      track.blocks.forEach(function(block) {\r\n        if (block.id === 0) {\r\n          delete block.id;\r\n        } else {\r\n          block.id = ret.patterns[block.id-1];\r\n        }\r\n      });\r\n    });\r\n\r\n    return {\r\n      measure: ret.measure,\r\n      bpm: ret.bpm,\r\n      tracks: ret.tracks\r\n    };\r\n  };\r\n\r\n  return {pack: pack, unpack: unpack};\r\n};\r\n\r\nvar substitution = function(keys) {\r\n  var pack = function(obj) {\r\n    var idx = keys.indexOf(obj);\r\n    if (idx === -1) return obj;\r\n    return idx;\r\n  };\r\n\r\n  var unpack = function(obj) {\r\n    if (isNaN(obj)) return obj;\r\n    return keys[obj];\r\n  };\r\n\r\n  return {pack: pack, unpack: unpack};\r\n};\r\n\r\nvar switchPacker = function(selectAttribute, packers) {\r\n\r\n  var pack = function(obj, parent) {\r\n    var innerPacker = packers[parent[selectAttribute]];\r\n    if (!innerPacker) {\r\n      return obj;\r\n    }\r\n\r\n    return innerPacker.pack(obj);\r\n  };\r\n\r\n  var unpack = function(obj, parent) {\r\n    var innerPacker = packers[parent[selectAttribute]];\r\n    if (!innerPacker) {\r\n      return obj;\r\n    }\r\n\r\n    return innerPacker.unpack(obj);\r\n  };\r\n\r\n  return {pack: pack, unpack: unpack};\r\n};\r\n\r\nvar nullable = function(innerPacker) {\r\n  var pack = function(obj) {\r\n    if (obj === undefined) return 0;\r\n    if (obj === null) return 1;\r\n\r\n    return innerPacker? innerPacker.pack(obj) : obj;\r\n  };\r\n\r\n  var unpack = function(obj) {\r\n    if (obj===0) return undefined;\r\n    if (obj===1) return null;\r\n\r\n    return innerPacker ? innerPacker.unpack(obj) : obj;\r\n  };\r\n\r\n  return {pack: pack, unpack: unpack};\r\n};\r\n\r\n\r\n\r\nvar songPacker = patternIndexPacker(objToArrayPacker([\r\n  \"patterns\",\r\n  \"measure\",\r\n  \"bpm\",\r\n  [\"tracks\", flatten(array(objToArrayPacker([\r\n    [\"blocks\", flatten(array(objToArrayPacker([\"id\"])),1)]\r\n  ])),1)]\r\n]));\r\n\r\nvar recursiveInstrumentPacker = {\r\n  pack: function(obj) {\r\n    return instrumentPacker.pack(obj);\r\n  },\r\n\r\n  unpack: function(obj) {\r\n    return instrumentPacker.unpack(obj);\r\n  }\r\n};\r\n\r\nvar stackPacker = objToArrayPacker([\r\n  [\"array\", array(recursiveInstrumentPacker)]\r\n]);\r\n\r\nvar envelopePacker = objToArrayPacker([\"attackTime\",\"decayTime\",\"sustainLevel\",\"releaseTime\", [\"reset_on_cut\", booleanPacker]]);\r\nvar oscillatorPacker = objToArrayPacker([\r\n  [\"oscillatorType\", substitution([\"sine\", \"square\", \"sawtooth\", \"triangle\", \"custom\"])],\r\n  [\"fixed_frequency\", booleanPacker],\r\n  [\"frequency\", nullable()],\r\n  [\"waveform\", nullable()],\r\n  [\"serie\", nullable(objToArrayPacker([\"sin\", \"cos\"]))],\r\n  [\"terms\", nullable(objToArrayPacker([\"sin\", \"cos\"]))],\r\n  [\"modulation\", nullable(objToArrayPacker([\r\n    [\"detune\", recursiveInstrumentPacker],\r\n    [\"pulse_width\", nullable(recursiveInstrumentPacker)]\r\n  ]))],\r\n  \"time_constant\",\r\n  \"pulse_width\"\r\n]);\r\n\r\nvar frequencyFilterPacker = objToArrayPacker([\r\n  \"frequency\",\r\n  \"detune\",\r\n  \"Q\",\r\n  [\"modulation\", objToArrayPacker([\r\n    [\"frequency\", recursiveInstrumentPacker],\r\n    [\"detune\", recursiveInstrumentPacker],\r\n    [\"Q\", recursiveInstrumentPacker]\r\n  ])]\r\n]);\r\n\r\nvar noParametersPacker = objToArrayPacker([]);\r\n\r\nvar multiInstrumentPacker = objToArrayPacker([\r\n  [\"subobjects\", flatten(array(recursiveInstrumentPacker), 2)]\r\n]);\r\n\r\nvar typeNames = [\"script\",\"null\",\"oscillator\",\"notesplit\",\"rise\",\"adsr\",\r\n\"envelope\",\"transpose\",\"scale\",\"gain\",\"echo\",\"lowpass\",\r\n\"highpass\",\"bandpass\",\"lowshelf\",\"highshelf\",\"peaking\",\r\n\"notch\",\"allpass\",\"reverb\",\"noise\",\"pink_noise\",\"red_noise\",\r\n\"arpeggiator\",\"stack\", \"multi_instrument\", \"monophoner\", \"polyphoner\", \"note_padding\",\r\n\"note_condition\", \"signal_monitor\", \"signal_constant\", \"note_delay\",\r\n\"sample_rate_reduction\", \"bit_crushing\",\r\n\"signal_scale\", \"signal_not\",\r\n\"signal_or\", \"signal_and\", \"signal_nor\", \"signal_nand\", \"delay\", \"note_frequency_generator\",\r\n\"note_time_shift\", \"wave_shaper\"];\r\n\r\nvar monophonerPacker = objToArrayPacker([\r\n  [\"force_note_cut\", booleanPacker]\r\n]);\r\nvar polyphonerPacker = objToArrayPacker([\"maxChannels\"]);\r\nvar notePaddingPacker = objToArrayPacker([\"time\"]);\r\n\r\nvar toModl = function(value) {\r\n  return [value, recursiveInstrumentPacker];\r\n};\r\n\r\nvar modl = function(values) {\r\n  return nullable(objToArrayPacker(values.map(toModl)));\r\n};\r\n\r\nvar instrumentPacker = objToArrayPacker([\r\n  [\"type\", substitution(typeNames)],\r\n  [\"data\", switchPacker('type', {\r\n      script: objToArrayPacker([\"code\"]),\r\n      'null': noParametersPacker,\r\n      oscillator: oscillatorPacker,\r\n      notesplit: objToArrayPacker([\"delay\"]),\r\n      rise: objToArrayPacker([\"time\", \"target\"]),\r\n      adsr: envelopePacker,\r\n      envelope: envelopePacker,\r\n      transpose: objToArrayPacker([\"amount\"]),\r\n      scale: objToArrayPacker([\"base\", \"top\"]),\r\n      gain: objToArrayPacker([\"gain\", [\"modulation\", modl([\"gain\"])]]),\r\n      echo: objToArrayPacker([\"gain\", \"delay\"]),\r\n      lowpass: frequencyFilterPacker,\r\n      highpass: frequencyFilterPacker,\r\n      bandpass: frequencyFilterPacker,\r\n      lowshelf: frequencyFilterPacker,\r\n      highshelf: frequencyFilterPacker,\r\n      peaking: frequencyFilterPacker,\r\n      notch: frequencyFilterPacker,\r\n      allpass: frequencyFilterPacker,\r\n      reverb: objToArrayPacker([\"room\", \"damp\", \"mix\"]),\r\n      noise: noParametersPacker,\r\n      pink_noise: noParametersPacker,\r\n      red_noise: noParametersPacker,\r\n      arpeggiator: objToArrayPacker([\"scale\", \"interval\", \"duration\", \"gap\"]),\r\n      stack: stackPacker,\r\n      multi_instrument: multiInstrumentPacker,\r\n      monophoner: monophonerPacker,\r\n      polyphoner: polyphonerPacker,\r\n      note_padding: notePaddingPacker,\r\n      note_condition: objToArrayPacker([\"note_on\", \"note_off\",\"enter_time_constant\", \"leave_time_constant\"]),\r\n      signal_monitor: noParametersPacker,\r\n      signal_constant: objToArrayPacker([\"offset\"]),\r\n      note_delay: objToArrayPacker([\"delay\"]),\r\n      delay: objToArrayPacker([\"delay\", [\"modulation\", modl([\"delay\"])]]),\r\n      sample_rate_reduction: objToArrayPacker([\"factor\"]),\r\n      bit_crushing: objToArrayPacker([\"bits\"]),\r\n      signal_scale: objToArrayPacker([\"base\", \"top\"]),\r\n      signal_not: noParametersPacker,\r\n      signal_or: objToArrayPacker([\"second_signal\", [\"modulation\", modl([\"second_signal\"])]]),\r\n      signal_and: objToArrayPacker([\"second_signal\", [\"modulation\", modl([\"second_signal\"])]]),\r\n      signal_nor: objToArrayPacker([\"second_signal\", [\"modulation\", modl([\"second_signal\"])]]),\r\n      signal_nand: objToArrayPacker([\"second_signal\", [\"modulation\", modl([\"second_signal\"])]]),\r\n      note_frequency_generator: objToArrayPacker([\"time_constant\"]),\r\n      note_time_shift: objToArrayPacker([\"time\"]),\r\n      wave_shaper: objToArrayPacker([\"samples\", \"f\"])\r\n    }\r\n  )],\r\n]);\r\n\r\nvar packer = {\r\n  pattern: patternPacker,\r\n  song: songPacker,\r\n  instrument: instrumentPacker\r\n};\r\n\r\nMUSIC.Formats.PackedJSONSerializerB.serialize = function(type, obj) {\r\n  if (packer[type]) {\r\n    var str = JSON.stringify(packer[type].pack(obj));\r\n    str = str.slice(1, str.length-1);\r\n    return str\r\n  }\r\n\r\n  return JSON.stringify(obj);\r\n};\r\n\r\nMUSIC.Formats.PackedJSONSerializerB.deserialize = function(type, str) {\r\n  if (packer[type]) {\r\n    return packer[type].unpack(JSON.parse('['+str+']'));\r\n  }\r\n\r\n  return JSON.parse(str);\r\n};\r\n\r\n})();\r\n"],"sourceRoot":"src"}