<head>
<script src="src/music.js" ></script>
<script src="src/music/instruments.js" ></script>
<script src="src/music/effects.js" ></script>
<script src="src/soundfont/accordion-ogg.js" ></script>
<script src="src/soundfont/acoustic_grand_piano-ogg.js" ></script>

<p> Use ZXCVBNM keys for keyboard </p>
<script>
(function() {

    var music = new MUSIC.Context();
    var startCurve = new MUSIC.Curve.Ramp(0, 1.0, 100).during(0.4);
    var stopCurve = new MUSIC.Curve.Ramp(1.0, 0.0, 100).during(0.4);

    // creates an effects pipeline
    var effects = music
                .gain(0.2)
                .reverb({delay: 0.07, gain: 0.5}); // apply reverb effect                

    // creates a soundGenerator to generate sound from frequency
    // appended to the effects pipeline
    var soundGenerator = 
                effects
                    .oscillator({type: 'square', effects: function(dst, param) { // implement separated efects for each note play
                        var gainNode = dst.gain(1.0);
                        /// gainNode.setParam('gain', startCurve); // optional
                        param.onstop = function() {
                            gainNode.setParam('gain', stopCurve);
                        };
                        return gainNode;
                    }});

    // create instrument from sound generator
    var instrument = 
        new MUSIC.Instrument(soundGenerator)
                    .mapNote(function(n) { return n + 36; })
                    .stopDelay(400)
                    .perNoteWrap(MUSIC.StopEvent());
    
/*
    var player = MUSIC.InstrumentSequence(instrument, 200);


    var seq = MUSIC
        .Sequence()
        .n(
                player('A-B-C-D-').loop(10));


    window.playing = seq.play();

*/

    var percussion = new MUSIC.PatchInstrument({
        'C': music.sound("src/sound/Kick 1.wav"),
        'D': music.highpass({frequency: 400}).sound("src/sound/Effect 1.wav"),
        'E': music
                .reverb({delay: 0.07, gain: 0.5})
                .sound("src/sound/Snare 1.wav")
                .stopDelay(1000)
    }, 0);
    
    instrument = percussion;


    player = MUSIC.InstrumentSequence(instrument, 200);
    var seq = MUSIC
        .Sequence()
        .n(
                [
                    player('C-C---C-'),
                    player('------E-')
                ]).loop(10);

        window.seq = seq;



    var notes = {};
    var keyCodeToNote = {
            90: 'C', 83: 'C#', 88: 'D',  68: 'D#', 67: 'E',
            86: 'F', 71: 'F#', 66: 'G', 72: 'G#', 78: 'A', 
            74: 'A#', 77: 'B'};

    window.onkeydown = function(e) {
        var n = notes[e.keyCode];
        if (n) return;

        var note = instrument.note(MUSIC.noteToNoteNum(keyCodeToNote[e.keyCode]));
        if (note == undefined) return;
        notes[e.keyCode] = note.play();
    };
    window.onkeyup = function(e) {
        var n = notes[e.keyCode];
        if (!n) return;
        notes[e.keyCode] = undefined;
        n.stop();
    };


})();

</script>
</head>
