<head>
<script src="src/music.js" ></script>
<script src="src/music/instruments.js" ></script>
<script src="src/music/effects.js" ></script>
<p> Use ZXCVBNM keys for keyboard </p>
<script>
(function() {

    var music = new MUSIC.Context();

    var att1 = music.
        attenuator(function() {
            return Math.sin(Date.now()*0.025 + Math.PI/2)*0.25+0.25;
        });

    var att2 = music.
        attenuator(function() {
            return Math.sin(Date.now()*0.025)*0.5+0.5;
        });

    var wrapInstrumentNote = function(note) {
        return {
            play: function() {
                var paramObject = {intensity:
                    function() {
                        if (this.stoppedTime) {
                            var ret = 1.0 + (this.stoppedTime - Date.now())*0.005;
                            if (ret < 0) ret = 0;
                        } else {
                            ret = 1.0;
                        }
                        return ret;
                    }
                };
                paramObject.startedTime = Date.now();
                var originalNote = note.play(paramObject);
                return {
                    stop: function() {
                        paramObject.stoppedTime = Date.now();
                        setTimeout(originalNote.stop.bind(originalNote), 500)
                    }
                };
            },

            during: MUSIC.during
        };
    };

    var wrapInstrumentParam = function(instrument) {
      return {
        note: function(noteName) {
          return wrapInstrumentNote(instrument.note(noteName));
        }
      };
    };

    var instrument = new MUSIC.MultiInstrument([
        new MUSIC.Instrument(
            music
                .noise(0.9)
                .oscillator({type: 'square'}, function(dst, param) {
                    return dst.attenuator(function(){return param.intensity();});
                }), 3)
                    .perNoteParam(wrapInstrumentParam)
    ]);


/*    var player = MUSIC.InstrumentSequence(instrument, 200);
    var playe2 = MUSIC.InstrumentSequence(instrument2, 200);
*/

    /*var seq = MUSIC
        .Sequence()
        .n(
            [
                player('A-------').measure(1600),
                playe2('A-------').measure(1600)
             ]);

    window.seq = seq;
    window.playing = seq.play();
    window.instrument = instrument;
*/
    var notes = {};
    var keyCodeToNote = {90: 'C', 88: 'D',  67: 'E', 86: 'F', 66: 'G', 78: 'A', 77: 'B'};

    window.onkeydown = function(e) {
        var n = notes[e.keyCode];
        if (n) return;

        var note = instrument.note(keyCodeToNote[e.keyCode]);
        if (note == undefined) return;
        notes[e.keyCode] = note.play();
    };
    window.onkeyup = function(e) {
        var n = notes[e.keyCode];
        if (!n) return;
        notes[e.keyCode] = undefined;
        n.stop();
    };


})();

</script>
</head>
